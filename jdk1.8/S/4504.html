<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
<title>src/com/sun/security/auth/module/LdapLoginModule.java</title>
<meta name="robots" content="noindex,nofollow">
<meta name="generator" content="GLOBAL-6.6.3">
<meta http-equiv="Content-Style-Type" content="text/css">
<link rel="stylesheet" type="text/css" href="../style.css">
</head>
<body>
<a id="TOP" name="TOP"></a><div class="comment">
/* [&lt;][&gt;]<a href="#L388">[^]</a><a href="#L998">[v]</a>[top]<a href="#BOTTOM">[bottom]</a><a href="../mains.html">[index]</a><a href="../help.html">[help]</a> */</div>
<hr>
<h2 class="header">DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href="#L388" title="Defined at 388.">SuppressWarnings</a></li>
<li><a href="#L389" title="Defined at 389.">initialize</a></li>
<li><a href="#L501" title="Defined at 501.">login</a></li>
<li><a href="#L607" title="Defined at 607.">commit</a></li>
<li><a href="#L672" title="Defined at 672.">abort</a></li>
<li><a href="#L706" title="Defined at 706.">logout</a></li>
<li><a href="#L740" title="Defined at 740.">attemptAuthentication</a></li>
<li><a href="#L862" title="Defined at 862.">findUserDN</a></li>
<li><a href="#L940" title="Defined at 940.">replaceUsernameToken</a></li>
<li><a href="#L957" title="Defined at 957.">getUsernamePassword</a></li>
<li><a href="#L998" title="Defined at 998.">cleanState</a></li>
</ol>
<hr>
<pre>
<div class="comment">
  Copyright (c) 2005, 2013, Oracle and/or its affiliates. All rights reserved.
  ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.</div>
<a id="L25" name="L25"></a>  25 
<a id="L26" name="L26"></a>  26 <strong class="reserved">package</strong> com.sun.security.auth.module;
<a id="L27" name="L27"></a>  27 
<a id="L28" name="L28"></a>  28 <strong class="reserved">import</strong> java.security.AccessController;
<a id="L29" name="L29"></a>  29 <strong class="reserved">import</strong> java.net.SocketPermission;
<a id="L30" name="L30"></a>  30 <strong class="reserved">import</strong> java.security.Principal;
<a id="L31" name="L31"></a>  31 <strong class="reserved">import</strong> java.security.PrivilegedAction;
<a id="L32" name="L32"></a>  32 <strong class="reserved">import</strong> java.util.Arrays;
<a id="L33" name="L33"></a>  33 <strong class="reserved">import</strong> java.util.Hashtable;
<a id="L34" name="L34"></a>  34 <strong class="reserved">import</strong> java.util.Map;
<a id="L35" name="L35"></a>  35 <strong class="reserved">import</strong> java.util.ResourceBundle;
<a id="L36" name="L36"></a>  36 <strong class="reserved">import</strong> java.util.regex.Matcher;
<a id="L37" name="L37"></a>  37 <strong class="reserved">import</strong> java.util.regex.Pattern;
<a id="L38" name="L38"></a>  38 <strong class="reserved">import</strong> java.util.Set;
<a id="L39" name="L39"></a>  39 
<a id="L40" name="L40"></a>  40 <strong class="reserved">import</strong> javax.naming.*;
<a id="L41" name="L41"></a>  41 <strong class="reserved">import</strong> javax.naming.directory.*;
<a id="L42" name="L42"></a>  42 <strong class="reserved">import</strong> javax.naming.ldap.*;
<a id="L43" name="L43"></a>  43 <strong class="reserved">import</strong> javax.security.auth.*;
<a id="L44" name="L44"></a>  44 <strong class="reserved">import</strong> javax.security.auth.callback.*;
<a id="L45" name="L45"></a>  45 <strong class="reserved">import</strong> javax.security.auth.login.*;
<a id="L46" name="L46"></a>  46 <strong class="reserved">import</strong> javax.security.auth.spi.*;
<a id="L47" name="L47"></a>  47 
<a id="L48" name="L48"></a>  48 <strong class="reserved">import</strong> com.sun.security.auth.LdapPrincipal;
<a id="L49" name="L49"></a>  49 <strong class="reserved">import</strong> com.sun.security.auth.UserPrincipal;
<a id="L50" name="L50"></a>  50 
<a id="L51" name="L51"></a>  51 
<div class="comment">
  This {@link LoginModule} performs LDAP-based authentication.
  A username and password is verified against the corresponding user
  credentials stored in an LDAP directory.
  This module requires the supplied {@link CallbackHandler} to support a
  {@link NameCallback} and a {@link PasswordCallback}.
  If authentication is successful then a new {@link LdapPrincipal} is created
  using the user's distinguished name and a new {@link UserPrincipal} is
  created using the user's username and both are associated
  with the current {@link Subject}.
  <p> This module operates in one of three modes: <i>search-first</i>,
  <i>authentication-first</i> or <i>authentication-only</i>.
  A mode is selected by specifying a particular set of options.
  </p><p> In search-first mode, the LDAP directory is searched to determine the
  user's distinguished name and then authentication is attempted.
  An (anonymous) search is performed using the supplied username in
  conjunction with a specified search filter.
  If successful then authentication is attempted using the user's
  distinguished name and the supplied password.
  To enable this mode, set the <code>userFilter</code> option and omit the
  <code>authIdentity</code> option.
  Use search-first mode when the user's distinguished name is not
  known in advance.
  </p><p> In authentication-first mode, authentication is attempted using the
  supplied username and password and then the LDAP directory is searched.
  If authentication is successful then a search is performed using the
  supplied username in conjunction with a specified search filter.
  To enable this mode, set the <code>authIdentity</code> and the
  <code>userFilter</code> options.
  Use authentication-first mode when accessing an LDAP directory
  that has been configured to disallow anonymous searches.
  </p><p> In authentication-only mode, authentication is attempted using the
  supplied username and password. The LDAP directory is not searched because
  the user's distinguished name is already known.
  To enable this mode, set the <code>authIdentity</code> option to a valid
  distinguished name and omit the <code>userFilter</code> option.
  Use authentication-only mode when the user's distinguished name is
  known in advance.
  </p><p> The following option is mandatory and must be specified in this
  module's login {@link Configuration}:
  </p><dl><dt></dt><dd>
  <dl>
  <dt> <code>userProvider=<b>ldap_urls</b></code>
  </dt>
  <dd> This option identifies the LDAP directory that stores user entries.
       <b>ldap_urls</b> is a list of space-separated LDAP URLs
       (<a href="http://www.ietf.org/rfc/rfc2255.txt">RFC 2255</a>)
       that identifies the LDAP server to use and the position in
       its directory tree where user entries are located.
       When several LDAP URLs are specified then each is attempted,
       in turn, until the first successful connection is established.
       Spaces in the distinguished name component of the URL must be escaped
       using the standard mechanism of percent character ('<code>%</code>')
       followed by two hexadecimal digits (see {@link java.net.URI}).
       Query components must also be omitted from the URL.
       <p>
       Automatic discovery of the LDAP server via DNS
       (<a href="http://www.ietf.org/rfc/rfc2782.txt">RFC 2782</a>)
       is supported (once DNS has been configured to support such a service).
       It is enabled by omitting the hostname and port number components from
       the LDAP URL. </p></dd>
  </dl></dd></dl>
  <p> This module also recognizes the following optional {@link Configuration}
      options:
  </p><dl><dt></dt><dd>
  <dl>
  <dt> <code>userFilter=<b>ldap_filter</b></code> </dt>
  <dd> This option specifies the search filter to use to locate a user's
       entry in the LDAP directory. It is used to determine a user's
       distinguished name.
       <code><b>ldap_filter</b></code> is an LDAP filter string
       (<a href="http://www.ietf.org/rfc/rfc2254.txt">RFC 2254</a>).
       If it contains the special token "<code><b>{USERNAME}</b></code>"
       then that token will be replaced with the supplied username value
       before the filter is used to search the directory. </dd>
  <dt> <code>authIdentity=<b>auth_id</b></code> </dt>
  <dd> This option specifies the identity to use when authenticating a user
       to the LDAP directory.
       <code><b>auth_id</b></code> may be an LDAP distinguished name string
       (<a href="http://www.ietf.org/rfc/rfc2253.txt">RFC 2253</a>) or some
       other string name.
       It must contain the special token "<code><b>{USERNAME}</b></code>"
       which will be replaced with the supplied username value before the
       name is used for authentication.
       Note that if this option does not contain a distinguished name then
       the <code>userFilter</code> option must also be specified. </dd>
  <dt> <code>authzIdentity=<b>authz_id</b></code> </dt>
  <dd> This option specifies an authorization identity for the user.
       <code><b>authz_id</b></code> is any string name.
       If it comprises a single special token with curly braces then
       that token is treated as a attribute name and will be replaced with a
       single value of that attribute from the user's LDAP entry.
       If the attribute cannot be found then the option is ignored.
       When this option is supplied and the user has been successfully
       authenticated then an additional {@link UserPrincipal}
       is created using the authorization identity and it is associated with
       the current {@link Subject}. </dd>
  <dt> <code>useSSL</code> </dt>
  <dd> if <code>false</code>, this module does not establish an SSL connection
       to the LDAP server before attempting authentication. SSL is used to
       protect the privacy of the user's password because it is transmitted
       in the clear over LDAP.
       By default, this module uses SSL. </dd>
  <dt> <code>useFirstPass</code> </dt>
  <dd> if <code>true</code>, this module retrieves the username and password
       from the module's shared state, using "javax.security.auth.login.name"
       and "javax.security.auth.login.password" as the respective keys. The
       retrieved values are used for authentication. If authentication fails,
       no attempt for a retry is made, and the failure is reported back to
       the calling application.</dd>
  <dt> <code>tryFirstPass</code> </dt>
  <dd> if <code>true</code>, this module retrieves the username and password
       from the module's shared state, using "javax.security.auth.login.name"
        and "javax.security.auth.login.password" as the respective keys.  The
       retrieved values are used for authentication. If authentication fails,
       the module uses the {@link CallbackHandler} to retrieve a new username
       and password, and another attempt to authenticate is made. If the
       authentication fails, the failure is reported back to the calling
       application.</dd>
  <dt> <code>storePass</code> </dt>
  <dd> if <code>true</code>, this module stores the username and password
       obtained from the {@link CallbackHandler} in the module's shared state,
       using
       "javax.security.auth.login.name" and
       "javax.security.auth.login.password" as the respective keys.  This is
       not performed if existing values already exist for the username and
       password in the shared state, or if authentication fails.</dd>
  <dt> <code>clearPass</code> </dt>
  <dd> if <code>true</code>, this module clears the username and password
       stored in the module's shared state after both phases of authentication
       (login and commit) have completed.</dd>
  <dt> <code>debug</code> </dt>
  <dd> if <code>true</code>, debug messages are displayed on the standard
       output stream.
  </dd></dl>
  </dd></dl>
  <p>
  Arbitrary
  <a href="{@docRoot}/../../../../../technotes/guides/jndi/jndi-ldap-gl.html#PROP">JNDI properties</a>
  may also be specified in the {@link Configuration}.
  They are added to the environment and passed to the LDAP provider.
  Note that the following four JNDI properties are set by this module directly
  and are ignored if also present in the configuration:
  </p><ul><li> <code>java.naming.provider.url</code>
  </li><li> <code>java.naming.security.principal</code>
  </li><li> <code>java.naming.security.credentials</code>
  </li><li> <code>java.naming.security.protocol</code>
  </li></ul>
  <p>
  Three sample {@link Configuration}s are shown below.
  The first one activates search-first mode. It identifies the LDAP server
  and specifies that users' entries be located by their <code>uid</code> and
  <code>objectClass</code> attributes. It also specifies that an identity
  based on the user's <code>employeeNumber</code> attribute should be created.
  The second one activates authentication-first mode. It requests that the
  LDAP server be located dynamically, that authentication be performed using
  the supplied username directly but without the protection of SSL and that
  users' entries be located by one of three naming attributes and their
  <code>objectClass</code> attribute.
  The third one activates authentication-only mode. It identifies alternative
  LDAP servers, it specifies the distinguished name to use for
  authentication and a fixed identity to use for authorization. No directory
  search is performed.
  </p><pre>      ExampleApplication {
          com.sun.security.auth.module.LdapLoginModule REQUIRED
              userProvider="ldap://ldap-svr/ou=people,dc=example,dc=com"
              userFilter="(&amp;(uid={USERNAME})(objectClass=inetOrgPerson))"
              authzIdentity="{EMPLOYEENUMBER}"
              debug=true;
      };
      ExampleApplication {
          com.sun.security.auth.module.LdapLoginModule REQUIRED
              userProvider="ldap:///cn=users,dc=example,dc=com"
              authIdentity="{USERNAME}"
              userFilter="(&amp;(|(samAccountName={USERNAME})(userPrincipalName={USERNAME})(cn={USERNAME}))(objectClass=user))"
              useSSL=false
              debug=true;
      };
      ExampleApplication {
          com.sun.security.auth.module.LdapLoginModule REQUIRED
              userProvider="ldap://ldap-svr1 ldap://ldap-svr2"
              authIdentity="cn={USERNAME},ou=people,dc=example,dc=com"
              authzIdentity="staff"
              debug=true;
      };
  </pre>
  <dl>
  <dt><b>Note:</b> </dt>
  <dd>When a {@link SecurityManager} is active then an application
      that creates a {@link LoginContext} and uses a {@link LoginModule}
      must be granted certain permissions.
      <p>
      If the application creates a login context using an <em>installed</em>
      {@link Configuration} then the application must be granted the
      {@link AuthPermission} to create login contexts.
      For example, the following security policy allows an application in
      the user's current directory to instantiate <em>any</em> login context:
      </p><pre>      grant codebase "file:${user.dir}/" {
          permission javax.security.auth.AuthPermission "createLoginContext.*";
      };
      </pre>
      Alternatively, if the application creates a login context using a
      <em>caller-specified</em> {@link Configuration} then the application
      must be granted the permissions required by the {@link LoginModule}.
      <em>This</em> module requires the following two permissions:
      <p>
      </p><ul><li> The {@link SocketPermission} to connect to an LDAP server.
      </li><li> The {@link AuthPermission} to modify the set of {@link Principal}s
           associated with a {@link Subject}.
      </li></ul>
      <p>
      For example, the following security policy grants an application in the
      user's current directory all the permissions required by this module:
      </p><pre>      grant codebase "file:${user.dir}/" {
          permission java.net.SocketPermission "*:389", "connect";
          permission java.net.SocketPermission "*:636", "connect";
          permission javax.security.auth.AuthPermission "modifyPrincipals";
      };
      </pre>
  </dd>
  </dl>
  @since 1.6</div>
<a id="L307" name="L307"></a> 307 @jdk.<a href="../D/3043.html" title="Multiple defined in 7 places.">Exported</a>
<a id="L308" name="L308"></a> 308 <strong class="reserved">public</strong> <strong class="reserved">class</strong> LdapLoginModule <strong class="reserved">implements</strong> <a href="../S/2646.html#L129" title="Defined at 129 in src/javax/security/auth/spi/LoginModule.java.">LoginModule</a> <em class="brace">{</em>
<a id="L309" name="L309"></a> 309 
<a id="L310" name="L310"></a> 310     <em class="comment">// Use the default classloader for this class to load the prompt strings.</em>
<a id="L311" name="L311"></a> 311     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../S/853.html#L287" title="Defined at 287 in src/java/util/ResourceBundle.java.">ResourceBundle</a> rb = <a href="../S/1248.html#L264" title="Defined at 264 in src/java/security/AccessController.java.">AccessController</a>.<a href="../D/15060.html" title="Multiple defined in 7 places.">doPrivileged</a>(
<a id="L312" name="L312"></a> 312             <strong class="reserved">new</strong> <a href="../S/1321.html#L42" title="Defined at 42 in src/java/security/PrivilegedAction.java.">PrivilegedAction</a>&lt;<a href="../S/853.html#L287" title="Defined at 287 in src/java/util/ResourceBundle.java.">ResourceBundle</a>&gt;() <em class="brace">{</em>
<a id="L313" name="L313"></a> 313                 <strong class="reserved">public</strong> <a href="../S/853.html#L287" title="Defined at 287 in src/java/util/ResourceBundle.java.">ResourceBundle</a> <a href="../D/31480.html" title="Multiple defined in 101 places.">run</a>() <em class="brace">{</em>
<a id="L314" name="L314"></a> 314                     <strong class="reserved">return</strong> <a href="../S/853.html#L287" title="Defined at 287 in src/java/util/ResourceBundle.java.">ResourceBundle</a>.<a href="../D/17375.html" title="Multiple defined in 6 places.">getBundle</a>(
<a id="L315" name="L315"></a> 315                         "sun.security.util.AuthResources");
<a id="L316" name="L316"></a> 316                 <em class="brace">}</em>
<a id="L317" name="L317"></a> 317             <em class="brace">}</em>
<a id="L318" name="L318"></a> 318         );
<a id="L319" name="L319"></a> 319 
<a id="L320" name="L320"></a> 320     <em class="comment">// Keys to retrieve the stored username and password</em>
<a id="L321" name="L321"></a> 321     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> USERNAME_KEY = "javax.security.auth.login.name";
<a id="L322" name="L322"></a> 322     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> PASSWORD_KEY =
<a id="L323" name="L323"></a> 323         "javax.security.auth.login.password";
<a id="L324" name="L324"></a> 324 
<a id="L325" name="L325"></a> 325     <em class="comment">// Option names</em>
<a id="L326" name="L326"></a> 326     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> USER_PROVIDER = "userProvider";
<a id="L327" name="L327"></a> 327     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> USER_FILTER = "userFilter";
<a id="L328" name="L328"></a> 328     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> AUTHC_IDENTITY = "authIdentity";
<a id="L329" name="L329"></a> 329     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> AUTHZ_IDENTITY = "authzIdentity";
<a id="L330" name="L330"></a> 330 
<a id="L331" name="L331"></a> 331     <em class="comment">// Used for the username token replacement</em>
<a id="L332" name="L332"></a> 332     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> USERNAME_TOKEN = "{USERNAME}";
<a id="L333" name="L333"></a> 333     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../D/6677.html" title="Multiple defined in 3 places.">Pattern</a> USERNAME_PATTERN =
<a id="L334" name="L334"></a> 334         <a href="../D/6677.html" title="Multiple defined in 3 places.">Pattern</a>.<a href="../D/13080.html" title="Multiple defined in 22 places.">compile</a>("\\{USERNAME\\}");
<a id="L335" name="L335"></a> 335 
<a id="L336" name="L336"></a> 336     <em class="comment">// Configurable options</em>
<a id="L337" name="L337"></a> 337     <strong class="reserved">private</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> userProvider;
<a id="L338" name="L338"></a> 338     <strong class="reserved">private</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> userFilter;
<a id="L339" name="L339"></a> 339     <strong class="reserved">private</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> authcIdentity;
<a id="L340" name="L340"></a> 340     <strong class="reserved">private</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> authzIdentity;
<a id="L341" name="L341"></a> 341     <strong class="reserved">private</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> authzIdentityAttr = <strong class="reserved">null</strong>;
<a id="L342" name="L342"></a> 342     <strong class="reserved">private</strong> <strong class="reserved">boolean</strong> useSSL = <strong class="reserved">true</strong>;
<a id="L343" name="L343"></a> 343     <strong class="reserved">private</strong> <strong class="reserved">boolean</strong> authFirst = <strong class="reserved">false</strong>;
<a id="L344" name="L344"></a> 344     <strong class="reserved">private</strong> <strong class="reserved">boolean</strong> authOnly = <strong class="reserved">false</strong>;
<a id="L345" name="L345"></a> 345     <strong class="reserved">private</strong> <strong class="reserved">boolean</strong> useFirstPass = <strong class="reserved">false</strong>;
<a id="L346" name="L346"></a> 346     <strong class="reserved">private</strong> <strong class="reserved">boolean</strong> tryFirstPass = <strong class="reserved">false</strong>;
<a id="L347" name="L347"></a> 347     <strong class="reserved">private</strong> <strong class="reserved">boolean</strong> storePass = <strong class="reserved">false</strong>;
<a id="L348" name="L348"></a> 348     <strong class="reserved">private</strong> <strong class="reserved">boolean</strong> clearPass = <strong class="reserved">false</strong>;
<a id="L349" name="L349"></a> 349     <strong class="reserved">private</strong> <strong class="reserved">boolean</strong> <a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a> = <strong class="reserved">false</strong>;
<a id="L350" name="L350"></a> 350 
<a id="L351" name="L351"></a> 351     <em class="comment">// Authentication status</em>
<a id="L352" name="L352"></a> 352     <strong class="reserved">private</strong> <strong class="reserved">boolean</strong> succeeded = <strong class="reserved">false</strong>;
<a id="L353" name="L353"></a> 353     <strong class="reserved">private</strong> <strong class="reserved">boolean</strong> commitSucceeded = <strong class="reserved">false</strong>;
<a id="L354" name="L354"></a> 354 
<a id="L355" name="L355"></a> 355     <em class="comment">// Supplied username and password</em>
<a id="L356" name="L356"></a> 356     <strong class="reserved">private</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> username;
<a id="L357" name="L357"></a> 357     <strong class="reserved">private</strong> <strong class="reserved">char</strong>[] password;
<a id="L358" name="L358"></a> 358 
<a id="L359" name="L359"></a> 359     <em class="comment">// User's identities</em>
<a id="L360" name="L360"></a> 360     <strong class="reserved">private</strong> <a href="../S/4492.html#L49" title="Defined at 49 in src/com/sun/security/auth/LdapPrincipal.java.">LdapPrincipal</a> ldapPrincipal;
<a id="L361" name="L361"></a> 361     <strong class="reserved">private</strong> <a href="../D/9436.html" title="Multiple defined in 2 places.">UserPrincipal</a> userPrincipal;
<a id="L362" name="L362"></a> 362     <strong class="reserved">private</strong> <a href="../D/9436.html" title="Multiple defined in 2 places.">UserPrincipal</a> authzPrincipal;
<a id="L363" name="L363"></a> 363 
<a id="L364" name="L364"></a> 364     <em class="comment">// Initial state</em>
<a id="L365" name="L365"></a> 365     <strong class="reserved">private</strong> <a href="../S/2639.html#L100" title="Defined at 100 in src/javax/security/auth/Subject.java.">Subject</a> subject;
<a id="L366" name="L366"></a> 366     <strong class="reserved">private</strong> <a href="../S/2659.html#L68" title="Defined at 68 in src/javax/security/auth/callback/CallbackHandler.java.">CallbackHandler</a> callbackHandler;
<a id="L367" name="L367"></a> 367     <strong class="reserved">private</strong> <a href="../D/5398.html" title="Multiple defined in 3 places.">Map</a>&lt;<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>, <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a>&gt; sharedState;
<a id="L368" name="L368"></a> 368     <strong class="reserved">private</strong> <a href="../D/5398.html" title="Multiple defined in 3 places.">Map</a>&lt;<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>, ?&gt; <a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>;
<a id="L369" name="L369"></a> 369     <strong class="reserved">private</strong> <a href="../S/4271.html#L175" title="Defined at 175 in src/javax/naming/ldap/LdapContext.java.">LdapContext</a> <a href="../D/14411.html" title="Multiple defined in 6 places.">ctx</a>;
<a id="L370" name="L370"></a> 370     <strong class="reserved">private</strong> <a href="../D/5451.html" title="Multiple defined in 3 places.">Matcher</a> identityMatcher = <strong class="reserved">null</strong>;
<a id="L371" name="L371"></a> 371     <strong class="reserved">private</strong> <a href="../D/5451.html" title="Multiple defined in 3 places.">Matcher</a> filterMatcher = <strong class="reserved">null</strong>;
<a id="L372" name="L372"></a> 372     <strong class="reserved">private</strong> <a href="../D/3743.html" title="Multiple defined in 2 places.">Hashtable</a>&lt;<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>, <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a>&gt; ldapEnvironment;
<a id="L373" name="L373"></a> 373     <strong class="reserved">private</strong> <a href="../S/4288.html#L43" title="Defined at 43 in src/javax/naming/directory/SearchControls.java.">SearchControls</a> constraints = <strong class="reserved">null</strong>;
<a id="L374" name="L374"></a> 374 
<div class="comment">
      Initialize this <code>LoginModule</code>.
      @param subject the <code>Subject</code> to be authenticated.
      @param callbackHandler a <code>CallbackHandler</code> to acquire the
                       username and password.
      @param sharedState shared <code>LoginModule</code> state.
      @param options options specified in the login
                       <code>Configuration</code> for this particular
                       <code>LoginModule</code>.</div>
<a id="L386" name="L386"></a> 386     <em class="comment">// Unchecked warning from (Map&lt;String, Object&gt;)sharedState is safe</em>
<a id="L387" name="L387"></a> 387     <em class="comment">// since javax.security.auth.login.LoginContext passes a raw HashMap.</em>
<a id="L388" name="L388"></a> 388     @<a href="../R/7764.html" title="Multiple referred from 264 places.">SuppressWarnings</a>("unchecked")
<a id="L389" name="L389"></a> 389     <strong class="reserved">public</strong> <strong class="reserved">void</strong> <a href="../R/20681.html" title="Multiple referred from 99 places.">initialize</a>(<a href="../S/2639.html#L100" title="Defined at 100 in src/javax/security/auth/Subject.java.">Subject</a> subject, <a href="../S/2659.html#L68" title="Defined at 68 in src/javax/security/auth/callback/CallbackHandler.java.">CallbackHandler</a> callbackHandler,
<a id="L390" name="L390"></a> 390                         <a href="../D/5398.html" title="Multiple defined in 3 places.">Map</a>&lt;<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>, ?&gt; sharedState, <a href="../D/5398.html" title="Multiple defined in 3 places.">Map</a>&lt;<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>, ?&gt; <a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>) <em class="brace">{</em>
<a id="L391" name="L391"></a> 391 
<a id="L392" name="L392"></a> 392         <strong class="reserved">this</strong>.subject = subject;
<a id="L393" name="L393"></a> 393         <strong class="reserved">this</strong>.callbackHandler = callbackHandler;
<a id="L394" name="L394"></a> 394         <strong class="reserved">this</strong>.sharedState = (<a href="../D/5398.html" title="Multiple defined in 3 places.">Map</a>&lt;<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>, <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a>&gt;)sharedState;
<a id="L395" name="L395"></a> 395         <strong class="reserved">this</strong>.<a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a> = <a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>;
<a id="L396" name="L396"></a> 396 
<a id="L397" name="L397"></a> 397         ldapEnvironment = <strong class="reserved">new</strong> <a href="../D/3743.html" title="Multiple defined in 2 places.">Hashtable</a>&lt;<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>, <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a>&gt;(9);
<a id="L398" name="L398"></a> 398         ldapEnvironment.<a href="../D/29971.html" title="Multiple defined in 370 places.">put</a>(<a href="../D/1859.html" title="Multiple defined in 4 places.">Context</a>.INITIAL_CONTEXT_FACTORY,
<a id="L399" name="L399"></a> 399             "com.sun.jndi.ldap.LdapCtxFactory");
<a id="L400" name="L400"></a> 400 
<a id="L401" name="L401"></a> 401         <em class="comment">// Add any JNDI properties to the environment</em>
<a id="L402" name="L402"></a> 402         <strong class="reserved">for</strong> (<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> <a href="../D/26706.html" title="Multiple defined in 2 places.">key</a> : <a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>.<a href="../D/26719.html" title="Multiple defined in 33 places.">keySet</a>()) <em class="brace">{</em>
<a id="L403" name="L403"></a> 403             <strong class="reserved">if</strong> (<a href="../D/26706.html" title="Multiple defined in 2 places.">key</a>.<a href="../D/24468.html" title="Multiple defined in 74 places.">indexOf</a>(".") &gt; -1) <em class="brace">{</em>
<a id="L404" name="L404"></a> 404                 ldapEnvironment.<a href="../D/29971.html" title="Multiple defined in 370 places.">put</a>(<a href="../D/26706.html" title="Multiple defined in 2 places.">key</a>, <a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>(<a href="../D/26706.html" title="Multiple defined in 2 places.">key</a>));
<a id="L405" name="L405"></a> 405             <em class="brace">}</em>
<a id="L406" name="L406"></a> 406         <em class="brace">}</em>
<a id="L407" name="L407"></a> 407 
<a id="L408" name="L408"></a> 408         <em class="comment">// initialize any configured options</em>
<a id="L409" name="L409"></a> 409 
<a id="L410" name="L410"></a> 410         userProvider = (<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>)<a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>(USER_PROVIDER);
<a id="L411" name="L411"></a> 411         <strong class="reserved">if</strong> (userProvider != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L412" name="L412"></a> 412             ldapEnvironment.<a href="../D/29971.html" title="Multiple defined in 370 places.">put</a>(<a href="../D/1859.html" title="Multiple defined in 4 places.">Context</a>.PROVIDER_URL, userProvider);
<a id="L413" name="L413"></a> 413         <em class="brace">}</em>
<a id="L414" name="L414"></a> 414 
<a id="L415" name="L415"></a> 415         authcIdentity = (<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>)<a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>(AUTHC_IDENTITY);
<a id="L416" name="L416"></a> 416         <strong class="reserved">if</strong> (authcIdentity != <strong class="reserved">null</strong> &amp;&amp;
<a id="L417" name="L417"></a> 417             (authcIdentity.<a href="../D/24468.html" title="Multiple defined in 74 places.">indexOf</a>(USERNAME_TOKEN) != -1)) <em class="brace">{</em>
<a id="L418" name="L418"></a> 418             identityMatcher = USERNAME_PATTERN.<a href="../S/986.html#L1086" title="Defined at 1086 in src/java/util/regex/Pattern.java.">matcher</a>(authcIdentity);
<a id="L419" name="L419"></a> 419         <em class="brace">}</em>
<a id="L420" name="L420"></a> 420 
<a id="L421" name="L421"></a> 421         userFilter = (<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>)<a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>(USER_FILTER);
<a id="L422" name="L422"></a> 422         <strong class="reserved">if</strong> (userFilter != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L423" name="L423"></a> 423             <strong class="reserved">if</strong> (userFilter.<a href="../D/24468.html" title="Multiple defined in 74 places.">indexOf</a>(USERNAME_TOKEN) != -1) <em class="brace">{</em>
<a id="L424" name="L424"></a> 424                 filterMatcher = USERNAME_PATTERN.<a href="../S/986.html#L1086" title="Defined at 1086 in src/java/util/regex/Pattern.java.">matcher</a>(userFilter);
<a id="L425" name="L425"></a> 425             <em class="brace">}</em>
<a id="L426" name="L426"></a> 426             constraints = <strong class="reserved">new</strong> <a href="../S/4288.html#L43" title="Defined at 43 in src/javax/naming/directory/SearchControls.java.">SearchControls</a>();
<a id="L427" name="L427"></a> 427             constraints.<a href="../S/4288.html#L266" title="Defined at 266 in src/javax/naming/directory/SearchControls.java.">setSearchScope</a>(<a href="../S/4288.html#L43" title="Defined at 43 in src/javax/naming/directory/SearchControls.java.">SearchControls</a>.SUBTREE_SCOPE);
<a id="L428" name="L428"></a> 428             constraints.<a href="../S/4288.html#L328" title="Defined at 328 in src/javax/naming/directory/SearchControls.java.">setReturningAttributes</a>(<strong class="reserved">new</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>[0]); <em class="comment">//return no attrs</em>
<a id="L429" name="L429"></a> 429             constraints.<a href="../S/4288.html#L301" title="Defined at 301 in src/javax/naming/directory/SearchControls.java.">setReturningObjFlag</a>(<strong class="reserved">true</strong>); <em class="comment">// to get the full DN</em>
<a id="L430" name="L430"></a> 430         <em class="brace">}</em>
<a id="L431" name="L431"></a> 431 
<a id="L432" name="L432"></a> 432         authzIdentity = (<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>)<a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>(AUTHZ_IDENTITY);
<a id="L433" name="L433"></a> 433         <strong class="reserved">if</strong> (authzIdentity != <strong class="reserved">null</strong> &amp;&amp;
<a id="L434" name="L434"></a> 434             authzIdentity.<a href="../D/34843.html" title="Multiple defined in 24 places.">startsWith</a>("{") &amp;&amp; authzIdentity.<a href="../D/15495.html" title="Multiple defined in 12 places.">endsWith</a>("}")) <em class="brace">{</em>
<a id="L435" name="L435"></a> 435             <strong class="reserved">if</strong> (constraints != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L436" name="L436"></a> 436                 authzIdentityAttr =
<a id="L437" name="L437"></a> 437                     authzIdentity.<a href="../D/35013.html" title="Multiple defined in 26 places.">substring</a>(1, authzIdentity.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>() - 1);
<a id="L438" name="L438"></a> 438                 constraints.<a href="../S/4288.html#L328" title="Defined at 328 in src/javax/naming/directory/SearchControls.java.">setReturningAttributes</a>(
<a id="L439" name="L439"></a> 439                     <strong class="reserved">new</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>[]<em class="brace">{</em>authzIdentityAttr<em class="brace">}</em>);
<a id="L440" name="L440"></a> 440             <em class="brace">}</em>
<a id="L441" name="L441"></a> 441             authzIdentity = <strong class="reserved">null</strong>; <em class="comment">// set later, from the specified attribute</em>
<a id="L442" name="L442"></a> 442         <em class="brace">}</em>
<a id="L443" name="L443"></a> 443 
<a id="L444" name="L444"></a> 444         <em class="comment">// determine mode</em>
<a id="L445" name="L445"></a> 445         <strong class="reserved">if</strong> (authcIdentity != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L446" name="L446"></a> 446             <strong class="reserved">if</strong> (userFilter != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L447" name="L447"></a> 447                 authFirst = <strong class="reserved">true</strong>; <em class="comment">// authentication-first mode</em>
<a id="L448" name="L448"></a> 448             <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L449" name="L449"></a> 449                 authOnly = <strong class="reserved">true</strong>; <em class="comment">// authentication-only mode</em>
<a id="L450" name="L450"></a> 450             <em class="brace">}</em>
<a id="L451" name="L451"></a> 451         <em class="brace">}</em>
<a id="L452" name="L452"></a> 452 
<a id="L453" name="L453"></a> 453         <strong class="reserved">if</strong> ("false".<a href="../D/15687.html" title="Multiple defined in 6 places.">equalsIgnoreCase</a>((<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>)<a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>("useSSL"))) <em class="brace">{</em>
<a id="L454" name="L454"></a> 454             useSSL = <strong class="reserved">false</strong>;
<a id="L455" name="L455"></a> 455             ldapEnvironment.<a href="../D/30677.html" title="Multiple defined in 356 places.">remove</a>(<a href="../D/1859.html" title="Multiple defined in 4 places.">Context</a>.SECURITY_PROTOCOL);
<a id="L456" name="L456"></a> 456         <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L457" name="L457"></a> 457             ldapEnvironment.<a href="../D/29971.html" title="Multiple defined in 370 places.">put</a>(<a href="../D/1859.html" title="Multiple defined in 4 places.">Context</a>.SECURITY_PROTOCOL, "ssl");
<a id="L458" name="L458"></a> 458         <em class="brace">}</em>
<a id="L459" name="L459"></a> 459 
<a id="L460" name="L460"></a> 460         tryFirstPass =
<a id="L461" name="L461"></a> 461                 "true".<a href="../D/15687.html" title="Multiple defined in 6 places.">equalsIgnoreCase</a>((<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>)<a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>("tryFirstPass"));
<a id="L462" name="L462"></a> 462 
<a id="L463" name="L463"></a> 463         useFirstPass =
<a id="L464" name="L464"></a> 464                 "true".<a href="../D/15687.html" title="Multiple defined in 6 places.">equalsIgnoreCase</a>((<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>)<a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>("useFirstPass"));
<a id="L465" name="L465"></a> 465 
<a id="L466" name="L466"></a> 466         storePass = "true".<a href="../D/15687.html" title="Multiple defined in 6 places.">equalsIgnoreCase</a>((<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>)<a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>("storePass"));
<a id="L467" name="L467"></a> 467 
<a id="L468" name="L468"></a> 468         clearPass = "true".<a href="../D/15687.html" title="Multiple defined in 6 places.">equalsIgnoreCase</a>((<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>)<a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>("clearPass"));
<a id="L469" name="L469"></a> 469 
<a id="L470" name="L470"></a> 470         <a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a> = "true".<a href="../D/15687.html" title="Multiple defined in 6 places.">equalsIgnoreCase</a>((<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>)<a href="../S/7709.html#L57" title="Defined at 57 in src/com/sun/javadoc/RootDoc.java.">options</a>.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>("debug"));
<a id="L471" name="L471"></a> 471 
<a id="L472" name="L472"></a> 472         <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L473" name="L473"></a> 473             <strong class="reserved">if</strong> (authFirst) <em class="brace">{</em>
<a id="L474" name="L474"></a> 474                 <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L475" name="L475"></a> 475                     "authentication-first mode; " +
<a id="L476" name="L476"></a> 476                     (useSSL ? "SSL enabled" : "SSL disabled"));
<a id="L477" name="L477"></a> 477             <em class="brace">}</em> <strong class="reserved">else</strong> <strong class="reserved">if</strong> (authOnly) <em class="brace">{</em>
<a id="L478" name="L478"></a> 478                 <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L479" name="L479"></a> 479                     "authentication-only mode; " +
<a id="L480" name="L480"></a> 480                     (useSSL ? "SSL enabled" : "SSL disabled"));
<a id="L481" name="L481"></a> 481             <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L482" name="L482"></a> 482                 <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L483" name="L483"></a> 483                     "search-first mode; " +
<a id="L484" name="L484"></a> 484                     (useSSL ? "SSL enabled" : "SSL disabled"));
<a id="L485" name="L485"></a> 485             <em class="brace">}</em>
<a id="L486" name="L486"></a> 486         <em class="brace">}</em>
<a id="L487" name="L487"></a> 487     <em class="brace">}</em>
<a id="L488" name="L488"></a> 488 
<div class="comment">
      Begin user authentication.
      <p> Acquire the user's credentials and verify them against the
      specified LDAP directory.
      @return true always, since this <code>LoginModule</code>
               should not be ignored.
      @exception FailedLoginException if the authentication fails.
      @exception LoginException if this <code>LoginModule</code>
               is unable to perform the authentication.</p></div>
<a id="L501" name="L501"></a> 501     <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/22690.html" title="Multiple referred from 35 places.">login</a>() <strong class="reserved">throws</strong> <a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a> <em class="brace">{</em>
<a id="L502" name="L502"></a> 502 
<a id="L503" name="L503"></a> 503         <strong class="reserved">if</strong> (userProvider == <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L504" name="L504"></a> 504             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a>
<a id="L505" name="L505"></a> 505                 ("Unable to locate the LDAP directory service");
<a id="L506" name="L506"></a> 506         <em class="brace">}</em>
<a id="L507" name="L507"></a> 507 
<a id="L508" name="L508"></a> 508         <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L509" name="L509"></a> 509             <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] user provider: " +
<a id="L510" name="L510"></a> 510                 userProvider);
<a id="L511" name="L511"></a> 511         <em class="brace">}</em>
<a id="L512" name="L512"></a> 512 
<a id="L513" name="L513"></a> 513         <em class="comment">// attempt the authentication</em>
<a id="L514" name="L514"></a> 514         <strong class="reserved">if</strong> (tryFirstPass) <em class="brace">{</em>
<a id="L515" name="L515"></a> 515 
<a id="L516" name="L516"></a> 516             <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L517" name="L517"></a> 517                 <em class="comment">// attempt the authentication by getting the</em>
<a id="L518" name="L518"></a> 518                 <em class="comment">// username and password from shared state</em>
<a id="L519" name="L519"></a> 519                 <a href="../D/11623.html" title="Multiple defined in 4 places.">attemptAuthentication</a>(<strong class="reserved">true</strong>);
<a id="L520" name="L520"></a> 520 
<a id="L521" name="L521"></a> 521                 <em class="comment">// authentication succeeded</em>
<a id="L522" name="L522"></a> 522                 succeeded = <strong class="reserved">true</strong>;
<a id="L523" name="L523"></a> 523                 <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L524" name="L524"></a> 524                     <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L525" name="L525"></a> 525                                 "tryFirstPass succeeded");
<a id="L526" name="L526"></a> 526                 <em class="brace">}</em>
<a id="L527" name="L527"></a> 527                 <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L528" name="L528"></a> 528 
<a id="L529" name="L529"></a> 529             <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a> le) <em class="brace">{</em>
<a id="L530" name="L530"></a> 530                 <em class="comment">// authentication failed -- try again below by prompting</em>
<a id="L531" name="L531"></a> 531                 <a href="../D/12805.html" title="Multiple defined in 4 places.">cleanState</a>();
<a id="L532" name="L532"></a> 532                 <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L533" name="L533"></a> 533                     <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L534" name="L534"></a> 534                                 "tryFirstPass failed: " + le.<a href="../D/35493.html" title="Multiple defined in 1021 places.">toString</a>());
<a id="L535" name="L535"></a> 535                 <em class="brace">}</em>
<a id="L536" name="L536"></a> 536             <em class="brace">}</em>
<a id="L537" name="L537"></a> 537 
<a id="L538" name="L538"></a> 538         <em class="brace">}</em> <strong class="reserved">else</strong> <strong class="reserved">if</strong> (useFirstPass) <em class="brace">{</em>
<a id="L539" name="L539"></a> 539 
<a id="L540" name="L540"></a> 540             <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L541" name="L541"></a> 541                 <em class="comment">// attempt the authentication by getting the</em>
<a id="L542" name="L542"></a> 542                 <em class="comment">// username and password from shared state</em>
<a id="L543" name="L543"></a> 543                 <a href="../D/11623.html" title="Multiple defined in 4 places.">attemptAuthentication</a>(<strong class="reserved">true</strong>);
<a id="L544" name="L544"></a> 544 
<a id="L545" name="L545"></a> 545                 <em class="comment">// authentication succeeded</em>
<a id="L546" name="L546"></a> 546                 succeeded = <strong class="reserved">true</strong>;
<a id="L547" name="L547"></a> 547                 <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L548" name="L548"></a> 548                     <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L549" name="L549"></a> 549                                 "useFirstPass succeeded");
<a id="L550" name="L550"></a> 550                 <em class="brace">}</em>
<a id="L551" name="L551"></a> 551                 <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L552" name="L552"></a> 552 
<a id="L553" name="L553"></a> 553             <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a> le) <em class="brace">{</em>
<a id="L554" name="L554"></a> 554                 <em class="comment">// authentication failed</em>
<a id="L555" name="L555"></a> 555                 <a href="../D/12805.html" title="Multiple defined in 4 places.">cleanState</a>();
<a id="L556" name="L556"></a> 556                 <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L557" name="L557"></a> 557                     <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L558" name="L558"></a> 558                                 "useFirstPass failed");
<a id="L559" name="L559"></a> 559                 <em class="brace">}</em>
<a id="L560" name="L560"></a> 560                 <strong class="reserved">throw</strong> le;
<a id="L561" name="L561"></a> 561             <em class="brace">}</em>
<a id="L562" name="L562"></a> 562         <em class="brace">}</em>
<a id="L563" name="L563"></a> 563 
<a id="L564" name="L564"></a> 564         <em class="comment">// attempt the authentication by prompting for the username and pwd</em>
<a id="L565" name="L565"></a> 565         <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L566" name="L566"></a> 566             <a href="../D/11623.html" title="Multiple defined in 4 places.">attemptAuthentication</a>(<strong class="reserved">false</strong>);
<a id="L567" name="L567"></a> 567 
<a id="L568" name="L568"></a> 568             <em class="comment">// authentication succeeded</em>
<a id="L569" name="L569"></a> 569            succeeded = <strong class="reserved">true</strong>;
<a id="L570" name="L570"></a> 570             <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L571" name="L571"></a> 571                 <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L572" name="L572"></a> 572                                 "authentication succeeded");
<a id="L573" name="L573"></a> 573             <em class="brace">}</em>
<a id="L574" name="L574"></a> 574             <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L575" name="L575"></a> 575 
<a id="L576" name="L576"></a> 576         <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a> le) <em class="brace">{</em>
<a id="L577" name="L577"></a> 577             <a href="../D/12805.html" title="Multiple defined in 4 places.">cleanState</a>();
<a id="L578" name="L578"></a> 578             <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L579" name="L579"></a> 579                 <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L580" name="L580"></a> 580                                 "authentication failed");
<a id="L581" name="L581"></a> 581             <em class="brace">}</em>
<a id="L582" name="L582"></a> 582             <strong class="reserved">throw</strong> le;
<a id="L583" name="L583"></a> 583         <em class="brace">}</em>
<a id="L584" name="L584"></a> 584     <em class="brace">}</em>
<a id="L585" name="L585"></a> 585 
<div class="comment">
      Complete user authentication.
      <p> This method is called if the LoginContext's
      overall authentication succeeded
      (the relevant REQUIRED, REQUISITE, SUFFICIENT and OPTIONAL LoginModules
      succeeded).
      </p><p> If this LoginModule's own authentication attempt
      succeeded (checked by retrieving the private state saved by the
      <code>login</code> method), then this method associates an
      <code>LdapPrincipal</code> and one or more <code>UserPrincipal</code>s
      with the <code>Subject</code> located in the
      <code>LoginModule</code>.  If this LoginModule's own
      authentication attempted failed, then this method removes
      any state that was originally saved.
      @exception LoginException if the commit fails
      @return true if this LoginModule's own login and commit
               attempts succeeded, or false otherwise.</p></div>
<a id="L607" name="L607"></a> 607     <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/11674.html" title="Multiple referred from 3 places.">commit</a>() <strong class="reserved">throws</strong> <a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a> <em class="brace">{</em>
<a id="L608" name="L608"></a> 608 
<a id="L609" name="L609"></a> 609         <strong class="reserved">if</strong> (succeeded == <strong class="reserved">false</strong>) <em class="brace">{</em>
<a id="L610" name="L610"></a> 610             <strong class="reserved">return</strong> <strong class="reserved">false</strong>;
<a id="L611" name="L611"></a> 611         <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L612" name="L612"></a> 612             <strong class="reserved">if</strong> (subject.<a href="../D/26131.html" title="Multiple defined in 90 places.">isReadOnly</a>()) <em class="brace">{</em>
<a id="L613" name="L613"></a> 613                 <a href="../D/12805.html" title="Multiple defined in 4 places.">cleanState</a>();
<a id="L614" name="L614"></a> 614                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a> ("Subject is read-only");
<a id="L615" name="L615"></a> 615             <em class="brace">}</em>
<a id="L616" name="L616"></a> 616             <em class="comment">// add Principals to the Subject</em>
<a id="L617" name="L617"></a> 617             <a href="../S/1160.html#L85" title="Defined at 85 in src/java/util/Set.java.">Set</a>&lt;<a href="../D/6815.html" title="Multiple defined in 2 places.">Principal</a>&gt; principals = subject.<a href="../D/21663.html" title="Multiple defined in 4 places.">getPrincipals</a>();
<a id="L618" name="L618"></a> 618             <strong class="reserved">if</strong> (! principals.<a href="../D/13313.html" title="Multiple defined in 245 places.">contains</a>(ldapPrincipal)) <em class="brace">{</em>
<a id="L619" name="L619"></a> 619                 principals.<a href="../D/10632.html" title="Multiple defined in 301 places.">add</a>(ldapPrincipal);
<a id="L620" name="L620"></a> 620             <em class="brace">}</em>
<a id="L621" name="L621"></a> 621             <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L622" name="L622"></a> 622                 <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L623" name="L623"></a> 623                                    "added LdapPrincipal \"" +
<a id="L624" name="L624"></a> 624                                    ldapPrincipal +
<a id="L625" name="L625"></a> 625                                    "\" to Subject");
<a id="L626" name="L626"></a> 626             <em class="brace">}</em>
<a id="L627" name="L627"></a> 627 
<a id="L628" name="L628"></a> 628             <strong class="reserved">if</strong> (! principals.<a href="../D/13313.html" title="Multiple defined in 245 places.">contains</a>(userPrincipal)) <em class="brace">{</em>
<a id="L629" name="L629"></a> 629                 principals.<a href="../D/10632.html" title="Multiple defined in 301 places.">add</a>(userPrincipal);
<a id="L630" name="L630"></a> 630             <em class="brace">}</em>
<a id="L631" name="L631"></a> 631             <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L632" name="L632"></a> 632                 <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L633" name="L633"></a> 633                                    "added UserPrincipal \"" +
<a id="L634" name="L634"></a> 634                                    userPrincipal +
<a id="L635" name="L635"></a> 635                                    "\" to Subject");
<a id="L636" name="L636"></a> 636             <em class="brace">}</em>
<a id="L637" name="L637"></a> 637 
<a id="L638" name="L638"></a> 638             <strong class="reserved">if</strong> (authzPrincipal != <strong class="reserved">null</strong> &amp;&amp;
<a id="L639" name="L639"></a> 639                 (! principals.<a href="../D/13313.html" title="Multiple defined in 245 places.">contains</a>(authzPrincipal))) <em class="brace">{</em>
<a id="L640" name="L640"></a> 640                 principals.<a href="../D/10632.html" title="Multiple defined in 301 places.">add</a>(authzPrincipal);
<a id="L641" name="L641"></a> 641 
<a id="L642" name="L642"></a> 642                 <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L643" name="L643"></a> 643                     <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L644" name="L644"></a> 644                                    "added UserPrincipal \"" +
<a id="L645" name="L645"></a> 645                                    authzPrincipal +
<a id="L646" name="L646"></a> 646                                    "\" to Subject");
<a id="L647" name="L647"></a> 647                 <em class="brace">}</em>
<a id="L648" name="L648"></a> 648             <em class="brace">}</em>
<a id="L649" name="L649"></a> 649         <em class="brace">}</em>
<a id="L650" name="L650"></a> 650         <em class="comment">// in any case, clean out state</em>
<a id="L651" name="L651"></a> 651         <a href="../D/12805.html" title="Multiple defined in 4 places.">cleanState</a>();
<a id="L652" name="L652"></a> 652         commitSucceeded = <strong class="reserved">true</strong>;
<a id="L653" name="L653"></a> 653         <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L654" name="L654"></a> 654     <em class="brace">}</em>
<a id="L655" name="L655"></a> 655 
<div class="comment">
      Abort user authentication.
      <p> This method is called if the overall authentication failed.
      (the relevant REQUIRED, REQUISITE, SUFFICIENT and OPTIONAL LoginModules
      did not succeed).
      </p><p> If this LoginModule's own authentication attempt
      succeeded (checked by retrieving the private state saved by the
      <code>login</code> and <code>commit</code> methods),
      then this method cleans up any state that was originally saved.
      @exception LoginException if the abort fails.
      @return false if this LoginModule's own login and/or commit attempts
               failed, and true otherwise.</p></div>
<a id="L672" name="L672"></a> 672     <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/9495.html" title="Multiple referred from 10 places.">abort</a>() <strong class="reserved">throws</strong> <a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a> <em class="brace">{</em>
<a id="L673" name="L673"></a> 673         <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>)
<a id="L674" name="L674"></a> 674             <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L675" name="L675"></a> 675                 "aborted authentication");
<a id="L676" name="L676"></a> 676 
<a id="L677" name="L677"></a> 677         <strong class="reserved">if</strong> (succeeded == <strong class="reserved">false</strong>) <em class="brace">{</em>
<a id="L678" name="L678"></a> 678             <strong class="reserved">return</strong> <strong class="reserved">false</strong>;
<a id="L679" name="L679"></a> 679         <em class="brace">}</em> <strong class="reserved">else</strong> <strong class="reserved">if</strong> (succeeded == <strong class="reserved">true</strong> &amp;&amp; commitSucceeded == <strong class="reserved">false</strong>) <em class="brace">{</em>
<a id="L680" name="L680"></a> 680 
<a id="L681" name="L681"></a> 681             <em class="comment">// Clean out state</em>
<a id="L682" name="L682"></a> 682             succeeded = <strong class="reserved">false</strong>;
<a id="L683" name="L683"></a> 683             <a href="../D/12805.html" title="Multiple defined in 4 places.">cleanState</a>();
<a id="L684" name="L684"></a> 684 
<a id="L685" name="L685"></a> 685             ldapPrincipal = <strong class="reserved">null</strong>;
<a id="L686" name="L686"></a> 686             userPrincipal = <strong class="reserved">null</strong>;
<a id="L687" name="L687"></a> 687             authzPrincipal = <strong class="reserved">null</strong>;
<a id="L688" name="L688"></a> 688         <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L689" name="L689"></a> 689             <em class="comment">// overall authentication succeeded and commit succeeded,</em>
<a id="L690" name="L690"></a> 690             <em class="comment">// but someone else's commit failed</em>
<a id="L691" name="L691"></a> 691             <a href="../D/27060.html" title="Multiple defined in 11 places.">logout</a>();
<a id="L692" name="L692"></a> 692         <em class="brace">}</em>
<a id="L693" name="L693"></a> 693         <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L694" name="L694"></a> 694     <em class="brace">}</em>
<a id="L695" name="L695"></a> 695 
<div class="comment">
      Logout a user.
      <p> This method removes the Principals
      that were added by the <code>commit</code> method.
      @exception LoginException if the logout fails.
      @return true in all cases since this <code>LoginModule</code>
               should not be ignored.</p></div>
<a id="L706" name="L706"></a> 706     <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/22691.html" title="Multiple referred from 8 places.">logout</a>() <strong class="reserved">throws</strong> <a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a> <em class="brace">{</em>
<a id="L707" name="L707"></a> 707         <strong class="reserved">if</strong> (subject.<a href="../D/26131.html" title="Multiple defined in 90 places.">isReadOnly</a>()) <em class="brace">{</em>
<a id="L708" name="L708"></a> 708             <a href="../D/12805.html" title="Multiple defined in 4 places.">cleanState</a>();
<a id="L709" name="L709"></a> 709             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a> ("Subject is read-only");
<a id="L710" name="L710"></a> 710         <em class="brace">}</em>
<a id="L711" name="L711"></a> 711         <a href="../S/1160.html#L85" title="Defined at 85 in src/java/util/Set.java.">Set</a>&lt;<a href="../D/6815.html" title="Multiple defined in 2 places.">Principal</a>&gt; principals = subject.<a href="../D/21663.html" title="Multiple defined in 4 places.">getPrincipals</a>();
<a id="L712" name="L712"></a> 712         principals.<a href="../D/30677.html" title="Multiple defined in 356 places.">remove</a>(ldapPrincipal);
<a id="L713" name="L713"></a> 713         principals.<a href="../D/30677.html" title="Multiple defined in 356 places.">remove</a>(userPrincipal);
<a id="L714" name="L714"></a> 714         <strong class="reserved">if</strong> (authzIdentity != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L715" name="L715"></a> 715             principals.<a href="../D/30677.html" title="Multiple defined in 356 places.">remove</a>(authzPrincipal);
<a id="L716" name="L716"></a> 716         <em class="brace">}</em>
<a id="L717" name="L717"></a> 717 
<a id="L718" name="L718"></a> 718         <em class="comment">// clean out state</em>
<a id="L719" name="L719"></a> 719         <a href="../D/12805.html" title="Multiple defined in 4 places.">cleanState</a>();
<a id="L720" name="L720"></a> 720         succeeded = <strong class="reserved">false</strong>;
<a id="L721" name="L721"></a> 721         commitSucceeded = <strong class="reserved">false</strong>;
<a id="L722" name="L722"></a> 722 
<a id="L723" name="L723"></a> 723         ldapPrincipal = <strong class="reserved">null</strong>;
<a id="L724" name="L724"></a> 724         userPrincipal = <strong class="reserved">null</strong>;
<a id="L725" name="L725"></a> 725         authzPrincipal = <strong class="reserved">null</strong>;
<a id="L726" name="L726"></a> 726 
<a id="L727" name="L727"></a> 727         <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L728" name="L728"></a> 728             <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] logged out Subject");
<a id="L729" name="L729"></a> 729         <em class="brace">}</em>
<a id="L730" name="L730"></a> 730         <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L731" name="L731"></a> 731     <em class="brace">}</em>
<a id="L732" name="L732"></a> 732 
<div class="comment">
      Attempt authentication
      @param getPasswdFromSharedState boolean that tells this method whether
               to retrieve the password from the sharedState.
      @exception LoginException if the authentication attempt fails.</div>
<a id="L740" name="L740"></a> 740     <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../R/10399.html" title="Multiple referred from 12 places.">attemptAuthentication</a>(<strong class="reserved">boolean</strong> getPasswdFromSharedState)
<a id="L741" name="L741"></a> 741         <strong class="reserved">throws</strong> <a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a> <em class="brace">{</em>
<a id="L742" name="L742"></a> 742 
<a id="L743" name="L743"></a> 743         <em class="comment">// first get the username and password</em>
<a id="L744" name="L744"></a> 744         <a href="../D/23505.html" title="Multiple defined in 3 places.">getUsernamePassword</a>(getPasswdFromSharedState);
<a id="L745" name="L745"></a> 745 
<a id="L746" name="L746"></a> 746         <strong class="reserved">if</strong> (password == <strong class="reserved">null</strong> || password.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a> == 0) <em class="brace">{</em>
<a id="L747" name="L747"></a> 747             <strong class="reserved">throw</strong> (<a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a>)
<a id="L748" name="L748"></a> 748                 <strong class="reserved">new</strong> <a href="../S/2668.html#L36" title="Defined at 36 in src/javax/security/auth/login/FailedLoginException.java.">FailedLoginException</a>("No password was supplied");
<a id="L749" name="L749"></a> 749         <em class="brace">}</em>
<a id="L750" name="L750"></a> 750 
<a id="L751" name="L751"></a> 751         <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> dn = "";
<a id="L752" name="L752"></a> 752 
<a id="L753" name="L753"></a> 753         <strong class="reserved">if</strong> (authFirst || authOnly) <em class="brace">{</em>
<a id="L754" name="L754"></a> 754 
<a id="L755" name="L755"></a> 755             <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> <a href="../D/24291.html" title="Multiple defined in 202 places.">id</a> = <a href="../S/4504.html#L940" title="Defined at 940 in src/com/sun/security/auth/module/LdapLoginModule.java.">replaceUsernameToken</a>(identityMatcher, authcIdentity);
<a id="L756" name="L756"></a> 756 
<a id="L757" name="L757"></a> 757             <em class="comment">// Prepare to bind using user's username and password</em>
<a id="L758" name="L758"></a> 758             ldapEnvironment.<a href="../D/29971.html" title="Multiple defined in 370 places.">put</a>(<a href="../D/1859.html" title="Multiple defined in 4 places.">Context</a>.SECURITY_CREDENTIALS, password);
<a id="L759" name="L759"></a> 759             ldapEnvironment.<a href="../D/29971.html" title="Multiple defined in 370 places.">put</a>(<a href="../D/1859.html" title="Multiple defined in 4 places.">Context</a>.SECURITY_PRINCIPAL, <a href="../D/24291.html" title="Multiple defined in 202 places.">id</a>);
<a id="L760" name="L760"></a> 760 
<a id="L761" name="L761"></a> 761             <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L762" name="L762"></a> 762                 <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L763" name="L763"></a> 763                     "attempting to authenticate user: " + username);
<a id="L764" name="L764"></a> 764             <em class="brace">}</em>
<a id="L765" name="L765"></a> 765 
<a id="L766" name="L766"></a> 766             <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L767" name="L767"></a> 767                 <em class="comment">// Connect to the LDAP server (using simple bind)</em>
<a id="L768" name="L768"></a> 768                 <a href="../D/14411.html" title="Multiple defined in 6 places.">ctx</a> = <strong class="reserved">new</strong> <a href="../S/4262.html#L90" title="Defined at 90 in src/javax/naming/ldap/InitialLdapContext.java.">InitialLdapContext</a>(ldapEnvironment, <strong class="reserved">null</strong>);
<a id="L769" name="L769"></a> 769 
<a id="L770" name="L770"></a> 770             <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/4338.html#L60" title="Defined at 60 in src/javax/naming/NamingException.java.">NamingException</a> e) <em class="brace">{</em>
<a id="L771" name="L771"></a> 771                 <strong class="reserved">throw</strong> (<a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a>)
<a id="L772" name="L772"></a> 772                     <strong class="reserved">new</strong> <a href="../S/2668.html#L36" title="Defined at 36 in src/javax/security/auth/login/FailedLoginException.java.">FailedLoginException</a>("Cannot bind to LDAP server")
<a id="L773" name="L773"></a> 773                         .<a href="../D/24507.html" title="Multiple defined in 7 places.">initCause</a>(e);
<a id="L774" name="L774"></a> 774             <em class="brace">}</em>
<a id="L775" name="L775"></a> 775 
<a id="L776" name="L776"></a> 776             <em class="comment">// Authentication has succeeded</em>
<a id="L777" name="L777"></a> 777 
<a id="L778" name="L778"></a> 778             <em class="comment">// Locate the user's distinguished name</em>
<a id="L779" name="L779"></a> 779             <strong class="reserved">if</strong> (userFilter != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L780" name="L780"></a> 780                 dn = <a href="../S/4504.html#L862" title="Defined at 862 in src/com/sun/security/auth/module/LdapLoginModule.java.">findUserDN</a>(<a href="../D/14411.html" title="Multiple defined in 6 places.">ctx</a>);
<a id="L781" name="L781"></a> 781             <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L782" name="L782"></a> 782                 dn = <a href="../D/24291.html" title="Multiple defined in 202 places.">id</a>;
<a id="L783" name="L783"></a> 783             <em class="brace">}</em>
<a id="L784" name="L784"></a> 784 
<a id="L785" name="L785"></a> 785         <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L786" name="L786"></a> 786 
<a id="L787" name="L787"></a> 787             <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L788" name="L788"></a> 788                 <em class="comment">// Connect to the LDAP server (using anonymous bind)</em>
<a id="L789" name="L789"></a> 789                 <a href="../D/14411.html" title="Multiple defined in 6 places.">ctx</a> = <strong class="reserved">new</strong> <a href="../S/4262.html#L90" title="Defined at 90 in src/javax/naming/ldap/InitialLdapContext.java.">InitialLdapContext</a>(ldapEnvironment, <strong class="reserved">null</strong>);
<a id="L790" name="L790"></a> 790 
<a id="L791" name="L791"></a> 791             <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/4338.html#L60" title="Defined at 60 in src/javax/naming/NamingException.java.">NamingException</a> e) <em class="brace">{</em>
<a id="L792" name="L792"></a> 792                 <strong class="reserved">throw</strong> (<a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a>)
<a id="L793" name="L793"></a> 793                     <strong class="reserved">new</strong> <a href="../S/2668.html#L36" title="Defined at 36 in src/javax/security/auth/login/FailedLoginException.java.">FailedLoginException</a>("Cannot connect to LDAP server")
<a id="L794" name="L794"></a> 794                         .<a href="../D/24507.html" title="Multiple defined in 7 places.">initCause</a>(e);
<a id="L795" name="L795"></a> 795             <em class="brace">}</em>
<a id="L796" name="L796"></a> 796 
<a id="L797" name="L797"></a> 797             <em class="comment">// Locate the user's distinguished name</em>
<a id="L798" name="L798"></a> 798             dn = <a href="../S/4504.html#L862" title="Defined at 862 in src/com/sun/security/auth/module/LdapLoginModule.java.">findUserDN</a>(<a href="../D/14411.html" title="Multiple defined in 6 places.">ctx</a>);
<a id="L799" name="L799"></a> 799 
<a id="L800" name="L800"></a> 800             <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L801" name="L801"></a> 801 
<a id="L802" name="L802"></a> 802                 <em class="comment">// Prepare to bind using user's distinguished name and password</em>
<a id="L803" name="L803"></a> 803                 <a href="../D/14411.html" title="Multiple defined in 6 places.">ctx</a>.<a href="../D/11122.html" title="Multiple defined in 3 places.">addToEnvironment</a>(<a href="../D/1859.html" title="Multiple defined in 4 places.">Context</a>.SECURITY_AUTHENTICATION, "simple");
<a id="L804" name="L804"></a> 804                 <a href="../D/14411.html" title="Multiple defined in 6 places.">ctx</a>.<a href="../D/11122.html" title="Multiple defined in 3 places.">addToEnvironment</a>(<a href="../D/1859.html" title="Multiple defined in 4 places.">Context</a>.SECURITY_PRINCIPAL, dn);
<a id="L805" name="L805"></a> 805                 <a href="../D/14411.html" title="Multiple defined in 6 places.">ctx</a>.<a href="../D/11122.html" title="Multiple defined in 3 places.">addToEnvironment</a>(<a href="../D/1859.html" title="Multiple defined in 4 places.">Context</a>.SECURITY_CREDENTIALS, password);
<a id="L806" name="L806"></a> 806 
<a id="L807" name="L807"></a> 807                 <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L808" name="L808"></a> 808                     <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L809" name="L809"></a> 809                         "attempting to authenticate user: " + username);
<a id="L810" name="L810"></a> 810                 <em class="brace">}</em>
<a id="L811" name="L811"></a> 811                 <em class="comment">// Connect to the LDAP server (using simple bind)</em>
<a id="L812" name="L812"></a> 812                 <a href="../D/14411.html" title="Multiple defined in 6 places.">ctx</a>.<a href="../D/30392.html" title="Multiple defined in 2 places.">reconnect</a>(<strong class="reserved">null</strong>);
<a id="L813" name="L813"></a> 813 
<a id="L814" name="L814"></a> 814                 <em class="comment">// Authentication has succeeded</em>
<a id="L815" name="L815"></a> 815 
<a id="L816" name="L816"></a> 816             <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/4338.html#L60" title="Defined at 60 in src/javax/naming/NamingException.java.">NamingException</a> e) <em class="brace">{</em>
<a id="L817" name="L817"></a> 817                 <strong class="reserved">throw</strong> (<a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a>)
<a id="L818" name="L818"></a> 818                     <strong class="reserved">new</strong> <a href="../S/2668.html#L36" title="Defined at 36 in src/javax/security/auth/login/FailedLoginException.java.">FailedLoginException</a>("Cannot bind to LDAP server")
<a id="L819" name="L819"></a> 819                         .<a href="../D/24507.html" title="Multiple defined in 7 places.">initCause</a>(e);
<a id="L820" name="L820"></a> 820             <em class="brace">}</em>
<a id="L821" name="L821"></a> 821         <em class="brace">}</em>
<a id="L822" name="L822"></a> 822 
<a id="L823" name="L823"></a> 823         <em class="comment">// Save input as shared state only if authentication succeeded</em>
<a id="L824" name="L824"></a> 824         <strong class="reserved">if</strong> (storePass &amp;&amp;
<a id="L825" name="L825"></a> 825             !sharedState.<a href="../D/13333.html" title="Multiple defined in 42 places.">containsKey</a>(USERNAME_KEY) &amp;&amp;
<a id="L826" name="L826"></a> 826             !sharedState.<a href="../D/13333.html" title="Multiple defined in 42 places.">containsKey</a>(PASSWORD_KEY)) <em class="brace">{</em>
<a id="L827" name="L827"></a> 827             sharedState.<a href="../D/29971.html" title="Multiple defined in 370 places.">put</a>(USERNAME_KEY, username);
<a id="L828" name="L828"></a> 828             sharedState.<a href="../D/29971.html" title="Multiple defined in 370 places.">put</a>(PASSWORD_KEY, password);
<a id="L829" name="L829"></a> 829         <em class="brace">}</em>
<a id="L830" name="L830"></a> 830 
<a id="L831" name="L831"></a> 831         <em class="comment">// Create the user principals</em>
<a id="L832" name="L832"></a> 832         userPrincipal = <strong class="reserved">new</strong> <a href="../D/9436.html" title="Multiple defined in 2 places.">UserPrincipal</a>(username);
<a id="L833" name="L833"></a> 833         <strong class="reserved">if</strong> (authzIdentity != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L834" name="L834"></a> 834             authzPrincipal = <strong class="reserved">new</strong> <a href="../D/9436.html" title="Multiple defined in 2 places.">UserPrincipal</a>(authzIdentity);
<a id="L835" name="L835"></a> 835         <em class="brace">}</em>
<a id="L836" name="L836"></a> 836 
<a id="L837" name="L837"></a> 837         <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L838" name="L838"></a> 838 
<a id="L839" name="L839"></a> 839             ldapPrincipal = <strong class="reserved">new</strong> <a href="../S/4492.html#L49" title="Defined at 49 in src/com/sun/security/auth/LdapPrincipal.java.">LdapPrincipal</a>(dn);
<a id="L840" name="L840"></a> 840 
<a id="L841" name="L841"></a> 841         <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/4332.html#L48" title="Defined at 48 in src/javax/naming/InvalidNameException.java.">InvalidNameException</a> e) <em class="brace">{</em>
<a id="L842" name="L842"></a> 842             <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L843" name="L843"></a> 843                 <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L844" name="L844"></a> 844                                    "cannot create LdapPrincipal: bad DN");
<a id="L845" name="L845"></a> 845             <em class="brace">}</em>
<a id="L846" name="L846"></a> 846             <strong class="reserved">throw</strong> (<a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a>)
<a id="L847" name="L847"></a> 847                 <strong class="reserved">new</strong> <a href="../S/2668.html#L36" title="Defined at 36 in src/javax/security/auth/login/FailedLoginException.java.">FailedLoginException</a>("Cannot create LdapPrincipal")
<a id="L848" name="L848"></a> 848                     .<a href="../D/24507.html" title="Multiple defined in 7 places.">initCause</a>(e);
<a id="L849" name="L849"></a> 849         <em class="brace">}</em>
<a id="L850" name="L850"></a> 850     <em class="brace">}</em>
<a id="L851" name="L851"></a> 851 
<div class="comment">
      Search for the user's entry.
      Determine the distinguished name of the user's entry and optionally
      an authorization identity for the user.
      @param ctx an LDAP context to use for the search
      @return the user's distinguished name or an empty string if none
              was found.
      @exception LoginException if the user's entry cannot be found.</div>
<a id="L862" name="L862"></a> 862     <strong class="reserved">private</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> <a href="../R/14497.html" title="Multiple referred from 2 places.">findUserDN</a>(<a href="../S/4271.html#L175" title="Defined at 175 in src/javax/naming/ldap/LdapContext.java.">LdapContext</a> <a href="../D/14411.html" title="Multiple defined in 6 places.">ctx</a>) <strong class="reserved">throws</strong> <a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a> <em class="brace">{</em>
<a id="L863" name="L863"></a> 863 
<a id="L864" name="L864"></a> 864         <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> userDN = "";
<a id="L865" name="L865"></a> 865 
<a id="L866" name="L866"></a> 866         <em class="comment">// Locate the user's LDAP entry</em>
<a id="L867" name="L867"></a> 867         <strong class="reserved">if</strong> (userFilter != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L868" name="L868"></a> 868             <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L869" name="L869"></a> 869                 <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L870" name="L870"></a> 870                     "searching for entry belonging to user: " + username);
<a id="L871" name="L871"></a> 871             <em class="brace">}</em>
<a id="L872" name="L872"></a> 872         <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L873" name="L873"></a> 873             <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L874" name="L874"></a> 874                 <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] " +
<a id="L875" name="L875"></a> 875                     "cannot search for entry belonging to user: " + username);
<a id="L876" name="L876"></a> 876             <em class="brace">}</em>
<a id="L877" name="L877"></a> 877             <strong class="reserved">throw</strong> (<a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a>)
<a id="L878" name="L878"></a> 878                 <strong class="reserved">new</strong> <a href="../S/2668.html#L36" title="Defined at 36 in src/javax/security/auth/login/FailedLoginException.java.">FailedLoginException</a>("Cannot find user's LDAP entry");
<a id="L879" name="L879"></a> 879         <em class="brace">}</em>
<a id="L880" name="L880"></a> 880 
<a id="L881" name="L881"></a> 881         <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L882" name="L882"></a> 882             <a href="../S/4244.html#L81" title="Defined at 81 in src/javax/naming/NamingEnumeration.java.">NamingEnumeration</a>&lt;<a href="../S/4293.html#L45" title="Defined at 45 in src/javax/naming/directory/SearchResult.java.">SearchResult</a>&gt; results = <a href="../D/14411.html" title="Multiple defined in 6 places.">ctx</a>.<a href="../D/31650.html" title="Multiple defined in 35 places.">search</a>("",
<a id="L883" name="L883"></a> 883                 <a href="../S/4504.html#L940" title="Defined at 940 in src/com/sun/security/auth/module/LdapLoginModule.java.">replaceUsernameToken</a>(filterMatcher, userFilter), constraints);
<a id="L884" name="L884"></a> 884 
<a id="L885" name="L885"></a> 885             <em class="comment">// Extract the distinguished name of the user's entry</em>
<a id="L886" name="L886"></a> 886             <em class="comment">// (Use the first entry if more than one is returned)</em>
<a id="L887" name="L887"></a> 887             <strong class="reserved">if</strong> (results.<a href="../D/24127.html" title="Multiple defined in 9 places.">hasMore</a>()) <em class="brace">{</em>
<a id="L888" name="L888"></a> 888                 <a href="../S/4293.html#L45" title="Defined at 45 in src/javax/naming/directory/SearchResult.java.">SearchResult</a> entry = results.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>();
<a id="L889" name="L889"></a> 889 
<a id="L890" name="L890"></a> 890                 <em class="comment">// %%% - use the SearchResult.getNameInNamespace method</em>
<a id="L891" name="L891"></a> 891                 <em class="comment">//        available in JDK 1.5 and later.</em>
<a id="L892" name="L892"></a> 892                 <em class="comment">//        (can remove call to constraints.setReturningObjFlag)</em>
<a id="L893" name="L893"></a> 893                 userDN = ((<a href="../D/1859.html" title="Multiple defined in 4 places.">Context</a>)entry.<a href="../D/21124.html" title="Multiple defined in 30 places.">getObject</a>()).<a href="../D/20790.html" title="Multiple defined in 4 places.">getNameInNamespace</a>();
<a id="L894" name="L894"></a> 894 
<a id="L895" name="L895"></a> 895                 <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L896" name="L896"></a> 896                     <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] found entry: " +
<a id="L897" name="L897"></a> 897                         userDN);
<a id="L898" name="L898"></a> 898                 <em class="brace">}</em>
<a id="L899" name="L899"></a> 899 
<a id="L900" name="L900"></a> 900                 <em class="comment">// Extract a value from user's authorization identity attribute</em>
<a id="L901" name="L901"></a> 901                 <strong class="reserved">if</strong> (authzIdentityAttr != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L902" name="L902"></a> 902                     <a href="../D/567.html" title="Multiple defined in 12 places.">Attribute</a> <a href="../D/11626.html" title="Multiple defined in 2 places.">attr</a> =
<a id="L903" name="L903"></a> 903                         entry.<a href="../D/17112.html" title="Multiple defined in 109 places.">getAttributes</a>().<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>(authzIdentityAttr);
<a id="L904" name="L904"></a> 904                     <strong class="reserved">if</strong> (<a href="../D/11626.html" title="Multiple defined in 2 places.">attr</a> != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L905" name="L905"></a> 905                         <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../S/1444.html#L56" title="Defined at 56 in src/java/io/ExpiringCache.java.">val</a> = <a href="../D/11626.html" title="Multiple defined in 2 places.">attr</a>.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>();
<a id="L906" name="L906"></a> 906                         <strong class="reserved">if</strong> (<a href="../S/1444.html#L56" title="Defined at 56 in src/java/io/ExpiringCache.java.">val</a> <strong class="reserved">instanceof</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>) <em class="brace">{</em>
<a id="L907" name="L907"></a> 907                             authzIdentity = (<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>) <a href="../S/1444.html#L56" title="Defined at 56 in src/java/io/ExpiringCache.java.">val</a>;
<a id="L908" name="L908"></a> 908                         <em class="brace">}</em>
<a id="L909" name="L909"></a> 909                     <em class="brace">}</em>
<a id="L910" name="L910"></a> 910                 <em class="brace">}</em>
<a id="L911" name="L911"></a> 911 
<a id="L912" name="L912"></a> 912                 results.<a href="../D/12922.html" title="Multiple defined in 218 places.">close</a>();
<a id="L913" name="L913"></a> 913 
<a id="L914" name="L914"></a> 914             <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L915" name="L915"></a> 915                 <em class="comment">// Bad username</em>
<a id="L916" name="L916"></a> 916                 <strong class="reserved">if</strong> (<a href="../D/14486.html" title="Multiple defined in 5 places.">debug</a>) <em class="brace">{</em>
<a id="L917" name="L917"></a> 917                     <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1038.html#L2317" title="Defined at 2317 in src/java/util/Formatter.java.">out</a>.<a href="../D/29725.html" title="Multiple defined in 27 places.">println</a>("\t\t[LdapLoginModule] user's entry " +
<a id="L918" name="L918"></a> 918                         "not found");
<a id="L919" name="L919"></a> 919                 <em class="brace">}</em>
<a id="L920" name="L920"></a> 920             <em class="brace">}</em>
<a id="L921" name="L921"></a> 921 
<a id="L922" name="L922"></a> 922         <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/4338.html#L60" title="Defined at 60 in src/javax/naming/NamingException.java.">NamingException</a> e) <em class="brace">{</em>
<a id="L923" name="L923"></a> 923             <em class="comment">// ignore</em>
<a id="L924" name="L924"></a> 924         <em class="brace">}</em>
<a id="L925" name="L925"></a> 925 
<a id="L926" name="L926"></a> 926         <strong class="reserved">if</strong> (userDN.<a href="../D/15685.html" title="Multiple defined in 654 places.">equals</a>("")) <em class="brace">{</em>
<a id="L927" name="L927"></a> 927             <strong class="reserved">throw</strong> (<a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a>)
<a id="L928" name="L928"></a> 928                 <strong class="reserved">new</strong> <a href="../S/2668.html#L36" title="Defined at 36 in src/javax/security/auth/login/FailedLoginException.java.">FailedLoginException</a>("Cannot find user's LDAP entry");
<a id="L929" name="L929"></a> 929         <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L930" name="L930"></a> 930             <strong class="reserved">return</strong> userDN;
<a id="L931" name="L931"></a> 931         <em class="brace">}</em>
<a id="L932" name="L932"></a> 932     <em class="brace">}</em>
<a id="L933" name="L933"></a> 933 
<div class="comment">
      Replace the username token
      @param string the target string
      @return the modified string</div>
<a id="L940" name="L940"></a> 940     <strong class="reserved">private</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> <a href="../R/26169.html" title="Multiple referred from 2 places.">replaceUsernameToken</a>(<a href="../D/5451.html" title="Multiple defined in 3 places.">Matcher</a> <a href="../S/986.html#L1086" title="Defined at 1086 in src/java/util/regex/Pattern.java.">matcher</a>, <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> <a href="../S/4997.html#L463" title="Defined at 463 in src/com/sun/org/apache/xpath/internal/compiler/Compiler.java.">string</a>) <em class="brace">{</em>
<a id="L941" name="L941"></a> 941         <strong class="reserved">return</strong> <a href="../S/986.html#L1086" title="Defined at 1086 in src/java/util/regex/Pattern.java.">matcher</a> != <strong class="reserved">null</strong> ? <a href="../S/986.html#L1086" title="Defined at 1086 in src/java/util/regex/Pattern.java.">matcher</a>.<a href="../D/31036.html" title="Multiple defined in 30 places.">replaceAll</a>(username) : <a href="../S/4997.html#L463" title="Defined at 463 in src/com/sun/org/apache/xpath/internal/compiler/Compiler.java.">string</a>;
<a id="L942" name="L942"></a> 942     <em class="brace">}</em>
<a id="L943" name="L943"></a> 943 
<div class="comment">
      Get the username and password.
      This method does not return any value.
      Instead, it sets global name and password variables.
      <p> Also note that this method will set the username and password
      values in the shared state in case subsequent LoginModules
      want to use them via use/tryFirstPass.
      @param getPasswdFromSharedState boolean that tells this method whether
               to retrieve the password from the sharedState.
      @exception LoginException if the username/password cannot be acquired.</p></div>
<a id="L957" name="L957"></a> 957     <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../R/19734.html" title="Multiple referred from 3 places.">getUsernamePassword</a>(<strong class="reserved">boolean</strong> getPasswdFromSharedState)
<a id="L958" name="L958"></a> 958         <strong class="reserved">throws</strong> <a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a> <em class="brace">{</em>
<a id="L959" name="L959"></a> 959 
<a id="L960" name="L960"></a> 960         <strong class="reserved">if</strong> (getPasswdFromSharedState) <em class="brace">{</em>
<a id="L961" name="L961"></a> 961             <em class="comment">// use the password saved by the first module in the stack</em>
<a id="L962" name="L962"></a> 962             username = (<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>)sharedState.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>(USERNAME_KEY);
<a id="L963" name="L963"></a> 963             password = (<strong class="reserved">char</strong>[])sharedState.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>(PASSWORD_KEY);
<a id="L964" name="L964"></a> 964             <strong class="reserved">return</strong>;
<a id="L965" name="L965"></a> 965         <em class="brace">}</em>
<a id="L966" name="L966"></a> 966 
<a id="L967" name="L967"></a> 967         <em class="comment">// prompt for a username and password</em>
<a id="L968" name="L968"></a> 968         <strong class="reserved">if</strong> (callbackHandler == <strong class="reserved">null</strong>)
<a id="L969" name="L969"></a> 969             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a>("No CallbackHandler available " +
<a id="L970" name="L970"></a> 970                 "to acquire authentication information from the user");
<a id="L971" name="L971"></a> 971 
<a id="L972" name="L972"></a> 972         <a href="../D/1261.html" title="Multiple defined in 2 places.">Callback</a>[] callbacks = <strong class="reserved">new</strong> <a href="../D/1261.html" title="Multiple defined in 2 places.">Callback</a>[2];
<a id="L973" name="L973"></a> 973         callbacks[0] = <strong class="reserved">new</strong> <a href="../S/2650.html#L35" title="Defined at 35 in src/javax/security/auth/callback/NameCallback.java.">NameCallback</a>(rb.<a href="../D/22769.html" title="Multiple defined in 35 places.">getString</a>("username."));
<a id="L974" name="L974"></a> 974         callbacks[1] = <strong class="reserved">new</strong> <a href="../S/2651.html#L35" title="Defined at 35 in src/javax/security/auth/callback/PasswordCallback.java.">PasswordCallback</a>(rb.<a href="../D/22769.html" title="Multiple defined in 35 places.">getString</a>("password."), <strong class="reserved">false</strong>);
<a id="L975" name="L975"></a> 975 
<a id="L976" name="L976"></a> 976         <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L977" name="L977"></a> 977             callbackHandler.<a href="../D/23942.html" title="Multiple defined in 13 places.">handle</a>(callbacks);
<a id="L978" name="L978"></a> 978             username = ((<a href="../S/2650.html#L35" title="Defined at 35 in src/javax/security/auth/callback/NameCallback.java.">NameCallback</a>)callbacks[0]).<a href="../D/20784.html" title="Multiple defined in 355 places.">getName</a>();
<a id="L979" name="L979"></a> 979             <strong class="reserved">char</strong>[] tmpPassword = ((<a href="../S/2651.html#L35" title="Defined at 35 in src/javax/security/auth/callback/PasswordCallback.java.">PasswordCallback</a>)callbacks[1]).<a href="../D/21429.html" title="Multiple defined in 6 places.">getPassword</a>();
<a id="L980" name="L980"></a> 980             password = <strong class="reserved">new</strong> <strong class="reserved">char</strong>[tmpPassword.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>];
<a id="L981" name="L981"></a> 981             <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1557.html#L493" title="Defined at 493 in src/java/lang/System.java.">arraycopy</a>(tmpPassword, 0,
<a id="L982" name="L982"></a> 982                                 password, 0, tmpPassword.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>);
<a id="L983" name="L983"></a> 983             ((<a href="../S/2651.html#L35" title="Defined at 35 in src/javax/security/auth/callback/PasswordCallback.java.">PasswordCallback</a>)callbacks[1]).<a href="../S/2651.html#L136" title="Defined at 136 in src/javax/security/auth/callback/PasswordCallback.java.">clearPassword</a>();
<a id="L984" name="L984"></a> 984 
<a id="L985" name="L985"></a> 985         <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/3625.html#L43" title="Defined at 43 in src/javax/management/remote/rmi/RMIConnectionImpl_Stub.java.">java</a>.io.<a href="../S/1392.html#L39" title="Defined at 39 in src/java/io/IOException.java.">IOException</a> ioe) <em class="brace">{</em>
<a id="L986" name="L986"></a> 986             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a>(ioe.<a href="../D/35493.html" title="Multiple defined in 1021 places.">toString</a>());
<a id="L987" name="L987"></a> 987 
<a id="L988" name="L988"></a> 988         <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/2652.html#L33" title="Defined at 33 in src/javax/security/auth/callback/UnsupportedCallbackException.java.">UnsupportedCallbackException</a> uce) <em class="brace">{</em>
<a id="L989" name="L989"></a> 989             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/2666.html#L34" title="Defined at 34 in src/javax/security/auth/login/LoginException.java.">LoginException</a>("Error: " + uce.<a href="../S/2652.html#L78" title="Defined at 78 in src/javax/security/auth/callback/UnsupportedCallbackException.java.">getCallback</a>().<a href="../D/35493.html" title="Multiple defined in 1021 places.">toString</a>() +
<a id="L990" name="L990"></a> 990                         " not available to acquire authentication information" +
<a id="L991" name="L991"></a> 991                         " from the user");
<a id="L992" name="L992"></a> 992         <em class="brace">}</em>
<a id="L993" name="L993"></a> 993     <em class="brace">}</em>
<a id="L994" name="L994"></a> 994 
<div class="comment">
      Clean out state because of a failed authentication attempt</div>
<a id="L998" name="L998"></a> 998     <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../R/11485.html" title="Multiple referred from 30 places.">cleanState</a>() <em class="brace">{</em>
<a id="L999" name="L999"></a> 999         username = <strong class="reserved">null</strong>;
<a id="L1000" name="L1000"></a>1000         <strong class="reserved">if</strong> (password != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L1001" name="L1001"></a>1001             <a href="../S/1150.html#L71" title="Defined at 71 in src/java/util/Arrays.java.">Arrays</a>.<a href="../D/16028.html" title="Multiple defined in 25 places.">fill</a>(password, ' ');
<a id="L1002" name="L1002"></a>1002             password = <strong class="reserved">null</strong>;
<a id="L1003" name="L1003"></a>1003         <em class="brace">}</em>
<a id="L1004" name="L1004"></a>1004         <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L1005" name="L1005"></a>1005             <strong class="reserved">if</strong> (<a href="../D/14411.html" title="Multiple defined in 6 places.">ctx</a> != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L1006" name="L1006"></a>1006                 <a href="../D/14411.html" title="Multiple defined in 6 places.">ctx</a>.<a href="../D/12922.html" title="Multiple defined in 218 places.">close</a>();
<a id="L1007" name="L1007"></a>1007             <em class="brace">}</em>
<a id="L1008" name="L1008"></a>1008         <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/4338.html#L60" title="Defined at 60 in src/javax/naming/NamingException.java.">NamingException</a> e) <em class="brace">{</em>
<a id="L1009" name="L1009"></a>1009             <em class="comment">// ignore</em>
<a id="L1010" name="L1010"></a>1010         <em class="brace">}</em>
<a id="L1011" name="L1011"></a>1011         <a href="../D/14411.html" title="Multiple defined in 6 places.">ctx</a> = <strong class="reserved">null</strong>;
<a id="L1012" name="L1012"></a>1012 
<a id="L1013" name="L1013"></a>1013         <strong class="reserved">if</strong> (clearPass) <em class="brace">{</em>
<a id="L1014" name="L1014"></a>1014             sharedState.<a href="../D/30677.html" title="Multiple defined in 356 places.">remove</a>(USERNAME_KEY);
<a id="L1015" name="L1015"></a>1015             sharedState.<a href="../D/30677.html" title="Multiple defined in 356 places.">remove</a>(PASSWORD_KEY);
<a id="L1016" name="L1016"></a>1016         <em class="brace">}</em>
<a id="L1017" name="L1017"></a>1017     <em class="brace">}</em>
<a id="L1018" name="L1018"></a>1018 <em class="brace">}</em>
</pre>
<hr>
<div class="comment">
/* [&lt;][&gt;]<a href="#L388">[^]</a><a href="#L998">[v]</a><a href="#TOP">[top]</a>[bottom]<a href="../mains.html">[index]</a><a href="../help.html">[help]</a> */</div>
</body></html>