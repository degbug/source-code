<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
<title>src/java/util/concurrent/SynchronousQueue.java</title>
<meta name="robots" content="noindex,nofollow">
<meta name="generator" content="GLOBAL-6.6.3">
<meta http-equiv="Content-Style-Type" content="text/css">
<link rel="stylesheet" type="text/css" href="../style.css">
</head>
<body>
<a id="TOP" name="TOP"></a><div class="comment">
/* [&lt;][&gt;]<a href="#L182">[^]</a><a href="#L1200">[v]</a>[top]<a href="#BOTTOM">[bottom]</a><a href="../mains.html">[index]</a><a href="../help.html">[help]</a> */</div>
<hr>
<h2 class="header">DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href="#L182" title="Defined at 182.">transfer</a></li>
<li><a href="#L229" title="Defined at 229.">isFulfilling</a></li>
<li><a href="#L246" title="Defined at 246.">casNext</a></li>
<li><a href="#L259" title="Defined at 259.">tryMatch</a></li>
<li><a href="#L275" title="Defined at 275.">tryCancel</a></li>
<li><a href="#L279" title="Defined at 279.">isCancelled</a></li>
<li><a href="#L305" title="Defined at 305.">casHead</a></li>
<li><a href="#L317" title="Defined at 317.">snode</a></li>
<li><a href="#L327" title="Defined at 327.">SuppressWarnings</a></li>
<li><a href="#L328" title="Defined at 328.">transfer</a></li>
<li><a href="#L413" title="Defined at 413.">awaitFulfill</a></li>
<li><a href="#L468" title="Defined at 468.">shouldSpin</a></li>
<li><a href="#L476" title="Defined at 476.">clean</a></li>
<li><a href="#L548" title="Defined at 548.">casNext</a></li>
<li><a href="#L553" title="Defined at 553.">casItem</a></li>
<li><a href="#L561" title="Defined at 561.">tryCancel</a></li>
<li><a href="#L565" title="Defined at 565.">isCancelled</a></li>
<li><a href="#L574" title="Defined at 574.">isOffList</a></li>
<li><a href="#L618" title="Defined at 618.">advanceHead</a></li>
<li><a href="#L627" title="Defined at 627.">advanceTail</a></li>
<li><a href="#L635" title="Defined at 635.">casCleanMe</a></li>
<li><a href="#L643" title="Defined at 643.">SuppressWarnings</a></li>
<li><a href="#L644" title="Defined at 644.">transfer</a></li>
<li><a href="#L738" title="Defined at 738.">awaitFulfill</a></li>
<li><a href="#L771" title="Defined at 771.">clean</a></li>
<li><a href="#L875" title="Defined at 875.">put</a></li>
<li><a href="#L892" title="Defined at 892.">offer</a></li>
<li><a href="#L911" title="Defined at 911.">offer</a></li>
<li><a href="#L923" title="Defined at 923.">take</a></li>
<li><a href="#L940" title="Defined at 940.">poll</a></li>
<li><a href="#L954" title="Defined at 954.">poll</a></li>
<li><a href="#L964" title="Defined at 964.">isEmpty</a></li>
<li><a href="#L974" title="Defined at 974.">size</a></li>
<li><a href="#L984" title="Defined at 984.">remainingCapacity</a></li>
<li><a href="#L992" title="Defined at 992.">clear</a></li>
<li><a href="#L1002" title="Defined at 1002.">contains</a></li>
<li><a href="#L1013" title="Defined at 1013.">remove</a></li>
<li><a href="#L1024" title="Defined at 1024.">containsAll</a></li>
<li><a href="#L1035" title="Defined at 1035.">removeAll</a></li>
<li><a href="#L1046" title="Defined at 1046.">retainAll</a></li>
<li><a href="#L1057" title="Defined at 1057.">peek</a></li>
<li><a href="#L1067" title="Defined at 1067.">iterator</a></li>
<li><a href="#L1078" title="Defined at 1078.">spliterator</a></li>
<li><a href="#L1086" title="Defined at 1086.">toArray</a></li>
<li><a href="#L1098" title="Defined at 1098.">toArray</a></li>
<li><a href="#L1110" title="Defined at 1110.">drainTo</a></li>
<li><a href="#L1129" title="Defined at 1129.">drainTo</a></li>
<li><a href="#L1150" title="Defined at 1150.">SuppressWarnings</a></li>
<li><a href="#L1167" title="Defined at 1167.">writeObject</a></li>
<li><a href="#L1190" title="Defined at 1190.">readObject</a></li>
<li><a href="#L1200" title="Defined at 1200.">objectFieldOffset</a></li>
</ol>
<hr>
<pre>
<div class="comment">
  ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.</div>
<a id="L24" name="L24"></a>  24 
<div class="comment">
  Written by Doug Lea, Bill Scherer, and Michael Scott with
  assistance from members of JCP JSR-166 Expert Group and released to
  the public domain, as explained at
  http://creativecommons.org/publicdomain/zero/1.0/</div>
<a id="L36" name="L36"></a>  36 
<a id="L37" name="L37"></a>  37 <strong class="reserved">package</strong> <a href="../S/3625.html#L43" title="Defined at 43 in src/javax/management/remote/rmi/RMIConnectionImpl_Stub.java.">java</a>.util.concurrent;
<a id="L38" name="L38"></a>  38 <strong class="reserved">import</strong> java.util.concurrent.locks.LockSupport;
<a id="L39" name="L39"></a>  39 <strong class="reserved">import</strong> java.util.concurrent.locks.ReentrantLock;
<a id="L40" name="L40"></a>  40 <strong class="reserved">import</strong> java.util.*;
<a id="L41" name="L41"></a>  41 <strong class="reserved">import</strong> java.util.Spliterator;
<a id="L42" name="L42"></a>  42 <strong class="reserved">import</strong> java.util.Spliterators;
<a id="L43" name="L43"></a>  43 
<div class="comment">
  A {@linkplain BlockingQueue blocking queue} in which each insert
  operation must wait for a corresponding remove operation by another
  thread, and vice versa.  A synchronous queue does not have any
  internal capacity, not even a capacity of one.  You cannot
  <code>peek</code> at a synchronous queue because an element is only
  present when you try to remove it; you cannot insert an element
  (using any method) unless another thread is trying to remove it;
  you cannot iterate as there is nothing to iterate.  The
  <em>head</em> of the queue is the element that the first queued
  inserting thread is trying to add to the queue; if there is no such
  queued thread then no element is available for removal and
  <code>poll()</code> will return <code>null</code>.  For purposes of other
  <code>Collection</code> methods (for example <code>contains</code>), a
  <code>SynchronousQueue</code> acts as an empty collection.  This queue
  does not permit <code>null</code> elements.
  <p>Synchronous queues are similar to rendezvous channels used in
  CSP and Ada. They are well suited for handoff designs, in which an
  object running in one thread must sync up with an object running
  in another thread in order to hand it some information, event, or
  task.
  </p><p>This class supports an optional fairness policy for ordering
  waiting producer and consumer threads.  By default, this ordering
  is not guaranteed. However, a queue constructed with fairness set
  to <code>true</code> grants threads access in FIFO order.
  </p><p>This class and its iterator implement all of the
  <em>optional</em> methods of the {@link Collection} and {@link
  Iterator} interfaces.
  </p><p>This class is a member of the
  <a href="{@docRoot}/../technotes/guides/collections/index.html">
  Java Collections Framework</a>.
  @since 1.5
  @author Doug Lea and Bill Scherer and Michael Scott
  @param <e> the type of elements held in this collection</e></p></div>
<a id="L84" name="L84"></a>  84 <strong class="reserved">public</strong> <strong class="reserved">class</strong> <a href="../R/7815.html" title="Multiple referred from 2 places.">SynchronousQueue</a>&lt;E&gt; <strong class="reserved">extends</strong> <a href="../S/994.html#L64" title="Defined at 64 in src/java/util/AbstractQueue.java.">AbstractQueue</a>&lt;E&gt;
<a id="L85" name="L85"></a>  85     <strong class="reserved">implements</strong> <a href="../S/1109.html#L180" title="Defined at 180 in src/java/util/concurrent/BlockingQueue.java.">BlockingQueue</a>&lt;E&gt;, <a href="../S/3625.html#L43" title="Defined at 43 in src/javax/management/remote/rmi/RMIConnectionImpl_Stub.java.">java</a>.io.<a href="../S/1407.html#L169" title="Defined at 169 in src/java/io/Serializable.java.">Serializable</a> <em class="brace">{</em>
<a id="L86" name="L86"></a>  86     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> serialVersionUID = -3223113410248163686L;
<a id="L87" name="L87"></a>  87 
<div class="comment">
      This class implements extensions of the dual stack and dual
      queue algorithms described in "Nonblocking Concurrent Objects
      with Condition Synchronization", by W. N. Scherer III and
      M. L. Scott.  18th Annual Conf. on Distributed Computing,
      Oct. 2004 (see also
      http://www.cs.rochester.edu/u/scott/synchronization/pseudocode/duals.html).
      The (Lifo) stack is used for non-fair mode, and the (Fifo)
      queue for fair mode. The performance of the two is generally
      similar. Fifo usually supports higher throughput under
      contention but Lifo maintains higher thread locality in common
      applications.
      A dual queue (and similarly stack) is one that at any given
      time either holds "data" -- items provided by put operations,
      or "requests" -- slots representing take operations, or is
      empty. A call to "fulfill" (i.e., a call requesting an item
      from a queue holding data or vice versa) dequeues a
      complementary node.  The most interesting feature of these
      queues is that any operation can figure out which mode the
      queue is in, and act accordingly without needing locks.
      Both the queue and stack extend abstract class Transferer
      defining the single method transfer that does a put or a
      take. These are unified into a single method because in dual
      data structures, the put and take operations are symmetrical,
      so nearly all code can be combined. The resulting transfer
      methods are on the long side, but are easier to follow than
      they would be if broken up into nearly-duplicated parts.
      The queue and stack data structures share many conceptual
      similarities but very few concrete details. For simplicity,
      they are kept distinct so that they can later evolve
      separately.
      The algorithms here differ from the versions in the above paper
      in extending them for use in synchronous queues, as well as
      dealing with cancellation. The main differences include:
       1. The original algorithms used bit-marked pointers, but
          the ones here use mode bits in nodes, leading to a number
          of further adaptations.
       2. SynchronousQueues must block threads waiting to become
          fulfilled.
       3. Support for cancellation via timeout and interrupts,
          including cleaning out cancelled nodes/threads
          from lists to avoid garbage retention and memory depletion.
      Blocking is mainly accomplished using LockSupport park/unpark,
      except that nodes that appear to be the next ones to become
      fulfilled first spin a bit (on multiprocessors only). On very
      busy synchronous queues, spinning can dramatically improve
      throughput. And on less busy ones, the amount of spinning is
      small enough not to be noticeable.
      Cleaning is done in different ways in queues vs stacks.  For
      queues, we can almost always remove a node immediately in O(1)
      time (modulo retries for consistency checks) when it is
      cancelled. But if it may be pinned as the current tail, it must
      wait until some subsequent cancellation. For stacks, we need a
      potentially O(n) traversal to be sure that we can remove the
      node, but this can run concurrently with other threads
      accessing the stack.
      While garbage collection takes care of most node reclamation
      issues that otherwise complicate nonblocking algorithms, care
      is taken to "forget" references to data, other nodes, and
      threads that might be held on to long-term by blocked
      threads. In cases where setting to null would otherwise
      conflict with main algorithms, this is done by changing a
      node's link to now point to the node itself. This doesn't arise
      much for Stack nodes (because blocked threads do not hang on to
      old head pointers), but references in Queue nodes must be
      aggressively forgotten to avoid reachability of everything any
      node has ever referred to since arrival.</div>
<a id="L164" name="L164"></a> 164 
<div class="comment">
      Shared internal API for dual stacks and queues.</div>
<a id="L168" name="L168"></a> 168     <strong class="reserved">abstract</strong> <strong class="reserved">static</strong> <strong class="reserved">class</strong> <a href="../R/8240.html" title="Multiple referred from 3 places.">Transferer</a>&lt;E&gt; <em class="brace">{</em>
<div class="comment">
          Performs a put or take.
          @param e if non-null, the item to be handed to a consumer;
                   if null, requests that transfer return an item
                   offered by producer.
          @param timed if this operation should timeout
          @param nanos the timeout, in nanoseconds
          @return if non-null, the item provided or received; if null,
                  the operation failed due to timeout or interrupt --
                  the caller can distinguish which of these occurred
                  by checking Thread.interrupted.</div>
<a id="L182" name="L182"></a> 182         <strong class="reserved">abstract</strong> E <a href="../R/29413.html" title="Multiple referred from 15 places.">transfer</a>(E e, <strong class="reserved">boolean</strong> timed, <strong class="reserved">long</strong> nanos);
<a id="L183" name="L183"></a> 183     <em class="brace">}</em>
<a id="L184" name="L184"></a> 184 
<div class="comment">
     /** The number of CPUs, for spin control */</div>
<a id="L186" name="L186"></a> 186     <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> NCPUS = <a href="../S/1774.html#L46" title="Defined at 46 in src/java/lang/Runtime.java.">Runtime</a>.<a href="../S/1774.html#L57" title="Defined at 57 in src/java/lang/Runtime.java.">getRuntime</a>().<a href="../S/1774.html#L635" title="Defined at 635 in src/java/lang/Runtime.java.">availableProcessors</a>();
<a id="L187" name="L187"></a> 187 
<div class="comment">
      The number of times to spin before blocking in timed waits.
      The value is empirically derived -- it works well across a
      variety of processors and OSes. Empirically, the best value
      seems not to vary with number of CPUs (beyond 2) so is just
      a constant.</div>
<a id="L195" name="L195"></a> 195     <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> maxTimedSpins = (NCPUS &lt; 2) ? 0 : 32;
<a id="L196" name="L196"></a> 196 
<div class="comment">
      The number of times to spin before blocking in untimed waits.
      This is greater than timed value because untimed waits spin
      faster since they don't need to check times on each spin.</div>
<a id="L202" name="L202"></a> 202     <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> maxUntimedSpins = maxTimedSpins * 16;
<a id="L203" name="L203"></a> 203 
<div class="comment">
      The number of nanoseconds for which it is faster to spin
      rather than to use timed park. A rough estimate suffices.</div>
<a id="L208" name="L208"></a> 208     <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> spinForTimeoutThreshold = 1000L;
<a id="L209" name="L209"></a> 209 
<div class="comment">
     /** Dual stack */</div>
<a id="L211" name="L211"></a> 211     <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">class</strong> <a href="../R/8236.html" title="Multiple referred from 3 places.">TransferStack</a>&lt;E&gt; <strong class="reserved">extends</strong> <a href="../S/1123.html#L168" title="Defined at 168 in src/java/util/concurrent/SynchronousQueue.java.">Transferer</a>&lt;E&gt; <em class="brace">{</em>
<div class="comment">
          This extends Scherer-Scott dual stack algorithm, differing,
          among other ways, by using "covering" nodes rather than
          bit-marked pointers: Fulfilling operations push on marker
          nodes (with FULFILLING bit set in mode) to reserve a spot
          to match a waiting node.</div>
<a id="L219" name="L219"></a> 219 
<div class="comment">
         /* Modes for SNodes, ORed together in node fields */</div>
<div class="comment">
         /** Node represents an unfulfilled consumer */</div>
<a id="L222" name="L222"></a> 222         <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> REQUEST    = 0;
<div class="comment">
         /** Node represents an unfulfilled producer */</div>
<a id="L224" name="L224"></a> 224         <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> DATA       = 1;
<div class="comment">
         /** Node is fulfilling another unfulfilled DATA or REQUEST */</div>
<a id="L226" name="L226"></a> 226         <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> FULFILLING = 2;
<a id="L227" name="L227"></a> 227 
<div class="comment">
         /** Returns true if m has fulfilling bit set. */</div>
<a id="L229" name="L229"></a> 229         <strong class="reserved">static</strong> <strong class="reserved">boolean</strong> <a href="../R/21501.html" title="Multiple referred from 2 places.">isFulfilling</a>(<strong class="reserved">int</strong> m) <em class="brace">{</em> <strong class="reserved">return</strong> (m &amp; FULFILLING) != 0; <em class="brace">}</em>
<a id="L230" name="L230"></a> 230 
<div class="comment">
         /** Node class for TransferStacks. */</div>
<a id="L232" name="L232"></a> 232         <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">class</strong> <a href="../R/6844.html" title="Multiple referred from 24 places.">SNode</a> <em class="brace">{</em>
<a id="L233" name="L233"></a> 233             <strong class="reserved">volatile</strong> <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> <a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;        <em class="comment">// next node in stack</em>
<a id="L234" name="L234"></a> 234             <strong class="reserved">volatile</strong> <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> <a href="../D/27519.html" title="Multiple defined in 69 places.">match</a>;       <em class="comment">// the node matched to this</em>
<a id="L235" name="L235"></a> 235             <strong class="reserved">volatile</strong> <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a> waiter;     <em class="comment">// to control park/unpark</em>
<a id="L236" name="L236"></a> 236             <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>;                <em class="comment">// data; or null for REQUESTs</em>
<a id="L237" name="L237"></a> 237             <strong class="reserved">int</strong> mode;
<a id="L238" name="L238"></a> 238             <em class="comment">// Note: item and mode fields don't need to be volatile</em>
<a id="L239" name="L239"></a> 239             <em class="comment">// since they are always written before, and read after,</em>
<a id="L240" name="L240"></a> 240             <em class="comment">// other volatile/atomic operations.</em>
<a id="L241" name="L241"></a> 241 
<a id="L242" name="L242"></a> 242             SNode(<a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>) <em class="brace">{</em>
<a id="L243" name="L243"></a> 243                 <strong class="reserved">this</strong>.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> = <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>;
<a id="L244" name="L244"></a> 244             <em class="brace">}</em>
<a id="L245" name="L245"></a> 245 
<a id="L246" name="L246"></a> 246             <strong class="reserved">boolean</strong> <a href="../R/10985.html" title="Multiple referred from 26 places.">casNext</a>(<a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> cmp, <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> <a href="../S/1444.html#L56" title="Defined at 56 in src/java/io/ExpiringCache.java.">val</a>) <em class="brace">{</em>
<a id="L247" name="L247"></a> 247                 <strong class="reserved">return</strong> cmp == <a href="../D/28131.html" title="Multiple defined in 273 places.">next</a> &amp;&amp;
<a id="L248" name="L248"></a> 248                     UNSAFE.compareAndSwapObject(<strong class="reserved">this</strong>, <a href="../D/28171.html" title="Multiple defined in 2 places.">nextOffset</a>, cmp, <a href="../S/1444.html#L56" title="Defined at 56 in src/java/io/ExpiringCache.java.">val</a>);
<a id="L249" name="L249"></a> 249             <em class="brace">}</em>
<a id="L250" name="L250"></a> 250 
<div class="comment">
              Tries to match node s to this node, if so, waking up thread.
              Fulfillers call tryMatch to identify their waiters.
              Waiters block until they have been matched.
              @param s the node to match
              @return true if successfully matched to s</div>
<a id="L259" name="L259"></a> 259             <strong class="reserved">boolean</strong> <a href="../R/29553.html" title="Multiple referred from 2 places.">tryMatch</a>(<a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> s) <em class="brace">{</em>
<a id="L260" name="L260"></a> 260                 <strong class="reserved">if</strong> (<a href="../D/27519.html" title="Multiple defined in 69 places.">match</a> == <strong class="reserved">null</strong> &amp;&amp;
<a id="L261" name="L261"></a> 261                     UNSAFE.compareAndSwapObject(<strong class="reserved">this</strong>, matchOffset, <strong class="reserved">null</strong>, s)) <em class="brace">{</em>
<a id="L262" name="L262"></a> 262                     <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a> w = waiter;
<a id="L263" name="L263"></a> 263                     <strong class="reserved">if</strong> (w != <strong class="reserved">null</strong>) <em class="brace">{</em>    <em class="comment">// waiters need at most one unpark</em>
<a id="L264" name="L264"></a> 264                         waiter = <strong class="reserved">null</strong>;
<a id="L265" name="L265"></a> 265                         <a href="../S/1045.html#L120" title="Defined at 120 in src/java/util/concurrent/locks/LockSupport.java.">LockSupport</a>.<a href="../S/1045.html#L139" title="Defined at 139 in src/java/util/concurrent/locks/LockSupport.java.">unpark</a>(w);
<a id="L266" name="L266"></a> 266                     <em class="brace">}</em>
<a id="L267" name="L267"></a> 267                     <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L268" name="L268"></a> 268                 <em class="brace">}</em>
<a id="L269" name="L269"></a> 269                 <strong class="reserved">return</strong> <a href="../D/27519.html" title="Multiple defined in 69 places.">match</a> == s;
<a id="L270" name="L270"></a> 270             <em class="brace">}</em>
<a id="L271" name="L271"></a> 271 
<div class="comment">
              Tries to cancel a wait by matching node to itself.</div>
<a id="L275" name="L275"></a> 275             <strong class="reserved">void</strong> <a href="../R/29543.html" title="Multiple referred from 4 places.">tryCancel</a>() <em class="brace">{</em>
<a id="L276" name="L276"></a> 276                 UNSAFE.compareAndSwapObject(<strong class="reserved">this</strong>, matchOffset, <strong class="reserved">null</strong>, <strong class="reserved">this</strong>);
<a id="L277" name="L277"></a> 277             <em class="brace">}</em>
<a id="L278" name="L278"></a> 278 
<a id="L279" name="L279"></a> 279             <strong class="reserved">boolean</strong> <a href="../R/21232.html" title="Multiple referred from 12 places.">isCancelled</a>() <em class="brace">{</em>
<a id="L280" name="L280"></a> 280                 <strong class="reserved">return</strong> <a href="../D/27519.html" title="Multiple defined in 69 places.">match</a> == <strong class="reserved">this</strong>;
<a id="L281" name="L281"></a> 281             <em class="brace">}</em>
<a id="L282" name="L282"></a> 282 
<a id="L283" name="L283"></a> 283             <em class="comment">// Unsafe mechanics</em>
<a id="L284" name="L284"></a> 284             <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> sun.misc.Unsafe UNSAFE;
<a id="L285" name="L285"></a> 285             <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> matchOffset;
<a id="L286" name="L286"></a> 286             <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> <a href="../D/28171.html" title="Multiple defined in 2 places.">nextOffset</a>;
<a id="L287" name="L287"></a> 287 
<a id="L288" name="L288"></a> 288             <strong class="reserved">static</strong> <em class="brace">{</em>
<a id="L289" name="L289"></a> 289                 <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L290" name="L290"></a> 290                     UNSAFE = sun.misc.Unsafe.getUnsafe();
<a id="L291" name="L291"></a> 291                     <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; k = <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a>.<strong class="reserved">class</strong>;
<a id="L292" name="L292"></a> 292                     matchOffset = UNSAFE.<a href="../D/28395.html" title="Multiple defined in 5 places.">objectFieldOffset</a>
<a id="L293" name="L293"></a> 293                         (k.<a href="../S/1722.html#L2065" title="Defined at 2065 in src/java/lang/Class.java.">getDeclaredField</a>("match"));
<a id="L294" name="L294"></a> 294                     <a href="../D/28171.html" title="Multiple defined in 2 places.">nextOffset</a> = UNSAFE.<a href="../D/28395.html" title="Multiple defined in 5 places.">objectFieldOffset</a>
<a id="L295" name="L295"></a> 295                         (k.<a href="../S/1722.html#L2065" title="Defined at 2065 in src/java/lang/Class.java.">getDeclaredField</a>("next"));
<a id="L296" name="L296"></a> 296                 <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/1582.html#L45" title="Defined at 45 in src/java/lang/Exception.java.">Exception</a> e) <em class="brace">{</em>
<a id="L297" name="L297"></a> 297                     <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1772.html#L49" title="Defined at 49 in src/java/lang/Error.java.">Error</a>(e);
<a id="L298" name="L298"></a> 298                 <em class="brace">}</em>
<a id="L299" name="L299"></a> 299             <em class="brace">}</em>
<a id="L300" name="L300"></a> 300         <em class="brace">}</em>
<a id="L301" name="L301"></a> 301 
<div class="comment">
         /** The head (top) of the stack */</div>
<a id="L303" name="L303"></a> 303         <strong class="reserved">volatile</strong> <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> head;
<a id="L304" name="L304"></a> 304 
<a id="L305" name="L305"></a> 305         <strong class="reserved">boolean</strong> <a href="../R/10983.html" title="Multiple referred from 20 places.">casHead</a>(<a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> h, <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> nh) <em class="brace">{</em>
<a id="L306" name="L306"></a> 306             <strong class="reserved">return</strong> h == head &amp;&amp;
<a id="L307" name="L307"></a> 307                 UNSAFE.compareAndSwapObject(<strong class="reserved">this</strong>, headOffset, h, nh);
<a id="L308" name="L308"></a> 308         <em class="brace">}</em>
<a id="L309" name="L309"></a> 309 
<div class="comment">
          Creates or resets fields of a node. Called only from transfer
          where the node to push on stack is lazily created and
          reused when possible to help reduce intervals between reads
          and CASes of head and to avoid surges of garbage when CASes
          to push nodes fail due to contention.</div>
<a id="L317" name="L317"></a> 317         <strong class="reserved">static</strong> <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> <a href="../R/28689.html" title="Multiple referred from 2 places.">snode</a>(<a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> s, <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> e, <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> <a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>, <strong class="reserved">int</strong> mode) <em class="brace">{</em>
<a id="L318" name="L318"></a> 318             <strong class="reserved">if</strong> (s == <strong class="reserved">null</strong>) s = <strong class="reserved">new</strong> <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a>(e);
<a id="L319" name="L319"></a> 319             s.mode = mode;
<a id="L320" name="L320"></a> 320             s.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a> = <a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;
<a id="L321" name="L321"></a> 321             <strong class="reserved">return</strong> s;
<a id="L322" name="L322"></a> 322         <em class="brace">}</em>
<a id="L323" name="L323"></a> 323 
<div class="comment">
          Puts or takes an item.</div>
<a id="L327" name="L327"></a> 327         @<a href="../R/7764.html" title="Multiple referred from 264 places.">SuppressWarnings</a>("unchecked")
<a id="L328" name="L328"></a> 328         E <a href="../R/29413.html" title="Multiple referred from 15 places.">transfer</a>(E e, <strong class="reserved">boolean</strong> timed, <strong class="reserved">long</strong> nanos) <em class="brace">{</em>
<div class="comment">
              Basic algorithm is to loop trying one of three actions:
              1. If apparently empty or already containing nodes of same
                 mode, try to push node on stack and wait for a match,
                 returning it, or null if cancelled.
              2. If apparently containing node of complementary mode,
                 try to push a fulfilling node on to stack, match
                 with corresponding waiting node, pop both from
                 stack, and return matched item. The matching or
                 unlinking might not actually be necessary because of
                 other threads performing action 3:
              3. If top of stack already holds another fulfilling node,
                 help it out by doing its match and/or pop
                 operations, and then continue. The code for helping
                 is essentially the same as for fulfilling, except
                 that it doesn't return the item.</div>
<a id="L349" name="L349"></a> 349 
<a id="L350" name="L350"></a> 350             <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> s = <strong class="reserved">null</strong>; <em class="comment">// constructed/reused as needed</em>
<a id="L351" name="L351"></a> 351             <strong class="reserved">int</strong> mode = (e == <strong class="reserved">null</strong>) ? REQUEST : DATA;
<a id="L352" name="L352"></a> 352 
<a id="L353" name="L353"></a> 353             <strong class="reserved">for</strong> (;;) <em class="brace">{</em>
<a id="L354" name="L354"></a> 354                 <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> h = head;
<a id="L355" name="L355"></a> 355                 <strong class="reserved">if</strong> (h == <strong class="reserved">null</strong> || h.mode == mode) <em class="brace">{</em>  <em class="comment">// empty or same-mode</em>
<a id="L356" name="L356"></a> 356                     <strong class="reserved">if</strong> (timed &amp;&amp; nanos &lt;= 0) <em class="brace">{</em>      <em class="comment">// can't wait</em>
<a id="L357" name="L357"></a> 357                         <strong class="reserved">if</strong> (h != <strong class="reserved">null</strong> &amp;&amp; h.<a href="../D/25280.html" title="Multiple defined in 8 places.">isCancelled</a>())
<a id="L358" name="L358"></a> 358                             <a href="../D/12261.html" title="Multiple defined in 5 places.">casHead</a>(h, h.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>);     <em class="comment">// pop cancelled node</em>
<a id="L359" name="L359"></a> 359                         <strong class="reserved">else</strong>
<a id="L360" name="L360"></a> 360                             <strong class="reserved">return</strong> <strong class="reserved">null</strong>;
<a id="L361" name="L361"></a> 361                     <em class="brace">}</em> <strong class="reserved">else</strong> <strong class="reserved">if</strong> (<a href="../D/12261.html" title="Multiple defined in 5 places.">casHead</a>(h, s = <a href="../S/1123.html#L317" title="Defined at 317 in src/java/util/concurrent/SynchronousQueue.java.">snode</a>(s, e, h, mode))) <em class="brace">{</em>
<a id="L362" name="L362"></a> 362                         <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> m = <a href="../D/11674.html" title="Multiple defined in 2 places.">awaitFulfill</a>(s, timed, nanos);
<a id="L363" name="L363"></a> 363                         <strong class="reserved">if</strong> (m == s) <em class="brace">{</em>               <em class="comment">// wait was cancelled</em>
<a id="L364" name="L364"></a> 364                             <a href="../D/12796.html" title="Multiple defined in 4 places.">clean</a>(s);
<a id="L365" name="L365"></a> 365                             <strong class="reserved">return</strong> <strong class="reserved">null</strong>;
<a id="L366" name="L366"></a> 366                         <em class="brace">}</em>
<a id="L367" name="L367"></a> 367                         <strong class="reserved">if</strong> ((h = head) != <strong class="reserved">null</strong> &amp;&amp; h.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a> == s)
<a id="L368" name="L368"></a> 368                             <a href="../D/12261.html" title="Multiple defined in 5 places.">casHead</a>(h, s.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>);     <em class="comment">// help s's fulfiller</em>
<a id="L369" name="L369"></a> 369                         <strong class="reserved">return</strong> (E) ((mode == REQUEST) ? m.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> : s.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>);
<a id="L370" name="L370"></a> 370                     <em class="brace">}</em>
<a id="L371" name="L371"></a> 371                 <em class="brace">}</em> <strong class="reserved">else</strong> <strong class="reserved">if</strong> (!<a href="../S/1123.html#L229" title="Defined at 229 in src/java/util/concurrent/SynchronousQueue.java.">isFulfilling</a>(h.mode)) <em class="brace">{</em> <em class="comment">// try to fulfill</em>
<a id="L372" name="L372"></a> 372                     <strong class="reserved">if</strong> (h.<a href="../D/25280.html" title="Multiple defined in 8 places.">isCancelled</a>())            <em class="comment">// already cancelled</em>
<a id="L373" name="L373"></a> 373                         <a href="../D/12261.html" title="Multiple defined in 5 places.">casHead</a>(h, h.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>);         <em class="comment">// pop and retry</em>
<a id="L374" name="L374"></a> 374                     <strong class="reserved">else</strong> <strong class="reserved">if</strong> (<a href="../D/12261.html" title="Multiple defined in 5 places.">casHead</a>(h, s=<a href="../S/1123.html#L317" title="Defined at 317 in src/java/util/concurrent/SynchronousQueue.java.">snode</a>(s, e, h, FULFILLING|mode))) <em class="brace">{</em>
<a id="L375" name="L375"></a> 375                         <strong class="reserved">for</strong> (;;) <em class="brace">{</em> <em class="comment">// loop until matched or waiters disappear</em>
<a id="L376" name="L376"></a> 376                             <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> m = s.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;       <em class="comment">// m is s's match</em>
<a id="L377" name="L377"></a> 377                             <strong class="reserved">if</strong> (m == <strong class="reserved">null</strong>) <em class="brace">{</em>        <em class="comment">// all waiters are gone</em>
<a id="L378" name="L378"></a> 378                                 <a href="../D/12261.html" title="Multiple defined in 5 places.">casHead</a>(s, <strong class="reserved">null</strong>);   <em class="comment">// pop fulfill node</em>
<a id="L379" name="L379"></a> 379                                 s = <strong class="reserved">null</strong>;           <em class="comment">// use new node next time</em>
<a id="L380" name="L380"></a> 380                                 <strong class="reserved">break</strong>;              <em class="comment">// restart main loop</em>
<a id="L381" name="L381"></a> 381                             <em class="brace">}</em>
<a id="L382" name="L382"></a> 382                             <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> mn = m.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;
<a id="L383" name="L383"></a> 383                             <strong class="reserved">if</strong> (m.<a href="../S/1123.html#L259" title="Defined at 259 in src/java/util/concurrent/SynchronousQueue.java.">tryMatch</a>(s)) <em class="brace">{</em>
<a id="L384" name="L384"></a> 384                                 <a href="../D/12261.html" title="Multiple defined in 5 places.">casHead</a>(s, mn);     <em class="comment">// pop both s and m</em>
<a id="L385" name="L385"></a> 385                                 <strong class="reserved">return</strong> (E) ((mode == REQUEST) ? m.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> : s.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>);
<a id="L386" name="L386"></a> 386                             <em class="brace">}</em> <strong class="reserved">else</strong>                  <em class="comment">// lost match</em>
<a id="L387" name="L387"></a> 387                                 s.<a href="../D/12263.html" title="Multiple defined in 6 places.">casNext</a>(m, mn);   <em class="comment">// help unlink</em>
<a id="L388" name="L388"></a> 388                         <em class="brace">}</em>
<a id="L389" name="L389"></a> 389                     <em class="brace">}</em>
<a id="L390" name="L390"></a> 390                 <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>                            <em class="comment">// help a fulfiller</em>
<a id="L391" name="L391"></a> 391                     <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> m = h.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;               <em class="comment">// m is h's match</em>
<a id="L392" name="L392"></a> 392                     <strong class="reserved">if</strong> (m == <strong class="reserved">null</strong>)                  <em class="comment">// waiter is gone</em>
<a id="L393" name="L393"></a> 393                         <a href="../D/12261.html" title="Multiple defined in 5 places.">casHead</a>(h, <strong class="reserved">null</strong>);           <em class="comment">// pop fulfilling node</em>
<a id="L394" name="L394"></a> 394                     <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L395" name="L395"></a> 395                         <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> mn = m.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;
<a id="L396" name="L396"></a> 396                         <strong class="reserved">if</strong> (m.<a href="../S/1123.html#L259" title="Defined at 259 in src/java/util/concurrent/SynchronousQueue.java.">tryMatch</a>(h))          <em class="comment">// help match</em>
<a id="L397" name="L397"></a> 397                             <a href="../D/12261.html" title="Multiple defined in 5 places.">casHead</a>(h, mn);         <em class="comment">// pop both h and m</em>
<a id="L398" name="L398"></a> 398                         <strong class="reserved">else</strong>                        <em class="comment">// lost match</em>
<a id="L399" name="L399"></a> 399                             h.<a href="../D/12263.html" title="Multiple defined in 6 places.">casNext</a>(m, mn);       <em class="comment">// help unlink</em>
<a id="L400" name="L400"></a> 400                     <em class="brace">}</em>
<a id="L401" name="L401"></a> 401                 <em class="brace">}</em>
<a id="L402" name="L402"></a> 402             <em class="brace">}</em>
<a id="L403" name="L403"></a> 403         <em class="brace">}</em>
<a id="L404" name="L404"></a> 404 
<div class="comment">
          Spins/blocks until node s is matched by a fulfill operation.
          @param s the waiting node
          @param timed true if timed wait
          @param nanos timeout value
          @return matched node, or s if cancelled</div>
<a id="L413" name="L413"></a> 413         <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> <a href="../R/10434.html" title="Multiple referred from 2 places.">awaitFulfill</a>(<a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> s, <strong class="reserved">boolean</strong> timed, <strong class="reserved">long</strong> nanos) <em class="brace">{</em>
<div class="comment">
              When a node/thread is about to block, it sets its waiter
              field and then rechecks state at least one more time
              before actually parking, thus covering race vs
              fulfiller noticing that waiter is non-null so should be
              woken.
              When invoked by nodes that appear at the point of call
              to be at the head of the stack, calls to park are
              preceded by spins to avoid blocking when producers and
              consumers are arriving very close in time.  This can
              happen enough to bother only on multiprocessors.
              The order of checks for returning out of main loop
              reflects fact that interrupts have precedence over
              normal returns, which have precedence over
              timeouts. (So, on timeout, one last check for match is
              done before giving up.) Except that calls from untimed
              SynchronousQueue.{poll/offer} don't check interrupts
              and don't wait at all, so are trapped in transfer
              method rather than calling awaitFulfill.</div>
<a id="L436" name="L436"></a> 436             <strong class="reserved">final</strong> <strong class="reserved">long</strong> deadline = timed ? <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1557.html#L399" title="Defined at 399 in src/java/lang/System.java.">nanoTime</a>() + nanos : 0L;
<a id="L437" name="L437"></a> 437             <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a> w = <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L264" title="Defined at 264 in src/java/lang/Thread.java.">currentThread</a>();
<a id="L438" name="L438"></a> 438             <strong class="reserved">int</strong> spins = (<a href="../S/1123.html#L468" title="Defined at 468 in src/java/util/concurrent/SynchronousQueue.java.">shouldSpin</a>(s) ?
<a id="L439" name="L439"></a> 439                          (timed ? maxTimedSpins : maxUntimedSpins) : 0);
<a id="L440" name="L440"></a> 440             <strong class="reserved">for</strong> (;;) <em class="brace">{</em>
<a id="L441" name="L441"></a> 441                 <strong class="reserved">if</strong> (w.<a href="../D/25738.html" title="Multiple defined in 2 places.">isInterrupted</a>())
<a id="L442" name="L442"></a> 442                     s.<a href="../D/35714.html" title="Multiple defined in 2 places.">tryCancel</a>();
<a id="L443" name="L443"></a> 443                 <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> m = s.<a href="../D/27519.html" title="Multiple defined in 69 places.">match</a>;
<a id="L444" name="L444"></a> 444                 <strong class="reserved">if</strong> (m != <strong class="reserved">null</strong>)
<a id="L445" name="L445"></a> 445                     <strong class="reserved">return</strong> m;
<a id="L446" name="L446"></a> 446                 <strong class="reserved">if</strong> (timed) <em class="brace">{</em>
<a id="L447" name="L447"></a> 447                     nanos = deadline - <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1557.html#L399" title="Defined at 399 in src/java/lang/System.java.">nanoTime</a>();
<a id="L448" name="L448"></a> 448                     <strong class="reserved">if</strong> (nanos &lt;= 0L) <em class="brace">{</em>
<a id="L449" name="L449"></a> 449                         s.<a href="../D/35714.html" title="Multiple defined in 2 places.">tryCancel</a>();
<a id="L450" name="L450"></a> 450                         <strong class="reserved">continue</strong>;
<a id="L451" name="L451"></a> 451                     <em class="brace">}</em>
<a id="L452" name="L452"></a> 452                 <em class="brace">}</em>
<a id="L453" name="L453"></a> 453                 <strong class="reserved">if</strong> (spins &gt; 0)
<a id="L454" name="L454"></a> 454                     spins = <a href="../S/1123.html#L468" title="Defined at 468 in src/java/util/concurrent/SynchronousQueue.java.">shouldSpin</a>(s) ? (spins-1) : 0;
<a id="L455" name="L455"></a> 455                 <strong class="reserved">else</strong> <strong class="reserved">if</strong> (s.waiter == <strong class="reserved">null</strong>)
<a id="L456" name="L456"></a> 456                     s.waiter = w; <em class="comment">// establish waiter so can park next iter</em>
<a id="L457" name="L457"></a> 457                 <strong class="reserved">else</strong> <strong class="reserved">if</strong> (!timed)
<a id="L458" name="L458"></a> 458                     <a href="../S/1045.html#L120" title="Defined at 120 in src/java/util/concurrent/locks/LockSupport.java.">LockSupport</a>.<a href="../D/29072.html" title="Multiple defined in 2 places.">park</a>(<strong class="reserved">this</strong>);
<a id="L459" name="L459"></a> 459                 <strong class="reserved">else</strong> <strong class="reserved">if</strong> (nanos &gt; spinForTimeoutThreshold)
<a id="L460" name="L460"></a> 460                     <a href="../S/1045.html#L120" title="Defined at 120 in src/java/util/concurrent/locks/LockSupport.java.">LockSupport</a>.<a href="../D/29074.html" title="Multiple defined in 2 places.">parkNanos</a>(<strong class="reserved">this</strong>, nanos);
<a id="L461" name="L461"></a> 461             <em class="brace">}</em>
<a id="L462" name="L462"></a> 462         <em class="brace">}</em>
<a id="L463" name="L463"></a> 463 
<div class="comment">
          Returns true if node s is at head or there is an active
          fulfiller.</div>
<a id="L468" name="L468"></a> 468         <strong class="reserved">boolean</strong> <a href="../R/28550.html" title="Multiple referred from 2 places.">shouldSpin</a>(<a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> s) <em class="brace">{</em>
<a id="L469" name="L469"></a> 469             <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> h = head;
<a id="L470" name="L470"></a> 470             <strong class="reserved">return</strong> (h == s || h == <strong class="reserved">null</strong> || <a href="../S/1123.html#L229" title="Defined at 229 in src/java/util/concurrent/SynchronousQueue.java.">isFulfilling</a>(h.mode));
<a id="L471" name="L471"></a> 471         <em class="brace">}</em>
<a id="L472" name="L472"></a> 472 
<div class="comment">
          Unlinks s from the stack.</div>
<a id="L476" name="L476"></a> 476         <strong class="reserved">void</strong> <a href="../R/11476.html" title="Multiple referred from 8 places.">clean</a>(<a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> s) <em class="brace">{</em>
<a id="L477" name="L477"></a> 477             s.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> = <strong class="reserved">null</strong>;   <em class="comment">// forget item</em>
<a id="L478" name="L478"></a> 478             s.waiter = <strong class="reserved">null</strong>; <em class="comment">// forget thread</em>
<a id="L479" name="L479"></a> 479 
<div class="comment">
              At worst we may need to traverse entire stack to unlink
              s. If there are multiple concurrent calls to clean, we
              might not see s if another thread has already removed
              it. But we can stop when we see any node known to
              follow s. We use s.next unless it too is cancelled, in
              which case we try the node one past. We don't check any
              further because we don't want to doubly traverse just to
              find sentinel.</div>
<a id="L490" name="L490"></a> 490 
<a id="L491" name="L491"></a> 491             <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> past = s.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;
<a id="L492" name="L492"></a> 492             <strong class="reserved">if</strong> (past != <strong class="reserved">null</strong> &amp;&amp; past.<a href="../D/25280.html" title="Multiple defined in 8 places.">isCancelled</a>())
<a id="L493" name="L493"></a> 493                 past = past.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;
<a id="L494" name="L494"></a> 494 
<a id="L495" name="L495"></a> 495             <em class="comment">// Absorb cancelled nodes at head</em>
<a id="L496" name="L496"></a> 496             <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> p;
<a id="L497" name="L497"></a> 497             <strong class="reserved">while</strong> ((p = head) != <strong class="reserved">null</strong> &amp;&amp; p != past &amp;&amp; p.<a href="../D/25280.html" title="Multiple defined in 8 places.">isCancelled</a>())
<a id="L498" name="L498"></a> 498                 <a href="../D/12261.html" title="Multiple defined in 5 places.">casHead</a>(p, p.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>);
<a id="L499" name="L499"></a> 499 
<a id="L500" name="L500"></a> 500             <em class="comment">// Unsplice embedded nodes</em>
<a id="L501" name="L501"></a> 501             <strong class="reserved">while</strong> (p != <strong class="reserved">null</strong> &amp;&amp; p != past) <em class="brace">{</em>
<a id="L502" name="L502"></a> 502                 <a href="../S/1123.html#L232" title="Defined at 232 in src/java/util/concurrent/SynchronousQueue.java.">SNode</a> n = p.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;
<a id="L503" name="L503"></a> 503                 <strong class="reserved">if</strong> (n != <strong class="reserved">null</strong> &amp;&amp; n.<a href="../D/25280.html" title="Multiple defined in 8 places.">isCancelled</a>())
<a id="L504" name="L504"></a> 504                     p.<a href="../D/12263.html" title="Multiple defined in 6 places.">casNext</a>(n, n.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>);
<a id="L505" name="L505"></a> 505                 <strong class="reserved">else</strong>
<a id="L506" name="L506"></a> 506                     p = n;
<a id="L507" name="L507"></a> 507             <em class="brace">}</em>
<a id="L508" name="L508"></a> 508         <em class="brace">}</em>
<a id="L509" name="L509"></a> 509 
<a id="L510" name="L510"></a> 510         <em class="comment">// Unsafe mechanics</em>
<a id="L511" name="L511"></a> 511         <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> sun.misc.Unsafe UNSAFE;
<a id="L512" name="L512"></a> 512         <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> headOffset;
<a id="L513" name="L513"></a> 513         <strong class="reserved">static</strong> <em class="brace">{</em>
<a id="L514" name="L514"></a> 514             <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L515" name="L515"></a> 515                 UNSAFE = sun.misc.Unsafe.getUnsafe();
<a id="L516" name="L516"></a> 516                 <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; k = <a href="../S/1123.html#L211" title="Defined at 211 in src/java/util/concurrent/SynchronousQueue.java.">TransferStack</a>.<strong class="reserved">class</strong>;
<a id="L517" name="L517"></a> 517                 headOffset = UNSAFE.<a href="../D/28395.html" title="Multiple defined in 5 places.">objectFieldOffset</a>
<a id="L518" name="L518"></a> 518                     (k.<a href="../S/1722.html#L2065" title="Defined at 2065 in src/java/lang/Class.java.">getDeclaredField</a>("head"));
<a id="L519" name="L519"></a> 519             <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/1582.html#L45" title="Defined at 45 in src/java/lang/Exception.java.">Exception</a> e) <em class="brace">{</em>
<a id="L520" name="L520"></a> 520                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1772.html#L49" title="Defined at 49 in src/java/lang/Error.java.">Error</a>(e);
<a id="L521" name="L521"></a> 521             <em class="brace">}</em>
<a id="L522" name="L522"></a> 522         <em class="brace">}</em>
<a id="L523" name="L523"></a> 523     <em class="brace">}</em>
<a id="L524" name="L524"></a> 524 
<div class="comment">
     /** Dual Queue */</div>
<a id="L526" name="L526"></a> 526     <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">class</strong> <a href="../R/8235.html" title="Multiple referred from 5 places.">TransferQueue</a>&lt;E&gt; <strong class="reserved">extends</strong> <a href="../S/1123.html#L168" title="Defined at 168 in src/java/util/concurrent/SynchronousQueue.java.">Transferer</a>&lt;E&gt; <em class="brace">{</em>
<div class="comment">
          This extends Scherer-Scott dual queue algorithm, differing,
          among other ways, by using modes within nodes rather than
          marked pointers. The algorithm is a little simpler than
          that for stacks because fulfillers do not need explicit
          nodes, and matching is done by CAS'ing QNode.item field
          from non-null to null (for put) or vice versa (for take).</div>
<a id="L535" name="L535"></a> 535 
<div class="comment">
         /** Node class for TransferQueue. */</div>
<a id="L537" name="L537"></a> 537         <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">class</strong> <a href="../R/6359.html" title="Multiple referred from 49 places.">QNode</a> <em class="brace">{</em>
<a id="L538" name="L538"></a> 538             <strong class="reserved">volatile</strong> <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> <a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;          <em class="comment">// next node in queue</em>
<a id="L539" name="L539"></a> 539             <strong class="reserved">volatile</strong> <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>;         <em class="comment">// CAS'ed to or from null</em>
<a id="L540" name="L540"></a> 540             <strong class="reserved">volatile</strong> <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a> waiter;       <em class="comment">// to control park/unpark</em>
<a id="L541" name="L541"></a> 541             <strong class="reserved">final</strong> <strong class="reserved">boolean</strong> <a href="../S/5170.html#L95" title="Defined at 95 in src/com/sun/org/apache/xerces/internal/impl/dv/util/Base64.java.">isData</a>;
<a id="L542" name="L542"></a> 542 
<a id="L543" name="L543"></a> 543             QNode(<a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>, <strong class="reserved">boolean</strong> <a href="../S/5170.html#L95" title="Defined at 95 in src/com/sun/org/apache/xerces/internal/impl/dv/util/Base64.java.">isData</a>) <em class="brace">{</em>
<a id="L544" name="L544"></a> 544                 <strong class="reserved">this</strong>.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> = <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>;
<a id="L545" name="L545"></a> 545                 <strong class="reserved">this</strong>.<a href="../S/5170.html#L95" title="Defined at 95 in src/com/sun/org/apache/xerces/internal/impl/dv/util/Base64.java.">isData</a> = <a href="../S/5170.html#L95" title="Defined at 95 in src/com/sun/org/apache/xerces/internal/impl/dv/util/Base64.java.">isData</a>;
<a id="L546" name="L546"></a> 546             <em class="brace">}</em>
<a id="L547" name="L547"></a> 547 
<a id="L548" name="L548"></a> 548             <strong class="reserved">boolean</strong> <a href="../R/10985.html" title="Multiple referred from 26 places.">casNext</a>(<a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> cmp, <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> <a href="../S/1444.html#L56" title="Defined at 56 in src/java/io/ExpiringCache.java.">val</a>) <em class="brace">{</em>
<a id="L549" name="L549"></a> 549                 <strong class="reserved">return</strong> <a href="../D/28131.html" title="Multiple defined in 273 places.">next</a> == cmp &amp;&amp;
<a id="L550" name="L550"></a> 550                     UNSAFE.compareAndSwapObject(<strong class="reserved">this</strong>, <a href="../D/28171.html" title="Multiple defined in 2 places.">nextOffset</a>, cmp, <a href="../S/1444.html#L56" title="Defined at 56 in src/java/io/ExpiringCache.java.">val</a>);
<a id="L551" name="L551"></a> 551             <em class="brace">}</em>
<a id="L552" name="L552"></a> 552 
<a id="L553" name="L553"></a> 553             <strong class="reserved">boolean</strong> <a href="../R/10984.html" title="Multiple referred from 10 places.">casItem</a>(<a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> cmp, <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../S/1444.html#L56" title="Defined at 56 in src/java/io/ExpiringCache.java.">val</a>) <em class="brace">{</em>
<a id="L554" name="L554"></a> 554                 <strong class="reserved">return</strong> <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> == cmp &amp;&amp;
<a id="L555" name="L555"></a> 555                     UNSAFE.compareAndSwapObject(<strong class="reserved">this</strong>, itemOffset, cmp, <a href="../S/1444.html#L56" title="Defined at 56 in src/java/io/ExpiringCache.java.">val</a>);
<a id="L556" name="L556"></a> 556             <em class="brace">}</em>
<a id="L557" name="L557"></a> 557 
<div class="comment">
              Tries to cancel by CAS'ing ref to this as item.</div>
<a id="L561" name="L561"></a> 561             <strong class="reserved">void</strong> <a href="../R/29543.html" title="Multiple referred from 4 places.">tryCancel</a>(<a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> cmp) <em class="brace">{</em>
<a id="L562" name="L562"></a> 562                 UNSAFE.compareAndSwapObject(<strong class="reserved">this</strong>, itemOffset, cmp, <strong class="reserved">this</strong>);
<a id="L563" name="L563"></a> 563             <em class="brace">}</em>
<a id="L564" name="L564"></a> 564 
<a id="L565" name="L565"></a> 565             <strong class="reserved">boolean</strong> <a href="../R/21232.html" title="Multiple referred from 12 places.">isCancelled</a>() <em class="brace">{</em>
<a id="L566" name="L566"></a> 566                 <strong class="reserved">return</strong> <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> == <strong class="reserved">this</strong>;
<a id="L567" name="L567"></a> 567             <em class="brace">}</em>
<a id="L568" name="L568"></a> 568 
<div class="comment">
              Returns true if this node is known to be off the queue
              because its next pointer has been forgotten due to
              an advanceHead operation.</div>
<a id="L574" name="L574"></a> 574             <strong class="reserved">boolean</strong> <a href="../S/1123.html#L701" title="Referred from 701 in src/java/util/concurrent/SynchronousQueue.java.">isOffList</a>() <em class="brace">{</em>
<a id="L575" name="L575"></a> 575                 <strong class="reserved">return</strong> <a href="../D/28131.html" title="Multiple defined in 273 places.">next</a> == <strong class="reserved">this</strong>;
<a id="L576" name="L576"></a> 576             <em class="brace">}</em>
<a id="L577" name="L577"></a> 577 
<a id="L578" name="L578"></a> 578             <em class="comment">// Unsafe mechanics</em>
<a id="L579" name="L579"></a> 579             <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> sun.misc.Unsafe UNSAFE;
<a id="L580" name="L580"></a> 580             <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> itemOffset;
<a id="L581" name="L581"></a> 581             <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> <a href="../D/28171.html" title="Multiple defined in 2 places.">nextOffset</a>;
<a id="L582" name="L582"></a> 582 
<a id="L583" name="L583"></a> 583             <strong class="reserved">static</strong> <em class="brace">{</em>
<a id="L584" name="L584"></a> 584                 <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L585" name="L585"></a> 585                     UNSAFE = sun.misc.Unsafe.getUnsafe();
<a id="L586" name="L586"></a> 586                     <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; k = <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a>.<strong class="reserved">class</strong>;
<a id="L587" name="L587"></a> 587                     itemOffset = UNSAFE.<a href="../D/28395.html" title="Multiple defined in 5 places.">objectFieldOffset</a>
<a id="L588" name="L588"></a> 588                         (k.<a href="../S/1722.html#L2065" title="Defined at 2065 in src/java/lang/Class.java.">getDeclaredField</a>("item"));
<a id="L589" name="L589"></a> 589                     <a href="../D/28171.html" title="Multiple defined in 2 places.">nextOffset</a> = UNSAFE.<a href="../D/28395.html" title="Multiple defined in 5 places.">objectFieldOffset</a>
<a id="L590" name="L590"></a> 590                         (k.<a href="../S/1722.html#L2065" title="Defined at 2065 in src/java/lang/Class.java.">getDeclaredField</a>("next"));
<a id="L591" name="L591"></a> 591                 <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/1582.html#L45" title="Defined at 45 in src/java/lang/Exception.java.">Exception</a> e) <em class="brace">{</em>
<a id="L592" name="L592"></a> 592                     <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1772.html#L49" title="Defined at 49 in src/java/lang/Error.java.">Error</a>(e);
<a id="L593" name="L593"></a> 593                 <em class="brace">}</em>
<a id="L594" name="L594"></a> 594             <em class="brace">}</em>
<a id="L595" name="L595"></a> 595         <em class="brace">}</em>
<a id="L596" name="L596"></a> 596 
<div class="comment">
         /** Head of queue */</div>
<a id="L598" name="L598"></a> 598         <strong class="reserved">transient</strong> <strong class="reserved">volatile</strong> <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> head;
<div class="comment">
         /** Tail of queue */</div>
<a id="L600" name="L600"></a> 600         <strong class="reserved">transient</strong> <strong class="reserved">volatile</strong> <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> tail;
<div class="comment">
          Reference to a cancelled node that might not yet have been
          unlinked from queue because it was the last inserted node
          when it was cancelled.</div>
<a id="L606" name="L606"></a> 606         <strong class="reserved">transient</strong> <strong class="reserved">volatile</strong> <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> cleanMe;
<a id="L607" name="L607"></a> 607 
<a id="L608" name="L608"></a> 608         TransferQueue() <em class="brace">{</em>
<a id="L609" name="L609"></a> 609             <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> h = <strong class="reserved">new</strong> <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a>(<strong class="reserved">null</strong>, <strong class="reserved">false</strong>); <em class="comment">// initialize to dummy node.</em>
<a id="L610" name="L610"></a> 610             head = h;
<a id="L611" name="L611"></a> 611             tail = h;
<a id="L612" name="L612"></a> 612         <em class="brace">}</em>
<a id="L613" name="L613"></a> 613 
<div class="comment">
          Tries to cas nh as new head; if successful, unlink
          old head's next node to avoid garbage retention.</div>
<a id="L618" name="L618"></a> 618         <strong class="reserved">void</strong> <a href="../R/10103.html" title="Multiple referred from 4 places.">advanceHead</a>(<a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> h, <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> nh) <em class="brace">{</em>
<a id="L619" name="L619"></a> 619             <strong class="reserved">if</strong> (h == head &amp;&amp;
<a id="L620" name="L620"></a> 620                 UNSAFE.compareAndSwapObject(<strong class="reserved">this</strong>, headOffset, h, nh))
<a id="L621" name="L621"></a> 621                 h.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a> = h; <em class="comment">// forget old next</em>
<a id="L622" name="L622"></a> 622         <em class="brace">}</em>
<a id="L623" name="L623"></a> 623 
<div class="comment">
          Tries to cas nt as new tail.</div>
<a id="L627" name="L627"></a> 627         <strong class="reserved">void</strong> <a href="../R/10106.html" title="Multiple referred from 3 places.">advanceTail</a>(<a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> t, <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> nt) <em class="brace">{</em>
<a id="L628" name="L628"></a> 628             <strong class="reserved">if</strong> (tail == t)
<a id="L629" name="L629"></a> 629                 UNSAFE.compareAndSwapObject(<strong class="reserved">this</strong>, tailOffset, t, nt);
<a id="L630" name="L630"></a> 630         <em class="brace">}</em>
<a id="L631" name="L631"></a> 631 
<div class="comment">
          Tries to CAS cleanMe slot.</div>
<a id="L635" name="L635"></a> 635         <strong class="reserved">boolean</strong> <a href="../R/10982.html" title="Multiple referred from 2 places.">casCleanMe</a>(<a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> cmp, <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> <a href="../S/1444.html#L56" title="Defined at 56 in src/java/io/ExpiringCache.java.">val</a>) <em class="brace">{</em>
<a id="L636" name="L636"></a> 636             <strong class="reserved">return</strong> cleanMe == cmp &amp;&amp;
<a id="L637" name="L637"></a> 637                 UNSAFE.compareAndSwapObject(<strong class="reserved">this</strong>, cleanMeOffset, cmp, <a href="../S/1444.html#L56" title="Defined at 56 in src/java/io/ExpiringCache.java.">val</a>);
<a id="L638" name="L638"></a> 638         <em class="brace">}</em>
<a id="L639" name="L639"></a> 639 
<div class="comment">
          Puts or takes an item.</div>
<a id="L643" name="L643"></a> 643         @<a href="../R/7764.html" title="Multiple referred from 264 places.">SuppressWarnings</a>("unchecked")
<a id="L644" name="L644"></a> 644         E <a href="../R/29413.html" title="Multiple referred from 15 places.">transfer</a>(E e, <strong class="reserved">boolean</strong> timed, <strong class="reserved">long</strong> nanos) <em class="brace">{</em>
<div class="comment">
 Basic algorithm is to loop trying to take either of
              two actions:
              1. If queue apparently empty or holding same-mode nodes,
                 try to add node to queue of waiters, wait to be
                 fulfilled (or cancelled) and return matching item.
              2. If queue apparently contains waiting items, and this
                 call is of complementary mode, try to fulfill by CAS'ing
                 item field of waiting node and dequeuing it, and then
                 returning matching item.
              In each case, along the way, check for and try to help
              advance head and tail on behalf of other stalled/slow
              threads.
              The loop starts off with a null check guarding against
              seeing uninitialized head or tail values. This never
              happens in current SynchronousQueue, but could if
              callers held non-volatile/final ref to the
              transferer. The check is here anyway because it places
              null checks at top of loop, which is usually faster
              than having them implicitly interspersed.</div>
<a id="L669" name="L669"></a> 669 
<a id="L670" name="L670"></a> 670             <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> s = <strong class="reserved">null</strong>; <em class="comment">// constructed/reused as needed</em>
<a id="L671" name="L671"></a> 671             <strong class="reserved">boolean</strong> <a href="../S/5170.html#L95" title="Defined at 95 in src/com/sun/org/apache/xerces/internal/impl/dv/util/Base64.java.">isData</a> = (e != <strong class="reserved">null</strong>);
<a id="L672" name="L672"></a> 672 
<a id="L673" name="L673"></a> 673             <strong class="reserved">for</strong> (;;) <em class="brace">{</em>
<a id="L674" name="L674"></a> 674                 <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> t = tail;
<a id="L675" name="L675"></a> 675                 <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> h = head;
<a id="L676" name="L676"></a> 676                 <strong class="reserved">if</strong> (t == <strong class="reserved">null</strong> || h == <strong class="reserved">null</strong>)         <em class="comment">// saw uninitialized value</em>
<a id="L677" name="L677"></a> 677                     <strong class="reserved">continue</strong>;                       <em class="comment">// spin</em>
<a id="L678" name="L678"></a> 678 
<a id="L679" name="L679"></a> 679                 <strong class="reserved">if</strong> (h == t || t.<a href="../S/5170.html#L95" title="Defined at 95 in src/com/sun/org/apache/xerces/internal/impl/dv/util/Base64.java.">isData</a> == <a href="../S/5170.html#L95" title="Defined at 95 in src/com/sun/org/apache/xerces/internal/impl/dv/util/Base64.java.">isData</a>) <em class="brace">{</em> <em class="comment">// empty or same-mode</em>
<a id="L680" name="L680"></a> 680                     <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> tn = t.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;
<a id="L681" name="L681"></a> 681                     <strong class="reserved">if</strong> (t != tail)                  <em class="comment">// inconsistent read</em>
<a id="L682" name="L682"></a> 682                         <strong class="reserved">continue</strong>;
<a id="L683" name="L683"></a> 683                     <strong class="reserved">if</strong> (tn != <strong class="reserved">null</strong>) <em class="brace">{</em>               <em class="comment">// lagging tail</em>
<a id="L684" name="L684"></a> 684                         <a href="../S/1123.html#L627" title="Defined at 627 in src/java/util/concurrent/SynchronousQueue.java.">advanceTail</a>(t, tn);
<a id="L685" name="L685"></a> 685                         <strong class="reserved">continue</strong>;
<a id="L686" name="L686"></a> 686                     <em class="brace">}</em>
<a id="L687" name="L687"></a> 687                     <strong class="reserved">if</strong> (timed &amp;&amp; nanos &lt;= 0)        <em class="comment">// can't wait</em>
<a id="L688" name="L688"></a> 688                         <strong class="reserved">return</strong> <strong class="reserved">null</strong>;
<a id="L689" name="L689"></a> 689                     <strong class="reserved">if</strong> (s == <strong class="reserved">null</strong>)
<a id="L690" name="L690"></a> 690                         s = <strong class="reserved">new</strong> <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a>(e, <a href="../S/5170.html#L95" title="Defined at 95 in src/com/sun/org/apache/xerces/internal/impl/dv/util/Base64.java.">isData</a>);
<a id="L691" name="L691"></a> 691                     <strong class="reserved">if</strong> (!t.<a href="../D/12263.html" title="Multiple defined in 6 places.">casNext</a>(<strong class="reserved">null</strong>, s))        <em class="comment">// failed to link in</em>
<a id="L692" name="L692"></a> 692                         <strong class="reserved">continue</strong>;
<a id="L693" name="L693"></a> 693 
<a id="L694" name="L694"></a> 694                     <a href="../S/1123.html#L627" title="Defined at 627 in src/java/util/concurrent/SynchronousQueue.java.">advanceTail</a>(t, s);              <em class="comment">// swing tail and wait</em>
<a id="L695" name="L695"></a> 695                     <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../D/37285.html" title="Multiple defined in 2 places.">x</a> = <a href="../D/11674.html" title="Multiple defined in 2 places.">awaitFulfill</a>(s, e, timed, nanos);
<a id="L696" name="L696"></a> 696                     <strong class="reserved">if</strong> (<a href="../D/37285.html" title="Multiple defined in 2 places.">x</a> == s) <em class="brace">{</em>                   <em class="comment">// wait was cancelled</em>
<a id="L697" name="L697"></a> 697                         <a href="../D/12796.html" title="Multiple defined in 4 places.">clean</a>(t, s);
<a id="L698" name="L698"></a> 698                         <strong class="reserved">return</strong> <strong class="reserved">null</strong>;
<a id="L699" name="L699"></a> 699                     <em class="brace">}</em>
<a id="L700" name="L700"></a> 700 
<a id="L701" name="L701"></a> 701                     <strong class="reserved">if</strong> (!s.<a href="../S/1123.html#L574" title="Defined at 574 in src/java/util/concurrent/SynchronousQueue.java.">isOffList</a>()) <em class="brace">{</em>           <em class="comment">// not already unlinked</em>
<a id="L702" name="L702"></a> 702                         <a href="../S/1123.html#L618" title="Defined at 618 in src/java/util/concurrent/SynchronousQueue.java.">advanceHead</a>(t, s);          <em class="comment">// unlink if head</em>
<a id="L703" name="L703"></a> 703                         <strong class="reserved">if</strong> (<a href="../D/37285.html" title="Multiple defined in 2 places.">x</a> != <strong class="reserved">null</strong>)              <em class="comment">// and forget fields</em>
<a id="L704" name="L704"></a> 704                             s.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> = s;
<a id="L705" name="L705"></a> 705                         s.waiter = <strong class="reserved">null</strong>;
<a id="L706" name="L706"></a> 706                     <em class="brace">}</em>
<a id="L707" name="L707"></a> 707                     <strong class="reserved">return</strong> (<a href="../D/37285.html" title="Multiple defined in 2 places.">x</a> != <strong class="reserved">null</strong>) ? (E)<a href="../D/37285.html" title="Multiple defined in 2 places.">x</a> : e;
<a id="L708" name="L708"></a> 708 
<a id="L709" name="L709"></a> 709                 <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>                            <em class="comment">// complementary-mode</em>
<a id="L710" name="L710"></a> 710                     <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> m = h.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;               <em class="comment">// node to fulfill</em>
<a id="L711" name="L711"></a> 711                     <strong class="reserved">if</strong> (t != tail || m == <strong class="reserved">null</strong> || h != head)
<a id="L712" name="L712"></a> 712                         <strong class="reserved">continue</strong>;                   <em class="comment">// inconsistent read</em>
<a id="L713" name="L713"></a> 713 
<a id="L714" name="L714"></a> 714                     <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../D/37285.html" title="Multiple defined in 2 places.">x</a> = m.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>;
<a id="L715" name="L715"></a> 715                     <strong class="reserved">if</strong> (<a href="../S/5170.html#L95" title="Defined at 95 in src/com/sun/org/apache/xerces/internal/impl/dv/util/Base64.java.">isData</a> == (<a href="../D/37285.html" title="Multiple defined in 2 places.">x</a> != <strong class="reserved">null</strong>) ||    <em class="comment">// m already fulfilled</em>
<a id="L716" name="L716"></a> 716                         <a href="../D/37285.html" title="Multiple defined in 2 places.">x</a> == m ||                   <em class="comment">// m cancelled</em>
<a id="L717" name="L717"></a> 717                         !m.<a href="../D/12262.html" title="Multiple defined in 4 places.">casItem</a>(<a href="../D/37285.html" title="Multiple defined in 2 places.">x</a>, e)) <em class="brace">{</em>         <em class="comment">// lost CAS</em>
<a id="L718" name="L718"></a> 718                         <a href="../S/1123.html#L618" title="Defined at 618 in src/java/util/concurrent/SynchronousQueue.java.">advanceHead</a>(h, m);          <em class="comment">// dequeue and retry</em>
<a id="L719" name="L719"></a> 719                         <strong class="reserved">continue</strong>;
<a id="L720" name="L720"></a> 720                     <em class="brace">}</em>
<a id="L721" name="L721"></a> 721 
<a id="L722" name="L722"></a> 722                     <a href="../S/1123.html#L618" title="Defined at 618 in src/java/util/concurrent/SynchronousQueue.java.">advanceHead</a>(h, m);              <em class="comment">// successfully fulfilled</em>
<a id="L723" name="L723"></a> 723                     <a href="../S/1045.html#L120" title="Defined at 120 in src/java/util/concurrent/locks/LockSupport.java.">LockSupport</a>.<a href="../S/1045.html#L139" title="Defined at 139 in src/java/util/concurrent/locks/LockSupport.java.">unpark</a>(m.waiter);
<a id="L724" name="L724"></a> 724                     <strong class="reserved">return</strong> (<a href="../D/37285.html" title="Multiple defined in 2 places.">x</a> != <strong class="reserved">null</strong>) ? (E)<a href="../D/37285.html" title="Multiple defined in 2 places.">x</a> : e;
<a id="L725" name="L725"></a> 725                 <em class="brace">}</em>
<a id="L726" name="L726"></a> 726             <em class="brace">}</em>
<a id="L727" name="L727"></a> 727         <em class="brace">}</em>
<a id="L728" name="L728"></a> 728 
<div class="comment">
          Spins/blocks until node s is fulfilled.
          @param s the waiting node
          @param e the comparison value for checking match
          @param timed true if timed wait
          @param nanos timeout value
          @return matched item, or s if cancelled</div>
<a id="L738" name="L738"></a> 738         <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../R/10434.html" title="Multiple referred from 2 places.">awaitFulfill</a>(<a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> s, E e, <strong class="reserved">boolean</strong> timed, <strong class="reserved">long</strong> nanos) <em class="brace">{</em>
<div class="comment">
             /* Same idea as TransferStack.awaitFulfill */</div>
<a id="L740" name="L740"></a> 740             <strong class="reserved">final</strong> <strong class="reserved">long</strong> deadline = timed ? <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1557.html#L399" title="Defined at 399 in src/java/lang/System.java.">nanoTime</a>() + nanos : 0L;
<a id="L741" name="L741"></a> 741             <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a> w = <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L264" title="Defined at 264 in src/java/lang/Thread.java.">currentThread</a>();
<a id="L742" name="L742"></a> 742             <strong class="reserved">int</strong> spins = ((head.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a> == s) ?
<a id="L743" name="L743"></a> 743                          (timed ? maxTimedSpins : maxUntimedSpins) : 0);
<a id="L744" name="L744"></a> 744             <strong class="reserved">for</strong> (;;) <em class="brace">{</em>
<a id="L745" name="L745"></a> 745                 <strong class="reserved">if</strong> (w.<a href="../D/25738.html" title="Multiple defined in 2 places.">isInterrupted</a>())
<a id="L746" name="L746"></a> 746                     s.<a href="../D/35714.html" title="Multiple defined in 2 places.">tryCancel</a>(e);
<a id="L747" name="L747"></a> 747                 <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../D/37285.html" title="Multiple defined in 2 places.">x</a> = s.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>;
<a id="L748" name="L748"></a> 748                 <strong class="reserved">if</strong> (<a href="../D/37285.html" title="Multiple defined in 2 places.">x</a> != e)
<a id="L749" name="L749"></a> 749                     <strong class="reserved">return</strong> <a href="../D/37285.html" title="Multiple defined in 2 places.">x</a>;
<a id="L750" name="L750"></a> 750                 <strong class="reserved">if</strong> (timed) <em class="brace">{</em>
<a id="L751" name="L751"></a> 751                     nanos = deadline - <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1557.html#L399" title="Defined at 399 in src/java/lang/System.java.">nanoTime</a>();
<a id="L752" name="L752"></a> 752                     <strong class="reserved">if</strong> (nanos &lt;= 0L) <em class="brace">{</em>
<a id="L753" name="L753"></a> 753                         s.<a href="../D/35714.html" title="Multiple defined in 2 places.">tryCancel</a>(e);
<a id="L754" name="L754"></a> 754                         <strong class="reserved">continue</strong>;
<a id="L755" name="L755"></a> 755                     <em class="brace">}</em>
<a id="L756" name="L756"></a> 756                 <em class="brace">}</em>
<a id="L757" name="L757"></a> 757                 <strong class="reserved">if</strong> (spins &gt; 0)
<a id="L758" name="L758"></a> 758                     --spins;
<a id="L759" name="L759"></a> 759                 <strong class="reserved">else</strong> <strong class="reserved">if</strong> (s.waiter == <strong class="reserved">null</strong>)
<a id="L760" name="L760"></a> 760                     s.waiter = w;
<a id="L761" name="L761"></a> 761                 <strong class="reserved">else</strong> <strong class="reserved">if</strong> (!timed)
<a id="L762" name="L762"></a> 762                     <a href="../S/1045.html#L120" title="Defined at 120 in src/java/util/concurrent/locks/LockSupport.java.">LockSupport</a>.<a href="../D/29072.html" title="Multiple defined in 2 places.">park</a>(<strong class="reserved">this</strong>);
<a id="L763" name="L763"></a> 763                 <strong class="reserved">else</strong> <strong class="reserved">if</strong> (nanos &gt; spinForTimeoutThreshold)
<a id="L764" name="L764"></a> 764                     <a href="../S/1045.html#L120" title="Defined at 120 in src/java/util/concurrent/locks/LockSupport.java.">LockSupport</a>.<a href="../D/29074.html" title="Multiple defined in 2 places.">parkNanos</a>(<strong class="reserved">this</strong>, nanos);
<a id="L765" name="L765"></a> 765             <em class="brace">}</em>
<a id="L766" name="L766"></a> 766         <em class="brace">}</em>
<a id="L767" name="L767"></a> 767 
<div class="comment">
          Gets rid of cancelled node s with original predecessor pred.</div>
<a id="L771" name="L771"></a> 771         <strong class="reserved">void</strong> <a href="../R/11476.html" title="Multiple referred from 8 places.">clean</a>(<a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> <a href="../S/1076.html#L734" title="Defined at 734 in src/java/util/concurrent/ConcurrentLinkedDeque.java.">pred</a>, <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> s) <em class="brace">{</em>
<a id="L772" name="L772"></a> 772             s.waiter = <strong class="reserved">null</strong>; <em class="comment">// forget thread</em>
<div class="comment">
              At any given time, exactly one node on list cannot be
              deleted -- the last inserted node. To accommodate this,
              if we cannot delete s, we save its predecessor as
              "cleanMe", deleting the previously saved version
              first. At least one of node s or the node previously
              saved can always be deleted, so this always terminates.</div>
<a id="L781" name="L781"></a> 781             <strong class="reserved">while</strong> (<a href="../S/1076.html#L734" title="Defined at 734 in src/java/util/concurrent/ConcurrentLinkedDeque.java.">pred</a>.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a> == s) <em class="brace">{</em> <em class="comment">// Return early if already unlinked</em>
<a id="L782" name="L782"></a> 782                 <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> h = head;
<a id="L783" name="L783"></a> 783                 <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> hn = h.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;   <em class="comment">// Absorb cancelled first node as head</em>
<a id="L784" name="L784"></a> 784                 <strong class="reserved">if</strong> (hn != <strong class="reserved">null</strong> &amp;&amp; hn.<a href="../D/25280.html" title="Multiple defined in 8 places.">isCancelled</a>()) <em class="brace">{</em>
<a id="L785" name="L785"></a> 785                     <a href="../S/1123.html#L618" title="Defined at 618 in src/java/util/concurrent/SynchronousQueue.java.">advanceHead</a>(h, hn);
<a id="L786" name="L786"></a> 786                     <strong class="reserved">continue</strong>;
<a id="L787" name="L787"></a> 787                 <em class="brace">}</em>
<a id="L788" name="L788"></a> 788                 <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> t = tail;      <em class="comment">// Ensure consistent read for tail</em>
<a id="L789" name="L789"></a> 789                 <strong class="reserved">if</strong> (t == h)
<a id="L790" name="L790"></a> 790                     <strong class="reserved">return</strong>;
<a id="L791" name="L791"></a> 791                 <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> tn = t.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;
<a id="L792" name="L792"></a> 792                 <strong class="reserved">if</strong> (t != tail)
<a id="L793" name="L793"></a> 793                     <strong class="reserved">continue</strong>;
<a id="L794" name="L794"></a> 794                 <strong class="reserved">if</strong> (tn != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L795" name="L795"></a> 795                     <a href="../S/1123.html#L627" title="Defined at 627 in src/java/util/concurrent/SynchronousQueue.java.">advanceTail</a>(t, tn);
<a id="L796" name="L796"></a> 796                     <strong class="reserved">continue</strong>;
<a id="L797" name="L797"></a> 797                 <em class="brace">}</em>
<a id="L798" name="L798"></a> 798                 <strong class="reserved">if</strong> (s != t) <em class="brace">{</em>        <em class="comment">// If not tail, try to unsplice</em>
<a id="L799" name="L799"></a> 799                     <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> sn = s.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;
<a id="L800" name="L800"></a> 800                     <strong class="reserved">if</strong> (sn == s || <a href="../S/1076.html#L734" title="Defined at 734 in src/java/util/concurrent/ConcurrentLinkedDeque.java.">pred</a>.<a href="../D/12263.html" title="Multiple defined in 6 places.">casNext</a>(s, sn))
<a id="L801" name="L801"></a> 801                         <strong class="reserved">return</strong>;
<a id="L802" name="L802"></a> 802                 <em class="brace">}</em>
<a id="L803" name="L803"></a> 803                 <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> dp = cleanMe;
<a id="L804" name="L804"></a> 804                 <strong class="reserved">if</strong> (dp != <strong class="reserved">null</strong>) <em class="brace">{</em>    <em class="comment">// Try unlinking previous cancelled node</em>
<a id="L805" name="L805"></a> 805                     <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> d = dp.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;
<a id="L806" name="L806"></a> 806                     <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> dn;
<a id="L807" name="L807"></a> 807                     <strong class="reserved">if</strong> (d == <strong class="reserved">null</strong> ||               <em class="comment">// d is gone or</em>
<a id="L808" name="L808"></a> 808                         d == dp ||                 <em class="comment">// d is off list or</em>
<a id="L809" name="L809"></a> 809                         !d.<a href="../D/25280.html" title="Multiple defined in 8 places.">isCancelled</a>() ||        <em class="comment">// d not cancelled or</em>
<a id="L810" name="L810"></a> 810                         (d != t &amp;&amp;                 <em class="comment">// d not tail and</em>
<a id="L811" name="L811"></a> 811                          (dn = d.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>) != <strong class="reserved">null</strong> &amp;&amp;  <em class="comment">//   has successor</em>
<a id="L812" name="L812"></a> 812                          dn != d &amp;&amp;                <em class="comment">//   that is on list</em>
<a id="L813" name="L813"></a> 813                          dp.<a href="../D/12263.html" title="Multiple defined in 6 places.">casNext</a>(d, dn)))       <em class="comment">// d unspliced</em>
<a id="L814" name="L814"></a> 814                         <a href="../S/1123.html#L635" title="Defined at 635 in src/java/util/concurrent/SynchronousQueue.java.">casCleanMe</a>(dp, <strong class="reserved">null</strong>);
<a id="L815" name="L815"></a> 815                     <strong class="reserved">if</strong> (dp == <a href="../S/1076.html#L734" title="Defined at 734 in src/java/util/concurrent/ConcurrentLinkedDeque.java.">pred</a>)
<a id="L816" name="L816"></a> 816                         <strong class="reserved">return</strong>;      <em class="comment">// s is already saved node</em>
<a id="L817" name="L817"></a> 817                 <em class="brace">}</em> <strong class="reserved">else</strong> <strong class="reserved">if</strong> (<a href="../S/1123.html#L635" title="Defined at 635 in src/java/util/concurrent/SynchronousQueue.java.">casCleanMe</a>(<strong class="reserved">null</strong>, <a href="../S/1076.html#L734" title="Defined at 734 in src/java/util/concurrent/ConcurrentLinkedDeque.java.">pred</a>))
<a id="L818" name="L818"></a> 818                     <strong class="reserved">return</strong>;          <em class="comment">// Postpone cleaning s</em>
<a id="L819" name="L819"></a> 819             <em class="brace">}</em>
<a id="L820" name="L820"></a> 820         <em class="brace">}</em>
<a id="L821" name="L821"></a> 821 
<a id="L822" name="L822"></a> 822         <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> sun.misc.Unsafe UNSAFE;
<a id="L823" name="L823"></a> 823         <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> headOffset;
<a id="L824" name="L824"></a> 824         <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> tailOffset;
<a id="L825" name="L825"></a> 825         <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> cleanMeOffset;
<a id="L826" name="L826"></a> 826         <strong class="reserved">static</strong> <em class="brace">{</em>
<a id="L827" name="L827"></a> 827             <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L828" name="L828"></a> 828                 UNSAFE = sun.misc.Unsafe.getUnsafe();
<a id="L829" name="L829"></a> 829                 <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; k = <a href="../D/9058.html" title="Multiple defined in 2 places.">TransferQueue</a>.<strong class="reserved">class</strong>;
<a id="L830" name="L830"></a> 830                 headOffset = UNSAFE.<a href="../D/28395.html" title="Multiple defined in 5 places.">objectFieldOffset</a>
<a id="L831" name="L831"></a> 831                     (k.<a href="../S/1722.html#L2065" title="Defined at 2065 in src/java/lang/Class.java.">getDeclaredField</a>("head"));
<a id="L832" name="L832"></a> 832                 tailOffset = UNSAFE.<a href="../D/28395.html" title="Multiple defined in 5 places.">objectFieldOffset</a>
<a id="L833" name="L833"></a> 833                     (k.<a href="../S/1722.html#L2065" title="Defined at 2065 in src/java/lang/Class.java.">getDeclaredField</a>("tail"));
<a id="L834" name="L834"></a> 834                 cleanMeOffset = UNSAFE.<a href="../D/28395.html" title="Multiple defined in 5 places.">objectFieldOffset</a>
<a id="L835" name="L835"></a> 835                     (k.<a href="../S/1722.html#L2065" title="Defined at 2065 in src/java/lang/Class.java.">getDeclaredField</a>("cleanMe"));
<a id="L836" name="L836"></a> 836             <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/1582.html#L45" title="Defined at 45 in src/java/lang/Exception.java.">Exception</a> e) <em class="brace">{</em>
<a id="L837" name="L837"></a> 837                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1772.html#L49" title="Defined at 49 in src/java/lang/Error.java.">Error</a>(e);
<a id="L838" name="L838"></a> 838             <em class="brace">}</em>
<a id="L839" name="L839"></a> 839         <em class="brace">}</em>
<a id="L840" name="L840"></a> 840     <em class="brace">}</em>
<a id="L841" name="L841"></a> 841 
<div class="comment">
      The transferer. Set only in constructor, but cannot be declared
      as final without further complicating serialization.  Since
      this is accessed only at most once per public method, there
      isn't a noticeable performance penalty for using volatile
      instead of final here.</div>
<a id="L849" name="L849"></a> 849     <strong class="reserved">private</strong> <strong class="reserved">transient</strong> <strong class="reserved">volatile</strong> <a href="../S/1123.html#L168" title="Defined at 168 in src/java/util/concurrent/SynchronousQueue.java.">Transferer</a>&lt;E&gt; transferer;
<a id="L850" name="L850"></a> 850 
<div class="comment">
      Creates a <code>SynchronousQueue</code> with nonfair access policy.</div>
<a id="L854" name="L854"></a> 854     <strong class="reserved">public</strong> SynchronousQueue() <em class="brace">{</em>
<a id="L855" name="L855"></a> 855         <strong class="reserved">this</strong>(<strong class="reserved">false</strong>);
<a id="L856" name="L856"></a> 856     <em class="brace">}</em>
<a id="L857" name="L857"></a> 857 
<div class="comment">
      Creates a <code>SynchronousQueue</code> with the specified fairness policy.
      @param fair if true, waiting threads contend in FIFO order for
             access; otherwise the order is unspecified.</div>
<a id="L864" name="L864"></a> 864     <strong class="reserved">public</strong> SynchronousQueue(<strong class="reserved">boolean</strong> fair) <em class="brace">{</em>
<a id="L865" name="L865"></a> 865         transferer = fair ? <strong class="reserved">new</strong> <a href="../D/9058.html" title="Multiple defined in 2 places.">TransferQueue</a>&lt;E&gt;() : <strong class="reserved">new</strong> <a href="../S/1123.html#L211" title="Defined at 211 in src/java/util/concurrent/SynchronousQueue.java.">TransferStack</a>&lt;E&gt;();
<a id="L866" name="L866"></a> 866     <em class="brace">}</em>
<a id="L867" name="L867"></a> 867 
<div class="comment">
      Adds the specified element to this queue, waiting if necessary for
      another thread to receive it.
      @throws InterruptedException {@inheritDoc}
      @throws NullPointerException {@inheritDoc}</div>
<a id="L875" name="L875"></a> 875     <strong class="reserved">public</strong> <strong class="reserved">void</strong> <a href="../R/25285.html" title="Multiple referred from 5173 places.">put</a>(E e) <strong class="reserved">throws</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a> <em class="brace">{</em>
<a id="L876" name="L876"></a> 876         <strong class="reserved">if</strong> (e == <strong class="reserved">null</strong>) <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1559.html#L53" title="Defined at 53 in src/java/lang/NullPointerException.java.">NullPointerException</a>();
<a id="L877" name="L877"></a> 877         <strong class="reserved">if</strong> (transferer.<a href="../D/35577.html" title="Multiple defined in 8 places.">transfer</a>(e, <strong class="reserved">false</strong>, 0) == <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L878" name="L878"></a> 878             <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L943" title="Defined at 943 in src/java/lang/Thread.java.">interrupted</a>();
<a id="L879" name="L879"></a> 879             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a>();
<a id="L880" name="L880"></a> 880         <em class="brace">}</em>
<a id="L881" name="L881"></a> 881     <em class="brace">}</em>
<a id="L882" name="L882"></a> 882 
<div class="comment">
      Inserts the specified element into this queue, waiting if necessary
      up to the specified wait time for another thread to receive it.
      @return <code>true</code> if successful, or <code>false</code> if the
              specified waiting time elapses before a consumer appears
      @throws InterruptedException {@inheritDoc}
      @throws NullPointerException {@inheritDoc}</div>
<a id="L892" name="L892"></a> 892     <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/23932.html" title="Multiple referred from 17 places.">offer</a>(E e, <strong class="reserved">long</strong> timeout, <a href="../S/1102.html#L71" title="Defined at 71 in src/java/util/concurrent/TimeUnit.java.">TimeUnit</a> unit)
<a id="L893" name="L893"></a> 893         <strong class="reserved">throws</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a> <em class="brace">{</em>
<a id="L894" name="L894"></a> 894         <strong class="reserved">if</strong> (e == <strong class="reserved">null</strong>) <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1559.html#L53" title="Defined at 53 in src/java/lang/NullPointerException.java.">NullPointerException</a>();
<a id="L895" name="L895"></a> 895         <strong class="reserved">if</strong> (transferer.<a href="../D/35577.html" title="Multiple defined in 8 places.">transfer</a>(e, <strong class="reserved">true</strong>, unit.<a href="../D/35449.html" title="Multiple defined in 2 places.">toNanos</a>(timeout)) != <strong class="reserved">null</strong>)
<a id="L896" name="L896"></a> 896             <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L897" name="L897"></a> 897         <strong class="reserved">if</strong> (!<a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L943" title="Defined at 943 in src/java/lang/Thread.java.">interrupted</a>())
<a id="L898" name="L898"></a> 898             <strong class="reserved">return</strong> <strong class="reserved">false</strong>;
<a id="L899" name="L899"></a> 899         <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a>();
<a id="L900" name="L900"></a> 900     <em class="brace">}</em>
<a id="L901" name="L901"></a> 901 
<div class="comment">
      Inserts the specified element into this queue, if another thread is
      waiting to receive it.
      @param e the element to add
      @return <code>true</code> if the element was added to this queue, else
              <code>false</code>
      @throws NullPointerException if the specified element is null</div>
<a id="L911" name="L911"></a> 911     <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/23932.html" title="Multiple referred from 17 places.">offer</a>(E e) <em class="brace">{</em>
<a id="L912" name="L912"></a> 912         <strong class="reserved">if</strong> (e == <strong class="reserved">null</strong>) <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1559.html#L53" title="Defined at 53 in src/java/lang/NullPointerException.java.">NullPointerException</a>();
<a id="L913" name="L913"></a> 913         <strong class="reserved">return</strong> transferer.<a href="../D/35577.html" title="Multiple defined in 8 places.">transfer</a>(e, <strong class="reserved">true</strong>, 0) != <strong class="reserved">null</strong>;
<a id="L914" name="L914"></a> 914     <em class="brace">}</em>
<a id="L915" name="L915"></a> 915 
<div class="comment">
      Retrieves and removes the head of this queue, waiting if necessary
      for another thread to insert it.
      @return the head of this queue
      @throws InterruptedException {@inheritDoc}</div>
<a id="L923" name="L923"></a> 923     <strong class="reserved">public</strong> E <a href="../R/29108.html" title="Multiple referred from 11 places.">take</a>() <strong class="reserved">throws</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a> <em class="brace">{</em>
<a id="L924" name="L924"></a> 924         E e = transferer.<a href="../D/35577.html" title="Multiple defined in 8 places.">transfer</a>(<strong class="reserved">null</strong>, <strong class="reserved">false</strong>, 0);
<a id="L925" name="L925"></a> 925         <strong class="reserved">if</strong> (e != <strong class="reserved">null</strong>)
<a id="L926" name="L926"></a> 926             <strong class="reserved">return</strong> e;
<a id="L927" name="L927"></a> 927         <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L943" title="Defined at 943 in src/java/lang/Thread.java.">interrupted</a>();
<a id="L928" name="L928"></a> 928         <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a>();
<a id="L929" name="L929"></a> 929     <em class="brace">}</em>
<a id="L930" name="L930"></a> 930 
<div class="comment">
      Retrieves and removes the head of this queue, waiting
      if necessary up to the specified wait time, for another thread
      to insert it.
      @return the head of this queue, or <code>null</code> if the
              specified waiting time elapses before an element is present
      @throws InterruptedException {@inheritDoc}</div>
<a id="L940" name="L940"></a> 940     <strong class="reserved">public</strong> E <a href="../R/24795.html" title="Multiple referred from 51 places.">poll</a>(<strong class="reserved">long</strong> timeout, <a href="../S/1102.html#L71" title="Defined at 71 in src/java/util/concurrent/TimeUnit.java.">TimeUnit</a> unit) <strong class="reserved">throws</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a> <em class="brace">{</em>
<a id="L941" name="L941"></a> 941         E e = transferer.<a href="../D/35577.html" title="Multiple defined in 8 places.">transfer</a>(<strong class="reserved">null</strong>, <strong class="reserved">true</strong>, unit.<a href="../D/35449.html" title="Multiple defined in 2 places.">toNanos</a>(timeout));
<a id="L942" name="L942"></a> 942         <strong class="reserved">if</strong> (e != <strong class="reserved">null</strong> || !<a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L943" title="Defined at 943 in src/java/lang/Thread.java.">interrupted</a>())
<a id="L943" name="L943"></a> 943             <strong class="reserved">return</strong> e;
<a id="L944" name="L944"></a> 944         <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a>();
<a id="L945" name="L945"></a> 945     <em class="brace">}</em>
<a id="L946" name="L946"></a> 946 
<div class="comment">
      Retrieves and removes the head of this queue, if another thread
      is currently making an element available.
      @return the head of this queue, or <code>null</code> if no
              element is available</div>
<a id="L954" name="L954"></a> 954     <strong class="reserved">public</strong> E <a href="../R/24795.html" title="Multiple referred from 51 places.">poll</a>() <em class="brace">{</em>
<a id="L955" name="L955"></a> 955         <strong class="reserved">return</strong> transferer.<a href="../D/35577.html" title="Multiple defined in 8 places.">transfer</a>(<strong class="reserved">null</strong>, <strong class="reserved">true</strong>, 0);
<a id="L956" name="L956"></a> 956     <em class="brace">}</em>
<a id="L957" name="L957"></a> 957 
<div class="comment">
      Always returns <code>true</code>.
      A <code>SynchronousQueue</code> has no internal capacity.
      @return <code>true</code></div>
<a id="L964" name="L964"></a> 964     <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/21404.html" title="Multiple referred from 435 places.">isEmpty</a>() <em class="brace">{</em>
<a id="L965" name="L965"></a> 965         <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L966" name="L966"></a> 966     <em class="brace">}</em>
<a id="L967" name="L967"></a> 967 
<div class="comment">
      Always returns zero.
      A <code>SynchronousQueue</code> has no internal capacity.
      @return zero</div>
<a id="L974" name="L974"></a> 974     <strong class="reserved">public</strong> <strong class="reserved">int</strong> <a href="../R/28639.html" title="Multiple referred from 5617 places.">size</a>() <em class="brace">{</em>
<a id="L975" name="L975"></a> 975         <strong class="reserved">return</strong> 0;
<a id="L976" name="L976"></a> 976     <em class="brace">}</em>
<a id="L977" name="L977"></a> 977 
<div class="comment">
      Always returns zero.
      A <code>SynchronousQueue</code> has no internal capacity.
      @return zero</div>
<a id="L984" name="L984"></a> 984     <strong class="reserved">public</strong> <strong class="reserved">int</strong> remainingCapacity() <em class="brace">{</em>
<a id="L985" name="L985"></a> 985         <strong class="reserved">return</strong> 0;
<a id="L986" name="L986"></a> 986     <em class="brace">}</em>
<a id="L987" name="L987"></a> 987 
<div class="comment">
      Does nothing.
      A <code>SynchronousQueue</code> has no internal capacity.</div>
<a id="L992" name="L992"></a> 992     <strong class="reserved">public</strong> <strong class="reserved">void</strong> <a href="../R/11497.html" title="Multiple referred from 522 places.">clear</a>() <em class="brace">{</em>
<a id="L993" name="L993"></a> 993     <em class="brace">}</em>
<a id="L994" name="L994"></a> 994 
<div class="comment">
      Always returns <code>false</code>.
      A <code>SynchronousQueue</code> has no internal capacity.
      @param o the element
      @return <code>false</code></div>
<a id="L1002" name="L1002"></a>1002     <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/11949.html" title="Multiple referred from 682 places.">contains</a>(<a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../S/986.html#L3177" title="Defined at 3177 in src/java/util/regex/Pattern.java.">o</a>) <em class="brace">{</em>
<a id="L1003" name="L1003"></a>1003         <strong class="reserved">return</strong> <strong class="reserved">false</strong>;
<a id="L1004" name="L1004"></a>1004     <em class="brace">}</em>
<a id="L1005" name="L1005"></a>1005 
<div class="comment">
      Always returns <code>false</code>.
      A <code>SynchronousQueue</code> has no internal capacity.
      @param o the element to remove
      @return <code>false</code></div>
<a id="L1013" name="L1013"></a>1013     <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/25882.html" title="Multiple referred from 1115 places.">remove</a>(<a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../S/986.html#L3177" title="Defined at 3177 in src/java/util/regex/Pattern.java.">o</a>) <em class="brace">{</em>
<a id="L1014" name="L1014"></a>1014         <strong class="reserved">return</strong> <strong class="reserved">false</strong>;
<a id="L1015" name="L1015"></a>1015     <em class="brace">}</em>
<a id="L1016" name="L1016"></a>1016 
<div class="comment">
      Returns <code>false</code> unless the given collection is empty.
      A <code>SynchronousQueue</code> has no internal capacity.
      @param c the collection
      @return <code>false</code> unless given collection is empty</div>
<a id="L1024" name="L1024"></a>1024     <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/11950.html" title="Multiple referred from 20 places.">containsAll</a>(<a href="../S/875.html#L144" title="Defined at 144 in src/java/util/Collection.java.">Collection</a>&lt;?&gt; <a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a>) <em class="brace">{</em>
<a id="L1025" name="L1025"></a>1025         <strong class="reserved">return</strong> <a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a>.<a href="../D/25493.html" title="Multiple defined in 113 places.">isEmpty</a>();
<a id="L1026" name="L1026"></a>1026     <em class="brace">}</em>
<a id="L1027" name="L1027"></a>1027 
<div class="comment">
      Always returns <code>false</code>.
      A <code>SynchronousQueue</code> has no internal capacity.
      @param c the collection
      @return <code>false</code></div>
<a id="L1035" name="L1035"></a>1035     <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/25889.html" title="Multiple referred from 59 places.">removeAll</a>(<a href="../S/875.html#L144" title="Defined at 144 in src/java/util/Collection.java.">Collection</a>&lt;?&gt; <a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a>) <em class="brace">{</em>
<a id="L1036" name="L1036"></a>1036         <strong class="reserved">return</strong> <strong class="reserved">false</strong>;
<a id="L1037" name="L1037"></a>1037     <em class="brace">}</em>
<a id="L1038" name="L1038"></a>1038 
<div class="comment">
      Always returns <code>false</code>.
      A <code>SynchronousQueue</code> has no internal capacity.
      @param c the collection
      @return <code>false</code></div>
<a id="L1046" name="L1046"></a>1046     <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/26446.html" title="Multiple referred from 10 places.">retainAll</a>(<a href="../S/875.html#L144" title="Defined at 144 in src/java/util/Collection.java.">Collection</a>&lt;?&gt; <a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a>) <em class="brace">{</em>
<a id="L1047" name="L1047"></a>1047         <strong class="reserved">return</strong> <strong class="reserved">false</strong>;
<a id="L1048" name="L1048"></a>1048     <em class="brace">}</em>
<a id="L1049" name="L1049"></a>1049 
<div class="comment">
      Always returns <code>null</code>.
      A <code>SynchronousQueue</code> does not return elements
      unless actively waited on.
      @return <code>null</code></div>
<a id="L1057" name="L1057"></a>1057     <strong class="reserved">public</strong> E <a href="../R/24689.html" title="Multiple referred from 168 places.">peek</a>() <em class="brace">{</em>
<a id="L1058" name="L1058"></a>1058         <strong class="reserved">return</strong> <strong class="reserved">null</strong>;
<a id="L1059" name="L1059"></a>1059     <em class="brace">}</em>
<a id="L1060" name="L1060"></a>1060 
<div class="comment">
      Returns an empty iterator in which <code>hasNext</code> always returns
      <code>false</code>.
      @return an empty iterator</div>
<a id="L1067" name="L1067"></a>1067     <strong class="reserved">public</strong> <a href="../D/4461.html" title="Multiple defined in 3 places.">Iterator</a>&lt;E&gt; <a href="../R/22304.html" title="Multiple referred from 905 places.">iterator</a>() <em class="brace">{</em>
<a id="L1068" name="L1068"></a>1068         <strong class="reserved">return</strong> <a href="../S/1147.html#L80" title="Defined at 80 in src/java/util/Collections.java.">Collections</a>.<a href="../S/1147.html#L4180" title="Defined at 4180 in src/java/util/Collections.java.">emptyIterator</a>();
<a id="L1069" name="L1069"></a>1069     <em class="brace">}</em>
<a id="L1070" name="L1070"></a>1070 
<div class="comment">
      Returns an empty spliterator in which calls to
      {@link java.util.Spliterator#trySplit()} always return <code>null</code>.
      @return an empty spliterator
      @since 1.8</div>
<a id="L1078" name="L1078"></a>1078     <strong class="reserved">public</strong> <a href="../S/1151.html#L296" title="Defined at 296 in src/java/util/Spliterator.java.">Spliterator</a>&lt;E&gt; <a href="../R/28762.html" title="Multiple referred from 435 places.">spliterator</a>() <em class="brace">{</em>
<a id="L1079" name="L1079"></a>1079         <strong class="reserved">return</strong> <a href="../S/1188.html#L41" title="Defined at 41 in src/java/util/Spliterators.java.">Spliterators</a>.<a href="../S/1188.html#L59" title="Defined at 59 in src/java/util/Spliterators.java.">emptySpliterator</a>();
<a id="L1080" name="L1080"></a>1080     <em class="brace">}</em>
<a id="L1081" name="L1081"></a>1081 
<div class="comment">
      Returns a zero-length array.
      @return a zero-length array</div>
<a id="L1086" name="L1086"></a>1086     <strong class="reserved">public</strong> <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a>[] <a href="../R/29213.html" title="Multiple referred from 289 places.">toArray</a>() <em class="brace">{</em>
<a id="L1087" name="L1087"></a>1087         <strong class="reserved">return</strong> <strong class="reserved">new</strong> <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a>[0];
<a id="L1088" name="L1088"></a>1088     <em class="brace">}</em>
<a id="L1089" name="L1089"></a>1089 
<div class="comment">
      Sets the zeroeth element of the specified array to <code>null</code>
      (if the array has non-zero length) and returns it.
      @param a the array
      @return the specified array
      @throws NullPointerException if the specified array is null</div>
<a id="L1098" name="L1098"></a>1098     <strong class="reserved">public</strong> &lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>[] <a href="../R/29213.html" title="Multiple referred from 289 places.">toArray</a>(<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>[] <a href="../D/10513.html" title="Multiple defined in 3 places.">a</a>) <em class="brace">{</em>
<a id="L1099" name="L1099"></a>1099         <strong class="reserved">if</strong> (<a href="../D/10513.html" title="Multiple defined in 3 places.">a</a>.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a> &gt; 0)
<a id="L1100" name="L1100"></a>1100             <a href="../D/10513.html" title="Multiple defined in 3 places.">a</a>[0] = <strong class="reserved">null</strong>;
<a id="L1101" name="L1101"></a>1101         <strong class="reserved">return</strong> <a href="../D/10513.html" title="Multiple defined in 3 places.">a</a>;
<a id="L1102" name="L1102"></a>1102     <em class="brace">}</em>
<a id="L1103" name="L1103"></a>1103 
<div class="comment">
      @throws UnsupportedOperationException {@inheritDoc}
      @throws ClassCastException            {@inheritDoc}
      @throws NullPointerException          {@inheritDoc}
      @throws IllegalArgumentException      {@inheritDoc}</div>
<a id="L1110" name="L1110"></a>1110     <strong class="reserved">public</strong> <strong class="reserved">int</strong> <a href="../R/13516.html" title="Multiple referred from 5 places.">drainTo</a>(<a href="../S/875.html#L144" title="Defined at 144 in src/java/util/Collection.java.">Collection</a>&lt;? <strong class="reserved">super</strong> E&gt; <a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a>) <em class="brace">{</em>
<a id="L1111" name="L1111"></a>1111         <strong class="reserved">if</strong> (<a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a> == <strong class="reserved">null</strong>)
<a id="L1112" name="L1112"></a>1112             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1559.html#L53" title="Defined at 53 in src/java/lang/NullPointerException.java.">NullPointerException</a>();
<a id="L1113" name="L1113"></a>1113         <strong class="reserved">if</strong> (<a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a> == <strong class="reserved">this</strong>)
<a id="L1114" name="L1114"></a>1114             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../D/4055.html" title="Multiple defined in 2 places.">IllegalArgumentException</a>();
<a id="L1115" name="L1115"></a>1115         <strong class="reserved">int</strong> n = 0;
<a id="L1116" name="L1116"></a>1116         <strong class="reserved">for</strong> (E e; (e = <a href="../D/29402.html" title="Multiple defined in 36 places.">poll</a>()) != <strong class="reserved">null</strong>;) <em class="brace">{</em>
<a id="L1117" name="L1117"></a>1117             <a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a>.<a href="../D/10632.html" title="Multiple defined in 301 places.">add</a>(e);
<a id="L1118" name="L1118"></a>1118             ++n;
<a id="L1119" name="L1119"></a>1119         <em class="brace">}</em>
<a id="L1120" name="L1120"></a>1120         <strong class="reserved">return</strong> n;
<a id="L1121" name="L1121"></a>1121     <em class="brace">}</em>
<a id="L1122" name="L1122"></a>1122 
<div class="comment">
      @throws UnsupportedOperationException {@inheritDoc}
      @throws ClassCastException            {@inheritDoc}
      @throws NullPointerException          {@inheritDoc}
      @throws IllegalArgumentException      {@inheritDoc}</div>
<a id="L1129" name="L1129"></a>1129     <strong class="reserved">public</strong> <strong class="reserved">int</strong> <a href="../R/13516.html" title="Multiple referred from 5 places.">drainTo</a>(<a href="../S/875.html#L144" title="Defined at 144 in src/java/util/Collection.java.">Collection</a>&lt;? <strong class="reserved">super</strong> E&gt; <a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a>, <strong class="reserved">int</strong> maxElements) <em class="brace">{</em>
<a id="L1130" name="L1130"></a>1130         <strong class="reserved">if</strong> (<a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a> == <strong class="reserved">null</strong>)
<a id="L1131" name="L1131"></a>1131             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1559.html#L53" title="Defined at 53 in src/java/lang/NullPointerException.java.">NullPointerException</a>();
<a id="L1132" name="L1132"></a>1132         <strong class="reserved">if</strong> (<a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a> == <strong class="reserved">this</strong>)
<a id="L1133" name="L1133"></a>1133             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../D/4055.html" title="Multiple defined in 2 places.">IllegalArgumentException</a>();
<a id="L1134" name="L1134"></a>1134         <strong class="reserved">int</strong> n = 0;
<a id="L1135" name="L1135"></a>1135         <strong class="reserved">for</strong> (E e; n &lt; maxElements &amp;&amp; (e = <a href="../D/29402.html" title="Multiple defined in 36 places.">poll</a>()) != <strong class="reserved">null</strong>;) <em class="brace">{</em>
<a id="L1136" name="L1136"></a>1136             <a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a>.<a href="../D/10632.html" title="Multiple defined in 301 places.">add</a>(e);
<a id="L1137" name="L1137"></a>1137             ++n;
<a id="L1138" name="L1138"></a>1138         <em class="brace">}</em>
<a id="L1139" name="L1139"></a>1139         <strong class="reserved">return</strong> n;
<a id="L1140" name="L1140"></a>1140     <em class="brace">}</em>
<a id="L1141" name="L1141"></a>1141 
<div class="comment">
      To cope with serialization strategy in the 1.5 version of
      SynchronousQueue, we declare some unused classes and fields
      that exist solely to enable serializability across versions.
      These fields are never used, so are initialized only if this
      object is ever serialized or deserialized.</div>
<a id="L1149" name="L1149"></a>1149 
<a id="L1150" name="L1150"></a>1150     @<a href="../R/7764.html" title="Multiple referred from 264 places.">SuppressWarnings</a>("serial")
<a id="L1151" name="L1151"></a>1151     <strong class="reserved">static</strong> <strong class="reserved">class</strong> <a href="../R/8721.html" title="Multiple referred from 4 places.">WaitQueue</a> <strong class="reserved">implements</strong> <a href="../S/3625.html#L43" title="Defined at 43 in src/javax/management/remote/rmi/RMIConnectionImpl_Stub.java.">java</a>.io.<a href="../S/1407.html#L169" title="Defined at 169 in src/java/io/Serializable.java.">Serializable</a> <em class="brace">{</em> <em class="brace">}</em>
<a id="L1152" name="L1152"></a>1152     <strong class="reserved">static</strong> <strong class="reserved">class</strong> <a href="../R/4574.html" title="Multiple referred from 2 places.">LifoWaitQueue</a> <strong class="reserved">extends</strong> <a href="../S/1123.html#L1151" title="Defined at 1151 in src/java/util/concurrent/SynchronousQueue.java.">WaitQueue</a> <em class="brace">{</em>
<a id="L1153" name="L1153"></a>1153         <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> serialVersionUID = -3633113410248163686L;
<a id="L1154" name="L1154"></a>1154     <em class="brace">}</em>
<a id="L1155" name="L1155"></a>1155     <strong class="reserved">static</strong> <strong class="reserved">class</strong> <a href="../R/2895.html" title="Multiple referred from 3 places.">FifoWaitQueue</a> <strong class="reserved">extends</strong> <a href="../S/1123.html#L1151" title="Defined at 1151 in src/java/util/concurrent/SynchronousQueue.java.">WaitQueue</a> <em class="brace">{</em>
<a id="L1156" name="L1156"></a>1156         <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> serialVersionUID = -3623113410248163686L;
<a id="L1157" name="L1157"></a>1157     <em class="brace">}</em>
<a id="L1158" name="L1158"></a>1158     <strong class="reserved">private</strong> <a href="../S/1047.html#L106" title="Defined at 106 in src/java/util/concurrent/locks/ReentrantLock.java.">ReentrantLock</a> qlock;
<a id="L1159" name="L1159"></a>1159     <strong class="reserved">private</strong> <a href="../S/1123.html#L1151" title="Defined at 1151 in src/java/util/concurrent/SynchronousQueue.java.">WaitQueue</a> waitingProducers;
<a id="L1160" name="L1160"></a>1160     <strong class="reserved">private</strong> <a href="../S/1123.html#L1151" title="Defined at 1151 in src/java/util/concurrent/SynchronousQueue.java.">WaitQueue</a> waitingConsumers;
<a id="L1161" name="L1161"></a>1161 
<div class="comment">
      Saves this queue to a stream (that is, serializes it).
      @param s the stream
      @throws java.io.IOException if an I/O error occurs</div>
<a id="L1167" name="L1167"></a>1167     <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../R/30680.html" title="Multiple referred from 184 places.">writeObject</a>(<a href="../S/3625.html#L43" title="Defined at 43 in src/javax/management/remote/rmi/RMIConnectionImpl_Stub.java.">java</a>.io.<a href="../S/1381.html#L162" title="Defined at 162 in src/java/io/ObjectOutputStream.java.">ObjectOutputStream</a> s)
<a id="L1168" name="L1168"></a>1168         <strong class="reserved">throws</strong> <a href="../S/3625.html#L43" title="Defined at 43 in src/javax/management/remote/rmi/RMIConnectionImpl_Stub.java.">java</a>.io.<a href="../S/1392.html#L39" title="Defined at 39 in src/java/io/IOException.java.">IOException</a> <em class="brace">{</em>
<a id="L1169" name="L1169"></a>1169         <strong class="reserved">boolean</strong> fair = transferer <strong class="reserved">instanceof</strong> <a href="../D/9058.html" title="Multiple defined in 2 places.">TransferQueue</a>;
<a id="L1170" name="L1170"></a>1170         <strong class="reserved">if</strong> (fair) <em class="brace">{</em>
<a id="L1171" name="L1171"></a>1171             qlock = <strong class="reserved">new</strong> <a href="../S/1047.html#L106" title="Defined at 106 in src/java/util/concurrent/locks/ReentrantLock.java.">ReentrantLock</a>(<strong class="reserved">true</strong>);
<a id="L1172" name="L1172"></a>1172             waitingProducers = <strong class="reserved">new</strong> <a href="../S/1123.html#L1155" title="Defined at 1155 in src/java/util/concurrent/SynchronousQueue.java.">FifoWaitQueue</a>();
<a id="L1173" name="L1173"></a>1173             waitingConsumers = <strong class="reserved">new</strong> <a href="../S/1123.html#L1155" title="Defined at 1155 in src/java/util/concurrent/SynchronousQueue.java.">FifoWaitQueue</a>();
<a id="L1174" name="L1174"></a>1174         <em class="brace">}</em>
<a id="L1175" name="L1175"></a>1175         <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L1176" name="L1176"></a>1176             qlock = <strong class="reserved">new</strong> <a href="../S/1047.html#L106" title="Defined at 106 in src/java/util/concurrent/locks/ReentrantLock.java.">ReentrantLock</a>();
<a id="L1177" name="L1177"></a>1177             waitingProducers = <strong class="reserved">new</strong> <a href="../S/1123.html#L1152" title="Defined at 1152 in src/java/util/concurrent/SynchronousQueue.java.">LifoWaitQueue</a>();
<a id="L1178" name="L1178"></a>1178             waitingConsumers = <strong class="reserved">new</strong> <a href="../S/1123.html#L1152" title="Defined at 1152 in src/java/util/concurrent/SynchronousQueue.java.">LifoWaitQueue</a>();
<a id="L1179" name="L1179"></a>1179         <em class="brace">}</em>
<a id="L1180" name="L1180"></a>1180         s.<a href="../D/14752.html" title="Multiple defined in 6 places.">defaultWriteObject</a>();
<a id="L1181" name="L1181"></a>1181     <em class="brace">}</em>
<a id="L1182" name="L1182"></a>1182 
<div class="comment">
      Reconstitutes this queue from a stream (that is, deserializes it).
      @param s the stream
      @throws ClassNotFoundException if the class of a serialized object
              could not be found
      @throws java.io.IOException if an I/O error occurs</div>
<a id="L1190" name="L1190"></a>1190     <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../R/25518.html" title="Multiple referred from 189 places.">readObject</a>(<a href="../S/3625.html#L43" title="Defined at 43 in src/javax/management/remote/rmi/RMIConnectionImpl_Stub.java.">java</a>.io.<a href="../S/1378.html#L206" title="Defined at 206 in src/java/io/ObjectInputStream.java.">ObjectInputStream</a> s)
<a id="L1191" name="L1191"></a>1191         <strong class="reserved">throws</strong> <a href="../S/3625.html#L43" title="Defined at 43 in src/javax/management/remote/rmi/RMIConnectionImpl_Stub.java.">java</a>.io.<a href="../S/1392.html#L39" title="Defined at 39 in src/java/io/IOException.java.">IOException</a>, <a href="../S/1705.html#L53" title="Defined at 53 in src/java/lang/ClassNotFoundException.java.">ClassNotFoundException</a> <em class="brace">{</em>
<a id="L1192" name="L1192"></a>1192         s.<a href="../D/14746.html" title="Multiple defined in 2 places.">defaultReadObject</a>();
<a id="L1193" name="L1193"></a>1193         <strong class="reserved">if</strong> (waitingProducers <strong class="reserved">instanceof</strong> <a href="../S/1123.html#L1155" title="Defined at 1155 in src/java/util/concurrent/SynchronousQueue.java.">FifoWaitQueue</a>)
<a id="L1194" name="L1194"></a>1194             transferer = <strong class="reserved">new</strong> <a href="../D/9058.html" title="Multiple defined in 2 places.">TransferQueue</a>&lt;E&gt;();
<a id="L1195" name="L1195"></a>1195         <strong class="reserved">else</strong>
<a id="L1196" name="L1196"></a>1196             transferer = <strong class="reserved">new</strong> <a href="../S/1123.html#L211" title="Defined at 211 in src/java/util/concurrent/SynchronousQueue.java.">TransferStack</a>&lt;E&gt;();
<a id="L1197" name="L1197"></a>1197     <em class="brace">}</em>
<a id="L1198" name="L1198"></a>1198 
<a id="L1199" name="L1199"></a>1199     <em class="comment">// Unsafe mechanics</em>
<a id="L1200" name="L1200"></a>1200     <strong class="reserved">static</strong> <strong class="reserved">long</strong> <a href="../R/23876.html" title="Multiple referred from 141 places.">objectFieldOffset</a>(sun.misc.Unsafe UNSAFE,
<a id="L1201" name="L1201"></a>1201                                   <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> field, <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; klazz) <em class="brace">{</em>
<a id="L1202" name="L1202"></a>1202         <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L1203" name="L1203"></a>1203             <strong class="reserved">return</strong> UNSAFE.<a href="../D/28395.html" title="Multiple defined in 5 places.">objectFieldOffset</a>(klazz.<a href="../S/1722.html#L2065" title="Defined at 2065 in src/java/lang/Class.java.">getDeclaredField</a>(field));
<a id="L1204" name="L1204"></a>1204         <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/1573.html#L34" title="Defined at 34 in src/java/lang/NoSuchFieldException.java.">NoSuchFieldException</a> e) <em class="brace">{</em>
<a id="L1205" name="L1205"></a>1205             <em class="comment">// Convert Exception to corresponding Error</em>
<a id="L1206" name="L1206"></a>1206             <a href="../S/1734.html#L40" title="Defined at 40 in src/java/lang/NoSuchFieldError.java.">NoSuchFieldError</a> <a href="../D/15699.html" title="Multiple defined in 51 places.">error</a> = <strong class="reserved">new</strong> <a href="../S/1734.html#L40" title="Defined at 40 in src/java/lang/NoSuchFieldError.java.">NoSuchFieldError</a>(field);
<a id="L1207" name="L1207"></a>1207             <a href="../D/15699.html" title="Multiple defined in 51 places.">error</a>.<a href="../D/24507.html" title="Multiple defined in 7 places.">initCause</a>(e);
<a id="L1208" name="L1208"></a>1208             <strong class="reserved">throw</strong> <a href="../D/15699.html" title="Multiple defined in 51 places.">error</a>;
<a id="L1209" name="L1209"></a>1209         <em class="brace">}</em>
<a id="L1210" name="L1210"></a>1210     <em class="brace">}</em>
<a id="L1211" name="L1211"></a>1211 
<a id="L1212" name="L1212"></a>1212 <em class="brace">}</em>
</pre>
<hr>
<div class="comment">
/* [&lt;][&gt;]<a href="#L182">[^]</a><a href="#L1200">[v]</a><a href="#TOP">[top]</a>[bottom]<a href="../mains.html">[index]</a><a href="../help.html">[help]</a> */</div>
</body></html>