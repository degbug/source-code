<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
<title>src/java/util/concurrent/Exchanger.java</title>
<meta name="robots" content="noindex,nofollow">
<meta name="generator" content="GLOBAL-6.6.3">
<meta http-equiv="Content-Style-Type" content="text/css">
<link rel="stylesheet" type="text/css" href="../style.css">
</head>
<body>
<a id="TOP" name="TOP"></a><div class="comment">
/* [&lt;][&gt;]<a href="#L325">[^]</a><a href="#L615">[v]</a>[top]<a href="#BOTTOM">[bottom]</a><a href="../mains.html">[index]</a><a href="../help.html">[help]</a> */</div>
<hr>
<h2 class="header">DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href="#L325" title="Defined at 325.">initialValue</a></li>
<li><a href="#L361" title="Defined at 361.">arenaExchange</a></li>
<li><a href="#L454" title="Defined at 454.">slotExchange</a></li>
<li><a href="#L560" title="Defined at 560.">SuppressWarnings</a></li>
<li><a href="#L561" title="Defined at 561.">exchange</a></li>
<li><a href="#L614" title="Defined at 614.">SuppressWarnings</a></li>
<li><a href="#L615" title="Defined at 615.">exchange</a></li>
</ol>
<hr>
<pre>
<div class="comment">
  ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.</div>
<a id="L24" name="L24"></a>  24 
<div class="comment">
  Written by Doug Lea, Bill Scherer, and Michael Scott with
  assistance from members of JCP JSR-166 Expert Group and released to
  the public domain, as explained at
  http://creativecommons.org/publicdomain/zero/1.0/</div>
<a id="L36" name="L36"></a>  36 
<a id="L37" name="L37"></a>  37 <strong class="reserved">package</strong> <a href="../S/3625.html#L43" title="Defined at 43 in src/javax/management/remote/rmi/RMIConnectionImpl_Stub.java.">java</a>.util.concurrent;
<a id="L38" name="L38"></a>  38 <strong class="reserved">import</strong> java.util.concurrent.atomic.AtomicInteger;
<a id="L39" name="L39"></a>  39 <strong class="reserved">import</strong> java.util.concurrent.atomic.AtomicReference;
<a id="L40" name="L40"></a>  40 <strong class="reserved">import</strong> java.util.concurrent.locks.LockSupport;
<a id="L41" name="L41"></a>  41 
<div class="comment">
  A synchronization point at which threads can pair and swap elements
  within pairs.  Each thread presents some object on entry to the
  <a href="#L561" title="Defined at 561.">exchange</a> method, matches with a partner thread,
  and receives its partner's object on return.  An Exchanger may be
  viewed as a bidirectional form of a {@link SynchronousQueue}.
  Exchangers may be useful in applications such as genetic algorithms
  and pipeline designs.
  <p><b>Sample Usage:</b>
  Here are the highlights of a class that uses an <code>Exchanger</code>
  to swap buffers between threads so that the thread filling the
  buffer gets a freshly emptied one when it needs it, handing off the
  filled one to the thread emptying the buffer.
   </p><pre> {@code
  class FillAndEmpty {
    Exchanger<databuffer> exchanger = new Exchanger<databuffer>();
    DataBuffer initialEmptyBuffer = ... a made-up type
    DataBuffer initialFullBuffer = ...
    class FillingLoop implements Runnable {
      public void run() {
        DataBuffer currentBuffer = initialEmptyBuffer;
        try {
          while (currentBuffer != null) {
            addToBuffer(currentBuffer);
            if (currentBuffer.isFull())
              currentBuffer = exchanger.exchange(currentBuffer);
          }
        } catch (InterruptedException ex) { ... handle ... }
      }
    }
    class EmptyingLoop implements Runnable {
      public void run() {
        DataBuffer currentBuffer = initialFullBuffer;
        try {
          while (currentBuffer != null) {
            takeFromBuffer(currentBuffer);
            if (currentBuffer.isEmpty())
              currentBuffer = exchanger.exchange(currentBuffer);
          }
        } catch (InterruptedException ex) { ... handle ...}
      }
    }
    void start() {
      new Thread(new FillingLoop()).start();
      new Thread(new EmptyingLoop()).start();
    }
  }}</databuffer></databuffer></pre>
  <p>Memory consistency effects: For each pair of threads that
  successfully exchange objects via an <code>Exchanger</code>, actions
  prior to the <code>exchange()</code> in each thread
  <a href="package-summary.html#MemoryVisibility"><i>happen-before</i></a>
  those subsequent to a return from the corresponding <code>exchange()</code>
  in the other thread.
  @since 1.5
  @author Doug Lea and Bill Scherer and Michael Scott
  @param <v> The type of objects that may be exchanged</v></p></div>
<a id="L105" name="L105"></a> 105 <strong class="reserved">public</strong> <strong class="reserved">class</strong> <a href="../S/1060.html#L641" title="Referred from 641 in src/java/util/concurrent/Exchanger.java.">Exchanger</a>&lt;V&gt; <em class="brace">{</em>
<a id="L106" name="L106"></a> 106 
<div class="comment">
      Overview: The core algorithm is, for an exchange "slot",
      and a participant (caller) with an item:
      for (;;) {
        if (slot is empty) {                       // offer
          place item in a Node;
          if (can CAS slot from empty to node) {
            wait for release;
            return matching item in node;
          }
        }
        else if (can CAS slot from node to empty) { // release
          get the item in node;
          set matching item in node;
          release waiting thread;
        }
        // else retry on CAS failure
      }
      This is among the simplest forms of a "dual data structure" --
      see Scott and Scherer's DISC 04 paper and
      http://www.cs.rochester.edu/research/synchronization/pseudocode/duals.html
      This works great in principle. But in practice, like many
      algorithms centered on atomic updates to a single location, it
      scales horribly when there are more than a few participants
      using the same Exchanger. So the implementation instead uses a
      form of elimination arena, that spreads out this contention by
      arranging that some threads typically use different slots,
      while still ensuring that eventually, any two parties will be
      able to exchange items. That is, we cannot completely partition
      across threads, but instead give threads arena indices that
      will on average grow under contention and shrink under lack of
      contention. We approach this by defining the Nodes that we need
      anyway as ThreadLocals, and include in them per-thread index
      and related bookkeeping state. (We can safely reuse per-thread
      nodes rather than creating them fresh each time because slots
      alternate between pointing to a node vs null, so cannot
      encounter ABA problems. However, we do need some care in
      resetting them between uses.)
      Implementing an effective arena requires allocating a bunch of
      space, so we only do so upon detecting contention (except on
      uniprocessors, where they wouldn't help, so aren't used).
      Otherwise, exchanges use the single-slot slotExchange method.
      On contention, not only must the slots be in different
      locations, but the locations must not encounter memory
      contention due to being on the same cache line (or more
      generally, the same coherence unit).  Because, as of this
      writing, there is no way to determine cacheline size, we define
      a value that is enough for common platforms.  Additionally,
      extra care elsewhere is taken to avoid other false/unintended
      sharing and to enhance locality, including adding padding (via
      sun.misc.Contended) to Nodes, embedding "bound" as an Exchanger
      field, and reworking some park/unpark mechanics compared to
      LockSupport versions.
      The arena starts out with only one used slot. We expand the
      effective arena size by tracking collisions; i.e., failed CASes
      while trying to exchange. By nature of the above algorithm, the
      only kinds of collision that reliably indicate contention are
      when two attempted releases collide -- one of two attempted
      offers can legitimately fail to CAS without indicating
      contention by more than one other thread. (Note: it is possible
      but not worthwhile to more precisely detect contention by
      reading slot values after CAS failures.)  When a thread has
      collided at each slot within the current arena bound, it tries
      to expand the arena size by one. We track collisions within
      bounds by using a version (sequence) number on the "bound"
      field, and conservatively reset collision counts when a
      participant notices that bound has been updated (in either
      direction).
      The effective arena size is reduced (when there is more than
      one slot) by giving up on waiting after a while and trying to
      decrement the arena size on expiration. The value of "a while"
      is an empirical matter.  We implement by piggybacking on the
      use of spin-&gt;yield-&gt;block that is essential for reasonable
      waiting performance anyway -- in a busy exchanger, offers are
      usually almost immediately released, in which case context
      switching on multiprocessors is extremely slow/wasteful.  Arena
      waits just omit the blocking part, and instead cancel. The spin
      count is empirically chosen to be a value that avoids blocking
      99% of the time under maximum sustained exchange rates on a
      range of test machines. Spins and yields entail some limited
      randomness (using a cheap xorshift) to avoid regular patterns
      that can induce unproductive grow/shrink cycles. (Using a
      pseudorandom also helps regularize spin cycle duration by
      making branches unpredictable.)  Also, during an offer, a
      waiter can "know" that it will be released when its slot has
      changed, but cannot yet proceed until match is set.  In the
      mean time it cannot cancel the offer, so instead spins/yields.
      Note: It is possible to avoid this secondary check by changing
      the linearization point to be a CAS of the match field (as done
      in one case in the Scott &amp; Scherer DISC paper), which also
      increases asynchrony a bit, at the expense of poorer collision
      detection and inability to always reuse per-thread nodes. So
      the current scheme is typically a better tradeoff.
      On collisions, indices traverse the arena cyclically in reverse
      order, restarting at the maximum index (which will tend to be
      sparsest) when bounds change. (On expirations, indices instead
      are halved until reaching 0.) It is possible (and has been
      tried) to use randomized, prime-value-stepped, or double-hash
      style traversal instead of simple cyclic traversal to reduce
      bunching.  But empirically, whatever benefits these may have
      don't overcome their added overhead: We are managing operations
      that occur very quickly unless there is sustained contention,
      so simpler/faster control policies work better than more
      accurate but slower ones.
      Because we use expiration for arena size control, we cannot
      throw TimeoutExceptions in the timed version of the public
      exchange method until the arena size has shrunken to zero (or
      the arena isn't enabled). This may delay response to timeout
      but is still within spec.
      Essentially all of the implementation is in methods
      slotExchange and arenaExchange. These have similar overall
      structure, but differ in too many details to combine. The
      slotExchange method uses the single Exchanger field "slot"
      rather than arena array elements. However, it still needs
      minimal collision detection to trigger arena construction.
      (The messiest part is making sure interrupt status and
      InterruptedExceptions come out right during transitions when
      both methods may be called. This is done by using null return
      as a sentinel to recheck interrupt status.)
      As is too common in this sort of code, methods are monolithic
      because most of the logic relies on reads of fields that are
      maintained as local variables so can't be nicely factored --
      mainly, here, bulky spin-&gt;yield-&gt;block/cancel code), and
      heavily dependent on intrinsics (Unsafe) to use inlined
      embedded CAS and related memory access operations (that tend
      not to be as readily inlined by dynamic compilers when they are
      hidden behind other methods that would more nicely name and
      encapsulate the intended effects). This includes the use of
      putOrderedX to clear fields of the per-thread Nodes between
      uses. Note that field Node.item is not declared as volatile
      even though it is read by releasing threads, because they only
      do so after CAS operations that must precede access, and all
      uses by the owning thread are otherwise acceptably ordered by
      other operations. (Because the actual points of atomicity are
      slot CASes, it would also be legal for the write to Node.match
      in a release to be weaker than a full volatile write. However,
      this is not done because it could allow further postponement of
      the write, delaying progress.)</div>
<a id="L256" name="L256"></a> 256 
<div class="comment">
      The byte distance (as a shift value) between any two used slots
      in the arena.  1 &lt;&lt; ASHIFT should be at least cacheline size.</div>
<a id="L261" name="L261"></a> 261     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> ASHIFT = 7;
<a id="L262" name="L262"></a> 262 
<div class="comment">
      The maximum supported arena index. The maximum allocatable
      arena size is MMASK + 1. Must be a power of two minus one, less
      than (1&lt;&lt;(31-ASHIFT)). The cap of 255 (0xff) more than suffices
      for the expected scaling limits of the main algorithms.</div>
<a id="L269" name="L269"></a> 269     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> MMASK = 0xff;
<a id="L270" name="L270"></a> 270 
<div class="comment">
      Unit for sequence/version bits of bound field. Each successful
      change to the bound also adds SEQ.</div>
<a id="L275" name="L275"></a> 275     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> SEQ = MMASK + 1;
<a id="L276" name="L276"></a> 276 
<div class="comment">
     /** The number of CPUs, for sizing and spin control */</div>
<a id="L278" name="L278"></a> 278     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> NCPU = <a href="../S/1774.html#L46" title="Defined at 46 in src/java/lang/Runtime.java.">Runtime</a>.<a href="../S/1774.html#L57" title="Defined at 57 in src/java/lang/Runtime.java.">getRuntime</a>().<a href="../S/1774.html#L635" title="Defined at 635 in src/java/lang/Runtime.java.">availableProcessors</a>();
<a id="L279" name="L279"></a> 279 
<div class="comment">
      The maximum slot index of the arena: The number of slots that
      can in principle hold all threads without contention, or at
      most the maximum indexable value.</div>
<a id="L285" name="L285"></a> 285     <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> <a href="../S/1535.html#L94" title="Defined at 94 in src/java/time/format/TextStyle.java.">FULL</a> = (NCPU &gt;= (MMASK &lt;&lt; 1)) ? MMASK : NCPU &gt;&gt;&gt; 1;
<a id="L286" name="L286"></a> 286 
<div class="comment">
      The bound for spins while waiting for a match. The actual
      number of iterations will on average be about twice this value
      due to randomization. Note: Spinning is disabled when NCPU==1.</div>
<a id="L292" name="L292"></a> 292     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> SPINS = 1 &lt;&lt; 10;
<a id="L293" name="L293"></a> 293 
<div class="comment">
      Value representing null arguments/returns from public
      methods. Needed because the API originally didn't disallow null
      arguments, which it should have.</div>
<a id="L299" name="L299"></a> 299     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> NULL_ITEM = <strong class="reserved">new</strong> <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a>();
<a id="L300" name="L300"></a> 300 
<div class="comment">
      Sentinel value returned by internal exchange methods upon
      timeout, to avoid need for separate timed versions of these
      methods.</div>
<a id="L306" name="L306"></a> 306     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> TIMED_OUT = <strong class="reserved">new</strong> <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a>();
<a id="L307" name="L307"></a> 307 
<div class="comment">
      Nodes hold partially exchanged data, plus other per-thread
      bookkeeping. Padded via @sun.misc.Contended to reduce memory
      contention.</div>
<a id="L313" name="L313"></a> 313     @sun.misc.<a href="../D/1850.html" title="Multiple defined in 3 places.">Contended</a> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">class</strong> <a href="../R/5542.html" title="Multiple referred from 4060 places.">Node</a> <em class="brace">{</em>
<a id="L314" name="L314"></a> 314         <strong class="reserved">int</strong> <a href="../D/24461.html" title="Multiple defined in 6 places.">index</a>;              <em class="comment">// Arena index</em>
<a id="L315" name="L315"></a> 315         <strong class="reserved">int</strong> bound;              <em class="comment">// Last recorded value of Exchanger.bound</em>
<a id="L316" name="L316"></a> 316         <strong class="reserved">int</strong> collides;           <em class="comment">// Number of CAS failures at current bound</em>
<a id="L317" name="L317"></a> 317         <strong class="reserved">int</strong> <a href="../D/24219.html" title="Multiple defined in 17 places.">hash</a>;               <em class="comment">// Pseudo-random for spins</em>
<a id="L318" name="L318"></a> 318         <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>;            <em class="comment">// This thread's current item</em>
<a id="L319" name="L319"></a> 319         <strong class="reserved">volatile</strong> <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../D/27519.html" title="Multiple defined in 69 places.">match</a>;  <em class="comment">// Item provided by releasing thread</em>
<a id="L320" name="L320"></a> 320         <strong class="reserved">volatile</strong> <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a> parked; <em class="comment">// Set to this thread when parked, else null</em>
<a id="L321" name="L321"></a> 321     <em class="brace">}</em>
<a id="L322" name="L322"></a> 322 
<div class="comment">
     /** The corresponding thread local class */</div>
<a id="L324" name="L324"></a> 324     <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">class</strong> <a href="../R/6060.html" title="Multiple referred from 2 places.">Participant</a> <strong class="reserved">extends</strong> <a href="../S/1738.html#L74" title="Defined at 74 in src/java/lang/ThreadLocal.java.">ThreadLocal</a>&lt;<a href="../D/6077.html" title="Multiple defined in 24 places.">Node</a>&gt; <em class="brace">{</em>
<a id="L325" name="L325"></a> 325         <strong class="reserved">public</strong> <a href="../D/6077.html" title="Multiple defined in 24 places.">Node</a> <a href="../R/20680.html" title="Multiple referred from 271 places.">initialValue</a>() <em class="brace">{</em> <strong class="reserved">return</strong> <strong class="reserved">new</strong> <a href="../D/6077.html" title="Multiple defined in 24 places.">Node</a>(); <em class="brace">}</em>
<a id="L326" name="L326"></a> 326     <em class="brace">}</em>
<a id="L327" name="L327"></a> 327 
<div class="comment">
      Per-thread state</div>
<a id="L331" name="L331"></a> 331     <strong class="reserved">private</strong> <strong class="reserved">final</strong> <a href="../S/1060.html#L324" title="Defined at 324 in src/java/util/concurrent/Exchanger.java.">Participant</a> participant;
<a id="L332" name="L332"></a> 332 
<div class="comment">
      Elimination array; null until enabled (within slotExchange).
      Element accesses use emulation of volatile gets and CAS.</div>
<a id="L337" name="L337"></a> 337     <strong class="reserved">private</strong> <strong class="reserved">volatile</strong> <a href="../D/6077.html" title="Multiple defined in 24 places.">Node</a>[] arena;
<a id="L338" name="L338"></a> 338 
<div class="comment">
      Slot used until contention detected.</div>
<a id="L342" name="L342"></a> 342     <strong class="reserved">private</strong> <strong class="reserved">volatile</strong> <a href="../D/6077.html" title="Multiple defined in 24 places.">Node</a> slot;
<a id="L343" name="L343"></a> 343 
<div class="comment">
      The index of the largest valid arena position, OR'ed with SEQ
      number in high bits, incremented on each update.  The initial
      update from 0 to SEQ is used to ensure that the arena array is
      constructed only once.</div>
<a id="L350" name="L350"></a> 350     <strong class="reserved">private</strong> <strong class="reserved">volatile</strong> <strong class="reserved">int</strong> bound;
<a id="L351" name="L351"></a> 351 
<div class="comment">
      Exchange function when arenas enabled. See above for explanation.
      @param item the (non-null) item to exchange
      @param timed true if the wait is timed
      @param ns if timed, the maximum wait time, else 0L
      @return the other thread's item; or null if interrupted; or
      TIMED_OUT if timed and timed out</div>
<a id="L361" name="L361"></a> 361     <strong class="reserved">private</strong> <strong class="reserved">final</strong> <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../R/10296.html" title="Multiple referred from 2 places.">arenaExchange</a>(<a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>, <strong class="reserved">boolean</strong> timed, <strong class="reserved">long</strong> ns) <em class="brace">{</em>
<a id="L362" name="L362"></a> 362         <a href="../D/6077.html" title="Multiple defined in 24 places.">Node</a>[] <a href="../D/10513.html" title="Multiple defined in 3 places.">a</a> = arena;
<a id="L363" name="L363"></a> 363         <a href="../D/6077.html" title="Multiple defined in 24 places.">Node</a> p = participant.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>();
<a id="L364" name="L364"></a> 364         <strong class="reserved">for</strong> (<strong class="reserved">int</strong> i = p.<a href="../D/24461.html" title="Multiple defined in 6 places.">index</a>;;) <em class="brace">{</em>                      <em class="comment">// access slot at i</em>
<a id="L365" name="L365"></a> 365             <strong class="reserved">int</strong> b, m, <a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a>; <strong class="reserved">long</strong> j;                       <em class="comment">// j is raw array offset</em>
<a id="L366" name="L366"></a> 366             <a href="../D/6077.html" title="Multiple defined in 24 places.">Node</a> q = (<a href="../D/6077.html" title="Multiple defined in 24 places.">Node</a>)U.getObjectVolatile(<a href="../D/10513.html" title="Multiple defined in 3 places.">a</a>, j = (i &lt;&lt; ASHIFT) + ABASE);
<a id="L367" name="L367"></a> 367             <strong class="reserved">if</strong> (q != <strong class="reserved">null</strong> &amp;&amp; U.compareAndSwapObject(<a href="../D/10513.html" title="Multiple defined in 3 places.">a</a>, j, q, <strong class="reserved">null</strong>)) <em class="brace">{</em>
<a id="L368" name="L368"></a> 368                 <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> v = q.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>;                     <em class="comment">// release</em>
<a id="L369" name="L369"></a> 369                 q.<a href="../D/27519.html" title="Multiple defined in 69 places.">match</a> = <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>;
<a id="L370" name="L370"></a> 370                 <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a> w = q.parked;
<a id="L371" name="L371"></a> 371                 <strong class="reserved">if</strong> (w != <strong class="reserved">null</strong>)
<a id="L372" name="L372"></a> 372                     U.<a href="../S/1045.html#L139" title="Defined at 139 in src/java/util/concurrent/locks/LockSupport.java.">unpark</a>(w);
<a id="L373" name="L373"></a> 373                 <strong class="reserved">return</strong> v;
<a id="L374" name="L374"></a> 374             <em class="brace">}</em>
<a id="L375" name="L375"></a> 375             <strong class="reserved">else</strong> <strong class="reserved">if</strong> (i &lt;= (m = (b = bound) &amp; MMASK) &amp;&amp; q == <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L376" name="L376"></a> 376                 p.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> = <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>;                         <em class="comment">// offer</em>
<a id="L377" name="L377"></a> 377                 <strong class="reserved">if</strong> (U.compareAndSwapObject(<a href="../D/10513.html" title="Multiple defined in 3 places.">a</a>, j, <strong class="reserved">null</strong>, p)) <em class="brace">{</em>
<a id="L378" name="L378"></a> 378                     <strong class="reserved">long</strong> <a href="../D/15431.html" title="Multiple defined in 52 places.">end</a> = (timed &amp;&amp; m == 0) ? <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1557.html#L399" title="Defined at 399 in src/java/lang/System.java.">nanoTime</a>() + ns : 0L;
<a id="L379" name="L379"></a> 379                     <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a> t = <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L264" title="Defined at 264 in src/java/lang/Thread.java.">currentThread</a>(); <em class="comment">// wait</em>
<a id="L380" name="L380"></a> 380                     <strong class="reserved">for</strong> (<strong class="reserved">int</strong> h = p.<a href="../D/24219.html" title="Multiple defined in 17 places.">hash</a>, spins = SPINS;;) <em class="brace">{</em>
<a id="L381" name="L381"></a> 381                         <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> v = p.<a href="../D/27519.html" title="Multiple defined in 69 places.">match</a>;
<a id="L382" name="L382"></a> 382                         <strong class="reserved">if</strong> (v != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L383" name="L383"></a> 383                             U.putOrderedObject(p, MATCH, <strong class="reserved">null</strong>);
<a id="L384" name="L384"></a> 384                             p.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> = <strong class="reserved">null</strong>;             <em class="comment">// clear for next use</em>
<a id="L385" name="L385"></a> 385                             p.<a href="../D/24219.html" title="Multiple defined in 17 places.">hash</a> = h;
<a id="L386" name="L386"></a> 386                             <strong class="reserved">return</strong> v;
<a id="L387" name="L387"></a> 387                         <em class="brace">}</em>
<a id="L388" name="L388"></a> 388                         <strong class="reserved">else</strong> <strong class="reserved">if</strong> (spins &gt; 0) <em class="brace">{</em>
<a id="L389" name="L389"></a> 389                             h ^= h &lt;&lt; 1; h ^= h &gt;&gt;&gt; 3; h ^= h &lt;&lt; 10; <em class="comment">// xorshift</em>
<a id="L390" name="L390"></a> 390                             <strong class="reserved">if</strong> (h == 0)                <em class="comment">// initialize hash</em>
<a id="L391" name="L391"></a> 391                                 h = SPINS | (<strong class="reserved">int</strong>)t.<a href="../D/19565.html" title="Multiple defined in 69 places.">getId</a>();
<a id="L392" name="L392"></a> 392                             <strong class="reserved">else</strong> <strong class="reserved">if</strong> (h &lt; 0 &amp;&amp;          <em class="comment">// approx 50% true</em>
<a id="L393" name="L393"></a> 393                                      (--spins &amp; ((SPINS &gt;&gt;&gt; 1) - 1)) == 0)
<a id="L394" name="L394"></a> 394                                 <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L282" title="Defined at 282 in src/java/lang/Thread.java.">yield</a>();        <em class="comment">// two yields per wait</em>
<a id="L395" name="L395"></a> 395                         <em class="brace">}</em>
<a id="L396" name="L396"></a> 396                         <strong class="reserved">else</strong> <strong class="reserved">if</strong> (U.getObjectVolatile(<a href="../D/10513.html" title="Multiple defined in 3 places.">a</a>, j) != p)
<a id="L397" name="L397"></a> 397                             spins = SPINS;       <em class="comment">// releaser hasn't set match yet</em>
<a id="L398" name="L398"></a> 398                         <strong class="reserved">else</strong> <strong class="reserved">if</strong> (!t.<a href="../D/25738.html" title="Multiple defined in 2 places.">isInterrupted</a>() &amp;&amp; m == 0 &amp;&amp;
<a id="L399" name="L399"></a> 399                                  (!timed ||
<a id="L400" name="L400"></a> 400                                   (ns = <a href="../D/15431.html" title="Multiple defined in 52 places.">end</a> - <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1557.html#L399" title="Defined at 399 in src/java/lang/System.java.">nanoTime</a>()) &gt; 0L)) <em class="brace">{</em>
<a id="L401" name="L401"></a> 401                             U.putObject(t, BLOCKER, <strong class="reserved">this</strong>); <em class="comment">// emulate LockSupport</em>
<a id="L402" name="L402"></a> 402                             p.parked = t;              <em class="comment">// minimize window</em>
<a id="L403" name="L403"></a> 403                             <strong class="reserved">if</strong> (U.getObjectVolatile(<a href="../D/10513.html" title="Multiple defined in 3 places.">a</a>, j) == p)
<a id="L404" name="L404"></a> 404                                 U.<a href="../D/29072.html" title="Multiple defined in 2 places.">park</a>(<strong class="reserved">false</strong>, ns);
<a id="L405" name="L405"></a> 405                             p.parked = <strong class="reserved">null</strong>;
<a id="L406" name="L406"></a> 406                             U.putObject(t, BLOCKER, <strong class="reserved">null</strong>);
<a id="L407" name="L407"></a> 407                         <em class="brace">}</em>
<a id="L408" name="L408"></a> 408                         <strong class="reserved">else</strong> <strong class="reserved">if</strong> (U.getObjectVolatile(<a href="../D/10513.html" title="Multiple defined in 3 places.">a</a>, j) == p &amp;&amp;
<a id="L409" name="L409"></a> 409                                  U.compareAndSwapObject(<a href="../D/10513.html" title="Multiple defined in 3 places.">a</a>, j, p, <strong class="reserved">null</strong>)) <em class="brace">{</em>
<a id="L410" name="L410"></a> 410                             <strong class="reserved">if</strong> (m != 0)                <em class="comment">// try to shrink</em>
<a id="L411" name="L411"></a> 411                                 U.compareAndSwapInt(<strong class="reserved">this</strong>, BOUND, b, b + SEQ - 1);
<a id="L412" name="L412"></a> 412                             p.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> = <strong class="reserved">null</strong>;
<a id="L413" name="L413"></a> 413                             p.<a href="../D/24219.html" title="Multiple defined in 17 places.">hash</a> = h;
<a id="L414" name="L414"></a> 414                             i = p.<a href="../D/24461.html" title="Multiple defined in 6 places.">index</a> &gt;&gt;&gt;= 1;        <em class="comment">// descend</em>
<a id="L415" name="L415"></a> 415                             <strong class="reserved">if</strong> (<a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L943" title="Defined at 943 in src/java/lang/Thread.java.">interrupted</a>())
<a id="L416" name="L416"></a> 416                                 <strong class="reserved">return</strong> <strong class="reserved">null</strong>;
<a id="L417" name="L417"></a> 417                             <strong class="reserved">if</strong> (timed &amp;&amp; m == 0 &amp;&amp; ns &lt;= 0L)
<a id="L418" name="L418"></a> 418                                 <strong class="reserved">return</strong> TIMED_OUT;
<a id="L419" name="L419"></a> 419                             <strong class="reserved">break</strong>;                     <em class="comment">// expired; restart</em>
<a id="L420" name="L420"></a> 420                         <em class="brace">}</em>
<a id="L421" name="L421"></a> 421                     <em class="brace">}</em>
<a id="L422" name="L422"></a> 422                 <em class="brace">}</em>
<a id="L423" name="L423"></a> 423                 <strong class="reserved">else</strong>
<a id="L424" name="L424"></a> 424                     p.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> = <strong class="reserved">null</strong>;                     <em class="comment">// clear offer</em>
<a id="L425" name="L425"></a> 425             <em class="brace">}</em>
<a id="L426" name="L426"></a> 426             <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L427" name="L427"></a> 427                 <strong class="reserved">if</strong> (p.bound != b) <em class="brace">{</em>                    <em class="comment">// stale; reset</em>
<a id="L428" name="L428"></a> 428                     p.bound = b;
<a id="L429" name="L429"></a> 429                     p.collides = 0;
<a id="L430" name="L430"></a> 430                     i = (i != m || m == 0) ? m : m - 1;
<a id="L431" name="L431"></a> 431                 <em class="brace">}</em>
<a id="L432" name="L432"></a> 432                 <strong class="reserved">else</strong> <strong class="reserved">if</strong> ((<a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a> = p.collides) &lt; m || m == <a href="../S/1535.html#L94" title="Defined at 94 in src/java/time/format/TextStyle.java.">FULL</a> ||
<a id="L433" name="L433"></a> 433                          !U.compareAndSwapInt(<strong class="reserved">this</strong>, BOUND, b, b + SEQ + 1)) <em class="brace">{</em>
<a id="L434" name="L434"></a> 434                     p.collides = <a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a> + 1;
<a id="L435" name="L435"></a> 435                     i = (i == 0) ? m : i - 1;          <em class="comment">// cyclically traverse</em>
<a id="L436" name="L436"></a> 436                 <em class="brace">}</em>
<a id="L437" name="L437"></a> 437                 <strong class="reserved">else</strong>
<a id="L438" name="L438"></a> 438                     i = m + 1;                         <em class="comment">// grow</em>
<a id="L439" name="L439"></a> 439                 p.<a href="../D/24461.html" title="Multiple defined in 6 places.">index</a> = i;
<a id="L440" name="L440"></a> 440             <em class="brace">}</em>
<a id="L441" name="L441"></a> 441         <em class="brace">}</em>
<a id="L442" name="L442"></a> 442     <em class="brace">}</em>
<a id="L443" name="L443"></a> 443 
<div class="comment">
      Exchange function used until arenas enabled. See above for explanation.
      @param item the item to exchange
      @param timed true if the wait is timed
      @param ns if timed, the maximum wait time, else 0L
      @return the other thread's item; or null if either the arena
      was enabled or the thread was interrupted before completion; or
      TIMED_OUT if timed and timed out</div>
<a id="L454" name="L454"></a> 454     <strong class="reserved">private</strong> <strong class="reserved">final</strong> <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../R/28677.html" title="Multiple referred from 2 places.">slotExchange</a>(<a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>, <strong class="reserved">boolean</strong> timed, <strong class="reserved">long</strong> ns) <em class="brace">{</em>
<a id="L455" name="L455"></a> 455         <a href="../D/6077.html" title="Multiple defined in 24 places.">Node</a> p = participant.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>();
<a id="L456" name="L456"></a> 456         <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a> t = <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L264" title="Defined at 264 in src/java/lang/Thread.java.">currentThread</a>();
<a id="L457" name="L457"></a> 457         <strong class="reserved">if</strong> (t.<a href="../D/25738.html" title="Multiple defined in 2 places.">isInterrupted</a>()) <em class="comment">// preserve interrupt status so caller can recheck</em>
<a id="L458" name="L458"></a> 458             <strong class="reserved">return</strong> <strong class="reserved">null</strong>;
<a id="L459" name="L459"></a> 459 
<a id="L460" name="L460"></a> 460         <strong class="reserved">for</strong> (<a href="../D/6077.html" title="Multiple defined in 24 places.">Node</a> q;;) <em class="brace">{</em>
<a id="L461" name="L461"></a> 461             <strong class="reserved">if</strong> ((q = slot) != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L462" name="L462"></a> 462                 <strong class="reserved">if</strong> (U.compareAndSwapObject(<strong class="reserved">this</strong>, SLOT, q, <strong class="reserved">null</strong>)) <em class="brace">{</em>
<a id="L463" name="L463"></a> 463                     <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> v = q.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>;
<a id="L464" name="L464"></a> 464                     q.<a href="../D/27519.html" title="Multiple defined in 69 places.">match</a> = <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>;
<a id="L465" name="L465"></a> 465                     <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a> w = q.parked;
<a id="L466" name="L466"></a> 466                     <strong class="reserved">if</strong> (w != <strong class="reserved">null</strong>)
<a id="L467" name="L467"></a> 467                         U.<a href="../S/1045.html#L139" title="Defined at 139 in src/java/util/concurrent/locks/LockSupport.java.">unpark</a>(w);
<a id="L468" name="L468"></a> 468                     <strong class="reserved">return</strong> v;
<a id="L469" name="L469"></a> 469                 <em class="brace">}</em>
<a id="L470" name="L470"></a> 470                 <em class="comment">// create arena on contention, but continue until slot null</em>
<a id="L471" name="L471"></a> 471                 <strong class="reserved">if</strong> (NCPU &gt; 1 &amp;&amp; bound == 0 &amp;&amp;
<a id="L472" name="L472"></a> 472                     U.compareAndSwapInt(<strong class="reserved">this</strong>, BOUND, 0, SEQ))
<a id="L473" name="L473"></a> 473                     arena = <strong class="reserved">new</strong> <a href="../D/6077.html" title="Multiple defined in 24 places.">Node</a>[(<a href="../S/1535.html#L94" title="Defined at 94 in src/java/time/format/TextStyle.java.">FULL</a> + 2) &lt;&lt; ASHIFT];
<a id="L474" name="L474"></a> 474             <em class="brace">}</em>
<a id="L475" name="L475"></a> 475             <strong class="reserved">else</strong> <strong class="reserved">if</strong> (arena != <strong class="reserved">null</strong>)
<a id="L476" name="L476"></a> 476                 <strong class="reserved">return</strong> <strong class="reserved">null</strong>; <em class="comment">// caller must reroute to arenaExchange</em>
<a id="L477" name="L477"></a> 477             <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L478" name="L478"></a> 478                 p.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> = <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>;
<a id="L479" name="L479"></a> 479                 <strong class="reserved">if</strong> (U.compareAndSwapObject(<strong class="reserved">this</strong>, SLOT, <strong class="reserved">null</strong>, p))
<a id="L480" name="L480"></a> 480                     <strong class="reserved">break</strong>;
<a id="L481" name="L481"></a> 481                 p.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> = <strong class="reserved">null</strong>;
<a id="L482" name="L482"></a> 482             <em class="brace">}</em>
<a id="L483" name="L483"></a> 483         <em class="brace">}</em>
<a id="L484" name="L484"></a> 484 
<a id="L485" name="L485"></a> 485         <em class="comment">// await release</em>
<a id="L486" name="L486"></a> 486         <strong class="reserved">int</strong> h = p.<a href="../D/24219.html" title="Multiple defined in 17 places.">hash</a>;
<a id="L487" name="L487"></a> 487         <strong class="reserved">long</strong> <a href="../D/15431.html" title="Multiple defined in 52 places.">end</a> = timed ? <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1557.html#L399" title="Defined at 399 in src/java/lang/System.java.">nanoTime</a>() + ns : 0L;
<a id="L488" name="L488"></a> 488         <strong class="reserved">int</strong> spins = (NCPU &gt; 1) ? SPINS : 1;
<a id="L489" name="L489"></a> 489         <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> v;
<a id="L490" name="L490"></a> 490         <strong class="reserved">while</strong> ((v = p.<a href="../D/27519.html" title="Multiple defined in 69 places.">match</a>) == <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L491" name="L491"></a> 491             <strong class="reserved">if</strong> (spins &gt; 0) <em class="brace">{</em>
<a id="L492" name="L492"></a> 492                 h ^= h &lt;&lt; 1; h ^= h &gt;&gt;&gt; 3; h ^= h &lt;&lt; 10;
<a id="L493" name="L493"></a> 493                 <strong class="reserved">if</strong> (h == 0)
<a id="L494" name="L494"></a> 494                     h = SPINS | (<strong class="reserved">int</strong>)t.<a href="../D/19565.html" title="Multiple defined in 69 places.">getId</a>();
<a id="L495" name="L495"></a> 495                 <strong class="reserved">else</strong> <strong class="reserved">if</strong> (h &lt; 0 &amp;&amp; (--spins &amp; ((SPINS &gt;&gt;&gt; 1) - 1)) == 0)
<a id="L496" name="L496"></a> 496                     <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L282" title="Defined at 282 in src/java/lang/Thread.java.">yield</a>();
<a id="L497" name="L497"></a> 497             <em class="brace">}</em>
<a id="L498" name="L498"></a> 498             <strong class="reserved">else</strong> <strong class="reserved">if</strong> (slot != p)
<a id="L499" name="L499"></a> 499                 spins = SPINS;
<a id="L500" name="L500"></a> 500             <strong class="reserved">else</strong> <strong class="reserved">if</strong> (!t.<a href="../D/25738.html" title="Multiple defined in 2 places.">isInterrupted</a>() &amp;&amp; arena == <strong class="reserved">null</strong> &amp;&amp;
<a id="L501" name="L501"></a> 501                      (!timed || (ns = <a href="../D/15431.html" title="Multiple defined in 52 places.">end</a> - <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1557.html#L399" title="Defined at 399 in src/java/lang/System.java.">nanoTime</a>()) &gt; 0L)) <em class="brace">{</em>
<a id="L502" name="L502"></a> 502                 U.putObject(t, BLOCKER, <strong class="reserved">this</strong>);
<a id="L503" name="L503"></a> 503                 p.parked = t;
<a id="L504" name="L504"></a> 504                 <strong class="reserved">if</strong> (slot == p)
<a id="L505" name="L505"></a> 505                     U.<a href="../D/29072.html" title="Multiple defined in 2 places.">park</a>(<strong class="reserved">false</strong>, ns);
<a id="L506" name="L506"></a> 506                 p.parked = <strong class="reserved">null</strong>;
<a id="L507" name="L507"></a> 507                 U.putObject(t, BLOCKER, <strong class="reserved">null</strong>);
<a id="L508" name="L508"></a> 508             <em class="brace">}</em>
<a id="L509" name="L509"></a> 509             <strong class="reserved">else</strong> <strong class="reserved">if</strong> (U.compareAndSwapObject(<strong class="reserved">this</strong>, SLOT, p, <strong class="reserved">null</strong>)) <em class="brace">{</em>
<a id="L510" name="L510"></a> 510                 v = timed &amp;&amp; ns &lt;= 0L &amp;&amp; !t.<a href="../D/25738.html" title="Multiple defined in 2 places.">isInterrupted</a>() ? TIMED_OUT : <strong class="reserved">null</strong>;
<a id="L511" name="L511"></a> 511                 <strong class="reserved">break</strong>;
<a id="L512" name="L512"></a> 512             <em class="brace">}</em>
<a id="L513" name="L513"></a> 513         <em class="brace">}</em>
<a id="L514" name="L514"></a> 514         U.putOrderedObject(p, MATCH, <strong class="reserved">null</strong>);
<a id="L515" name="L515"></a> 515         p.<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> = <strong class="reserved">null</strong>;
<a id="L516" name="L516"></a> 516         p.<a href="../D/24219.html" title="Multiple defined in 17 places.">hash</a> = h;
<a id="L517" name="L517"></a> 517         <strong class="reserved">return</strong> v;
<a id="L518" name="L518"></a> 518     <em class="brace">}</em>
<a id="L519" name="L519"></a> 519 
<div class="comment">
      Creates a new Exchanger.</div>
<a id="L523" name="L523"></a> 523     <strong class="reserved">public</strong> Exchanger() <em class="brace">{</em>
<a id="L524" name="L524"></a> 524         participant = <strong class="reserved">new</strong> <a href="../S/1060.html#L324" title="Defined at 324 in src/java/util/concurrent/Exchanger.java.">Participant</a>();
<a id="L525" name="L525"></a> 525     <em class="brace">}</em>
<a id="L526" name="L526"></a> 526 
<div class="comment">
      Waits for another thread to arrive at this exchange point (unless
      the current thread is {@linkplain Thread#interrupt interrupted}),
      and then transfers the given object to it, receiving its object
      in return.
      <p>If another thread is already waiting at the exchange point then
      it is resumed for thread scheduling purposes and receives the object
      passed in by the current thread.  The current thread returns immediately,
      receiving the object passed to the exchange by that other thread.
      </p><p>If no other thread is already waiting at the exchange then the
      current thread is disabled for thread scheduling purposes and lies
      dormant until one of two things happens:
      </p><ul><li>Some other thread enters the exchange; or
      </li><li>Some other thread {@linkplain Thread#interrupt interrupts}
      the current thread.
      </li></ul>
      <p>If the current thread:
      </p><ul><li>has its interrupted status set on entry to this method; or
      </li><li>is {@linkplain Thread#interrupt interrupted} while waiting
      for the exchange,
      </li></ul>
      then <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a> is thrown and the current thread's
      interrupted status is cleared.
      @param x the object to exchange
      @return the object provided by the other thread
      @throws InterruptedException if the current thread was
              interrupted while waiting</div>
<a id="L560" name="L560"></a> 560     @<a href="../R/7764.html" title="Multiple referred from 264 places.">SuppressWarnings</a>("unchecked")
<a id="L561" name="L561"></a> 561     <strong class="reserved">public</strong> V <a href="../S/4104.html#L53" title="Referred from 53 in src/javax/xml/ws/spi/http/HttpHandler.java.">exchange</a>(V <a href="../D/37285.html" title="Multiple defined in 2 places.">x</a>) <strong class="reserved">throws</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a> <em class="brace">{</em>
<a id="L562" name="L562"></a> 562         <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> v;
<a id="L563" name="L563"></a> 563         <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> = (<a href="../D/37285.html" title="Multiple defined in 2 places.">x</a> == <strong class="reserved">null</strong>) ? NULL_ITEM : <a href="../D/37285.html" title="Multiple defined in 2 places.">x</a>; <em class="comment">// translate null args</em>
<a id="L564" name="L564"></a> 564         <strong class="reserved">if</strong> ((arena != <strong class="reserved">null</strong> ||
<a id="L565" name="L565"></a> 565              (v = <a href="../S/1060.html#L454" title="Defined at 454 in src/java/util/concurrent/Exchanger.java.">slotExchange</a>(<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>, <strong class="reserved">false</strong>, 0L)) == <strong class="reserved">null</strong>) &amp;&amp;
<a id="L566" name="L566"></a> 566             ((<a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L943" title="Defined at 943 in src/java/lang/Thread.java.">interrupted</a>() || <em class="comment">// disambiguates null return</em>
<a id="L567" name="L567"></a> 567               (v = <a href="../S/1060.html#L361" title="Defined at 361 in src/java/util/concurrent/Exchanger.java.">arenaExchange</a>(<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>, <strong class="reserved">false</strong>, 0L)) == <strong class="reserved">null</strong>)))
<a id="L568" name="L568"></a> 568             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a>();
<a id="L569" name="L569"></a> 569         <strong class="reserved">return</strong> (v == NULL_ITEM) ? <strong class="reserved">null</strong> : (V)v;
<a id="L570" name="L570"></a> 570     <em class="brace">}</em>
<a id="L571" name="L571"></a> 571 
<div class="comment">
      Waits for another thread to arrive at this exchange point (unless
      the current thread is {@linkplain Thread#interrupt interrupted} or
      the specified waiting time elapses), and then transfers the given
      object to it, receiving its object in return.
      <p>If another thread is already waiting at the exchange point then
      it is resumed for thread scheduling purposes and receives the object
      passed in by the current thread.  The current thread returns immediately,
      receiving the object passed to the exchange by that other thread.
      </p><p>If no other thread is already waiting at the exchange then the
      current thread is disabled for thread scheduling purposes and lies
      dormant until one of three things happens:
      </p><ul><li>Some other thread enters the exchange; or
      </li><li>Some other thread {@linkplain Thread#interrupt interrupts}
      the current thread; or
      </li><li>The specified waiting time elapses.
      </li></ul>
      <p>If the current thread:
      </p><ul><li>has its interrupted status set on entry to this method; or
      </li><li>is {@linkplain Thread#interrupt interrupted} while waiting
      for the exchange,
      </li></ul>
      then <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a> is thrown and the current thread's
      interrupted status is cleared.
      <p>If the specified waiting time elapses then {@link
      TimeoutException} is thrown.  If the time is less than or equal
      to zero, the method will not wait at all.
      @param x the object to exchange
      @param timeout the maximum time to wait
      @param unit the time unit of the <code>timeout</code> argument
      @return the object provided by the other thread
      @throws InterruptedException if the current thread was
              interrupted while waiting
      @throws TimeoutException if the specified waiting time elapses
              before another thread enters the exchange</p></div>
<a id="L614" name="L614"></a> 614     @<a href="../R/7764.html" title="Multiple referred from 264 places.">SuppressWarnings</a>("unchecked")
<a id="L615" name="L615"></a> 615     <strong class="reserved">public</strong> V <a href="../S/4104.html#L53" title="Referred from 53 in src/javax/xml/ws/spi/http/HttpHandler.java.">exchange</a>(V <a href="../D/37285.html" title="Multiple defined in 2 places.">x</a>, <strong class="reserved">long</strong> timeout, <a href="../S/1102.html#L71" title="Defined at 71 in src/java/util/concurrent/TimeUnit.java.">TimeUnit</a> unit)
<a id="L616" name="L616"></a> 616         <strong class="reserved">throws</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a>, <a href="../D/8986.html" title="Multiple defined in 2 places.">TimeoutException</a> <em class="brace">{</em>
<a id="L617" name="L617"></a> 617         <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> v;
<a id="L618" name="L618"></a> 618         <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../D/26564.html" title="Multiple defined in 60 places.">item</a> = (<a href="../D/37285.html" title="Multiple defined in 2 places.">x</a> == <strong class="reserved">null</strong>) ? NULL_ITEM : <a href="../D/37285.html" title="Multiple defined in 2 places.">x</a>;
<a id="L619" name="L619"></a> 619         <strong class="reserved">long</strong> ns = unit.<a href="../D/35449.html" title="Multiple defined in 2 places.">toNanos</a>(timeout);
<a id="L620" name="L620"></a> 620         <strong class="reserved">if</strong> ((arena != <strong class="reserved">null</strong> ||
<a id="L621" name="L621"></a> 621              (v = <a href="../S/1060.html#L454" title="Defined at 454 in src/java/util/concurrent/Exchanger.java.">slotExchange</a>(<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>, <strong class="reserved">true</strong>, ns)) == <strong class="reserved">null</strong>) &amp;&amp;
<a id="L622" name="L622"></a> 622             ((<a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L943" title="Defined at 943 in src/java/lang/Thread.java.">interrupted</a>() ||
<a id="L623" name="L623"></a> 623               (v = <a href="../S/1060.html#L361" title="Defined at 361 in src/java/util/concurrent/Exchanger.java.">arenaExchange</a>(<a href="../D/26564.html" title="Multiple defined in 60 places.">item</a>, <strong class="reserved">true</strong>, ns)) == <strong class="reserved">null</strong>)))
<a id="L624" name="L624"></a> 624             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a>();
<a id="L625" name="L625"></a> 625         <strong class="reserved">if</strong> (v == TIMED_OUT)
<a id="L626" name="L626"></a> 626             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../D/8986.html" title="Multiple defined in 2 places.">TimeoutException</a>();
<a id="L627" name="L627"></a> 627         <strong class="reserved">return</strong> (v == NULL_ITEM) ? <strong class="reserved">null</strong> : (V)v;
<a id="L628" name="L628"></a> 628     <em class="brace">}</em>
<a id="L629" name="L629"></a> 629 
<a id="L630" name="L630"></a> 630     <em class="comment">// Unsafe mechanics</em>
<a id="L631" name="L631"></a> 631     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> sun.misc.Unsafe U;
<a id="L632" name="L632"></a> 632     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> BOUND;
<a id="L633" name="L633"></a> 633     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> SLOT;
<a id="L634" name="L634"></a> 634     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> MATCH;
<a id="L635" name="L635"></a> 635     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> BLOCKER;
<a id="L636" name="L636"></a> 636     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> ABASE;
<a id="L637" name="L637"></a> 637     <strong class="reserved">static</strong> <em class="brace">{</em>
<a id="L638" name="L638"></a> 638         <strong class="reserved">int</strong> s;
<a id="L639" name="L639"></a> 639         <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L640" name="L640"></a> 640             U = sun.misc.Unsafe.getUnsafe();
<a id="L641" name="L641"></a> 641             <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; ek = <a href="../S/1060.html#L105" title="Defined at 105 in src/java/util/concurrent/Exchanger.java.">Exchanger</a>.<strong class="reserved">class</strong>;
<a id="L642" name="L642"></a> 642             <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; nk = <a href="../D/6077.html" title="Multiple defined in 24 places.">Node</a>.<strong class="reserved">class</strong>;
<a id="L643" name="L643"></a> 643             <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; ak = <a href="../D/6077.html" title="Multiple defined in 24 places.">Node</a>[].<strong class="reserved">class</strong>;
<a id="L644" name="L644"></a> 644             <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; tk = <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<strong class="reserved">class</strong>;
<a id="L645" name="L645"></a> 645             BOUND = U.<a href="../D/28395.html" title="Multiple defined in 5 places.">objectFieldOffset</a>
<a id="L646" name="L646"></a> 646                 (ek.<a href="../S/1722.html#L2065" title="Defined at 2065 in src/java/lang/Class.java.">getDeclaredField</a>("bound"));
<a id="L647" name="L647"></a> 647             SLOT = U.<a href="../D/28395.html" title="Multiple defined in 5 places.">objectFieldOffset</a>
<a id="L648" name="L648"></a> 648                 (ek.<a href="../S/1722.html#L2065" title="Defined at 2065 in src/java/lang/Class.java.">getDeclaredField</a>("slot"));
<a id="L649" name="L649"></a> 649             MATCH = U.<a href="../D/28395.html" title="Multiple defined in 5 places.">objectFieldOffset</a>
<a id="L650" name="L650"></a> 650                 (nk.<a href="../S/1722.html#L2065" title="Defined at 2065 in src/java/lang/Class.java.">getDeclaredField</a>("match"));
<a id="L651" name="L651"></a> 651             BLOCKER = U.<a href="../D/28395.html" title="Multiple defined in 5 places.">objectFieldOffset</a>
<a id="L652" name="L652"></a> 652                 (tk.<a href="../S/1722.html#L2065" title="Defined at 2065 in src/java/lang/Class.java.">getDeclaredField</a>("parkBlocker"));
<a id="L653" name="L653"></a> 653             s = U.arrayIndexScale(ak);
<a id="L654" name="L654"></a> 654             <em class="comment">// ABASE absorbs padding in front of element 0</em>
<a id="L655" name="L655"></a> 655             ABASE = U.arrayBaseOffset(ak) + (1 &lt;&lt; ASHIFT);
<a id="L656" name="L656"></a> 656 
<a id="L657" name="L657"></a> 657         <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/1582.html#L45" title="Defined at 45 in src/java/lang/Exception.java.">Exception</a> e) <em class="brace">{</em>
<a id="L658" name="L658"></a> 658             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1772.html#L49" title="Defined at 49 in src/java/lang/Error.java.">Error</a>(e);
<a id="L659" name="L659"></a> 659         <em class="brace">}</em>
<a id="L660" name="L660"></a> 660         <strong class="reserved">if</strong> ((s &amp; (s-1)) != 0 || s &gt; (1 &lt;&lt; ASHIFT))
<a id="L661" name="L661"></a> 661             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1772.html#L49" title="Defined at 49 in src/java/lang/Error.java.">Error</a>("Unsupported array scale");
<a id="L662" name="L662"></a> 662     <em class="brace">}</em>
<a id="L663" name="L663"></a> 663 
<a id="L664" name="L664"></a> 664 <em class="brace">}</em>
</pre>
<hr>
<div class="comment">
/* [&lt;][&gt;]<a href="#L325">[^]</a><a href="#L615">[v]</a><a href="#TOP">[top]</a>[bottom]<a href="../mains.html">[index]</a><a href="../help.html">[help]</a> */</div>
</body></html>