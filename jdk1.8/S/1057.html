<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
<title>src/java/util/concurrent/Phaser.java</title>
<meta name="robots" content="noindex,nofollow">
<meta name="generator" content="GLOBAL-6.6.3">
<meta http-equiv="Content-Style-Type" content="text/css">
<link rel="stylesheet" type="text/css" href="../style.css">
</head>
<body>
<a id="TOP" name="TOP"></a><div class="comment">
/* [&lt;][&gt;]<a href="#L314">[^]</a><a href="#L1136">[v]</a>[top]<a href="#BOTTOM">[bottom]</a><a href="../mains.html">[index]</a><a href="../help.html">[help]</a> */</div>
<hr>
<h2 class="header">DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href="#L314" title="Defined at 314.">unarrivedOf</a></li>
<li><a href="#L319" title="Defined at 319.">partiesOf</a></li>
<li><a href="#L323" title="Defined at 323.">phaseOf</a></li>
<li><a href="#L327" title="Defined at 327.">arrivedOf</a></li>
<li><a href="#L352" title="Defined at 352.">queueFor</a></li>
<li><a href="#L359" title="Defined at 359.">badArrive</a></li>
<li><a href="#L367" title="Defined at 367.">badRegister</a></li>
<li><a href="#L381" title="Defined at 381.">doArrive</a></li>
<li><a href="#L427" title="Defined at 427.">doRegister</a></li>
<li><a href="#L489" title="Defined at 489.">reconcileState</a></li>
<li><a href="#L590" title="Defined at 590.">register</a></li>
<li><a href="#L613" title="Defined at 613.">bulkRegister</a></li>
<li><a href="#L633" title="Defined at 633.">arrive</a></li>
<li><a href="#L653" title="Defined at 653.">arriveAndDeregister</a></li>
<li><a href="#L675" title="Defined at 675.">arriveAndAwaitAdvance</a></li>
<li><a href="#L723" title="Defined at 723.">awaitAdvance</a></li>
<li><a href="#L749" title="Defined at 749.">awaitAdvanceInterruptibly</a></li>
<li><a href="#L785" title="Defined at 785.">awaitAdvanceInterruptibly</a></li>
<li><a href="#L814" title="Defined at 814.">forceTermination</a></li>
<li><a href="#L838" title="Defined at 838.">getPhase</a></li>
<li><a href="#L847" title="Defined at 847.">getRegisteredParties</a></li>
<li><a href="#L858" title="Defined at 858.">getArrivedParties</a></li>
<li><a href="#L869" title="Defined at 869.">getUnarrivedParties</a></li>
<li><a href="#L878" title="Defined at 878.">getParent</a></li>
<li><a href="#L888" title="Defined at 888.">getRoot</a></li>
<li><a href="#L897" title="Defined at 897.">isTerminated</a></li>
<li><a href="#L941" title="Defined at 941.">onAdvance</a></li>
<li><a href="#L954" title="Defined at 954.">toString</a></li>
<li><a href="#L961" title="Defined at 961.">stateToString</a></li>
<li><a href="#L973" title="Defined at 973.">releaseWaiters</a></li>
<li><a href="#L996" title="Defined at 996.">abortWait</a></li>
<li><a href="#L1036" title="Defined at 1036.">internalAwaitAdvance</a></li>
<li><a href="#L1111" title="Defined at 1111.">isReleasable</a></li>
<li><a href="#L1136" title="Defined at 1136.">block</a></li>
</ol>
<hr>
<pre>
<div class="comment">
  ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.</div>
<a id="L24" name="L24"></a>  24 
<div class="comment">
  Written by Doug Lea with assistance from members of JCP JSR-166
  Expert Group and released to the public domain, as explained at
  http://creativecommons.org/publicdomain/zero/1.0/</div>
<a id="L35" name="L35"></a>  35 
<a id="L36" name="L36"></a>  36 <strong class="reserved">package</strong> <a href="../S/3625.html#L43" title="Defined at 43 in src/javax/management/remote/rmi/RMIConnectionImpl_Stub.java.">java</a>.util.concurrent;
<a id="L37" name="L37"></a>  37 
<a id="L38" name="L38"></a>  38 <strong class="reserved">import</strong> java.util.concurrent.TimeUnit;
<a id="L39" name="L39"></a>  39 <strong class="reserved">import</strong> java.util.concurrent.TimeoutException;
<a id="L40" name="L40"></a>  40 <strong class="reserved">import</strong> java.util.concurrent.atomic.AtomicReference;
<a id="L41" name="L41"></a>  41 <strong class="reserved">import</strong> java.util.concurrent.locks.LockSupport;
<a id="L42" name="L42"></a>  42 
<div class="comment">
  A reusable synchronization barrier, similar in functionality to
  {@link java.util.concurrent.CyclicBarrier CyclicBarrier} and
  {@link java.util.concurrent.CountDownLatch CountDownLatch}
  but supporting more flexible usage.
  <p><b>Registration.</b> Unlike the case for other barriers, the
  number of parties <em>registered</em> to synchronize on a phaser
  may vary over time.  Tasks may be registered at any time (using
  methods <a href="#L590" title="Defined at 590.">register</a>, <a href="#L613" title="Defined at 613.">bulkRegister</a>, or forms of
  constructors establishing initial numbers of parties), and
  optionally deregistered upon any arrival (using {@link
  #arriveAndDeregister}).  As is the case with most basic
  synchronization constructs, registration and deregistration affect
  only internal counts; they do not establish any further internal
  bookkeeping, so tasks cannot query whether they are registered.
  (However, you can introduce such bookkeeping by subclassing this
  class.)
  </p><p><b>Synchronization.</b> Like a <code>CyclicBarrier</code>, a {@code
  Phaser} may be repeatedly awaited.  Method {@link
  #arriveAndAwaitAdvance} has effect analogous to {@link
  java.util.concurrent.CyclicBarrier#await CyclicBarrier.await}. Each
  generation of a phaser has an associated phase number. The phase
  number starts at zero, and advances when all parties arrive at the
  phaser, wrapping around to zero after reaching {@code
  Integer.MAX_VALUE}. The use of phase numbers enables independent
  control of actions upon arrival at a phaser and upon awaiting
  others, via two kinds of methods that may be invoked by any
  registered party:
  </p><ul><li> <b>Arrival.</b> Methods <a href="#L633" title="Defined at 633.">arrive</a> and
        <a href="#L653" title="Defined at 653.">arriveAndDeregister</a> record arrival.  These methods
        do not block, but return an associated <em>arrival phase
        number</em>; that is, the phase number of the phaser to which
        the arrival applied. When the final party for a given phase
        arrives, an optional action is performed and the phase
        advances.  These actions are performed by the party
        triggering a phase advance, and are arranged by overriding
        method {@link #onAdvance(int, int)}, which also controls
        termination. Overriding this method is similar to, but more
        flexible than, providing a barrier action to a {@code
        CyclicBarrier}.
    </li><li> <b>Waiting.</b> Method <a href="#L723" title="Defined at 723.">awaitAdvance</a> requires an
        argument indicating an arrival phase number, and returns when
        the phaser advances to (or is already at) a different phase.
        Unlike similar constructions using <code>CyclicBarrier</code>,
        method <code>awaitAdvance</code> continues to wait even if the
        waiting thread is interrupted. Interruptible and timeout
        versions are also available, but exceptions encountered while
        tasks wait interruptibly or with timeout do not change the
        state of the phaser. If necessary, you can perform any
        associated recovery within handlers of those exceptions,
        often after invoking <code>forceTermination</code>.  Phasers may
        also be used by tasks executing in a <a href="../S/1063.html#L170" title="Defined at 170 in src/java/util/concurrent/ForkJoinPool.java.">ForkJoinPool</a>,
        which will ensure sufficient parallelism to execute tasks
        when others are blocked waiting for a phase to advance.
  </li></ul>
  <p><b>Termination.</b> A phaser may enter a <em>termination</em>
  state, that may be checked using method <a href="#L897" title="Defined at 897.">isTerminated</a>. Upon
  termination, all synchronization methods immediately return without
  waiting for advance, as indicated by a negative return value.
  Similarly, attempts to register upon termination have no effect.
  Termination is triggered when an invocation of <code>onAdvance</code>
  returns <code>true</code>. The default implementation returns {@code
  true} if a deregistration has caused the number of registered
  parties to become zero.  As illustrated below, when phasers control
  actions with a fixed number of iterations, it is often convenient
  to override this method to cause termination when the current phase
  number reaches a threshold. Method <a href="#L814" title="Defined at 814.">forceTermination</a> is
  also available to abruptly release waiting threads and allow them
  to terminate.
  </p><p><b>Tiering.</b> Phasers may be <em>tiered</em> (i.e.,
  constructed in tree structures) to reduce contention. Phasers with
  large numbers of parties that would otherwise experience heavy
  synchronization contention costs may instead be set up so that
  groups of sub-phasers share a common parent.  This may greatly
  increase throughput even though it incurs greater per-operation
  overhead.
  </p><p>In a tree of tiered phasers, registration and deregistration of
  child phasers with their parent are managed automatically.
  Whenever the number of registered parties of a child phaser becomes
  non-zero (as established in the {@link #Phaser(Phaser,int)}
  constructor, <a href="#L590" title="Defined at 590.">register</a>, or <a href="#L613" title="Defined at 613.">bulkRegister</a>), the
  child phaser is registered with its parent.  Whenever the number of
  registered parties becomes zero as the result of an invocation of
  <a href="#L653" title="Defined at 653.">arriveAndDeregister</a>, the child phaser is deregistered
  from its parent.
  </p><p><b>Monitoring.</b> While synchronization methods may be invoked
  only by registered parties, the current state of a phaser may be
  monitored by any caller.  At any given moment there are {@link
  #getRegisteredParties} parties in total, of which {@link
  #getArrivedParties} have arrived at the current phase ({@link
  #getPhase}).  When the remaining (<a href="#L869" title="Defined at 869.">getUnarrivedParties</a>)
  parties arrive, the phase advances.  The values returned by these
  methods may reflect transient states and so are not in general
  useful for synchronization control.  Method <a href="#L954" title="Defined at 954.">toString</a>
  returns snapshots of these state queries in a form convenient for
  informal monitoring.
  </p><p><b>Sample usages:</b>
  </p><p>A <code>Phaser</code> may be used instead of a <code>CountDownLatch</code>
  to control a one-shot action serving a variable number of parties.
  The typical idiom is for the method setting this up to first
  register, then start the actions, then deregister, as in:
   </p><pre> {@code
  void runTasks(List<runnable> tasks) {
    final Phaser phaser = new Phaser(1); // "1" to register self
    // create and start threads
    for (final Runnable task : tasks) {
      phaser.register();
      new Thread() {
        public void run() {
          phaser.arriveAndAwaitAdvance(); // await all creation
          task.run();
        }
      }.start();
    }
    // allow threads to start and deregister self
    phaser.arriveAndDeregister();
  }}</runnable></pre>
  <p>One way to cause a set of threads to repeatedly perform actions
  for a given number of iterations is to override <code>onAdvance</code>:
   </p><pre> {@code
  void startTasks(List<runnable> tasks, final int iterations) {
    final Phaser phaser = new Phaser() {
      protected boolean onAdvance(int phase, int registeredParties) {
        return phase &gt;= iterations || registeredParties == 0;
      }
    };
    phaser.register();
    for (final Runnable task : tasks) {
      phaser.register();
      new Thread() {
        public void run() {
          do {
            task.run();
            phaser.arriveAndAwaitAdvance();
          } while (!phaser.isTerminated());
        }
      }.start();
    }
    phaser.arriveAndDeregister(); // deregister self, don't wait
  }}</runnable></pre>
  If the main task must later await termination, it
  may re-register and then execute a similar loop:
   <pre> {@code
    // ...
    phaser.register();
    while (!phaser.isTerminated())
      phaser.arriveAndAwaitAdvance();}</pre>
  <p>Related constructions may be used to await particular phase numbers
  in contexts where you are sure that the phase will never wrap around
  <code>Integer.MAX_VALUE</code>. For example:
   </p><pre> {@code
  void awaitPhase(Phaser phaser, int phase) {
    int p = phaser.register(); // assumes caller not already registered
    while (p &lt; phase) {
      if (phaser.isTerminated())
        // ... deal with unexpected termination
      else
        p = phaser.arriveAndAwaitAdvance();
    }
    phaser.arriveAndDeregister();
  }}</pre>
  <p>To create a set of <code>n</code> tasks using a tree of phasers, you
  could use code of the following form, assuming a Task class with a
  constructor accepting a <code>Phaser</code> that it registers with upon
  construction. After invocation of {@code build(new Task[n], 0, n,
  new Phaser())}, these tasks could then be started, for example by
  submitting to a pool:
   </p><pre> {@code
  void build(Task[] tasks, int lo, int hi, Phaser ph) {
    if (hi - lo &gt; TASKS_PER_PHASER) {
      for (int i = lo; i &lt; hi; i += TASKS_PER_PHASER) {
        int j = Math.min(i + TASKS_PER_PHASER, hi);
        build(tasks, i, j, new Phaser(ph));
      }
    } else {
      for (int i = lo; i &lt; hi; ++i)
        tasks[i] = new Task(ph);
        // assumes new Task(ph) performs ph.register()
    }
  }}</pre>
  The best value of <code>TASKS_PER_PHASER</code> depends mainly on
  expected synchronization rates. A value as low as four may
  be appropriate for extremely small per-phase task bodies (thus
  high rates), or up to hundreds for extremely large ones.
  <p><b>Implementation notes</b>: This implementation restricts the
  maximum number of parties to 65535. Attempts to register additional
  parties result in <code>IllegalStateException</code>. However, you can and
  should create tiered phasers to accommodate arbitrarily large sets
  of participants.
  @since 1.7
  @author Doug Lea</p></div>
<a id="L261" name="L261"></a> 261 <strong class="reserved">public</strong> <strong class="reserved">class</strong> <a href="../R/6106.html" title="Multiple referred from 18 places.">Phaser</a> <em class="brace">{</em>
<div class="comment">
      This class implements an extension of X10 "clocks".  Thanks to
      Vijay Saraswat for the idea, and to Vivek Sarkar for
      enhancements to extend functionality.</div>
<a id="L267" name="L267"></a> 267 
<div class="comment">
      Primary state representation, holding four bit-fields:
      unarrived  -- the number of parties yet to hit barrier (bits  0-15)
      parties    -- the number of parties to wait            (bits 16-31)
      phase      -- the generation of the barrier            (bits 32-62)
      terminated -- set if barrier is terminated             (bit  63 / sign)
      Except that a phaser with no registered parties is
      distinguished by the otherwise illegal state of having zero
      parties and one unarrived parties (encoded as EMPTY below).
      To efficiently maintain atomicity, these values are packed into
      a single (atomic) long. Good performance relies on keeping
      state decoding and encoding simple, and keeping race windows
      short.
      All state updates are performed via CAS except initial
      registration of a sub-phaser (i.e., one with a non-null
      parent).  In this (relatively rare) case, we use built-in
      synchronization to lock while first registering with its
      parent.
      The phase of a subphaser is allowed to lag that of its
      ancestors until it is actually accessed -- see method
      reconcileState.</div>
<a id="L295" name="L295"></a> 295     <strong class="reserved">private</strong> <strong class="reserved">volatile</strong> <strong class="reserved">long</strong> <a href="../D/34848.html" title="Multiple defined in 2 places.">state</a>;
<a id="L296" name="L296"></a> 296 
<a id="L297" name="L297"></a> 297     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong>  MAX_PARTIES     = 0xffff;
<a id="L298" name="L298"></a> 298     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong>  MAX_PHASE       = <a href="../D/4299.html" title="Multiple defined in 4 places.">Integer</a>.MAX_VALUE;
<a id="L299" name="L299"></a> 299     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong>  PARTIES_SHIFT   = 16;
<a id="L300" name="L300"></a> 300     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong>  PHASE_SHIFT     = 32;
<a id="L301" name="L301"></a> 301     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong>  UNARRIVED_MASK  = 0xffff;      <em class="comment">// to mask ints</em>
<a id="L302" name="L302"></a> 302     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> PARTIES_MASK    = 0xffff0000L; <em class="comment">// to mask longs</em>
<a id="L303" name="L303"></a> 303     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> COUNTS_MASK     = 0xffffffffL;
<a id="L304" name="L304"></a> 304     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> TERMINATION_BIT = 1L &lt;&lt; 63;
<a id="L305" name="L305"></a> 305 
<a id="L306" name="L306"></a> 306     <em class="comment">// some special values</em>
<a id="L307" name="L307"></a> 307     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong>  ONE_ARRIVAL     = 1;
<a id="L308" name="L308"></a> 308     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong>  ONE_PARTY       = 1 &lt;&lt; PARTIES_SHIFT;
<a id="L309" name="L309"></a> 309     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong>  ONE_DEREGISTER  = ONE_ARRIVAL|ONE_PARTY;
<a id="L310" name="L310"></a> 310     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong>  EMPTY           = 1;
<a id="L311" name="L311"></a> 311 
<a id="L312" name="L312"></a> 312     <em class="comment">// The following unpacking methods are usually manually inlined</em>
<a id="L313" name="L313"></a> 313 
<a id="L314" name="L314"></a> 314     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">int</strong> <a href="../S/1057.html#L870" title="Referred from 870 in src/java/util/concurrent/Phaser.java.">unarrivedOf</a>(<strong class="reserved">long</strong> s) <em class="brace">{</em>
<a id="L315" name="L315"></a> 315         <strong class="reserved">int</strong> counts = (<strong class="reserved">int</strong>)s;
<a id="L316" name="L316"></a> 316         <strong class="reserved">return</strong> (counts == EMPTY) ? 0 : (counts &amp; UNARRIVED_MASK);
<a id="L317" name="L317"></a> 317     <em class="brace">}</em>
<a id="L318" name="L318"></a> 318 
<a id="L319" name="L319"></a> 319     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">int</strong> <a href="../R/24669.html" title="Multiple referred from 2 places.">partiesOf</a>(<strong class="reserved">long</strong> s) <em class="brace">{</em>
<a id="L320" name="L320"></a> 320         <strong class="reserved">return</strong> (<strong class="reserved">int</strong>)s &gt;&gt;&gt; PARTIES_SHIFT;
<a id="L321" name="L321"></a> 321     <em class="brace">}</em>
<a id="L322" name="L322"></a> 322 
<a id="L323" name="L323"></a> 323     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">int</strong> <a href="../S/1057.html#L963" title="Referred from 963 in src/java/util/concurrent/Phaser.java.">phaseOf</a>(<strong class="reserved">long</strong> s) <em class="brace">{</em>
<a id="L324" name="L324"></a> 324         <strong class="reserved">return</strong> (<strong class="reserved">int</strong>)(s &gt;&gt;&gt; PHASE_SHIFT);
<a id="L325" name="L325"></a> 325     <em class="brace">}</em>
<a id="L326" name="L326"></a> 326 
<a id="L327" name="L327"></a> 327     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">int</strong> <a href="../R/10331.html" title="Multiple referred from 2 places.">arrivedOf</a>(<strong class="reserved">long</strong> s) <em class="brace">{</em>
<a id="L328" name="L328"></a> 328         <strong class="reserved">int</strong> counts = (<strong class="reserved">int</strong>)s;
<a id="L329" name="L329"></a> 329         <strong class="reserved">return</strong> (counts == EMPTY) ? 0 :
<a id="L330" name="L330"></a> 330             (counts &gt;&gt;&gt; PARTIES_SHIFT) - (counts &amp; UNARRIVED_MASK);
<a id="L331" name="L331"></a> 331     <em class="brace">}</em>
<a id="L332" name="L332"></a> 332 
<div class="comment">
      The parent of this phaser, or null if none</div>
<a id="L336" name="L336"></a> 336     <strong class="reserved">private</strong> <strong class="reserved">final</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> <a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a>;
<a id="L337" name="L337"></a> 337 
<div class="comment">
      The root of phaser tree. Equals this if not in a tree.</div>
<a id="L341" name="L341"></a> 341     <strong class="reserved">private</strong> <strong class="reserved">final</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>;
<a id="L342" name="L342"></a> 342 
<div class="comment">
      Heads of Treiber stacks for waiting threads. To eliminate
      contention when releasing some threads while adding others, we
      use two of them, alternating across even and odd phases.
      Subphasers share queues with root to speed up releases.</div>
<a id="L349" name="L349"></a> 349     <strong class="reserved">private</strong> <strong class="reserved">final</strong> <a href="../S/1090.html#L49" title="Defined at 49 in src/java/util/concurrent/atomic/AtomicReference.java.">AtomicReference</a>&lt;<a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a>&gt; evenQ;
<a id="L350" name="L350"></a> 350     <strong class="reserved">private</strong> <strong class="reserved">final</strong> <a href="../S/1090.html#L49" title="Defined at 49 in src/java/util/concurrent/atomic/AtomicReference.java.">AtomicReference</a>&lt;<a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a>&gt; oddQ;
<a id="L351" name="L351"></a> 351 
<a id="L352" name="L352"></a> 352     <strong class="reserved">private</strong> <a href="../S/1090.html#L49" title="Defined at 49 in src/java/util/concurrent/atomic/AtomicReference.java.">AtomicReference</a>&lt;<a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a>&gt; queueFor(<strong class="reserved">int</strong> phase) <em class="brace">{</em>
<a id="L353" name="L353"></a> 353         <strong class="reserved">return</strong> ((phase &amp; 1) == 0) ? evenQ : oddQ;
<a id="L354" name="L354"></a> 354     <em class="brace">}</em>
<a id="L355" name="L355"></a> 355 
<div class="comment">
      Returns message string for bounds exceptions on arrival.</div>
<a id="L359" name="L359"></a> 359     <strong class="reserved">private</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> <a href="../R/10455.html" title="Multiple referred from 2 places.">badArrive</a>(<strong class="reserved">long</strong> s) <em class="brace">{</em>
<a id="L360" name="L360"></a> 360         <strong class="reserved">return</strong> "Attempted arrival of unregistered party for " +
<a id="L361" name="L361"></a> 361             <a href="../D/34852.html" title="Multiple defined in 3 places.">stateToString</a>(s);
<a id="L362" name="L362"></a> 362     <em class="brace">}</em>
<a id="L363" name="L363"></a> 363 
<div class="comment">
      Returns message string for bounds exceptions on registration.</div>
<a id="L367" name="L367"></a> 367     <strong class="reserved">private</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> <a href="../S/1057.html#L438" title="Referred from 438 in src/java/util/concurrent/Phaser.java.">badRegister</a>(<strong class="reserved">long</strong> s) <em class="brace">{</em>
<a id="L368" name="L368"></a> 368         <strong class="reserved">return</strong> "Attempt to register more than " +
<a id="L369" name="L369"></a> 369             MAX_PARTIES + " parties for " + <a href="../D/34852.html" title="Multiple defined in 3 places.">stateToString</a>(s);
<a id="L370" name="L370"></a> 370     <em class="brace">}</em>
<a id="L371" name="L371"></a> 371 
<div class="comment">
      Main implementation for methods arrive and arriveAndDeregister.
      Manually tuned to speed up and minimize race windows for the
      common case of just decrementing unarrived field.
      @param adjust value to subtract from state;
                    ONE_ARRIVAL for arrive,
                    ONE_DEREGISTER for arriveAndDeregister</div>
<a id="L381" name="L381"></a> 381     <strong class="reserved">private</strong> <strong class="reserved">int</strong> <a href="../R/13382.html" title="Multiple referred from 4 places.">doArrive</a>(<strong class="reserved">int</strong> <a href="../D/11206.html" title="Multiple defined in 2 places.">adjust</a>) <em class="brace">{</em>
<a id="L382" name="L382"></a> 382         <strong class="reserved">final</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> = <strong class="reserved">this</strong>.<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>;
<a id="L383" name="L383"></a> 383         <strong class="reserved">for</strong> (;;) <em class="brace">{</em>
<a id="L384" name="L384"></a> 384             <strong class="reserved">long</strong> s = (<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> == <strong class="reserved">this</strong>) ? <a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> : <a href="../S/1057.html#L489" title="Defined at 489 in src/java/util/concurrent/Phaser.java.">reconcileState</a>();
<a id="L385" name="L385"></a> 385             <strong class="reserved">int</strong> phase = (<strong class="reserved">int</strong>)(s &gt;&gt;&gt; PHASE_SHIFT);
<a id="L386" name="L386"></a> 386             <strong class="reserved">if</strong> (phase &lt; 0)
<a id="L387" name="L387"></a> 387                 <strong class="reserved">return</strong> phase;
<a id="L388" name="L388"></a> 388             <strong class="reserved">int</strong> counts = (<strong class="reserved">int</strong>)s;
<a id="L389" name="L389"></a> 389             <strong class="reserved">int</strong> unarrived = (counts == EMPTY) ? 0 : (counts &amp; UNARRIVED_MASK);
<a id="L390" name="L390"></a> 390             <strong class="reserved">if</strong> (unarrived &lt;= 0)
<a id="L391" name="L391"></a> 391                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1555.html#L38" title="Defined at 38 in src/java/lang/IllegalStateException.java.">IllegalStateException</a>(<a href="../S/1057.html#L359" title="Defined at 359 in src/java/util/concurrent/Phaser.java.">badArrive</a>(s));
<a id="L392" name="L392"></a> 392             <strong class="reserved">if</strong> (UNSAFE.compareAndSwapLong(<strong class="reserved">this</strong>, stateOffset, s, s-=<a href="../D/11206.html" title="Multiple defined in 2 places.">adjust</a>)) <em class="brace">{</em>
<a id="L393" name="L393"></a> 393                 <strong class="reserved">if</strong> (unarrived == 1) <em class="brace">{</em>
<a id="L394" name="L394"></a> 394                     <strong class="reserved">long</strong> n = s &amp; PARTIES_MASK;  <em class="comment">// base of next state</em>
<a id="L395" name="L395"></a> 395                     <strong class="reserved">int</strong> nextUnarrived = (<strong class="reserved">int</strong>)n &gt;&gt;&gt; PARTIES_SHIFT;
<a id="L396" name="L396"></a> 396                     <strong class="reserved">if</strong> (<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> == <strong class="reserved">this</strong>) <em class="brace">{</em>
<a id="L397" name="L397"></a> 397                         <strong class="reserved">if</strong> (<a href="../S/1057.html#L941" title="Defined at 941 in src/java/util/concurrent/Phaser.java.">onAdvance</a>(phase, nextUnarrived))
<a id="L398" name="L398"></a> 398                             n |= TERMINATION_BIT;
<a id="L399" name="L399"></a> 399                         <strong class="reserved">else</strong> <strong class="reserved">if</strong> (nextUnarrived == 0)
<a id="L400" name="L400"></a> 400                             n |= EMPTY;
<a id="L401" name="L401"></a> 401                         <strong class="reserved">else</strong>
<a id="L402" name="L402"></a> 402                             n |= nextUnarrived;
<a id="L403" name="L403"></a> 403                         <strong class="reserved">int</strong> nextPhase = (phase + 1) &amp; MAX_PHASE;
<a id="L404" name="L404"></a> 404                         n |= (<strong class="reserved">long</strong>)nextPhase &lt;&lt; PHASE_SHIFT;
<a id="L405" name="L405"></a> 405                         UNSAFE.compareAndSwapLong(<strong class="reserved">this</strong>, stateOffset, s, n);
<a id="L406" name="L406"></a> 406                         <a href="../S/1057.html#L973" title="Defined at 973 in src/java/util/concurrent/Phaser.java.">releaseWaiters</a>(phase);
<a id="L407" name="L407"></a> 407                     <em class="brace">}</em>
<a id="L408" name="L408"></a> 408                     <strong class="reserved">else</strong> <strong class="reserved">if</strong> (nextUnarrived == 0) <em class="brace">{</em> <em class="comment">// propagate deregistration</em>
<a id="L409" name="L409"></a> 409                         phase = <a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a>.<a href="../S/1057.html#L381" title="Defined at 381 in src/java/util/concurrent/Phaser.java.">doArrive</a>(ONE_DEREGISTER);
<a id="L410" name="L410"></a> 410                         UNSAFE.compareAndSwapLong(<strong class="reserved">this</strong>, stateOffset,
<a id="L411" name="L411"></a> 411                                                   s, s | EMPTY);
<a id="L412" name="L412"></a> 412                     <em class="brace">}</em>
<a id="L413" name="L413"></a> 413                     <strong class="reserved">else</strong>
<a id="L414" name="L414"></a> 414                         phase = <a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a>.<a href="../S/1057.html#L381" title="Defined at 381 in src/java/util/concurrent/Phaser.java.">doArrive</a>(ONE_ARRIVAL);
<a id="L415" name="L415"></a> 415                 <em class="brace">}</em>
<a id="L416" name="L416"></a> 416                 <strong class="reserved">return</strong> phase;
<a id="L417" name="L417"></a> 417             <em class="brace">}</em>
<a id="L418" name="L418"></a> 418         <em class="brace">}</em>
<a id="L419" name="L419"></a> 419     <em class="brace">}</em>
<a id="L420" name="L420"></a> 420 
<div class="comment">
      Implementation of register, bulkRegister
      @param registrations number to add to both parties and
      unarrived fields. Must be greater than zero.</div>
<a id="L427" name="L427"></a> 427     <strong class="reserved">private</strong> <strong class="reserved">int</strong> <a href="../R/13429.html" title="Multiple referred from 4 places.">doRegister</a>(<strong class="reserved">int</strong> registrations) <em class="brace">{</em>
<a id="L428" name="L428"></a> 428         <em class="comment">// adjustment to state</em>
<a id="L429" name="L429"></a> 429         <strong class="reserved">long</strong> <a href="../D/11206.html" title="Multiple defined in 2 places.">adjust</a> = ((<strong class="reserved">long</strong>)registrations &lt;&lt; PARTIES_SHIFT) | registrations;
<a id="L430" name="L430"></a> 430         <strong class="reserved">final</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> <a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a> = <strong class="reserved">this</strong>.<a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a>;
<a id="L431" name="L431"></a> 431         <strong class="reserved">int</strong> phase;
<a id="L432" name="L432"></a> 432         <strong class="reserved">for</strong> (;;) <em class="brace">{</em>
<a id="L433" name="L433"></a> 433             <strong class="reserved">long</strong> s = (<a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a> == <strong class="reserved">null</strong>) ? <a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> : <a href="../S/1057.html#L489" title="Defined at 489 in src/java/util/concurrent/Phaser.java.">reconcileState</a>();
<a id="L434" name="L434"></a> 434             <strong class="reserved">int</strong> counts = (<strong class="reserved">int</strong>)s;
<a id="L435" name="L435"></a> 435             <strong class="reserved">int</strong> parties = counts &gt;&gt;&gt; PARTIES_SHIFT;
<a id="L436" name="L436"></a> 436             <strong class="reserved">int</strong> unarrived = counts &amp; UNARRIVED_MASK;
<a id="L437" name="L437"></a> 437             <strong class="reserved">if</strong> (registrations &gt; MAX_PARTIES - parties)
<a id="L438" name="L438"></a> 438                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1555.html#L38" title="Defined at 38 in src/java/lang/IllegalStateException.java.">IllegalStateException</a>(<a href="../S/1057.html#L367" title="Defined at 367 in src/java/util/concurrent/Phaser.java.">badRegister</a>(s));
<a id="L439" name="L439"></a> 439             phase = (<strong class="reserved">int</strong>)(s &gt;&gt;&gt; PHASE_SHIFT);
<a id="L440" name="L440"></a> 440             <strong class="reserved">if</strong> (phase &lt; 0)
<a id="L441" name="L441"></a> 441                 <strong class="reserved">break</strong>;
<a id="L442" name="L442"></a> 442             <strong class="reserved">if</strong> (counts != EMPTY) <em class="brace">{</em>                  <em class="comment">// not 1st registration</em>
<a id="L443" name="L443"></a> 443                 <strong class="reserved">if</strong> (<a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a> == <strong class="reserved">null</strong> || <a href="../S/1057.html#L489" title="Defined at 489 in src/java/util/concurrent/Phaser.java.">reconcileState</a>() == s) <em class="brace">{</em>
<a id="L444" name="L444"></a> 444                     <strong class="reserved">if</strong> (unarrived == 0)             <em class="comment">// wait out advance</em>
<a id="L445" name="L445"></a> 445                         <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>.<a href="../S/1057.html#L1036" title="Defined at 1036 in src/java/util/concurrent/Phaser.java.">internalAwaitAdvance</a>(phase, <strong class="reserved">null</strong>);
<a id="L446" name="L446"></a> 446                     <strong class="reserved">else</strong> <strong class="reserved">if</strong> (UNSAFE.compareAndSwapLong(<strong class="reserved">this</strong>, stateOffset,
<a id="L447" name="L447"></a> 447                                                        s, s + <a href="../D/11206.html" title="Multiple defined in 2 places.">adjust</a>))
<a id="L448" name="L448"></a> 448                         <strong class="reserved">break</strong>;
<a id="L449" name="L449"></a> 449                 <em class="brace">}</em>
<a id="L450" name="L450"></a> 450             <em class="brace">}</em>
<a id="L451" name="L451"></a> 451             <strong class="reserved">else</strong> <strong class="reserved">if</strong> (<a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a> == <strong class="reserved">null</strong>) <em class="brace">{</em>              <em class="comment">// 1st root registration</em>
<a id="L452" name="L452"></a> 452                 <strong class="reserved">long</strong> <a href="../D/28131.html" title="Multiple defined in 273 places.">next</a> = ((<strong class="reserved">long</strong>)phase &lt;&lt; PHASE_SHIFT) | <a href="../D/11206.html" title="Multiple defined in 2 places.">adjust</a>;
<a id="L453" name="L453"></a> 453                 <strong class="reserved">if</strong> (UNSAFE.compareAndSwapLong(<strong class="reserved">this</strong>, stateOffset, s, <a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>))
<a id="L454" name="L454"></a> 454                     <strong class="reserved">break</strong>;
<a id="L455" name="L455"></a> 455             <em class="brace">}</em>
<a id="L456" name="L456"></a> 456             <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L457" name="L457"></a> 457                 <strong class="reserved">synchronized</strong> (<strong class="reserved">this</strong>) <em class="brace">{</em>               <em class="comment">// 1st sub registration</em>
<a id="L458" name="L458"></a> 458                     <strong class="reserved">if</strong> (<a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> == s) <em class="brace">{</em>               <em class="comment">// recheck under lock</em>
<a id="L459" name="L459"></a> 459                         phase = <a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a>.<a href="../S/1057.html#L427" title="Defined at 427 in src/java/util/concurrent/Phaser.java.">doRegister</a>(1);
<a id="L460" name="L460"></a> 460                         <strong class="reserved">if</strong> (phase &lt; 0)
<a id="L461" name="L461"></a> 461                             <strong class="reserved">break</strong>;
<a id="L462" name="L462"></a> 462                         <em class="comment">// finish registration whenever parent registration</em>
<a id="L463" name="L463"></a> 463                         <em class="comment">// succeeded, even when racing with termination,</em>
<a id="L464" name="L464"></a> 464                         <em class="comment">// since these are part of the same "transaction".</em>
<a id="L465" name="L465"></a> 465                         <strong class="reserved">while</strong> (!UNSAFE.compareAndSwapLong
<a id="L466" name="L466"></a> 466                                (<strong class="reserved">this</strong>, stateOffset, s,
<a id="L467" name="L467"></a> 467                                 ((<strong class="reserved">long</strong>)phase &lt;&lt; PHASE_SHIFT) | <a href="../D/11206.html" title="Multiple defined in 2 places.">adjust</a>)) <em class="brace">{</em>
<a id="L468" name="L468"></a> 468                             s = <a href="../D/34848.html" title="Multiple defined in 2 places.">state</a>;
<a id="L469" name="L469"></a> 469                             phase = (<strong class="reserved">int</strong>)(<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>.<a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> &gt;&gt;&gt; PHASE_SHIFT);
<a id="L470" name="L470"></a> 470                             <em class="comment">// assert (int)s == EMPTY;</em>
<a id="L471" name="L471"></a> 471                         <em class="brace">}</em>
<a id="L472" name="L472"></a> 472                         <strong class="reserved">break</strong>;
<a id="L473" name="L473"></a> 473                     <em class="brace">}</em>
<a id="L474" name="L474"></a> 474                 <em class="brace">}</em>
<a id="L475" name="L475"></a> 475             <em class="brace">}</em>
<a id="L476" name="L476"></a> 476         <em class="brace">}</em>
<a id="L477" name="L477"></a> 477         <strong class="reserved">return</strong> phase;
<a id="L478" name="L478"></a> 478     <em class="brace">}</em>
<a id="L479" name="L479"></a> 479 
<div class="comment">
      Resolves lagged phase propagation from root if necessary.
      Reconciliation normally occurs when root has advanced but
      subphasers have not yet done so, in which case they must finish
      their own advance by setting unarrived to parties (or if
      parties is zero, resetting to unregistered EMPTY state).
      @return reconciled state</div>
<a id="L489" name="L489"></a> 489     <strong class="reserved">private</strong> <strong class="reserved">long</strong> <a href="../R/25656.html" title="Multiple referred from 10 places.">reconcileState</a>() <em class="brace">{</em>
<a id="L490" name="L490"></a> 490         <strong class="reserved">final</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> = <strong class="reserved">this</strong>.<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>;
<a id="L491" name="L491"></a> 491         <strong class="reserved">long</strong> s = <a href="../D/34848.html" title="Multiple defined in 2 places.">state</a>;
<a id="L492" name="L492"></a> 492         <strong class="reserved">if</strong> (<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> != <strong class="reserved">this</strong>) <em class="brace">{</em>
<a id="L493" name="L493"></a> 493             <strong class="reserved">int</strong> phase, p;
<a id="L494" name="L494"></a> 494             <em class="comment">// CAS to root phase with current parties, tripping unarrived</em>
<a id="L495" name="L495"></a> 495             <strong class="reserved">while</strong> ((phase = (<strong class="reserved">int</strong>)(<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>.<a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> &gt;&gt;&gt; PHASE_SHIFT)) !=
<a id="L496" name="L496"></a> 496                    (<strong class="reserved">int</strong>)(s &gt;&gt;&gt; PHASE_SHIFT) &amp;&amp;
<a id="L497" name="L497"></a> 497                    !UNSAFE.compareAndSwapLong
<a id="L498" name="L498"></a> 498                    (<strong class="reserved">this</strong>, stateOffset, s,
<a id="L499" name="L499"></a> 499                     s = (((<strong class="reserved">long</strong>)phase &lt;&lt; PHASE_SHIFT) |
<a id="L500" name="L500"></a> 500                          ((phase &lt; 0) ? (s &amp; COUNTS_MASK) :
<a id="L501" name="L501"></a> 501                           (((p = (<strong class="reserved">int</strong>)s &gt;&gt;&gt; PARTIES_SHIFT) == 0) ? EMPTY :
<a id="L502" name="L502"></a> 502                            ((s &amp; PARTIES_MASK) | p))))))
<a id="L503" name="L503"></a> 503                 s = <a href="../D/34848.html" title="Multiple defined in 2 places.">state</a>;
<a id="L504" name="L504"></a> 504         <em class="brace">}</em>
<a id="L505" name="L505"></a> 505         <strong class="reserved">return</strong> s;
<a id="L506" name="L506"></a> 506     <em class="brace">}</em>
<a id="L507" name="L507"></a> 507 
<div class="comment">
      Creates a new phaser with no initially registered parties, no
      parent, and initial phase number 0. Any thread using this
      phaser will need to first register for it.</div>
<a id="L513" name="L513"></a> 513     <strong class="reserved">public</strong> Phaser() <em class="brace">{</em>
<a id="L514" name="L514"></a> 514         <strong class="reserved">this</strong>(<strong class="reserved">null</strong>, 0);
<a id="L515" name="L515"></a> 515     <em class="brace">}</em>
<a id="L516" name="L516"></a> 516 
<div class="comment">
      Creates a new phaser with the given number of registered
      unarrived parties, no parent, and initial phase number 0.
      @param parties the number of parties required to advance to the
      next phase
      @throws IllegalArgumentException if parties less than zero
      or greater than the maximum number of parties supported</div>
<a id="L526" name="L526"></a> 526     <strong class="reserved">public</strong> Phaser(<strong class="reserved">int</strong> parties) <em class="brace">{</em>
<a id="L527" name="L527"></a> 527         <strong class="reserved">this</strong>(<strong class="reserved">null</strong>, parties);
<a id="L528" name="L528"></a> 528     <em class="brace">}</em>
<a id="L529" name="L529"></a> 529 
<div class="comment">
      Equivalent to {@link #Phaser(Phaser, int) Phaser(parent, 0)}.
      @param parent the parent phaser</div>
<a id="L535" name="L535"></a> 535     <strong class="reserved">public</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a>(Phaser <a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a>) <em class="brace">{</em>
<a id="L536" name="L536"></a> 536         <strong class="reserved">this</strong>(<a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a>, 0);
<a id="L537" name="L537"></a> 537     <em class="brace">}</em>
<a id="L538" name="L538"></a> 538 
<div class="comment">
      Creates a new phaser with the given parent and number of
      registered unarrived parties.  When the given parent is non-null
      and the given number of parties is greater than zero, this
      child phaser is registered with its parent.
      @param parent the parent phaser
      @param parties the number of parties required to advance to the
      next phase
      @throws IllegalArgumentException if parties less than zero
      or greater than the maximum number of parties supported</div>
<a id="L551" name="L551"></a> 551     <strong class="reserved">public</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a>(Phaser <a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a>, <strong class="reserved">int</strong> parties) <em class="brace">{</em>
<a id="L552" name="L552"></a> 552         <strong class="reserved">if</strong> (parties &gt;&gt;&gt; PARTIES_SHIFT != 0)
<a id="L553" name="L553"></a> 553             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../D/4055.html" title="Multiple defined in 2 places.">IllegalArgumentException</a>("Illegal number of parties");
<a id="L554" name="L554"></a> 554         <strong class="reserved">int</strong> phase = 0;
<a id="L555" name="L555"></a> 555         <strong class="reserved">this</strong>.<a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a> = <a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a>;
<a id="L556" name="L556"></a> 556         <strong class="reserved">if</strong> (<a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a> != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L557" name="L557"></a> 557             <strong class="reserved">final</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> = <a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a>.<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>;
<a id="L558" name="L558"></a> 558             <strong class="reserved">this</strong>.<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> = <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>;
<a id="L559" name="L559"></a> 559             <strong class="reserved">this</strong>.evenQ = <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>.evenQ;
<a id="L560" name="L560"></a> 560             <strong class="reserved">this</strong>.oddQ = <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>.oddQ;
<a id="L561" name="L561"></a> 561             <strong class="reserved">if</strong> (parties != 0)
<a id="L562" name="L562"></a> 562                 phase = <a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a>.<a href="../S/1057.html#L427" title="Defined at 427 in src/java/util/concurrent/Phaser.java.">doRegister</a>(1);
<a id="L563" name="L563"></a> 563         <em class="brace">}</em>
<a id="L564" name="L564"></a> 564         <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L565" name="L565"></a> 565             <strong class="reserved">this</strong>.<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> = <strong class="reserved">this</strong>;
<a id="L566" name="L566"></a> 566             <strong class="reserved">this</strong>.evenQ = <strong class="reserved">new</strong> <a href="../S/1090.html#L49" title="Defined at 49 in src/java/util/concurrent/atomic/AtomicReference.java.">AtomicReference</a>&lt;<a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a>&gt;();
<a id="L567" name="L567"></a> 567             <strong class="reserved">this</strong>.oddQ = <strong class="reserved">new</strong> <a href="../S/1090.html#L49" title="Defined at 49 in src/java/util/concurrent/atomic/AtomicReference.java.">AtomicReference</a>&lt;<a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a>&gt;();
<a id="L568" name="L568"></a> 568         <em class="brace">}</em>
<a id="L569" name="L569"></a> 569         <strong class="reserved">this</strong>.<a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> = (parties == 0) ? (<strong class="reserved">long</strong>)EMPTY :
<a id="L570" name="L570"></a> 570             ((<strong class="reserved">long</strong>)phase &lt;&lt; PHASE_SHIFT) |
<a id="L571" name="L571"></a> 571             ((<strong class="reserved">long</strong>)parties &lt;&lt; PARTIES_SHIFT) |
<a id="L572" name="L572"></a> 572             ((<strong class="reserved">long</strong>)parties);
<a id="L573" name="L573"></a> 573     <em class="brace">}</em>
<a id="L574" name="L574"></a> 574 
<div class="comment">
      Adds a new unarrived party to this phaser.  If an ongoing
      invocation of <a href="#L941" title="Defined at 941.">onAdvance</a> is in progress, this method
      may await its completion before returning.  If this phaser has
      a parent, and this phaser previously had no registered parties,
      this child phaser is also registered with its parent. If
      this phaser is terminated, the attempt to register has
      no effect, and a negative value is returned.
      @return the arrival phase number to which this registration
      applied.  If this value is negative, then this phaser has
      terminated, in which case registration has no effect.
      @throws IllegalStateException if attempting to register more
      than the maximum supported number of parties</div>
<a id="L590" name="L590"></a> 590     <strong class="reserved">public</strong> <strong class="reserved">int</strong> <a href="../R/25749.html" title="Multiple referred from 136 places.">register</a>() <em class="brace">{</em>
<a id="L591" name="L591"></a> 591         <strong class="reserved">return</strong> <a href="../S/1057.html#L427" title="Defined at 427 in src/java/util/concurrent/Phaser.java.">doRegister</a>(1);
<a id="L592" name="L592"></a> 592     <em class="brace">}</em>
<a id="L593" name="L593"></a> 593 
<div class="comment">
      Adds the given number of new unarrived parties to this phaser.
      If an ongoing invocation of <a href="#L941" title="Defined at 941.">onAdvance</a> is in progress,
      this method may await its completion before returning.  If this
      phaser has a parent, and the given number of parties is greater
      than zero, and this phaser previously had no registered
      parties, this child phaser is also registered with its parent.
      If this phaser is terminated, the attempt to register has no
      effect, and a negative value is returned.
      @param parties the number of additional parties required to
      advance to the next phase
      @return the arrival phase number to which this registration
      applied.  If this value is negative, then this phaser has
      terminated, in which case registration has no effect.
      @throws IllegalStateException if attempting to register more
      than the maximum supported number of parties
      @throws IllegalArgumentException if <code>parties &lt; 0</code></div>
<a id="L613" name="L613"></a> 613     <strong class="reserved">public</strong> <strong class="reserved">int</strong> bulkRegister(<strong class="reserved">int</strong> parties) <em class="brace">{</em>
<a id="L614" name="L614"></a> 614         <strong class="reserved">if</strong> (parties &lt; 0)
<a id="L615" name="L615"></a> 615             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../D/4055.html" title="Multiple defined in 2 places.">IllegalArgumentException</a>();
<a id="L616" name="L616"></a> 616         <strong class="reserved">if</strong> (parties == 0)
<a id="L617" name="L617"></a> 617             <strong class="reserved">return</strong> <a href="../S/1057.html#L838" title="Defined at 838 in src/java/util/concurrent/Phaser.java.">getPhase</a>();
<a id="L618" name="L618"></a> 618         <strong class="reserved">return</strong> <a href="../S/1057.html#L427" title="Defined at 427 in src/java/util/concurrent/Phaser.java.">doRegister</a>(parties);
<a id="L619" name="L619"></a> 619     <em class="brace">}</em>
<a id="L620" name="L620"></a> 620 
<div class="comment">
      Arrives at this phaser, without waiting for others to arrive.
      <p>It is a usage error for an unregistered party to invoke this
      method.  However, this error may result in an {@code
      IllegalStateException} only upon some subsequent operation on
      this phaser, if ever.
      @return the arrival phase number, or a negative value if terminated
      @throws IllegalStateException if not terminated and the number
      of unarrived parties would become negative</p></div>
<a id="L633" name="L633"></a> 633     <strong class="reserved">public</strong> <strong class="reserved">int</strong> arrive() <em class="brace">{</em>
<a id="L634" name="L634"></a> 634         <strong class="reserved">return</strong> <a href="../S/1057.html#L381" title="Defined at 381 in src/java/util/concurrent/Phaser.java.">doArrive</a>(ONE_ARRIVAL);
<a id="L635" name="L635"></a> 635     <em class="brace">}</em>
<a id="L636" name="L636"></a> 636 
<div class="comment">
      Arrives at this phaser and deregisters from it without waiting
      for others to arrive. Deregistration reduces the number of
      parties required to advance in future phases.  If this phaser
      has a parent, and deregistration causes this phaser to have
      zero parties, this phaser is also deregistered from its parent.
      <p>It is a usage error for an unregistered party to invoke this
      method.  However, this error may result in an {@code
      IllegalStateException} only upon some subsequent operation on
      this phaser, if ever.
      @return the arrival phase number, or a negative value if terminated
      @throws IllegalStateException if not terminated and the number
      of registered or unarrived parties would become negative</p></div>
<a id="L653" name="L653"></a> 653     <strong class="reserved">public</strong> <strong class="reserved">int</strong> arriveAndDeregister() <em class="brace">{</em>
<a id="L654" name="L654"></a> 654         <strong class="reserved">return</strong> <a href="../S/1057.html#L381" title="Defined at 381 in src/java/util/concurrent/Phaser.java.">doArrive</a>(ONE_DEREGISTER);
<a id="L655" name="L655"></a> 655     <em class="brace">}</em>
<a id="L656" name="L656"></a> 656 
<div class="comment">
      Arrives at this phaser and awaits others. Equivalent in effect
      to <code>awaitAdvance(arrive())</code>.  If you need to await with
      interruption or timeout, you can arrange this with an analogous
      construction using one of the other forms of the {@code
      awaitAdvance} method.  If instead you need to deregister upon
      arrival, use <code>awaitAdvance(arriveAndDeregister())</code>.
      <p>It is a usage error for an unregistered party to invoke this
      method.  However, this error may result in an {@code
      IllegalStateException} only upon some subsequent operation on
      this phaser, if ever.
      @return the arrival phase number, or the (negative)
      {@linkplain #getPhase() current phase} if terminated
      @throws IllegalStateException if not terminated and the number
      of unarrived parties would become negative</p></div>
<a id="L675" name="L675"></a> 675     <strong class="reserved">public</strong> <strong class="reserved">int</strong> <a href="../S/1057.html#L692" title="Referred from 692 in src/java/util/concurrent/Phaser.java.">arriveAndAwaitAdvance</a>() <em class="brace">{</em>
<a id="L676" name="L676"></a> 676         <em class="comment">// Specialization of doArrive+awaitAdvance eliminating some reads/paths</em>
<a id="L677" name="L677"></a> 677         <strong class="reserved">final</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> = <strong class="reserved">this</strong>.<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>;
<a id="L678" name="L678"></a> 678         <strong class="reserved">for</strong> (;;) <em class="brace">{</em>
<a id="L679" name="L679"></a> 679             <strong class="reserved">long</strong> s = (<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> == <strong class="reserved">this</strong>) ? <a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> : <a href="../S/1057.html#L489" title="Defined at 489 in src/java/util/concurrent/Phaser.java.">reconcileState</a>();
<a id="L680" name="L680"></a> 680             <strong class="reserved">int</strong> phase = (<strong class="reserved">int</strong>)(s &gt;&gt;&gt; PHASE_SHIFT);
<a id="L681" name="L681"></a> 681             <strong class="reserved">if</strong> (phase &lt; 0)
<a id="L682" name="L682"></a> 682                 <strong class="reserved">return</strong> phase;
<a id="L683" name="L683"></a> 683             <strong class="reserved">int</strong> counts = (<strong class="reserved">int</strong>)s;
<a id="L684" name="L684"></a> 684             <strong class="reserved">int</strong> unarrived = (counts == EMPTY) ? 0 : (counts &amp; UNARRIVED_MASK);
<a id="L685" name="L685"></a> 685             <strong class="reserved">if</strong> (unarrived &lt;= 0)
<a id="L686" name="L686"></a> 686                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1555.html#L38" title="Defined at 38 in src/java/lang/IllegalStateException.java.">IllegalStateException</a>(<a href="../S/1057.html#L359" title="Defined at 359 in src/java/util/concurrent/Phaser.java.">badArrive</a>(s));
<a id="L687" name="L687"></a> 687             <strong class="reserved">if</strong> (UNSAFE.compareAndSwapLong(<strong class="reserved">this</strong>, stateOffset, s,
<a id="L688" name="L688"></a> 688                                           s -= ONE_ARRIVAL)) <em class="brace">{</em>
<a id="L689" name="L689"></a> 689                 <strong class="reserved">if</strong> (unarrived &gt; 1)
<a id="L690" name="L690"></a> 690                     <strong class="reserved">return</strong> <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>.<a href="../S/1057.html#L1036" title="Defined at 1036 in src/java/util/concurrent/Phaser.java.">internalAwaitAdvance</a>(phase, <strong class="reserved">null</strong>);
<a id="L691" name="L691"></a> 691                 <strong class="reserved">if</strong> (<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> != <strong class="reserved">this</strong>)
<a id="L692" name="L692"></a> 692                     <strong class="reserved">return</strong> <a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a>.<a href="../S/1057.html#L675" title="Defined at 675 in src/java/util/concurrent/Phaser.java.">arriveAndAwaitAdvance</a>();
<a id="L693" name="L693"></a> 693                 <strong class="reserved">long</strong> n = s &amp; PARTIES_MASK;  <em class="comment">// base of next state</em>
<a id="L694" name="L694"></a> 694                 <strong class="reserved">int</strong> nextUnarrived = (<strong class="reserved">int</strong>)n &gt;&gt;&gt; PARTIES_SHIFT;
<a id="L695" name="L695"></a> 695                 <strong class="reserved">if</strong> (<a href="../S/1057.html#L941" title="Defined at 941 in src/java/util/concurrent/Phaser.java.">onAdvance</a>(phase, nextUnarrived))
<a id="L696" name="L696"></a> 696                     n |= TERMINATION_BIT;
<a id="L697" name="L697"></a> 697                 <strong class="reserved">else</strong> <strong class="reserved">if</strong> (nextUnarrived == 0)
<a id="L698" name="L698"></a> 698                     n |= EMPTY;
<a id="L699" name="L699"></a> 699                 <strong class="reserved">else</strong>
<a id="L700" name="L700"></a> 700                     n |= nextUnarrived;
<a id="L701" name="L701"></a> 701                 <strong class="reserved">int</strong> nextPhase = (phase + 1) &amp; MAX_PHASE;
<a id="L702" name="L702"></a> 702                 n |= (<strong class="reserved">long</strong>)nextPhase &lt;&lt; PHASE_SHIFT;
<a id="L703" name="L703"></a> 703                 <strong class="reserved">if</strong> (!UNSAFE.compareAndSwapLong(<strong class="reserved">this</strong>, stateOffset, s, n))
<a id="L704" name="L704"></a> 704                     <strong class="reserved">return</strong> (<strong class="reserved">int</strong>)(<a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> &gt;&gt;&gt; PHASE_SHIFT); <em class="comment">// terminated</em>
<a id="L705" name="L705"></a> 705                 <a href="../S/1057.html#L973" title="Defined at 973 in src/java/util/concurrent/Phaser.java.">releaseWaiters</a>(phase);
<a id="L706" name="L706"></a> 706                 <strong class="reserved">return</strong> nextPhase;
<a id="L707" name="L707"></a> 707             <em class="brace">}</em>
<a id="L708" name="L708"></a> 708         <em class="brace">}</em>
<a id="L709" name="L709"></a> 709     <em class="brace">}</em>
<a id="L710" name="L710"></a> 710 
<div class="comment">
      Awaits the phase of this phaser to advance from the given phase
      value, returning immediately if the current phase is not equal
      to the given phase value or this phaser is terminated.
      @param phase an arrival phase number, or negative value if
      terminated; this argument is normally the value returned by a
      previous call to <code>arrive</code> or <code>arriveAndDeregister</code>.
      @return the next arrival phase number, or the argument if it is
      negative, or the (negative) {@linkplain #getPhase() current phase}
      if terminated</div>
<a id="L723" name="L723"></a> 723     <strong class="reserved">public</strong> <strong class="reserved">int</strong> awaitAdvance(<strong class="reserved">int</strong> phase) <em class="brace">{</em>
<a id="L724" name="L724"></a> 724         <strong class="reserved">final</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> = <strong class="reserved">this</strong>.<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>;
<a id="L725" name="L725"></a> 725         <strong class="reserved">long</strong> s = (<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> == <strong class="reserved">this</strong>) ? <a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> : <a href="../S/1057.html#L489" title="Defined at 489 in src/java/util/concurrent/Phaser.java.">reconcileState</a>();
<a id="L726" name="L726"></a> 726         <strong class="reserved">int</strong> p = (<strong class="reserved">int</strong>)(s &gt;&gt;&gt; PHASE_SHIFT);
<a id="L727" name="L727"></a> 727         <strong class="reserved">if</strong> (phase &lt; 0)
<a id="L728" name="L728"></a> 728             <strong class="reserved">return</strong> phase;
<a id="L729" name="L729"></a> 729         <strong class="reserved">if</strong> (p == phase)
<a id="L730" name="L730"></a> 730             <strong class="reserved">return</strong> <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>.<a href="../S/1057.html#L1036" title="Defined at 1036 in src/java/util/concurrent/Phaser.java.">internalAwaitAdvance</a>(phase, <strong class="reserved">null</strong>);
<a id="L731" name="L731"></a> 731         <strong class="reserved">return</strong> p;
<a id="L732" name="L732"></a> 732     <em class="brace">}</em>
<a id="L733" name="L733"></a> 733 
<div class="comment">
      Awaits the phase of this phaser to advance from the given phase
      value, throwing <code>InterruptedException</code> if interrupted
      while waiting, or returning immediately if the current phase is
      not equal to the given phase value or this phaser is
      terminated.
      @param phase an arrival phase number, or negative value if
      terminated; this argument is normally the value returned by a
      previous call to <code>arrive</code> or <code>arriveAndDeregister</code>.
      @return the next arrival phase number, or the argument if it is
      negative, or the (negative) {@linkplain #getPhase() current phase}
      if terminated
      @throws InterruptedException if thread interrupted while waiting</div>
<a id="L749" name="L749"></a> 749     <strong class="reserved">public</strong> <strong class="reserved">int</strong> awaitAdvanceInterruptibly(<strong class="reserved">int</strong> phase)
<a id="L750" name="L750"></a> 750         <strong class="reserved">throws</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a> <em class="brace">{</em>
<a id="L751" name="L751"></a> 751         <strong class="reserved">final</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> = <strong class="reserved">this</strong>.<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>;
<a id="L752" name="L752"></a> 752         <strong class="reserved">long</strong> s = (<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> == <strong class="reserved">this</strong>) ? <a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> : <a href="../S/1057.html#L489" title="Defined at 489 in src/java/util/concurrent/Phaser.java.">reconcileState</a>();
<a id="L753" name="L753"></a> 753         <strong class="reserved">int</strong> p = (<strong class="reserved">int</strong>)(s &gt;&gt;&gt; PHASE_SHIFT);
<a id="L754" name="L754"></a> 754         <strong class="reserved">if</strong> (phase &lt; 0)
<a id="L755" name="L755"></a> 755             <strong class="reserved">return</strong> phase;
<a id="L756" name="L756"></a> 756         <strong class="reserved">if</strong> (p == phase) <em class="brace">{</em>
<a id="L757" name="L757"></a> 757             <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> <a href="../D/28235.html" title="Multiple defined in 11 places.">node</a> = <strong class="reserved">new</strong> <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a>(<strong class="reserved">this</strong>, phase, <strong class="reserved">true</strong>, <strong class="reserved">false</strong>, 0L);
<a id="L758" name="L758"></a> 758             p = <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>.<a href="../S/1057.html#L1036" title="Defined at 1036 in src/java/util/concurrent/Phaser.java.">internalAwaitAdvance</a>(phase, <a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>);
<a id="L759" name="L759"></a> 759             <strong class="reserved">if</strong> (<a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>.wasInterrupted)
<a id="L760" name="L760"></a> 760                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a>();
<a id="L761" name="L761"></a> 761         <em class="brace">}</em>
<a id="L762" name="L762"></a> 762         <strong class="reserved">return</strong> p;
<a id="L763" name="L763"></a> 763     <em class="brace">}</em>
<a id="L764" name="L764"></a> 764 
<div class="comment">
      Awaits the phase of this phaser to advance from the given phase
      value or the given timeout to elapse, throwing {@code
      InterruptedException} if interrupted while waiting, or
      returning immediately if the current phase is not equal to the
      given phase value or this phaser is terminated.
      @param phase an arrival phase number, or negative value if
      terminated; this argument is normally the value returned by a
      previous call to <code>arrive</code> or <code>arriveAndDeregister</code>.
      @param timeout how long to wait before giving up, in units of
             <code>unit</code>
      @param unit a <code>TimeUnit</code> determining how to interpret the
             <code>timeout</code> parameter
      @return the next arrival phase number, or the argument if it is
      negative, or the (negative) {@linkplain #getPhase() current phase}
      if terminated
      @throws InterruptedException if thread interrupted while waiting
      @throws TimeoutException if timed out while waiting</div>
<a id="L785" name="L785"></a> 785     <strong class="reserved">public</strong> <strong class="reserved">int</strong> awaitAdvanceInterruptibly(<strong class="reserved">int</strong> phase,
<a id="L786" name="L786"></a> 786                                          <strong class="reserved">long</strong> timeout, <a href="../S/1102.html#L71" title="Defined at 71 in src/java/util/concurrent/TimeUnit.java.">TimeUnit</a> unit)
<a id="L787" name="L787"></a> 787         <strong class="reserved">throws</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a>, <a href="../D/8986.html" title="Multiple defined in 2 places.">TimeoutException</a> <em class="brace">{</em>
<a id="L788" name="L788"></a> 788         <strong class="reserved">long</strong> nanos = unit.<a href="../D/35449.html" title="Multiple defined in 2 places.">toNanos</a>(timeout);
<a id="L789" name="L789"></a> 789         <strong class="reserved">final</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> = <strong class="reserved">this</strong>.<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>;
<a id="L790" name="L790"></a> 790         <strong class="reserved">long</strong> s = (<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> == <strong class="reserved">this</strong>) ? <a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> : <a href="../S/1057.html#L489" title="Defined at 489 in src/java/util/concurrent/Phaser.java.">reconcileState</a>();
<a id="L791" name="L791"></a> 791         <strong class="reserved">int</strong> p = (<strong class="reserved">int</strong>)(s &gt;&gt;&gt; PHASE_SHIFT);
<a id="L792" name="L792"></a> 792         <strong class="reserved">if</strong> (phase &lt; 0)
<a id="L793" name="L793"></a> 793             <strong class="reserved">return</strong> phase;
<a id="L794" name="L794"></a> 794         <strong class="reserved">if</strong> (p == phase) <em class="brace">{</em>
<a id="L795" name="L795"></a> 795             <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> <a href="../D/28235.html" title="Multiple defined in 11 places.">node</a> = <strong class="reserved">new</strong> <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a>(<strong class="reserved">this</strong>, phase, <strong class="reserved">true</strong>, <strong class="reserved">true</strong>, nanos);
<a id="L796" name="L796"></a> 796             p = <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>.<a href="../S/1057.html#L1036" title="Defined at 1036 in src/java/util/concurrent/Phaser.java.">internalAwaitAdvance</a>(phase, <a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>);
<a id="L797" name="L797"></a> 797             <strong class="reserved">if</strong> (<a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>.wasInterrupted)
<a id="L798" name="L798"></a> 798                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a>();
<a id="L799" name="L799"></a> 799             <strong class="reserved">else</strong> <strong class="reserved">if</strong> (p == phase)
<a id="L800" name="L800"></a> 800                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../D/8986.html" title="Multiple defined in 2 places.">TimeoutException</a>();
<a id="L801" name="L801"></a> 801         <em class="brace">}</em>
<a id="L802" name="L802"></a> 802         <strong class="reserved">return</strong> p;
<a id="L803" name="L803"></a> 803     <em class="brace">}</em>
<a id="L804" name="L804"></a> 804 
<div class="comment">
      Forces this phaser to enter termination state.  Counts of
      registered parties are unaffected.  If this phaser is a member
      of a tiered set of phasers, then all of the phasers in the set
      are terminated.  If this phaser is already terminated, this
      method has no effect.  This method may be useful for
      coordinating recovery after one or more tasks encounter
      unexpected exceptions.</div>
<a id="L814" name="L814"></a> 814     <strong class="reserved">public</strong> <strong class="reserved">void</strong> forceTermination() <em class="brace">{</em>
<a id="L815" name="L815"></a> 815         <em class="comment">// Only need to change root state</em>
<a id="L816" name="L816"></a> 816         <strong class="reserved">final</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a> = <strong class="reserved">this</strong>.<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>;
<a id="L817" name="L817"></a> 817         <strong class="reserved">long</strong> s;
<a id="L818" name="L818"></a> 818         <strong class="reserved">while</strong> ((s = <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>.<a href="../D/34848.html" title="Multiple defined in 2 places.">state</a>) &gt;= 0) <em class="brace">{</em>
<a id="L819" name="L819"></a> 819             <strong class="reserved">if</strong> (UNSAFE.compareAndSwapLong(<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>, stateOffset,
<a id="L820" name="L820"></a> 820                                           s, s | TERMINATION_BIT)) <em class="brace">{</em>
<a id="L821" name="L821"></a> 821                 <em class="comment">// signal all threads</em>
<a id="L822" name="L822"></a> 822                 <a href="../S/1057.html#L973" title="Defined at 973 in src/java/util/concurrent/Phaser.java.">releaseWaiters</a>(0); <em class="comment">// Waiters on evenQ</em>
<a id="L823" name="L823"></a> 823                 <a href="../S/1057.html#L973" title="Defined at 973 in src/java/util/concurrent/Phaser.java.">releaseWaiters</a>(1); <em class="comment">// Waiters on oddQ</em>
<a id="L824" name="L824"></a> 824                 <strong class="reserved">return</strong>;
<a id="L825" name="L825"></a> 825             <em class="brace">}</em>
<a id="L826" name="L826"></a> 826         <em class="brace">}</em>
<a id="L827" name="L827"></a> 827     <em class="brace">}</em>
<a id="L828" name="L828"></a> 828 
<div class="comment">
      Returns the current phase number. The maximum phase number is
      <code>Integer.MAX_VALUE</code>, after which it restarts at
      zero. Upon termination, the phase number is negative,
      in which case the prevailing phase prior to termination
      may be obtained via <code>getPhase() + Integer.MIN_VALUE</code>.
      @return the phase number, or a negative value if terminated</div>
<a id="L838" name="L838"></a> 838     <strong class="reserved">public</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> <a href="../R/18342.html" title="Multiple referred from 2 places.">getPhase</a>() <em class="brace">{</em>
<a id="L839" name="L839"></a> 839         <strong class="reserved">return</strong> (<strong class="reserved">int</strong>)(<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>.<a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> &gt;&gt;&gt; PHASE_SHIFT);
<a id="L840" name="L840"></a> 840     <em class="brace">}</em>
<a id="L841" name="L841"></a> 841 
<div class="comment">
      Returns the number of parties registered at this phaser.
      @return the number of parties</div>
<a id="L847" name="L847"></a> 847     <strong class="reserved">public</strong> <strong class="reserved">int</strong> getRegisteredParties() <em class="brace">{</em>
<a id="L848" name="L848"></a> 848         <strong class="reserved">return</strong> <a href="../S/1057.html#L319" title="Defined at 319 in src/java/util/concurrent/Phaser.java.">partiesOf</a>(<a href="../D/34848.html" title="Multiple defined in 2 places.">state</a>);
<a id="L849" name="L849"></a> 849     <em class="brace">}</em>
<a id="L850" name="L850"></a> 850 
<div class="comment">
      Returns the number of registered parties that have arrived at
      the current phase of this phaser. If this phaser has terminated,
      the returned value is meaningless and arbitrary.
      @return the number of arrived parties</div>
<a id="L858" name="L858"></a> 858     <strong class="reserved">public</strong> <strong class="reserved">int</strong> getArrivedParties() <em class="brace">{</em>
<a id="L859" name="L859"></a> 859         <strong class="reserved">return</strong> <a href="../S/1057.html#L327" title="Defined at 327 in src/java/util/concurrent/Phaser.java.">arrivedOf</a>(<a href="../S/1057.html#L489" title="Defined at 489 in src/java/util/concurrent/Phaser.java.">reconcileState</a>());
<a id="L860" name="L860"></a> 860     <em class="brace">}</em>
<a id="L861" name="L861"></a> 861 
<div class="comment">
      Returns the number of registered parties that have not yet
      arrived at the current phase of this phaser. If this phaser has
      terminated, the returned value is meaningless and arbitrary.
      @return the number of unarrived parties</div>
<a id="L869" name="L869"></a> 869     <strong class="reserved">public</strong> <strong class="reserved">int</strong> getUnarrivedParties() <em class="brace">{</em>
<a id="L870" name="L870"></a> 870         <strong class="reserved">return</strong> <a href="../S/1057.html#L314" title="Defined at 314 in src/java/util/concurrent/Phaser.java.">unarrivedOf</a>(<a href="../S/1057.html#L489" title="Defined at 489 in src/java/util/concurrent/Phaser.java.">reconcileState</a>());
<a id="L871" name="L871"></a> 871     <em class="brace">}</em>
<a id="L872" name="L872"></a> 872 
<div class="comment">
      Returns the parent of this phaser, or <code>null</code> if none.
      @return the parent of this phaser, or <code>null</code> if none</div>
<a id="L878" name="L878"></a> 878     <strong class="reserved">public</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> <a href="../R/18269.html" title="Multiple referred from 606 places.">getParent</a>() <em class="brace">{</em>
<a id="L879" name="L879"></a> 879         <strong class="reserved">return</strong> <a href="../D/29067.html" title="Multiple defined in 4 places.">parent</a>;
<a id="L880" name="L880"></a> 880     <em class="brace">}</em>
<a id="L881" name="L881"></a> 881 
<div class="comment">
      Returns the root ancestor of this phaser, which is the same as
      this phaser if it has no parent.
      @return the root ancestor of this phaser</div>
<a id="L888" name="L888"></a> 888     <strong class="reserved">public</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> <a href="../R/18758.html" title="Multiple referred from 54 places.">getRoot</a>() <em class="brace">{</em>
<a id="L889" name="L889"></a> 889         <strong class="reserved">return</strong> <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>;
<a id="L890" name="L890"></a> 890     <em class="brace">}</em>
<a id="L891" name="L891"></a> 891 
<div class="comment">
      Returns <code>true</code> if this phaser has been terminated.
      @return <code>true</code> if this phaser has been terminated</div>
<a id="L897" name="L897"></a> 897     <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/22100.html" title="Multiple referred from 3 places.">isTerminated</a>() <em class="brace">{</em>
<a id="L898" name="L898"></a> 898         <strong class="reserved">return</strong> <a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>.<a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> &lt; 0L;
<a id="L899" name="L899"></a> 899     <em class="brace">}</em>
<a id="L900" name="L900"></a> 900 
<div class="comment">
      Overridable method to perform an action upon impending phase
      advance, and to control termination. This method is invoked
      upon arrival of the party advancing this phaser (when all other
      waiting parties are dormant).  If this method returns {@code
      true}, this phaser will be set to a final termination state
      upon advance, and subsequent calls to <a href="#L897" title="Defined at 897.">isTerminated</a>
      will return true. Any (unchecked) Exception or Error thrown by
      an invocation of this method is propagated to the party
      attempting to advance this phaser, in which case no advance
      occurs.
      <p>The arguments to this method provide the state of the phaser
      prevailing for the current transition.  The effects of invoking
      arrival, registration, and waiting methods on this phaser from
      within <code>onAdvance</code> are unspecified and should not be
      relied on.
      </p><p>If this phaser is a member of a tiered set of phasers, then
      <code>onAdvance</code> is invoked only for its root phaser on each
      advance.
      </p><p>To support the most common use cases, the default
      implementation of this method returns <code>true</code> when the
      number of registered parties has become zero as the result of a
      party invoking <code>arriveAndDeregister</code>.  You can disable
      this behavior, thus enabling continuation upon future
      registrations, by overriding this method to always return
      <code>false</code>:
      </p><pre> {@code
      Phaser phaser = new Phaser() {
        protected boolean onAdvance(int phase, int parties) { return false; }
      }}</pre>
      @param phase the current phase number on entry to this method,
      before this phaser is advanced
      @param registeredParties the current number of registered parties
      @return <code>true</code> if this phaser should terminate</div>
<a id="L941" name="L941"></a> 941     <strong class="reserved">protected</strong> <strong class="reserved">boolean</strong> <a href="../R/23946.html" title="Multiple referred from 2 places.">onAdvance</a>(<strong class="reserved">int</strong> phase, <strong class="reserved">int</strong> registeredParties) <em class="brace">{</em>
<a id="L942" name="L942"></a> 942         <strong class="reserved">return</strong> registeredParties == 0;
<a id="L943" name="L943"></a> 943     <em class="brace">}</em>
<a id="L944" name="L944"></a> 944 
<div class="comment">
      Returns a string identifying this phaser, as well as its
      state.  The state, in brackets, includes the String {@code
      "phase = "} followed by the phase number, <code>"parties = "</code>
      followed by the number of registered parties, and {@code
      "arrived = "} followed by the number of arrived parties.
      @return a string identifying this phaser, as well as its state</div>
<a id="L954" name="L954"></a> 954     <strong class="reserved">public</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> <a href="../R/29337.html" title="Multiple referred from 3013 places.">toString</a>() <em class="brace">{</em>
<a id="L955" name="L955"></a> 955         <strong class="reserved">return</strong> <a href="../D/34852.html" title="Multiple defined in 3 places.">stateToString</a>(<a href="../S/1057.html#L489" title="Defined at 489 in src/java/util/concurrent/Phaser.java.">reconcileState</a>());
<a id="L956" name="L956"></a> 956     <em class="brace">}</em>
<a id="L957" name="L957"></a> 957 
<div class="comment">
      Implementation of toString and string-based error messages</div>
<a id="L961" name="L961"></a> 961     <strong class="reserved">private</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> <a href="../R/28877.html" title="Multiple referred from 5 places.">stateToString</a>(<strong class="reserved">long</strong> s) <em class="brace">{</em>
<a id="L962" name="L962"></a> 962         <strong class="reserved">return</strong> <strong class="reserved">super</strong>.<a href="../D/35493.html" title="Multiple defined in 1021 places.">toString</a>() +
<a id="L963" name="L963"></a> 963             "[phase = " + <a href="../S/1057.html#L323" title="Defined at 323 in src/java/util/concurrent/Phaser.java.">phaseOf</a>(s) +
<a id="L964" name="L964"></a> 964             " parties = " + <a href="../S/1057.html#L319" title="Defined at 319 in src/java/util/concurrent/Phaser.java.">partiesOf</a>(s) +
<a id="L965" name="L965"></a> 965             " arrived = " + <a href="../S/1057.html#L327" title="Defined at 327 in src/java/util/concurrent/Phaser.java.">arrivedOf</a>(s) + "]";
<a id="L966" name="L966"></a> 966     <em class="brace">}</em>
<a id="L967" name="L967"></a> 967 
<a id="L968" name="L968"></a> 968     <em class="comment">// Waiting mechanics</em>
<a id="L969" name="L969"></a> 969 
<div class="comment">
      Removes and signals threads from queue for phase.</div>
<a id="L973" name="L973"></a> 973     <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../R/25869.html" title="Multiple referred from 6 places.">releaseWaiters</a>(<strong class="reserved">int</strong> phase) <em class="brace">{</em>
<a id="L974" name="L974"></a> 974         <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> q;   <em class="comment">// first element of queue</em>
<a id="L975" name="L975"></a> 975         <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a> t;  <em class="comment">// its thread</em>
<a id="L976" name="L976"></a> 976         <a href="../S/1090.html#L49" title="Defined at 49 in src/java/util/concurrent/atomic/AtomicReference.java.">AtomicReference</a>&lt;<a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a>&gt; head = (phase &amp; 1) == 0 ? evenQ : oddQ;
<a id="L977" name="L977"></a> 977         <strong class="reserved">while</strong> ((q = head.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>()) != <strong class="reserved">null</strong> &amp;&amp;
<a id="L978" name="L978"></a> 978                q.phase != (<strong class="reserved">int</strong>)(<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>.<a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> &gt;&gt;&gt; PHASE_SHIFT)) <em class="brace">{</em>
<a id="L979" name="L979"></a> 979             <strong class="reserved">if</strong> (head.<a href="../D/13035.html" title="Multiple defined in 16 places.">compareAndSet</a>(q, q.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>) &amp;&amp;
<a id="L980" name="L980"></a> 980                 (t = q.thread) != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L981" name="L981"></a> 981                 q.thread = <strong class="reserved">null</strong>;
<a id="L982" name="L982"></a> 982                 <a href="../S/1045.html#L120" title="Defined at 120 in src/java/util/concurrent/locks/LockSupport.java.">LockSupport</a>.<a href="../S/1045.html#L139" title="Defined at 139 in src/java/util/concurrent/locks/LockSupport.java.">unpark</a>(t);
<a id="L983" name="L983"></a> 983             <em class="brace">}</em>
<a id="L984" name="L984"></a> 984         <em class="brace">}</em>
<a id="L985" name="L985"></a> 985     <em class="brace">}</em>
<a id="L986" name="L986"></a> 986 
<div class="comment">
      Variant of releaseWaiters that additionally tries to remove any
      nodes no longer waiting for advance due to timeout or
      interrupt. Currently, nodes are removed only if they are at
      head of queue, which suffices to reduce memory footprint in
      most usages.
      @return current phase on exit</div>
<a id="L996" name="L996"></a> 996     <strong class="reserved">private</strong> <strong class="reserved">int</strong> <a href="../S/1057.html#L1080" title="Referred from 1080 in src/java/util/concurrent/Phaser.java.">abortWait</a>(<strong class="reserved">int</strong> phase) <em class="brace">{</em>
<a id="L997" name="L997"></a> 997         <a href="../S/1090.html#L49" title="Defined at 49 in src/java/util/concurrent/atomic/AtomicReference.java.">AtomicReference</a>&lt;<a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a>&gt; head = (phase &amp; 1) == 0 ? evenQ : oddQ;
<a id="L998" name="L998"></a> 998         <strong class="reserved">for</strong> (;;) <em class="brace">{</em>
<a id="L999" name="L999"></a> 999             <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a> t;
<a id="L1000" name="L1000"></a>1000             <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> q = head.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>();
<a id="L1001" name="L1001"></a>1001             <strong class="reserved">int</strong> p = (<strong class="reserved">int</strong>)(<a href="../S/867.html#L1804" title="Defined at 1804 in src/java/util/HashMap.java.">root</a>.<a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> &gt;&gt;&gt; PHASE_SHIFT);
<a id="L1002" name="L1002"></a>1002             <strong class="reserved">if</strong> (q == <strong class="reserved">null</strong> || ((t = q.thread) != <strong class="reserved">null</strong> &amp;&amp; q.phase == p))
<a id="L1003" name="L1003"></a>1003                 <strong class="reserved">return</strong> p;
<a id="L1004" name="L1004"></a>1004             <strong class="reserved">if</strong> (head.<a href="../D/13035.html" title="Multiple defined in 16 places.">compareAndSet</a>(q, q.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>) &amp;&amp; t != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L1005" name="L1005"></a>1005                 q.thread = <strong class="reserved">null</strong>;
<a id="L1006" name="L1006"></a>1006                 <a href="../S/1045.html#L120" title="Defined at 120 in src/java/util/concurrent/locks/LockSupport.java.">LockSupport</a>.<a href="../S/1045.html#L139" title="Defined at 139 in src/java/util/concurrent/locks/LockSupport.java.">unpark</a>(t);
<a id="L1007" name="L1007"></a>1007             <em class="brace">}</em>
<a id="L1008" name="L1008"></a>1008         <em class="brace">}</em>
<a id="L1009" name="L1009"></a>1009     <em class="brace">}</em>
<a id="L1010" name="L1010"></a>1010 
<div class="comment">
     /** The number of CPUs, for spin control */</div>
<a id="L1012" name="L1012"></a>1012     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> NCPU = <a href="../S/1774.html#L46" title="Defined at 46 in src/java/lang/Runtime.java.">Runtime</a>.<a href="../S/1774.html#L57" title="Defined at 57 in src/java/lang/Runtime.java.">getRuntime</a>().<a href="../S/1774.html#L635" title="Defined at 635 in src/java/lang/Runtime.java.">availableProcessors</a>();
<a id="L1013" name="L1013"></a>1013 
<div class="comment">
      The number of times to spin before blocking while waiting for
      advance, per arrival while waiting. On multiprocessors, fully
      blocking and waking up a large number of threads all at once is
      usually a very slow process, so we use rechargeable spins to
      avoid it when threads regularly arrive: When a thread in
      internalAwaitAdvance notices another arrival before blocking,
      and there appear to be enough CPUs available, it spins
      SPINS_PER_ARRIVAL more times before blocking. The value trades
      off good-citizenship vs big unnecessary slowdowns.</div>
<a id="L1025" name="L1025"></a>1025     <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> SPINS_PER_ARRIVAL = (NCPU &lt; 2) ? 1 : 1 &lt;&lt; 8;
<a id="L1026" name="L1026"></a>1026 
<div class="comment">
      Possibly blocks and waits for phase to advance unless aborted.
      Call only on root phaser.
      @param phase current phase
      @param node if non-null, the wait node to track interrupt and timeout;
      if null, denotes noninterruptible wait
      @return current phase</div>
<a id="L1036" name="L1036"></a>1036     <strong class="reserved">private</strong> <strong class="reserved">int</strong> <a href="../R/20921.html" title="Multiple referred from 5 places.">internalAwaitAdvance</a>(<strong class="reserved">int</strong> phase, <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> <a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>) <em class="brace">{</em>
<a id="L1037" name="L1037"></a>1037         <em class="comment">// assert root == this;</em>
<a id="L1038" name="L1038"></a>1038         <a href="../S/1057.html#L973" title="Defined at 973 in src/java/util/concurrent/Phaser.java.">releaseWaiters</a>(phase-1);          <em class="comment">// ensure old queue clean</em>
<a id="L1039" name="L1039"></a>1039         <strong class="reserved">boolean</strong> queued = <strong class="reserved">false</strong>;           <em class="comment">// true when node is enqueued</em>
<a id="L1040" name="L1040"></a>1040         <strong class="reserved">int</strong> lastUnarrived = 0;            <em class="comment">// to increase spins upon change</em>
<a id="L1041" name="L1041"></a>1041         <strong class="reserved">int</strong> spins = SPINS_PER_ARRIVAL;
<a id="L1042" name="L1042"></a>1042         <strong class="reserved">long</strong> s;
<a id="L1043" name="L1043"></a>1043         <strong class="reserved">int</strong> p;
<a id="L1044" name="L1044"></a>1044         <strong class="reserved">while</strong> ((p = (<strong class="reserved">int</strong>)((s = <a href="../D/34848.html" title="Multiple defined in 2 places.">state</a>) &gt;&gt;&gt; PHASE_SHIFT)) == phase) <em class="brace">{</em>
<a id="L1045" name="L1045"></a>1045             <strong class="reserved">if</strong> (<a href="../D/28235.html" title="Multiple defined in 11 places.">node</a> == <strong class="reserved">null</strong>) <em class="brace">{</em>           <em class="comment">// spinning in noninterruptible mode</em>
<a id="L1046" name="L1046"></a>1046                 <strong class="reserved">int</strong> unarrived = (<strong class="reserved">int</strong>)s &amp; UNARRIVED_MASK;
<a id="L1047" name="L1047"></a>1047                 <strong class="reserved">if</strong> (unarrived != lastUnarrived &amp;&amp;
<a id="L1048" name="L1048"></a>1048                     (lastUnarrived = unarrived) &lt; NCPU)
<a id="L1049" name="L1049"></a>1049                     spins += SPINS_PER_ARRIVAL;
<a id="L1050" name="L1050"></a>1050                 <strong class="reserved">boolean</strong> <a href="../S/1769.html#L943" title="Defined at 943 in src/java/lang/Thread.java.">interrupted</a> = <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L943" title="Defined at 943 in src/java/lang/Thread.java.">interrupted</a>();
<a id="L1051" name="L1051"></a>1051                 <strong class="reserved">if</strong> (<a href="../S/1769.html#L943" title="Defined at 943 in src/java/lang/Thread.java.">interrupted</a> || --spins &lt; 0) <em class="brace">{</em> <em class="comment">// need node to record intr</em>
<a id="L1052" name="L1052"></a>1052                     <a href="../D/28235.html" title="Multiple defined in 11 places.">node</a> = <strong class="reserved">new</strong> <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a>(<strong class="reserved">this</strong>, phase, <strong class="reserved">false</strong>, <strong class="reserved">false</strong>, 0L);
<a id="L1053" name="L1053"></a>1053                     <a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>.wasInterrupted = <a href="../S/1769.html#L943" title="Defined at 943 in src/java/lang/Thread.java.">interrupted</a>;
<a id="L1054" name="L1054"></a>1054                 <em class="brace">}</em>
<a id="L1055" name="L1055"></a>1055             <em class="brace">}</em>
<a id="L1056" name="L1056"></a>1056             <strong class="reserved">else</strong> <strong class="reserved">if</strong> (<a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>.<a href="../D/26148.html" title="Multiple defined in 3 places.">isReleasable</a>()) <em class="comment">// done or aborted</em>
<a id="L1057" name="L1057"></a>1057                 <strong class="reserved">break</strong>;
<a id="L1058" name="L1058"></a>1058             <strong class="reserved">else</strong> <strong class="reserved">if</strong> (!queued) <em class="brace">{</em>           <em class="comment">// push onto queue</em>
<a id="L1059" name="L1059"></a>1059                 <a href="../S/1090.html#L49" title="Defined at 49 in src/java/util/concurrent/atomic/AtomicReference.java.">AtomicReference</a>&lt;<a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a>&gt; head = (phase &amp; 1) == 0 ? evenQ : oddQ;
<a id="L1060" name="L1060"></a>1060                 <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> q = <a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>.<a href="../D/28131.html" title="Multiple defined in 273 places.">next</a> = head.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>();
<a id="L1061" name="L1061"></a>1061                 <strong class="reserved">if</strong> ((q == <strong class="reserved">null</strong> || q.phase == phase) &amp;&amp;
<a id="L1062" name="L1062"></a>1062                     (<strong class="reserved">int</strong>)(<a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> &gt;&gt;&gt; PHASE_SHIFT) == phase) <em class="comment">// avoid stale enq</em>
<a id="L1063" name="L1063"></a>1063                     queued = head.<a href="../D/13035.html" title="Multiple defined in 16 places.">compareAndSet</a>(q, <a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>);
<a id="L1064" name="L1064"></a>1064             <em class="brace">}</em>
<a id="L1065" name="L1065"></a>1065             <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L1066" name="L1066"></a>1066                 <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L1067" name="L1067"></a>1067                     <a href="../S/1063.html#L170" title="Defined at 170 in src/java/util/concurrent/ForkJoinPool.java.">ForkJoinPool</a>.<a href="../S/1063.html#L3301" title="Defined at 3301 in src/java/util/concurrent/ForkJoinPool.java.">managedBlock</a>(<a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>);
<a id="L1068" name="L1068"></a>1068                 <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/1730.html#L50" title="Defined at 50 in src/java/lang/InterruptedException.java.">InterruptedException</a> ie) <em class="brace">{</em>
<a id="L1069" name="L1069"></a>1069                     <a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>.wasInterrupted = <strong class="reserved">true</strong>;
<a id="L1070" name="L1070"></a>1070                 <em class="brace">}</em>
<a id="L1071" name="L1071"></a>1071             <em class="brace">}</em>
<a id="L1072" name="L1072"></a>1072         <em class="brace">}</em>
<a id="L1073" name="L1073"></a>1073 
<a id="L1074" name="L1074"></a>1074         <strong class="reserved">if</strong> (<a href="../D/28235.html" title="Multiple defined in 11 places.">node</a> != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L1075" name="L1075"></a>1075             <strong class="reserved">if</strong> (<a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>.thread != <strong class="reserved">null</strong>)
<a id="L1076" name="L1076"></a>1076                 <a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>.thread = <strong class="reserved">null</strong>;       <em class="comment">// avoid need for unpark()</em>
<a id="L1077" name="L1077"></a>1077             <strong class="reserved">if</strong> (<a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>.wasInterrupted &amp;&amp; !<a href="../D/28235.html" title="Multiple defined in 11 places.">node</a>.interruptible)
<a id="L1078" name="L1078"></a>1078                 <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L264" title="Defined at 264 in src/java/lang/Thread.java.">currentThread</a>().<a href="../D/24969.html" title="Multiple defined in 3 places.">interrupt</a>();
<a id="L1079" name="L1079"></a>1079             <strong class="reserved">if</strong> (p == phase &amp;&amp; (p = (<strong class="reserved">int</strong>)(<a href="../D/34848.html" title="Multiple defined in 2 places.">state</a> &gt;&gt;&gt; PHASE_SHIFT)) == phase)
<a id="L1080" name="L1080"></a>1080                 <strong class="reserved">return</strong> <a href="../S/1057.html#L996" title="Defined at 996 in src/java/util/concurrent/Phaser.java.">abortWait</a>(phase); <em class="comment">// possibly clean up on abort</em>
<a id="L1081" name="L1081"></a>1081         <em class="brace">}</em>
<a id="L1082" name="L1082"></a>1082         <a href="../S/1057.html#L973" title="Defined at 973 in src/java/util/concurrent/Phaser.java.">releaseWaiters</a>(phase);
<a id="L1083" name="L1083"></a>1083         <strong class="reserved">return</strong> p;
<a id="L1084" name="L1084"></a>1084     <em class="brace">}</em>
<a id="L1085" name="L1085"></a>1085 
<div class="comment">
      Wait nodes for Treiber stack representing wait queue</div>
<a id="L1089" name="L1089"></a>1089     <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">class</strong> <a href="../R/6359.html" title="Multiple referred from 49 places.">QNode</a> <strong class="reserved">implements</strong> <a href="../S/1063.html#L170" title="Defined at 170 in src/java/util/concurrent/ForkJoinPool.java.">ForkJoinPool</a>.<a href="../S/1063.html#L3256" title="Defined at 3256 in src/java/util/concurrent/ForkJoinPool.java.">ManagedBlocker</a> <em class="brace">{</em>
<a id="L1090" name="L1090"></a>1090         <strong class="reserved">final</strong> <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> phaser;
<a id="L1091" name="L1091"></a>1091         <strong class="reserved">final</strong> <strong class="reserved">int</strong> phase;
<a id="L1092" name="L1092"></a>1092         <strong class="reserved">final</strong> <strong class="reserved">boolean</strong> interruptible;
<a id="L1093" name="L1093"></a>1093         <strong class="reserved">final</strong> <strong class="reserved">boolean</strong> timed;
<a id="L1094" name="L1094"></a>1094         <strong class="reserved">boolean</strong> wasInterrupted;
<a id="L1095" name="L1095"></a>1095         <strong class="reserved">long</strong> nanos;
<a id="L1096" name="L1096"></a>1096         <strong class="reserved">final</strong> <strong class="reserved">long</strong> deadline;
<a id="L1097" name="L1097"></a>1097         <strong class="reserved">volatile</strong> <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a> thread; <em class="comment">// nulled to cancel wait</em>
<a id="L1098" name="L1098"></a>1098         <a href="../D/6979.html" title="Multiple defined in 3 places.">QNode</a> <a href="../D/28131.html" title="Multiple defined in 273 places.">next</a>;
<a id="L1099" name="L1099"></a>1099 
<a id="L1100" name="L1100"></a>1100         QNode(<a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a> phaser, <strong class="reserved">int</strong> phase, <strong class="reserved">boolean</strong> interruptible,
<a id="L1101" name="L1101"></a>1101               <strong class="reserved">boolean</strong> timed, <strong class="reserved">long</strong> nanos) <em class="brace">{</em>
<a id="L1102" name="L1102"></a>1102             <strong class="reserved">this</strong>.phaser = phaser;
<a id="L1103" name="L1103"></a>1103             <strong class="reserved">this</strong>.phase = phase;
<a id="L1104" name="L1104"></a>1104             <strong class="reserved">this</strong>.interruptible = interruptible;
<a id="L1105" name="L1105"></a>1105             <strong class="reserved">this</strong>.nanos = nanos;
<a id="L1106" name="L1106"></a>1106             <strong class="reserved">this</strong>.timed = timed;
<a id="L1107" name="L1107"></a>1107             <strong class="reserved">this</strong>.deadline = timed ? <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1557.html#L399" title="Defined at 399 in src/java/lang/System.java.">nanoTime</a>() + nanos : 0L;
<a id="L1108" name="L1108"></a>1108             thread = <a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L264" title="Defined at 264 in src/java/lang/Thread.java.">currentThread</a>();
<a id="L1109" name="L1109"></a>1109         <em class="brace">}</em>
<a id="L1110" name="L1110"></a>1110 
<a id="L1111" name="L1111"></a>1111         <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/21942.html" title="Multiple referred from 8 places.">isReleasable</a>() <em class="brace">{</em>
<a id="L1112" name="L1112"></a>1112             <strong class="reserved">if</strong> (thread == <strong class="reserved">null</strong>)
<a id="L1113" name="L1113"></a>1113                 <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L1114" name="L1114"></a>1114             <strong class="reserved">if</strong> (phaser.<a href="../S/1057.html#L838" title="Defined at 838 in src/java/util/concurrent/Phaser.java.">getPhase</a>() != phase) <em class="brace">{</em>
<a id="L1115" name="L1115"></a>1115                 thread = <strong class="reserved">null</strong>;
<a id="L1116" name="L1116"></a>1116                 <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L1117" name="L1117"></a>1117             <em class="brace">}</em>
<a id="L1118" name="L1118"></a>1118             <strong class="reserved">if</strong> (<a href="../S/1769.html#L141" title="Defined at 141 in src/java/lang/Thread.java.">Thread</a>.<a href="../S/1769.html#L943" title="Defined at 943 in src/java/lang/Thread.java.">interrupted</a>())
<a id="L1119" name="L1119"></a>1119                 wasInterrupted = <strong class="reserved">true</strong>;
<a id="L1120" name="L1120"></a>1120             <strong class="reserved">if</strong> (wasInterrupted &amp;&amp; interruptible) <em class="brace">{</em>
<a id="L1121" name="L1121"></a>1121                 thread = <strong class="reserved">null</strong>;
<a id="L1122" name="L1122"></a>1122                 <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L1123" name="L1123"></a>1123             <em class="brace">}</em>
<a id="L1124" name="L1124"></a>1124             <strong class="reserved">if</strong> (timed) <em class="brace">{</em>
<a id="L1125" name="L1125"></a>1125                 <strong class="reserved">if</strong> (nanos &gt; 0L) <em class="brace">{</em>
<a id="L1126" name="L1126"></a>1126                     nanos = deadline - <a href="../S/1557.html#L59" title="Defined at 59 in src/java/lang/System.java.">System</a>.<a href="../S/1557.html#L399" title="Defined at 399 in src/java/lang/System.java.">nanoTime</a>();
<a id="L1127" name="L1127"></a>1127                 <em class="brace">}</em>
<a id="L1128" name="L1128"></a>1128                 <strong class="reserved">if</strong> (nanos &lt;= 0L) <em class="brace">{</em>
<a id="L1129" name="L1129"></a>1129                     thread = <strong class="reserved">null</strong>;
<a id="L1130" name="L1130"></a>1130                     <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L1131" name="L1131"></a>1131                 <em class="brace">}</em>
<a id="L1132" name="L1132"></a>1132             <em class="brace">}</em>
<a id="L1133" name="L1133"></a>1133             <strong class="reserved">return</strong> <strong class="reserved">false</strong>;
<a id="L1134" name="L1134"></a>1134         <em class="brace">}</em>
<a id="L1135" name="L1135"></a>1135 
<a id="L1136" name="L1136"></a>1136         <strong class="reserved">public</strong> <strong class="reserved">boolean</strong> <a href="../R/10632.html" title="Multiple referred from 165 places.">block</a>() <em class="brace">{</em>
<a id="L1137" name="L1137"></a>1137             <strong class="reserved">if</strong> (<a href="../D/26148.html" title="Multiple defined in 3 places.">isReleasable</a>())
<a id="L1138" name="L1138"></a>1138                 <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L1139" name="L1139"></a>1139             <strong class="reserved">else</strong> <strong class="reserved">if</strong> (!timed)
<a id="L1140" name="L1140"></a>1140                 <a href="../S/1045.html#L120" title="Defined at 120 in src/java/util/concurrent/locks/LockSupport.java.">LockSupport</a>.<a href="../D/29072.html" title="Multiple defined in 2 places.">park</a>(<strong class="reserved">this</strong>);
<a id="L1141" name="L1141"></a>1141             <strong class="reserved">else</strong> <strong class="reserved">if</strong> (nanos &gt; 0L)
<a id="L1142" name="L1142"></a>1142                 <a href="../S/1045.html#L120" title="Defined at 120 in src/java/util/concurrent/locks/LockSupport.java.">LockSupport</a>.<a href="../D/29074.html" title="Multiple defined in 2 places.">parkNanos</a>(<strong class="reserved">this</strong>, nanos);
<a id="L1143" name="L1143"></a>1143             <strong class="reserved">return</strong> <a href="../D/26148.html" title="Multiple defined in 3 places.">isReleasable</a>();
<a id="L1144" name="L1144"></a>1144         <em class="brace">}</em>
<a id="L1145" name="L1145"></a>1145     <em class="brace">}</em>
<a id="L1146" name="L1146"></a>1146 
<a id="L1147" name="L1147"></a>1147     <em class="comment">// Unsafe mechanics</em>
<a id="L1148" name="L1148"></a>1148 
<a id="L1149" name="L1149"></a>1149     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> sun.misc.Unsafe UNSAFE;
<a id="L1150" name="L1150"></a>1150     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">long</strong> stateOffset;
<a id="L1151" name="L1151"></a>1151     <strong class="reserved">static</strong> <em class="brace">{</em>
<a id="L1152" name="L1152"></a>1152         <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L1153" name="L1153"></a>1153             UNSAFE = sun.misc.Unsafe.getUnsafe();
<a id="L1154" name="L1154"></a>1154             <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; k = <a href="../S/1057.html#L261" title="Defined at 261 in src/java/util/concurrent/Phaser.java.">Phaser</a>.<strong class="reserved">class</strong>;
<a id="L1155" name="L1155"></a>1155             stateOffset = UNSAFE.<a href="../D/28395.html" title="Multiple defined in 5 places.">objectFieldOffset</a>
<a id="L1156" name="L1156"></a>1156                 (k.<a href="../S/1722.html#L2065" title="Defined at 2065 in src/java/lang/Class.java.">getDeclaredField</a>("state"));
<a id="L1157" name="L1157"></a>1157         <em class="brace">}</em> <strong class="reserved">catch</strong> (<a href="../S/1582.html#L45" title="Defined at 45 in src/java/lang/Exception.java.">Exception</a> e) <em class="brace">{</em>
<a id="L1158" name="L1158"></a>1158             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1772.html#L49" title="Defined at 49 in src/java/lang/Error.java.">Error</a>(e);
<a id="L1159" name="L1159"></a>1159         <em class="brace">}</em>
<a id="L1160" name="L1160"></a>1160     <em class="brace">}</em>
<a id="L1161" name="L1161"></a>1161 <em class="brace">}</em>
</pre>
<hr>
<div class="comment">
/* [&lt;][&gt;]<a href="#L314">[^]</a><a href="#L1136">[v]</a><a href="#TOP">[top]</a>[bottom]<a href="../mains.html">[index]</a><a href="../help.html">[help]</a> */</div>
</body></html>