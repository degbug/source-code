<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
<title>src/java/lang/ClassValue.java</title>
<meta name="robots" content="noindex,nofollow">
<meta name="generator" content="GLOBAL-6.6.3">
<meta http-equiv="Content-Style-Type" content="text/css">
<link rel="stylesheet" type="text/css" href="../style.css">
</head>
<body>
<a id="TOP" name="TOP"></a><div class="comment">
/* [&lt;][&gt;]<a href="#L71">[^]</a><a href="#L748">[v]</a>[top]<a href="#BOTTOM">[bottom]</a><a href="../mains.html">[index]</a><a href="../help.html">[help]</a> */</div>
<hr>
<h2 class="header">DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href="#L71" title="Defined at 71.">computeValue</a></li>
<li><a href="#L99" title="Defined at 99.">get</a></li>
<li><a href="#L171" title="Defined at 171.">remove</a></li>
<li><a href="#L177" title="Defined at 177.">put</a></li>
<li><a href="#L187" title="Defined at 187.">getCacheCarefully</a></li>
<li><a href="#L205" title="Defined at 205.">getFromBackup</a></li>
<li><a href="#L213" title="Defined at 213.">SuppressWarnings</a></li>
<li><a href="#L214" title="Defined at 214.">castEntry</a></li>
<li><a href="#L218" title="Defined at 218.">getFromHashMap</a></li>
<li><a href="#L240" title="Defined at 240.">match</a></li>
<li><a href="#L301" title="Defined at 301.">version</a></li>
<li><a href="#L302" title="Defined at 302.">bumpVersion</a></li>
<li><a href="#L307" title="Defined at 307.">classValue</a></li>
<li><a href="#L308" title="Defined at 308.">promise</a></li>
<li><a href="#L309" title="Defined at 309.">isLive</a></li>
<li><a href="#L329" title="Defined at 329.">assertNotPromise</a></li>
<li><a href="#L336" title="Defined at 336.">SuppressWarnings</a></li>
<li><a href="#L337" title="Defined at 337.">value</a></li>
<li><a href="#L338" title="Defined at 338.">isPromise</a></li>
<li><a href="#L339" title="Defined at 339.">version</a></li>
<li><a href="#L340" title="Defined at 340.">classValueOrNull</a></li>
<li><a href="#L344" title="Defined at 344.">isLive</a></li>
<li><a href="#L351" title="Defined at 351.">refreshVersion</a></li>
<li><a href="#L363" title="Defined at 363.">getMap</a></li>
<li><a href="#L373" title="Defined at 373.">initializeMap</a></li>
<li><a href="#L383" title="Defined at 383.">makeEntry</a></li>
<li><a href="#L424" title="Defined at 424.">getCache</a></li>
<li><a href="#L428" title="Defined at 428.">startEntry</a></li>
<li><a href="#L464" title="Defined at 464.">finishEntry</a></li>
<li><a href="#L491" title="Defined at 491.">removeEntry</a></li>
<li><a href="#L510" title="Defined at 510.">changeEntry</a></li>
<li><a href="#L535" title="Defined at 535.">loadFromCache</a></li>
<li><a href="#L543" title="Defined at 543.">probeHomeLocation</a></li>
<li><a href="#L548" title="Defined at 548.">probeBackupLocations</a></li>
<li><a href="#L584" title="Defined at 584.">entryDislocation</a></li>
<li><a href="#L595" title="Defined at 595.">sizeCache</a></li>
<li><a href="#L603" title="Defined at 603.">checkCacheLoad</a></li>
<li><a href="#L608" title="Defined at 608.">reduceCacheLoad</a></li>
<li><a href="#L626" title="Defined at 626.">removeStaleEntries</a></li>
<li><a href="#L650" title="Defined at 650.">findReplacement</a></li>
<li><a href="#L689" title="Defined at 689.">removeStaleEntries</a></li>
<li><a href="#L694" title="Defined at 694.">removeStaleEntries</a></li>
<li><a href="#L700" title="Defined at 700.">addToCache</a></li>
<li><a href="#L707" title="Defined at 707.">addToCache</a></li>
<li><a href="#L731" title="Defined at 731.">placeInCache</a></li>
<li><a href="#L748" title="Defined at 748.">overwrittenEntry</a></li>
</ol>
<hr>
<pre>
<div class="comment">
  Copyright (c) 2010, 2013, Oracle and/or its affiliates. All rights reserved.
  ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.</div>
<a id="L25" name="L25"></a>  25 
<a id="L26" name="L26"></a>  26 <strong class="reserved">package</strong> <a href="../S/3625.html#L43" title="Defined at 43 in src/javax/management/remote/rmi/RMIConnectionImpl_Stub.java.">java</a>.lang;
<a id="L27" name="L27"></a>  27 
<a id="L28" name="L28"></a>  28 <strong class="reserved">import</strong> java.lang.ClassValue.ClassValueMap;
<a id="L29" name="L29"></a>  29 <strong class="reserved">import</strong> java.util.WeakHashMap;
<a id="L30" name="L30"></a>  30 <strong class="reserved">import</strong> java.lang.ref.WeakReference;
<a id="L31" name="L31"></a>  31 <strong class="reserved">import</strong> java.util.concurrent.atomic.AtomicInteger;
<a id="L32" name="L32"></a>  32 
<a id="L33" name="L33"></a>  33 <strong class="reserved">import</strong> static java.lang.ClassValue.ClassValueMap.probeHomeLocation;
<a id="L34" name="L34"></a>  34 <strong class="reserved">import</strong> static java.lang.ClassValue.ClassValueMap.probeBackupLocations;
<a id="L35" name="L35"></a>  35 
<div class="comment">
  Lazily associate a computed value with (potentially) every type.
  For example, if a dynamic language needs to construct a message dispatch
  table for each class encountered at a message send call site,
  it can use a <code>ClassValue</code> to cache information needed to
  perform the message send quickly, for each class encountered.
  @author John Rose, JSR 292 EG
  @since 1.7</div>
<a id="L45" name="L45"></a>  45 <strong class="reserved">public</strong> <strong class="reserved">abstract</strong> <strong class="reserved">class</strong> <a href="../R/1405.html" title="Multiple referred from 26 places.">ClassValue</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <em class="brace">{</em>
<div class="comment">
      Sole constructor.  (For invocation by subclass constructors, typically
      implicit.)</div>
<a id="L50" name="L50"></a>  50     <strong class="reserved">protected</strong> ClassValue() <em class="brace">{</em>
<a id="L51" name="L51"></a>  51     <em class="brace">}</em>
<a id="L52" name="L52"></a>  52 
<div class="comment">
      Computes the given class's derived value for this <code>ClassValue</code>.
      <p>
      This method will be invoked within the first thread that accesses
      the value with the {@link #get get} method.
      </p><p>
      Normally, this method is invoked at most once per class,
      but it may be invoked again if there has been a call to
      {@link #remove remove}.
      </p><p>
      If this method throws an exception, the corresponding call to <code>get</code>
      will terminate abnormally with that exception, and no class value will be recorded.
      @param type the type whose class value must be computed
      @return the newly computed value associated with this <code>ClassValue</code>, for the given class or interface
      @see #get
      @see #remove</p></div>
<a id="L71" name="L71"></a>  71     <strong class="reserved">protected</strong> <strong class="reserved">abstract</strong> <a href="../D/8701.html" title="Multiple defined in 3 places.">T</a> <a href="../R/11848.html" title="Multiple referred from 4 places.">computeValue</a>(<a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>);
<a id="L72" name="L72"></a>  72 
<div class="comment">
      Returns the value for the given class.
      If no value has yet been computed, it is obtained by
      an invocation of the {@link #computeValue computeValue} method.
      <p>
      The actual installation of the value on the class
      is performed atomically.
      At that point, if several racing threads have
      computed values, one is chosen, and returned to
      all the racing threads.
      </p><p>
      The <code>type</code> parameter is typically a class, but it may be any type,
      such as an interface, a primitive type (like <code>int.class</code>), or <code>void.class</code>.
      </p><p>
      In the absence of <code>remove</code> calls, a class value has a simple
      state diagram:  uninitialized and initialized.
      When <code>remove</code> calls are made,
      the rules for value observation are more complex.
      See the documentation for {@link #remove remove} for more information.
      @param type the type whose class value must be computed or retrieved
      @return the current value associated with this <code>ClassValue</code>, for the given class or interface
      @throws NullPointerException if the argument is null
      @see #remove
      @see #computeValue</p></div>
<a id="L99" name="L99"></a>  99     <strong class="reserved">public</strong> <a href="../D/8701.html" title="Multiple defined in 3 places.">T</a> <a href="../R/14874.html" title="Multiple referred from 4230 places.">get</a>(<a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>) <em class="brace">{</em>
<a id="L100" name="L100"></a> 100         <em class="comment">// non-racing this.hashCodeForCache : final int</em>
<a id="L101" name="L101"></a> 101         <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>;
<a id="L102" name="L102"></a> 102         <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; e = <a href="../S/1784.html#L543" title="Defined at 543 in src/java/lang/ClassValue.java.">probeHomeLocation</a>(<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a> = <a href="../S/1784.html#L187" title="Defined at 187 in src/java/lang/ClassValue.java.">getCacheCarefully</a>(<a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>), <strong class="reserved">this</strong>);
<a id="L103" name="L103"></a> 103         <em class="comment">// racing e : current value &lt;=&gt; stale value from current cache or from stale cache</em>
<a id="L104" name="L104"></a> 104         <em class="comment">// invariant:  e is null or an Entry with readable Entry.version and Entry.value</em>
<a id="L105" name="L105"></a> 105         <strong class="reserved">if</strong> (<a href="../D/27519.html" title="Multiple defined in 69 places.">match</a>(e))
<a id="L106" name="L106"></a> 106             <em class="comment">// invariant:  No false positive matches.  False negatives are OK if rare.</em>
<a id="L107" name="L107"></a> 107             <em class="comment">// The key fact that makes this work: if this.version == e.version,</em>
<a id="L108" name="L108"></a> 108             <em class="comment">// then this thread has a right to observe (final) e.value.</em>
<a id="L109" name="L109"></a> 109             <strong class="reserved">return</strong> e.<a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>();
<a id="L110" name="L110"></a> 110         <em class="comment">// The fast path can fail for any of these reasons:</em>
<a id="L111" name="L111"></a> 111         <em class="comment">// 1. no entry has been computed yet</em>
<a id="L112" name="L112"></a> 112         <em class="comment">// 2. hash code collision (before or after reduction mod cache.length)</em>
<a id="L113" name="L113"></a> 113         <em class="comment">// 3. an entry has been removed (either on this type or another)</em>
<a id="L114" name="L114"></a> 114         <em class="comment">// 4. the GC has somehow managed to delete e.version and clear the reference</em>
<a id="L115" name="L115"></a> 115         <strong class="reserved">return</strong> <a href="../S/1784.html#L205" title="Defined at 205 in src/java/lang/ClassValue.java.">getFromBackup</a>(<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>);
<a id="L116" name="L116"></a> 116     <em class="brace">}</em>
<a id="L117" name="L117"></a> 117 
<div class="comment">
      Removes the associated value for the given class.
      If this value is subsequently {@linkplain #get read} for the same class,
      its value will be reinitialized by invoking its {@link #computeValue computeValue} method.
      This may result in an additional invocation of the
      <code>computeValue</code> method for the given class.
      <p>
      In order to explain the interaction between <code>get</code> and <code>remove</code> calls,
      we must model the state transitions of a class value to take into account
      the alternation between uninitialized and initialized states.
      To do this, number these states sequentially from zero, and note that
      uninitialized (or removed) states are numbered with even numbers,
      while initialized (or re-initialized) states have odd numbers.
      </p><p>
      When a thread <code>T</code> removes a class value in state <code>2N</code>,
      nothing happens, since the class value is already uninitialized.
      Otherwise, the state is advanced atomically to <code>2N+1</code>.
      </p><p>
      When a thread <code>T</code> queries a class value in state <code>2N</code>,
      the thread first attempts to initialize the class value to state <code>2N+1</code>
      by invoking <code>computeValue</code> and installing the resulting value.
      </p><p>
      When <code>T</code> attempts to install the newly computed value,
      if the state is still at <code>2N</code>, the class value will be initialized
      with the computed value, advancing it to state <code>2N+1</code>.
      </p><p>
      Otherwise, whether the new state is even or odd,
      <code>T</code> will discard the newly computed value
      and retry the <code>get</code> operation.
      </p><p>
      Discarding and retrying is an important proviso,
      since otherwise <code>T</code> could potentially install
      a disastrously stale value.  For example:
      </p><ul><li><code>T</code> calls <code>CV.get(C)</code> and sees state <code>2N</code>
      </li><li><code>T</code> quickly computes a time-dependent value <code>V0</code> and gets ready to install it
      </li><li><code>T</code> is hit by an unlucky paging or scheduling event, and goes to sleep for a long time
      </li><li>...meanwhile, <code>T2</code> also calls <code>CV.get(C)</code> and sees state <code>2N</code>
      </li><li><code>T2</code> quickly computes a similar time-dependent value <code>V1</code> and installs it on <code>CV.get(C)</code>
      </li><li><code>T2</code> (or a third thread) then calls <code>CV.remove(C)</code>, undoing <code>T2</code>'s work
      </li><li> the previous actions of <code>T2</code> are repeated several times
      </li><li> also, the relevant computed values change over time: <code>V1</code>, <code>V2</code>, ...
      </li><li>...meanwhile, <code>T</code> wakes up and attempts to install <code>V0</code>; <em>this must fail</em>
      </li></ul>
      We can assume in the above scenario that <code>CV.computeValue</code> uses locks to properly
      observe the time-dependent states as it computes <code>V1</code>, etc.
      This does not remove the threat of a stale value, since there is a window of time
      between the return of <code>computeValue</code> in <code>T</code> and the installation
      of the the new value.  No user synchronization is possible during this time.
      @param type the type whose class value must be removed
      @throws NullPointerException if the argument is null</div>
<a id="L171" name="L171"></a> 171     <strong class="reserved">public</strong> <strong class="reserved">void</strong> <a href="../R/25882.html" title="Multiple referred from 1115 places.">remove</a>(<a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>) <em class="brace">{</em>
<a id="L172" name="L172"></a> 172         <a href="../S/1784.html#L405" title="Defined at 405 in src/java/lang/ClassValue.java.">ClassValueMap</a> <a href="../D/27441.html" title="Multiple defined in 12 places.">map</a> = <a href="../D/20367.html" title="Multiple defined in 6 places.">getMap</a>(<a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>);
<a id="L173" name="L173"></a> 173         <a href="../D/27441.html" title="Multiple defined in 12 places.">map</a>.<a href="../D/30784.html" title="Multiple defined in 11 places.">removeEntry</a>(<strong class="reserved">this</strong>);
<a id="L174" name="L174"></a> 174     <em class="brace">}</em>
<a id="L175" name="L175"></a> 175 
<a id="L176" name="L176"></a> 176     <em class="comment">// Possible functionality for JSR 292 MR 1</em>
<div class="comment">
     /*public*/</div> <strong class="reserved">void</strong> <a href="../R/25285.html" title="Multiple referred from 5173 places.">put</a>(<a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>, <a href="../D/8701.html" title="Multiple defined in 3 places.">T</a> <a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>) <em class="brace">{</em>
<a id="L178" name="L178"></a> 178         <a href="../S/1784.html#L405" title="Defined at 405 in src/java/lang/ClassValue.java.">ClassValueMap</a> <a href="../D/27441.html" title="Multiple defined in 12 places.">map</a> = <a href="../D/20367.html" title="Multiple defined in 6 places.">getMap</a>(<a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>);
<a id="L179" name="L179"></a> 179         <a href="../D/27441.html" title="Multiple defined in 12 places.">map</a>.<a href="../S/1784.html#L510" title="Defined at 510 in src/java/lang/ClassValue.java.">changeEntry</a>(<strong class="reserved">this</strong>, <a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>);
<a id="L180" name="L180"></a> 180     <em class="brace">}</em>
<a id="L181" name="L181"></a> 181 
<a id="L182" name="L182"></a> 182     <em class="comment">/// --------</em>
<a id="L183" name="L183"></a> 183     <em class="comment">/// Implementation...</em>
<a id="L184" name="L184"></a> 184     <em class="comment">/// --------</em>
<a id="L185" name="L185"></a> 185 
<div class="comment">
     /** Return the cache, if it exists, else a dummy empty cache. */</div>
<a id="L187" name="L187"></a> 187     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] <a href="../S/1784.html#L102" title="Referred from 102 in src/java/lang/ClassValue.java.">getCacheCarefully</a>(<a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>) <em class="brace">{</em>
<a id="L188" name="L188"></a> 188         <em class="comment">// racing type.classValueMap{.cacheArray} : null =&gt; new Entry[X] &lt;=&gt; new Entry[Y]</em>
<a id="L189" name="L189"></a> 189         <a href="../S/1784.html#L405" title="Defined at 405 in src/java/lang/ClassValue.java.">ClassValueMap</a> <a href="../D/27441.html" title="Multiple defined in 12 places.">map</a> = <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>.classValueMap;
<a id="L190" name="L190"></a> 190         <strong class="reserved">if</strong> (<a href="../D/27441.html" title="Multiple defined in 12 places.">map</a> == <strong class="reserved">null</strong>)  <strong class="reserved">return</strong> EMPTY_CACHE;
<a id="L191" name="L191"></a> 191         <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a> = <a href="../D/27441.html" title="Multiple defined in 12 places.">map</a>.<a href="../D/17438.html" title="Multiple defined in 2 places.">getCache</a>();
<a id="L192" name="L192"></a> 192         <strong class="reserved">return</strong> <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>;
<a id="L193" name="L193"></a> 193         <em class="comment">// invariant:  returned value is safe to dereference and check for an Entry</em>
<a id="L194" name="L194"></a> 194     <em class="brace">}</em>
<a id="L195" name="L195"></a> 195 
<div class="comment">
     /** Initial, one-element, empty cache used by all Class instances.  Must never be filled. */</div>
<a id="L197" name="L197"></a> 197     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] EMPTY_CACHE = <em class="brace">{</em> <strong class="reserved">null</strong> <em class="brace">}</em>;
<a id="L198" name="L198"></a> 198 
<div class="comment">
      Slow tail of ClassValue.get to retry at nearby locations in the cache,
      or take a slow lock and check the hash table.
      Called only if the first probe was empty or a collision.
      This is a separate method, so compilers can process it independently.</div>
<a id="L205" name="L205"></a> 205     <strong class="reserved">private</strong> <a href="../D/8701.html" title="Multiple defined in 3 places.">T</a> <a href="../S/1784.html#L115" title="Referred from 115 in src/java/lang/ClassValue.java.">getFromBackup</a>(<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>) <em class="brace">{</em>
<a id="L206" name="L206"></a> 206         <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; e = <a href="../S/1784.html#L548" title="Defined at 548 in src/java/lang/ClassValue.java.">probeBackupLocations</a>(<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, <strong class="reserved">this</strong>);
<a id="L207" name="L207"></a> 207         <strong class="reserved">if</strong> (e != <strong class="reserved">null</strong>)
<a id="L208" name="L208"></a> 208             <strong class="reserved">return</strong> e.<a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>();
<a id="L209" name="L209"></a> 209         <strong class="reserved">return</strong> <a href="../S/1784.html#L218" title="Defined at 218 in src/java/lang/ClassValue.java.">getFromHashMap</a>(<a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>);
<a id="L210" name="L210"></a> 210     <em class="brace">}</em>
<a id="L211" name="L211"></a> 211 
<a id="L212" name="L212"></a> 212     <em class="comment">// Hack to suppress warnings on the (T) cast, which is a no-op.</em>
<a id="L213" name="L213"></a> 213     @<a href="../R/7764.html" title="Multiple referred from 264 places.">SuppressWarnings</a>("unchecked")
<a id="L214" name="L214"></a> 214     <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../R/10997.html" title="Multiple referred from 2 places.">castEntry</a>(<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; e) <em class="brace">{</em> <strong class="reserved">return</strong> (<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt;) e; <em class="brace">}</em>
<a id="L215" name="L215"></a> 215 
<div class="comment">
 Called when the fast path of get fails, and cache reprobe also fails.</div>
<a id="L218" name="L218"></a> 218     <strong class="reserved">private</strong> <a href="../D/8701.html" title="Multiple defined in 3 places.">T</a> <a href="../S/1784.html#L209" title="Referred from 209 in src/java/lang/ClassValue.java.">getFromHashMap</a>(<a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>) <em class="brace">{</em>
<a id="L219" name="L219"></a> 219         <em class="comment">// The fail-safe recovery is to fall back to the underlying classValueMap.</em>
<a id="L220" name="L220"></a> 220         <a href="../S/1784.html#L405" title="Defined at 405 in src/java/lang/ClassValue.java.">ClassValueMap</a> <a href="../D/27441.html" title="Multiple defined in 12 places.">map</a> = <a href="../D/20367.html" title="Multiple defined in 6 places.">getMap</a>(<a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>);
<a id="L221" name="L221"></a> 221         <strong class="reserved">for</strong> (;;) <em class="brace">{</em>
<a id="L222" name="L222"></a> 222             <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; e = <a href="../D/27441.html" title="Multiple defined in 12 places.">map</a>.<a href="../S/1784.html#L428" title="Defined at 428 in src/java/lang/ClassValue.java.">startEntry</a>(<strong class="reserved">this</strong>);
<a id="L223" name="L223"></a> 223             <strong class="reserved">if</strong> (!e.<a href="../S/1784.html#L338" title="Defined at 338 in src/java/lang/ClassValue.java.">isPromise</a>())
<a id="L224" name="L224"></a> 224                 <strong class="reserved">return</strong> e.<a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>();
<a id="L225" name="L225"></a> 225             <strong class="reserved">try</strong> <em class="brace">{</em>
<a id="L226" name="L226"></a> 226                 <em class="comment">// Try to make a real entry for the promised version.</em>
<a id="L227" name="L227"></a> 227                 e = <a href="../S/1784.html#L383" title="Defined at 383 in src/java/lang/ClassValue.java.">makeEntry</a>(e.<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>(), <a href="../D/13200.html" title="Multiple defined in 4 places.">computeValue</a>(<a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>));
<a id="L228" name="L228"></a> 228             <em class="brace">}</em> <strong class="reserved">finally</strong> <em class="brace">{</em>
<a id="L229" name="L229"></a> 229                 <em class="comment">// Whether computeValue throws or returns normally,</em>
<a id="L230" name="L230"></a> 230                 <em class="comment">// be sure to remove the empty entry.</em>
<a id="L231" name="L231"></a> 231                 e = <a href="../D/27441.html" title="Multiple defined in 12 places.">map</a>.<a href="../S/1784.html#L464" title="Defined at 464 in src/java/lang/ClassValue.java.">finishEntry</a>(<strong class="reserved">this</strong>, e);
<a id="L232" name="L232"></a> 232             <em class="brace">}</em>
<a id="L233" name="L233"></a> 233             <strong class="reserved">if</strong> (e != <strong class="reserved">null</strong>)
<a id="L234" name="L234"></a> 234                 <strong class="reserved">return</strong> e.<a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>();
<a id="L235" name="L235"></a> 235             <em class="comment">// else try again, in case a racing thread called remove (so e == null)</em>
<a id="L236" name="L236"></a> 236         <em class="brace">}</em>
<a id="L237" name="L237"></a> 237     <em class="brace">}</em>
<a id="L238" name="L238"></a> 238 
<div class="comment">
     /** Check that e is non-null, matches this ClassValue, and is live. */</div>
<a id="L240" name="L240"></a> 240     <strong class="reserved">boolean</strong> <a href="../R/23117.html" title="Multiple referred from 460 places.">match</a>(<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; e) <em class="brace">{</em>
<a id="L241" name="L241"></a> 241         <em class="comment">// racing e.version : null (blank) =&gt; unique Version token =&gt; null (GC-ed version)</em>
<a id="L242" name="L242"></a> 242         <em class="comment">// non-racing this.version : v1 =&gt; v2 =&gt; ... (updates are read faithfully from volatile)</em>
<a id="L243" name="L243"></a> 243         <strong class="reserved">return</strong> (e != <strong class="reserved">null</strong> &amp;&amp; e.<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>() == <strong class="reserved">this</strong>.<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>);
<a id="L244" name="L244"></a> 244         <em class="comment">// invariant:  No false positives on version match.  Null is OK for false negative.</em>
<a id="L245" name="L245"></a> 245         <em class="comment">// invariant:  If version matches, then e.value is readable (final set in Entry.&lt;init&gt;)</em>
<a id="L246" name="L246"></a> 246     <em class="brace">}</em>
<a id="L247" name="L247"></a> 247 
<div class="comment">
     /** Internal hash code for accessing Class.classValueMap.cacheArray. */</div>
<a id="L249" name="L249"></a> 249     <strong class="reserved">final</strong> <strong class="reserved">int</strong> hashCodeForCache = <a href="../S/1738.html#L104" title="Defined at 104 in src/java/lang/ThreadLocal.java.">nextHashCode</a>.<a href="../D/16937.html" title="Multiple defined in 8 places.">getAndAdd</a>(HASH_INCREMENT) &amp; HASH_MASK;
<a id="L250" name="L250"></a> 250 
<div class="comment">
     /** Value stream for hashCodeForCache.  See similar structure in ThreadLocal. */</div>
<a id="L252" name="L252"></a> 252     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../S/1089.html#L54" title="Defined at 54 in src/java/util/concurrent/atomic/AtomicInteger.java.">AtomicInteger</a> <a href="../S/1738.html#L104" title="Defined at 104 in src/java/lang/ThreadLocal.java.">nextHashCode</a> = <strong class="reserved">new</strong> <a href="../S/1089.html#L54" title="Defined at 54 in src/java/util/concurrent/atomic/AtomicInteger.java.">AtomicInteger</a>();
<a id="L253" name="L253"></a> 253 
<div class="comment">
     /** Good for power-of-two tables.  See similar structure in ThreadLocal. */</div>
<a id="L255" name="L255"></a> 255     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> HASH_INCREMENT = 0x61c88647;
<a id="L256" name="L256"></a> 256 
<div class="comment">
     /** Mask a hash code to be positive but not too large, to prevent wraparound. */</div>
<a id="L258" name="L258"></a> 258     <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> HASH_MASK = (-1 &gt;&gt;&gt; 2);
<a id="L259" name="L259"></a> 259 
<div class="comment">
      Private key for retrieval of this object from ClassValueMap.</div>
<a id="L263" name="L263"></a> 263     <strong class="reserved">static</strong> <strong class="reserved">class</strong> <a href="../R/3663.html" title="Multiple referred from 13 places.">Identity</a> <em class="brace">{</em>
<a id="L264" name="L264"></a> 264     <em class="brace">}</em>
<div class="comment">
      This ClassValue's identity, expressed as an opaque object.
      The main object <code>ClassValue.this</code> is incorrect since
      subclasses may override <code>ClassValue.equals</code>, which
      could confuse keys in the ClassValueMap.</div>
<a id="L271" name="L271"></a> 271     <strong class="reserved">final</strong> <a href="../D/4036.html" title="Multiple defined in 2 places.">Identity</a> <a href="../D/24301.html" title="Multiple defined in 8 places.">identity</a> = <strong class="reserved">new</strong> <a href="../D/4036.html" title="Multiple defined in 2 places.">Identity</a>();
<a id="L272" name="L272"></a> 272 
<div class="comment">
      Current version for retrieving this class value from the cache.
      Any number of computeValue calls can be cached in association with one version.
      But the version changes when a remove (on any type) is executed.
      A version change invalidates all cache entries for the affected ClassValue,
      by marking them as stale.  Stale cache entries do not force another call
      to computeValue, but they do require a synchronized visit to a backing map.
      <p>
      All user-visible state changes on the ClassValue take place under
      a lock inside the synchronized methods of ClassValueMap.
      Readers (of ClassValue.get) are notified of such state changes
      when this.version is bumped to a new token.
      This variable must be volatile so that an unsynchronized reader
      will receive the notification without delay.
      </p><p>
      If version were not volatile, one thread T1 could persistently hold onto
      a stale value this.value == V1, while while another thread T2 advances
      (under a lock) to this.value == V2.  This will typically be harmless,
      but if T1 and T2 interact causally via some other channel, such that
      T1's further actions are constrained (in the JMM) to happen after
      the V2 event, then T1's observation of V1 will be an error.
      </p><p>
      The practical effect of making this.version be volatile is that it cannot
      be hoisted out of a loop (by an optimizing JIT) or otherwise cached.
      Some machines may also require a barrier instruction to execute
      before this.version.</p></div>
<a id="L300" name="L300"></a> 300     <strong class="reserved">private</strong> <strong class="reserved">volatile</strong> <a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../D/36409.html" title="Multiple defined in 4 places.">version</a> = <strong class="reserved">new</strong> <a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;&gt;(<strong class="reserved">this</strong>);
<a id="L301" name="L301"></a> 301     <a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>() <em class="brace">{</em> <strong class="reserved">return</strong> <a href="../R/30131.html" title="Multiple referred from 624 places.">version</a>; <em class="brace">}</em>
<a id="L302" name="L302"></a> 302     <strong class="reserved">void</strong> <a href="../R/10732.html" title="Multiple referred from 2 places.">bumpVersion</a>() <em class="brace">{</em> <a href="../D/36409.html" title="Multiple defined in 4 places.">version</a> = <strong class="reserved">new</strong> <a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;&gt;(<strong class="reserved">this</strong>); <em class="brace">}</em>
<a id="L303" name="L303"></a> 303     <strong class="reserved">static</strong> <strong class="reserved">class</strong> <a href="../R/8656.html" title="Multiple referred from 17 places.">Version</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <em class="brace">{</em>
<a id="L304" name="L304"></a> 304         <strong class="reserved">private</strong> <strong class="reserved">final</strong> <a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>;
<a id="L305" name="L305"></a> 305         <strong class="reserved">private</strong> <strong class="reserved">final</strong> <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../S/1784.html#L308" title="Defined at 308 in src/java/lang/ClassValue.java.">promise</a> = <strong class="reserved">new</strong> <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;&gt;(<strong class="reserved">this</strong>);
<a id="L306" name="L306"></a> 306         Version(<a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>) <em class="brace">{</em> <strong class="reserved">this</strong>.<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a> = <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>; <em class="brace">}</em>
<a id="L307" name="L307"></a> 307         <a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../R/11471.html" title="Multiple referred from 43 places.">classValue</a>() <em class="brace">{</em> <strong class="reserved">return</strong> <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>; <em class="brace">}</em>
<a id="L308" name="L308"></a> 308         <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../S/1784.html#L308" title="Defined at 308 in src/java/lang/ClassValue.java.">promise</a>() <em class="brace">{</em> <strong class="reserved">return</strong> <a href="../R/25214.html" title="Multiple referred from 4 places.">promise</a>; <em class="brace">}</em>
<a id="L309" name="L309"></a> 309         <strong class="reserved">boolean</strong> <a href="../R/21679.html" title="Multiple referred from 8 places.">isLive</a>() <em class="brace">{</em> <strong class="reserved">return</strong> <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>() == <strong class="reserved">this</strong>; <em class="brace">}</em>
<a id="L310" name="L310"></a> 310     <em class="brace">}</em>
<a id="L311" name="L311"></a> 311 
<div class="comment">
 One binding of a value to a class via a ClassValue.
       States are:<ul><li> promise if value == Entry.this
       </li><li> else dead if version == null
       </li><li> else stale if version != classValue.version
       </li><li> else live </li></ul>
       Promises are never put into the cache; they only live in the
       backing map while a computeValue call is in flight.
       Once an entry goes stale, it can be reset at any time
       into the dead state.</div>
<a id="L323" name="L323"></a> 323     <strong class="reserved">static</strong> <strong class="reserved">class</strong> <a href="../R/2694.html" title="Multiple referred from 1260 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <strong class="reserved">extends</strong> <a href="../S/1569.html#L48" title="Defined at 48 in src/java/lang/ref/WeakReference.java.">WeakReference</a>&lt;<a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt;&gt; <em class="brace">{</em>
<a id="L324" name="L324"></a> 324         <strong class="reserved">final</strong> <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> <a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>;  <em class="comment">// usually of type T, but sometimes (Entry)this</em>
<a id="L325" name="L325"></a> 325         Entry(<a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>, <a href="../D/8701.html" title="Multiple defined in 3 places.">T</a> <a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>) <em class="brace">{</em>
<a id="L326" name="L326"></a> 326             <strong class="reserved">super</strong>(<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>);
<a id="L327" name="L327"></a> 327             <strong class="reserved">this</strong>.<a href="../D/36360.html" title="Multiple defined in 73 places.">value</a> = <a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>;  <em class="comment">// for a regular entry, value is of type T</em>
<a id="L328" name="L328"></a> 328         <em class="brace">}</em>
<a id="L329" name="L329"></a> 329         <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../R/10373.html" title="Multiple referred from 2 places.">assertNotPromise</a>() <em class="brace">{</em> <a href="../S/1616.html#L490" title="Defined at 490 in src/java/lang/invoke/MethodType.java.">assert</a>(!<a href="../S/1784.html#L338" title="Defined at 338 in src/java/lang/ClassValue.java.">isPromise</a>()); <em class="brace">}</em>
<div class="comment">
         /** For creating a promise. */</div>
<a id="L331" name="L331"></a> 331         Entry(<a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>) <em class="brace">{</em>
<a id="L332" name="L332"></a> 332             <strong class="reserved">super</strong>(<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>);
<a id="L333" name="L333"></a> 333             <strong class="reserved">this</strong>.<a href="../D/36360.html" title="Multiple defined in 73 places.">value</a> = <strong class="reserved">this</strong>;  <em class="comment">// for a promise, value is not of type T, but Entry!</em>
<a id="L334" name="L334"></a> 334         <em class="brace">}</em>
<div class="comment">
         /** Fetch the value.  This entry must not be a promise. */</div>
<a id="L336" name="L336"></a> 336         @<a href="../R/7764.html" title="Multiple referred from 264 places.">SuppressWarnings</a>("unchecked")  <em class="comment">// if !isPromise, type is T</em>
<a id="L337" name="L337"></a> 337         <a href="../D/8701.html" title="Multiple defined in 3 places.">T</a> <a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>() <em class="brace">{</em> <a href="../S/1784.html#L329" title="Defined at 329 in src/java/lang/ClassValue.java.">assertNotPromise</a>(); <strong class="reserved">return</strong> (<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>) <a href="../R/30090.html" title="Multiple referred from 11731 places.">value</a>; <em class="brace">}</em>
<a id="L338" name="L338"></a> 338         <strong class="reserved">boolean</strong> <a href="../R/21906.html" title="Multiple referred from 6 places.">isPromise</a>() <em class="brace">{</em> <strong class="reserved">return</strong> <a href="../D/36360.html" title="Multiple defined in 73 places.">value</a> == <strong class="reserved">this</strong>; <em class="brace">}</em>
<a id="L339" name="L339"></a> 339         <a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../R/30131.html" title="Multiple referred from 624 places.">version</a>() <em class="brace">{</em> <strong class="reserved">return</strong> <a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>(); <em class="brace">}</em>
<a id="L340" name="L340"></a> 340         <a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../R/11472.html" title="Multiple referred from 2 places.">classValueOrNull</a>() <em class="brace">{</em>
<a id="L341" name="L341"></a> 341             <a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; v = <a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>();
<a id="L342" name="L342"></a> 342             <strong class="reserved">return</strong> (v == <strong class="reserved">null</strong>) ? <strong class="reserved">null</strong> : v.<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>();
<a id="L343" name="L343"></a> 343         <em class="brace">}</em>
<a id="L344" name="L344"></a> 344         <strong class="reserved">boolean</strong> <a href="../R/21679.html" title="Multiple referred from 8 places.">isLive</a>() <em class="brace">{</em>
<a id="L345" name="L345"></a> 345             <a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; v = <a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>();
<a id="L346" name="L346"></a> 346             <strong class="reserved">if</strong> (v == <strong class="reserved">null</strong>)  <strong class="reserved">return</strong> <strong class="reserved">false</strong>;
<a id="L347" name="L347"></a> 347             <strong class="reserved">if</strong> (v.<a href="../D/25816.html" title="Multiple defined in 6 places.">isLive</a>())  <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L348" name="L348"></a> 348             <a href="../D/12817.html" title="Multiple defined in 199 places.">clear</a>();
<a id="L349" name="L349"></a> 349             <strong class="reserved">return</strong> <strong class="reserved">false</strong>;
<a id="L350" name="L350"></a> 350         <em class="brace">}</em>
<a id="L351" name="L351"></a> 351         <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../R/25743.html" title="Multiple referred from 2 places.">refreshVersion</a>(<a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; v2) <em class="brace">{</em>
<a id="L352" name="L352"></a> 352             <a href="../S/1784.html#L329" title="Defined at 329 in src/java/lang/ClassValue.java.">assertNotPromise</a>();
<a id="L353" name="L353"></a> 353             @<a href="../D/8551.html" title="Multiple defined in 725 places.">SuppressWarnings</a>("unchecked")  <em class="comment">// if !isPromise, type is T</em>
<a id="L354" name="L354"></a> 354             <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; e2 = <strong class="reserved">new</strong> <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;&gt;(v2, (<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>) <a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>);
<a id="L355" name="L355"></a> 355             <a href="../D/12817.html" title="Multiple defined in 199 places.">clear</a>();
<a id="L356" name="L356"></a> 356             <em class="comment">// value = null -- caller must drop</em>
<a id="L357" name="L357"></a> 357             <strong class="reserved">return</strong> e2;
<a id="L358" name="L358"></a> 358         <em class="brace">}</em>
<a id="L359" name="L359"></a> 359         <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; DEAD_ENTRY = <strong class="reserved">new</strong> <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;&gt;(<strong class="reserved">null</strong>, <strong class="reserved">null</strong>);
<a id="L360" name="L360"></a> 360     <em class="brace">}</em>
<a id="L361" name="L361"></a> 361 
<div class="comment">
     /** Return the backing map associated with this type. */</div>
<a id="L363" name="L363"></a> 363     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <a href="../S/1784.html#L405" title="Defined at 405 in src/java/lang/ClassValue.java.">ClassValueMap</a> <a href="../R/17544.html" title="Multiple referred from 12 places.">getMap</a>(<a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>) <em class="brace">{</em>
<a id="L364" name="L364"></a> 364         <em class="comment">// racing type.classValueMap : null (blank) =&gt; unique ClassValueMap</em>
<a id="L365" name="L365"></a> 365         <em class="comment">// if a null is observed, a map is created (lazily, synchronously, uniquely)</em>
<a id="L366" name="L366"></a> 366         <em class="comment">// all further access to that map is synchronized</em>
<a id="L367" name="L367"></a> 367         <a href="../S/1784.html#L405" title="Defined at 405 in src/java/lang/ClassValue.java.">ClassValueMap</a> <a href="../D/27441.html" title="Multiple defined in 12 places.">map</a> = <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>.classValueMap;
<a id="L368" name="L368"></a> 368         <strong class="reserved">if</strong> (<a href="../D/27441.html" title="Multiple defined in 12 places.">map</a> != <strong class="reserved">null</strong>)  <strong class="reserved">return</strong> <a href="../D/27441.html" title="Multiple defined in 12 places.">map</a>;
<a id="L369" name="L369"></a> 369         <strong class="reserved">return</strong> <a href="../S/1784.html#L373" title="Defined at 373 in src/java/lang/ClassValue.java.">initializeMap</a>(<a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>);
<a id="L370" name="L370"></a> 370     <em class="brace">}</em>
<a id="L371" name="L371"></a> 371 
<a id="L372" name="L372"></a> 372     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a> CRITICAL_SECTION = <strong class="reserved">new</strong> <a href="../D/6272.html" title="Multiple defined in 7 places.">Object</a>();
<a id="L373" name="L373"></a> 373     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <a href="../S/1784.html#L405" title="Defined at 405 in src/java/lang/ClassValue.java.">ClassValueMap</a> <a href="../S/1784.html#L369" title="Referred from 369 in src/java/lang/ClassValue.java.">initializeMap</a>(<a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>) <em class="brace">{</em>
<a id="L374" name="L374"></a> 374         <a href="../S/1784.html#L405" title="Defined at 405 in src/java/lang/ClassValue.java.">ClassValueMap</a> <a href="../D/27441.html" title="Multiple defined in 12 places.">map</a>;
<a id="L375" name="L375"></a> 375         <strong class="reserved">synchronized</strong> (CRITICAL_SECTION) <em class="brace">{</em>  <em class="comment">// private object to avoid deadlocks</em>
<a id="L376" name="L376"></a> 376             <em class="comment">// happens about once per type</em>
<a id="L377" name="L377"></a> 377             <strong class="reserved">if</strong> ((<a href="../D/27441.html" title="Multiple defined in 12 places.">map</a> = <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>.classValueMap) == <strong class="reserved">null</strong>)
<a id="L378" name="L378"></a> 378                 <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>.classValueMap = <a href="../D/27441.html" title="Multiple defined in 12 places.">map</a> = <strong class="reserved">new</strong> <a href="../S/1784.html#L405" title="Defined at 405 in src/java/lang/ClassValue.java.">ClassValueMap</a>(<a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>);
<a id="L379" name="L379"></a> 379         <em class="brace">}</em>
<a id="L380" name="L380"></a> 380             <strong class="reserved">return</strong> <a href="../D/27441.html" title="Multiple defined in 12 places.">map</a>;
<a id="L381" name="L381"></a> 381         <em class="brace">}</em>
<a id="L382" name="L382"></a> 382 
<a id="L383" name="L383"></a> 383     <strong class="reserved">static</strong> &lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../R/22874.html" title="Multiple referred from 2 places.">makeEntry</a>(<a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; explicitVersion, <a href="../D/8701.html" title="Multiple defined in 3 places.">T</a> <a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>) <em class="brace">{</em>
<a id="L384" name="L384"></a> 384         <em class="comment">// Note that explicitVersion might be different from this.version.</em>
<a id="L385" name="L385"></a> 385         <strong class="reserved">return</strong> <strong class="reserved">new</strong> <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;&gt;(explicitVersion, <a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>);
<a id="L386" name="L386"></a> 386 
<a id="L387" name="L387"></a> 387         <em class="comment">// As soon as the Entry is put into the cache, the value will be</em>
<a id="L388" name="L388"></a> 388         <em class="comment">// reachable via a data race (as defined by the Java Memory Model).</em>
<a id="L389" name="L389"></a> 389         <em class="comment">// This race is benign, assuming the value object itself can be</em>
<a id="L390" name="L390"></a> 390         <em class="comment">// read safely by multiple threads.  This is up to the user.</em>
<a id="L391" name="L391"></a> 391         <em class="comment">//</em>
<a id="L392" name="L392"></a> 392         <em class="comment">// The entry and version fields themselves can be safely read via</em>
<a id="L393" name="L393"></a> 393         <em class="comment">// a race because they are either final or have controlled states.</em>
<a id="L394" name="L394"></a> 394         <em class="comment">// If the pointer from the entry to the version is still null,</em>
<a id="L395" name="L395"></a> 395         <em class="comment">// or if the version goes immediately dead and is nulled out,</em>
<a id="L396" name="L396"></a> 396         <em class="comment">// the reader will take the slow path and retry under a lock.</em>
<a id="L397" name="L397"></a> 397     <em class="brace">}</em>
<a id="L398" name="L398"></a> 398 
<a id="L399" name="L399"></a> 399     <em class="comment">// The following class could also be top level and non-public:</em>
<a id="L400" name="L400"></a> 400 
<div class="comment">
 A backing map for all ClassValues, relative a single given type.
       Gives a fully serialized "true state" for each pair (ClassValue cv, Class type).
       Also manages an unserialized fast-path cache.</div>
<a id="L405" name="L405"></a> 405     <strong class="reserved">static</strong> <strong class="reserved">class</strong> <a href="../R/1406.html" title="Multiple referred from 13 places.">ClassValueMap</a> <strong class="reserved">extends</strong> <a href="../S/934.html#L136" title="Defined at 136 in src/java/util/WeakHashMap.java.">WeakHashMap</a>&lt;<a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>.<a href="../D/4036.html" title="Multiple defined in 2 places.">Identity</a>, <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;&gt; <em class="brace">{</em>
<a id="L406" name="L406"></a> 406         <strong class="reserved">private</strong> <strong class="reserved">final</strong> <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>;
<a id="L407" name="L407"></a> 407         <strong class="reserved">private</strong> <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] cacheArray;
<a id="L408" name="L408"></a> 408         <strong class="reserved">private</strong> <strong class="reserved">int</strong> cacheLoad, cacheLoadLimit;
<a id="L409" name="L409"></a> 409 
<div class="comment">
 Number of entries initially allocated to each type when first used with any ClassValue.
           It would be pointless to make this much smaller than the Class and ClassValueMap objects themselves.
           Must be a power of 2.</div>
<a id="L414" name="L414"></a> 414         <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> INITIAL_ENTRIES = 32;
<a id="L415" name="L415"></a> 415 
<div class="comment">
 Build a backing map for ClassValues, relative the given type.
           Also, create an empty cache array and install it on the class.</div>
<a id="L419" name="L419"></a> 419         ClassValueMap(<a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>) <em class="brace">{</em>
<a id="L420" name="L420"></a> 420             <strong class="reserved">this</strong>.<a href="../D/35749.html" title="Multiple defined in 239 places.">type</a> = <a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>;
<a id="L421" name="L421"></a> 421             <a href="../S/1784.html#L595" title="Defined at 595 in src/java/lang/ClassValue.java.">sizeCache</a>(INITIAL_ENTRIES);
<a id="L422" name="L422"></a> 422         <em class="brace">}</em>
<a id="L423" name="L423"></a> 423 
<a id="L424" name="L424"></a> 424         <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] <a href="../R/15402.html" title="Multiple referred from 6 places.">getCache</a>() <em class="brace">{</em> <strong class="reserved">return</strong> cacheArray; <em class="brace">}</em>
<a id="L425" name="L425"></a> 425 
<div class="comment">
         /** Initiate a query.  Store a promise (placeholder) if there is no value yet. */</div>
<a id="L427" name="L427"></a> 427         <strong class="reserved">synchronized</strong>
<a id="L428" name="L428"></a> 428         &lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../S/1784.html#L222" title="Referred from 222 in src/java/lang/ClassValue.java.">startEntry</a>(<a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>) <em class="brace">{</em>
<a id="L429" name="L429"></a> 429             @<a href="../D/8551.html" title="Multiple defined in 725 places.">SuppressWarnings</a>("unchecked")  <em class="comment">// one map has entries for all value types &lt;T&gt;</em>
<a id="L430" name="L430"></a> 430             <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; e = (<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt;) <a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/24301.html" title="Multiple defined in 8 places.">identity</a>);
<a id="L431" name="L431"></a> 431             <a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; v = <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>();
<a id="L432" name="L432"></a> 432             <strong class="reserved">if</strong> (e == <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L433" name="L433"></a> 433                 e = v.<a href="../S/1784.html#L308" title="Defined at 308 in src/java/lang/ClassValue.java.">promise</a>();
<a id="L434" name="L434"></a> 434                 <em class="comment">// The presence of a promise means that a value is pending for v.</em>
<a id="L435" name="L435"></a> 435                 <em class="comment">// Eventually, finishEntry will overwrite the promise.</em>
<a id="L436" name="L436"></a> 436                 <a href="../D/29971.html" title="Multiple defined in 370 places.">put</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/24301.html" title="Multiple defined in 8 places.">identity</a>, e);
<a id="L437" name="L437"></a> 437                 <em class="comment">// Note that the promise is never entered into the cache!</em>
<a id="L438" name="L438"></a> 438                 <strong class="reserved">return</strong> e;
<a id="L439" name="L439"></a> 439             <em class="brace">}</em> <strong class="reserved">else</strong> <strong class="reserved">if</strong> (e.<a href="../S/1784.html#L338" title="Defined at 338 in src/java/lang/ClassValue.java.">isPromise</a>()) <em class="brace">{</em>
<a id="L440" name="L440"></a> 440                 <em class="comment">// Somebody else has asked the same question.</em>
<a id="L441" name="L441"></a> 441                 <em class="comment">// Let the races begin!</em>
<a id="L442" name="L442"></a> 442                 <strong class="reserved">if</strong> (e.<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>() != v) <em class="brace">{</em>
<a id="L443" name="L443"></a> 443                     e = v.<a href="../S/1784.html#L308" title="Defined at 308 in src/java/lang/ClassValue.java.">promise</a>();
<a id="L444" name="L444"></a> 444                     <a href="../D/29971.html" title="Multiple defined in 370 places.">put</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/24301.html" title="Multiple defined in 8 places.">identity</a>, e);
<a id="L445" name="L445"></a> 445                 <em class="brace">}</em>
<a id="L446" name="L446"></a> 446                 <strong class="reserved">return</strong> e;
<a id="L447" name="L447"></a> 447             <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L448" name="L448"></a> 448                 <em class="comment">// there is already a completed entry here; report it</em>
<a id="L449" name="L449"></a> 449                 <strong class="reserved">if</strong> (e.<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>() != v) <em class="brace">{</em>
<a id="L450" name="L450"></a> 450                     <em class="comment">// There is a stale but valid entry here; make it fresh again.</em>
<a id="L451" name="L451"></a> 451                     <em class="comment">// Once an entry is in the hash table, we don't care what its version is.</em>
<a id="L452" name="L452"></a> 452                     e = e.<a href="../S/1784.html#L351" title="Defined at 351 in src/java/lang/ClassValue.java.">refreshVersion</a>(v);
<a id="L453" name="L453"></a> 453                     <a href="../D/29971.html" title="Multiple defined in 370 places.">put</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/24301.html" title="Multiple defined in 8 places.">identity</a>, e);
<a id="L454" name="L454"></a> 454                 <em class="brace">}</em>
<a id="L455" name="L455"></a> 455                 <em class="comment">// Add to the cache, to enable the fast path, next time.</em>
<a id="L456" name="L456"></a> 456                 <a href="../S/1784.html#L603" title="Defined at 603 in src/java/lang/ClassValue.java.">checkCacheLoad</a>();
<a id="L457" name="L457"></a> 457                 <a href="../D/11118.html" title="Multiple defined in 2 places.">addToCache</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>, e);
<a id="L458" name="L458"></a> 458                 <strong class="reserved">return</strong> e;
<a id="L459" name="L459"></a> 459             <em class="brace">}</em>
<a id="L460" name="L460"></a> 460         <em class="brace">}</em>
<a id="L461" name="L461"></a> 461 
<div class="comment">
         /** Finish a query.  Overwrite a matching placeholder.  Drop stale incoming values. */</div>
<a id="L463" name="L463"></a> 463         <strong class="reserved">synchronized</strong>
<a id="L464" name="L464"></a> 464         &lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../S/1784.html#L231" title="Referred from 231 in src/java/lang/ClassValue.java.">finishEntry</a>(<a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>, <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; e) <em class="brace">{</em>
<a id="L465" name="L465"></a> 465             @<a href="../D/8551.html" title="Multiple defined in 725 places.">SuppressWarnings</a>("unchecked")  <em class="comment">// one map has entries for all value types &lt;T&gt;</em>
<a id="L466" name="L466"></a> 466             <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; e0 = (<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt;) <a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/24301.html" title="Multiple defined in 8 places.">identity</a>);
<a id="L467" name="L467"></a> 467             <strong class="reserved">if</strong> (e == e0) <em class="brace">{</em>
<a id="L468" name="L468"></a> 468                 <em class="comment">// We can get here during exception processing, unwinding from computeValue.</em>
<a id="L469" name="L469"></a> 469                 <a href="../S/1616.html#L490" title="Defined at 490 in src/java/lang/invoke/MethodType.java.">assert</a>(e.<a href="../S/1784.html#L338" title="Defined at 338 in src/java/lang/ClassValue.java.">isPromise</a>());
<a id="L470" name="L470"></a> 470                 <a href="../D/30677.html" title="Multiple defined in 356 places.">remove</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/24301.html" title="Multiple defined in 8 places.">identity</a>);
<a id="L471" name="L471"></a> 471                 <strong class="reserved">return</strong> <strong class="reserved">null</strong>;
<a id="L472" name="L472"></a> 472             <em class="brace">}</em> <strong class="reserved">else</strong> <strong class="reserved">if</strong> (e0 != <strong class="reserved">null</strong> &amp;&amp; e0.<a href="../S/1784.html#L338" title="Defined at 338 in src/java/lang/ClassValue.java.">isPromise</a>() &amp;&amp; e0.<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>() == e.<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>()) <em class="brace">{</em>
<a id="L473" name="L473"></a> 473                 <em class="comment">// If e0 matches the intended entry, there has not been a remove call</em>
<a id="L474" name="L474"></a> 474                 <em class="comment">// between the previous startEntry and now.  So now overwrite e0.</em>
<a id="L475" name="L475"></a> 475                 <a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; v = <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>();
<a id="L476" name="L476"></a> 476                 <strong class="reserved">if</strong> (e.<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>() != v)
<a id="L477" name="L477"></a> 477                     e = e.<a href="../S/1784.html#L351" title="Defined at 351 in src/java/lang/ClassValue.java.">refreshVersion</a>(v);
<a id="L478" name="L478"></a> 478                 <a href="../D/29971.html" title="Multiple defined in 370 places.">put</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/24301.html" title="Multiple defined in 8 places.">identity</a>, e);
<a id="L479" name="L479"></a> 479                 <em class="comment">// Add to the cache, to enable the fast path, next time.</em>
<a id="L480" name="L480"></a> 480                 <a href="../S/1784.html#L603" title="Defined at 603 in src/java/lang/ClassValue.java.">checkCacheLoad</a>();
<a id="L481" name="L481"></a> 481                 <a href="../D/11118.html" title="Multiple defined in 2 places.">addToCache</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>, e);
<a id="L482" name="L482"></a> 482                 <strong class="reserved">return</strong> e;
<a id="L483" name="L483"></a> 483             <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L484" name="L484"></a> 484                 <em class="comment">// Some sort of mismatch; caller must try again.</em>
<a id="L485" name="L485"></a> 485                 <strong class="reserved">return</strong> <strong class="reserved">null</strong>;
<a id="L486" name="L486"></a> 486             <em class="brace">}</em>
<a id="L487" name="L487"></a> 487         <em class="brace">}</em>
<a id="L488" name="L488"></a> 488 
<div class="comment">
         /** Remove an entry. */</div>
<a id="L490" name="L490"></a> 490         <strong class="reserved">synchronized</strong>
<a id="L491" name="L491"></a> 491         <strong class="reserved">void</strong> <a href="../R/25957.html" title="Multiple referred from 10 places.">removeEntry</a>(<a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>&lt;?&gt; <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>) <em class="brace">{</em>
<a id="L492" name="L492"></a> 492             <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; e = <a href="../D/30677.html" title="Multiple defined in 356 places.">remove</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/24301.html" title="Multiple defined in 8 places.">identity</a>);
<a id="L493" name="L493"></a> 493             <strong class="reserved">if</strong> (e == <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L494" name="L494"></a> 494                 <em class="comment">// Uninitialized, and no pending calls to computeValue.  No change.</em>
<a id="L495" name="L495"></a> 495             <em class="brace">}</em> <strong class="reserved">else</strong> <strong class="reserved">if</strong> (e.<a href="../S/1784.html#L338" title="Defined at 338 in src/java/lang/ClassValue.java.">isPromise</a>()) <em class="brace">{</em>
<a id="L496" name="L496"></a> 496                 <em class="comment">// State is uninitialized, with a pending call to finishEntry.</em>
<a id="L497" name="L497"></a> 497                 <em class="comment">// Since remove is a no-op in such a state, keep the promise</em>
<a id="L498" name="L498"></a> 498                 <em class="comment">// by putting it back into the map.</em>
<a id="L499" name="L499"></a> 499                 <a href="../D/29971.html" title="Multiple defined in 370 places.">put</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/24301.html" title="Multiple defined in 8 places.">identity</a>, e);
<a id="L500" name="L500"></a> 500             <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L501" name="L501"></a> 501                 <em class="comment">// In an initialized state.  Bump forward, and de-initialize.</em>
<a id="L502" name="L502"></a> 502                 <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../S/1784.html#L302" title="Defined at 302 in src/java/lang/ClassValue.java.">bumpVersion</a>();
<a id="L503" name="L503"></a> 503                 <em class="comment">// Make all cache elements for this guy go stale.</em>
<a id="L504" name="L504"></a> 504                 <a href="../D/30957.html" title="Multiple defined in 4 places.">removeStaleEntries</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>);
<a id="L505" name="L505"></a> 505             <em class="brace">}</em>
<a id="L506" name="L506"></a> 506         <em class="brace">}</em>
<a id="L507" name="L507"></a> 507 
<div class="comment">
         /** Change the value for an entry. */</div>
<a id="L509" name="L509"></a> 509         <strong class="reserved">synchronized</strong>
<a id="L510" name="L510"></a> 510         &lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <strong class="reserved">void</strong> <a href="../S/1784.html#L179" title="Referred from 179 in src/java/lang/ClassValue.java.">changeEntry</a>(<a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>, <a href="../D/8701.html" title="Multiple defined in 3 places.">T</a> <a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>) <em class="brace">{</em>
<a id="L511" name="L511"></a> 511             @<a href="../D/8551.html" title="Multiple defined in 725 places.">SuppressWarnings</a>("unchecked")  <em class="comment">// one map has entries for all value types &lt;T&gt;</em>
<a id="L512" name="L512"></a> 512             <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; e0 = (<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt;) <a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/24301.html" title="Multiple defined in 8 places.">identity</a>);
<a id="L513" name="L513"></a> 513             <a href="../D/9532.html" title="Multiple defined in 5 places.">Version</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../D/36409.html" title="Multiple defined in 4 places.">version</a> = <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>();
<a id="L514" name="L514"></a> 514             <strong class="reserved">if</strong> (e0 != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L515" name="L515"></a> 515                 <strong class="reserved">if</strong> (e0.<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>() == <a href="../D/36409.html" title="Multiple defined in 4 places.">version</a> &amp;&amp; e0.<a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>() == <a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>)
<a id="L516" name="L516"></a> 516                     <em class="comment">// no value change =&gt; no version change needed</em>
<a id="L517" name="L517"></a> 517                     <strong class="reserved">return</strong>;
<a id="L518" name="L518"></a> 518                 <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../S/1784.html#L302" title="Defined at 302 in src/java/lang/ClassValue.java.">bumpVersion</a>();
<a id="L519" name="L519"></a> 519                 <a href="../D/30957.html" title="Multiple defined in 4 places.">removeStaleEntries</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>);
<a id="L520" name="L520"></a> 520             <em class="brace">}</em>
<a id="L521" name="L521"></a> 521             <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; e = <a href="../S/1784.html#L383" title="Defined at 383 in src/java/lang/ClassValue.java.">makeEntry</a>(<a href="../D/36409.html" title="Multiple defined in 4 places.">version</a>, <a href="../D/36360.html" title="Multiple defined in 73 places.">value</a>);
<a id="L522" name="L522"></a> 522             <a href="../D/29971.html" title="Multiple defined in 370 places.">put</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/24301.html" title="Multiple defined in 8 places.">identity</a>, e);
<a id="L523" name="L523"></a> 523             <em class="comment">// Add to the cache, to enable the fast path, next time.</em>
<a id="L524" name="L524"></a> 524             <a href="../S/1784.html#L603" title="Defined at 603 in src/java/lang/ClassValue.java.">checkCacheLoad</a>();
<a id="L525" name="L525"></a> 525             <a href="../D/11118.html" title="Multiple defined in 2 places.">addToCache</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>, e);
<a id="L526" name="L526"></a> 526         <em class="brace">}</em>
<a id="L527" name="L527"></a> 527 
<a id="L528" name="L528"></a> 528         <em class="comment">/// --------</em>
<a id="L529" name="L529"></a> 529         <em class="comment">/// Cache management.</em>
<a id="L530" name="L530"></a> 530         <em class="comment">/// --------</em>
<a id="L531" name="L531"></a> 531 
<a id="L532" name="L532"></a> 532         <em class="comment">// Statics do not need synchronization.</em>
<a id="L533" name="L533"></a> 533 
<div class="comment">
         /** Load the cache entry at the given (hashed) location. */</div>
<a id="L535" name="L535"></a> 535         <strong class="reserved">static</strong> <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; <a href="../S/1784.html#L544" title="Referred from 544 in src/java/lang/ClassValue.java.">loadFromCache</a>(<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, <strong class="reserved">int</strong> i) <em class="brace">{</em>
<a id="L536" name="L536"></a> 536             <em class="comment">// non-racing cache.length : constant</em>
<a id="L537" name="L537"></a> 537             <em class="comment">// racing cache[i &amp; (mask)] : null &lt;=&gt; Entry</em>
<a id="L538" name="L538"></a> 538             <strong class="reserved">return</strong> <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>[i &amp; (<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>-1)];
<a id="L539" name="L539"></a> 539             <em class="comment">// invariant:  returned value is null or well-constructed (ready to match)</em>
<a id="L540" name="L540"></a> 540         <em class="brace">}</em>
<a id="L541" name="L541"></a> 541 
<div class="comment">
         /** Look in the cache, at the home location for the given ClassValue. */</div>
<a id="L543" name="L543"></a> 543         <strong class="reserved">static</strong> &lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../R/25081.html" title="Multiple referred from 2 places.">probeHomeLocation</a>(<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, <a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>) <em class="brace">{</em>
<a id="L544" name="L544"></a> 544             <strong class="reserved">return</strong> <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../S/1784.html#L214" title="Defined at 214 in src/java/lang/ClassValue.java.">castEntry</a>(<a href="../S/1784.html#L535" title="Defined at 535 in src/java/lang/ClassValue.java.">loadFromCache</a>(<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.hashCodeForCache));
<a id="L545" name="L545"></a> 545         <em class="brace">}</em>
<a id="L546" name="L546"></a> 546 
<div class="comment">
         /** Given that first probe was a collision, retry at nearby locations. */</div>
<a id="L548" name="L548"></a> 548         <strong class="reserved">static</strong> &lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../R/25079.html" title="Multiple referred from 2 places.">probeBackupLocations</a>(<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, <a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>) <em class="brace">{</em>
<a id="L549" name="L549"></a> 549             <strong class="reserved">if</strong> (PROBE_LIMIT &lt;= 0)  <strong class="reserved">return</strong> <strong class="reserved">null</strong>;
<a id="L550" name="L550"></a> 550             <em class="comment">// Probe the cache carefully, in a range of slots.</em>
<a id="L551" name="L551"></a> 551             <strong class="reserved">int</strong> <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a> = (<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>-1);
<a id="L552" name="L552"></a> 552             <strong class="reserved">int</strong> <a href="../S/2912.html#L4518" title="Defined at 4518 in src/javax/swing/plaf/basic/BasicTreeUI.java.">home</a> = (<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.hashCodeForCache &amp; <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a>);
<a id="L553" name="L553"></a> 553             <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; e2 = <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>[<a href="../S/2912.html#L4518" title="Defined at 4518 in src/javax/swing/plaf/basic/BasicTreeUI.java.">home</a>];  <em class="comment">// victim, if we find the real guy</em>
<a id="L554" name="L554"></a> 554             <strong class="reserved">if</strong> (e2 == <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L555" name="L555"></a> 555                 <strong class="reserved">return</strong> <strong class="reserved">null</strong>;   <em class="comment">// if nobody is at home, no need to search nearby</em>
<a id="L556" name="L556"></a> 556             <em class="brace">}</em>
<a id="L557" name="L557"></a> 557             <em class="comment">// assume !classValue.match(e2), but do not assert, because of races</em>
<a id="L558" name="L558"></a> 558             <strong class="reserved">int</strong> pos2 = -1;
<a id="L559" name="L559"></a> 559             <strong class="reserved">for</strong> (<strong class="reserved">int</strong> i = <a href="../S/2912.html#L4518" title="Defined at 4518 in src/javax/swing/plaf/basic/BasicTreeUI.java.">home</a> + 1; i &lt; <a href="../S/2912.html#L4518" title="Defined at 4518 in src/javax/swing/plaf/basic/BasicTreeUI.java.">home</a> + PROBE_LIMIT; i++) <em class="brace">{</em>
<a id="L560" name="L560"></a> 560                 <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; e = <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>[i &amp; <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a>];
<a id="L561" name="L561"></a> 561                 <strong class="reserved">if</strong> (e == <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L562" name="L562"></a> 562                     <strong class="reserved">break</strong>;   <em class="comment">// only search within non-null runs</em>
<a id="L563" name="L563"></a> 563                 <em class="brace">}</em>
<a id="L564" name="L564"></a> 564                 <strong class="reserved">if</strong> (<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../D/27519.html" title="Multiple defined in 69 places.">match</a>(e)) <em class="brace">{</em>
<a id="L565" name="L565"></a> 565                     <em class="comment">// relocate colliding entry e2 (from cache[home]) to first empty slot</em>
<a id="L566" name="L566"></a> 566                     <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>[<a href="../S/2912.html#L4518" title="Defined at 4518 in src/javax/swing/plaf/basic/BasicTreeUI.java.">home</a>] = e;
<a id="L567" name="L567"></a> 567                     <strong class="reserved">if</strong> (pos2 &gt;= 0) <em class="brace">{</em>
<a id="L568" name="L568"></a> 568                         <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>[i &amp; <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a>] = <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>.DEAD_ENTRY;
<a id="L569" name="L569"></a> 569                     <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L570" name="L570"></a> 570                         pos2 = i;
<a id="L571" name="L571"></a> 571                     <em class="brace">}</em>
<a id="L572" name="L572"></a> 572                     <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>[pos2 &amp; <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a>] = ((<a href="../S/1784.html#L584" title="Defined at 584 in src/java/lang/ClassValue.java.">entryDislocation</a>(<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, pos2, e2) &lt; PROBE_LIMIT)
<a id="L573" name="L573"></a> 573                                           ? e2                  <em class="comment">// put e2 here if it fits</em>
<a id="L574" name="L574"></a> 574                                           : <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>.DEAD_ENTRY);
<a id="L575" name="L575"></a> 575                     <strong class="reserved">return</strong> <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.<a href="../S/1784.html#L214" title="Defined at 214 in src/java/lang/ClassValue.java.">castEntry</a>(e);
<a id="L576" name="L576"></a> 576                 <em class="brace">}</em>
<a id="L577" name="L577"></a> 577                 <em class="comment">// Remember first empty slot, if any:</em>
<a id="L578" name="L578"></a> 578                 <strong class="reserved">if</strong> (!e.<a href="../D/25816.html" title="Multiple defined in 6 places.">isLive</a>() &amp;&amp; pos2 &lt; 0)  pos2 = i;
<a id="L579" name="L579"></a> 579             <em class="brace">}</em>
<a id="L580" name="L580"></a> 580             <strong class="reserved">return</strong> <strong class="reserved">null</strong>;
<a id="L581" name="L581"></a> 581         <em class="brace">}</em>
<a id="L582" name="L582"></a> 582 
<div class="comment">
         /** How far out of place is e? */</div>
<a id="L584" name="L584"></a> 584         <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">int</strong> <a href="../R/13956.html" title="Multiple referred from 3 places.">entryDislocation</a>(<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, <strong class="reserved">int</strong> pos, <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; e) <em class="brace">{</em>
<a id="L585" name="L585"></a> 585             <a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>&lt;?&gt; cv = e.<a href="../S/1784.html#L340" title="Defined at 340 in src/java/lang/ClassValue.java.">classValueOrNull</a>();
<a id="L586" name="L586"></a> 586             <strong class="reserved">if</strong> (cv == <strong class="reserved">null</strong>)  <strong class="reserved">return</strong> 0;  <em class="comment">// entry is not live!</em>
<a id="L587" name="L587"></a> 587             <strong class="reserved">int</strong> <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a> = (<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>-1);
<a id="L588" name="L588"></a> 588             <strong class="reserved">return</strong> (pos - cv.hashCodeForCache) &amp; <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a>;
<a id="L589" name="L589"></a> 589         <em class="brace">}</em>
<a id="L590" name="L590"></a> 590 
<a id="L591" name="L591"></a> 591         <em class="comment">/// --------</em>
<a id="L592" name="L592"></a> 592         <em class="comment">/// Below this line all functions are private, and assume synchronized access.</em>
<a id="L593" name="L593"></a> 593         <em class="comment">/// --------</em>
<a id="L594" name="L594"></a> 594 
<a id="L595" name="L595"></a> 595         <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../R/28640.html" title="Multiple referred from 2 places.">sizeCache</a>(<strong class="reserved">int</strong> <a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>) <em class="brace">{</em>
<a id="L596" name="L596"></a> 596             <a href="../S/1616.html#L490" title="Defined at 490 in src/java/lang/invoke/MethodType.java.">assert</a>((<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a> &amp; (<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>-1)) == 0);  <em class="comment">// must be power of 2</em>
<a id="L597" name="L597"></a> 597             cacheLoad = 0;
<a id="L598" name="L598"></a> 598             cacheLoadLimit = (<strong class="reserved">int</strong>) ((<strong class="reserved">double</strong>) <a href="../D/26813.html" title="Multiple defined in 43 places.">length</a> * CACHE_LOAD_LIMIT / 100);
<a id="L599" name="L599"></a> 599             cacheArray = <strong class="reserved">new</strong> <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>];
<a id="L600" name="L600"></a> 600         <em class="brace">}</em>
<a id="L601" name="L601"></a> 601 
<div class="comment">
         /** Make sure the cache load stays below its limit, if possible. */</div>
<a id="L603" name="L603"></a> 603         <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../R/11099.html" title="Multiple referred from 3 places.">checkCacheLoad</a>() <em class="brace">{</em>
<a id="L604" name="L604"></a> 604             <strong class="reserved">if</strong> (cacheLoad &gt;= cacheLoadLimit) <em class="brace">{</em>
<a id="L605" name="L605"></a> 605                 <a href="../S/1784.html#L608" title="Defined at 608 in src/java/lang/ClassValue.java.">reduceCacheLoad</a>();
<a id="L606" name="L606"></a> 606             <em class="brace">}</em>
<a id="L607" name="L607"></a> 607         <em class="brace">}</em>
<a id="L608" name="L608"></a> 608         <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../S/1784.html#L605" title="Referred from 605 in src/java/lang/ClassValue.java.">reduceCacheLoad</a>() <em class="brace">{</em>
<a id="L609" name="L609"></a> 609             <a href="../D/30957.html" title="Multiple defined in 4 places.">removeStaleEntries</a>();
<a id="L610" name="L610"></a> 610             <strong class="reserved">if</strong> (cacheLoad &lt; cacheLoadLimit)
<a id="L611" name="L611"></a> 611                 <strong class="reserved">return</strong>;  <em class="comment">// win</em>
<a id="L612" name="L612"></a> 612             <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] oldCache = <a href="../D/17438.html" title="Multiple defined in 2 places.">getCache</a>();
<a id="L613" name="L613"></a> 613             <strong class="reserved">if</strong> (oldCache.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a> &gt; HASH_MASK)
<a id="L614" name="L614"></a> 614                 <strong class="reserved">return</strong>;  <em class="comment">// lose</em>
<a id="L615" name="L615"></a> 615             <a href="../S/1784.html#L595" title="Defined at 595 in src/java/lang/ClassValue.java.">sizeCache</a>(oldCache.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a> * 2);
<a id="L616" name="L616"></a> 616             <strong class="reserved">for</strong> (<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; e : oldCache) <em class="brace">{</em>
<a id="L617" name="L617"></a> 617                 <strong class="reserved">if</strong> (e != <strong class="reserved">null</strong> &amp;&amp; e.<a href="../D/25816.html" title="Multiple defined in 6 places.">isLive</a>()) <em class="brace">{</em>
<a id="L618" name="L618"></a> 618                     <a href="../D/11118.html" title="Multiple defined in 2 places.">addToCache</a>(e);
<a id="L619" name="L619"></a> 619                 <em class="brace">}</em>
<a id="L620" name="L620"></a> 620             <em class="brace">}</em>
<a id="L621" name="L621"></a> 621         <em class="brace">}</em>
<a id="L622" name="L622"></a> 622 
<div class="comment">
 Remove stale entries in the given range.
           Should be executed under a Map lock.</div>
<a id="L626" name="L626"></a> 626         <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../R/26074.html" title="Multiple referred from 7 places.">removeStaleEntries</a>(<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, <strong class="reserved">int</strong> <a href="../D/11808.html" title="Multiple defined in 37 places.">begin</a>, <strong class="reserved">int</strong> <a href="../D/13557.html" title="Multiple defined in 24 places.">count</a>) <em class="brace">{</em>
<a id="L627" name="L627"></a> 627             <strong class="reserved">if</strong> (PROBE_LIMIT &lt;= 0)  <strong class="reserved">return</strong>;
<a id="L628" name="L628"></a> 628             <strong class="reserved">int</strong> <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a> = (<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>-1);
<a id="L629" name="L629"></a> 629             <strong class="reserved">int</strong> removed = 0;
<a id="L630" name="L630"></a> 630             <strong class="reserved">for</strong> (<strong class="reserved">int</strong> i = <a href="../D/11808.html" title="Multiple defined in 37 places.">begin</a>; i &lt; <a href="../D/11808.html" title="Multiple defined in 37 places.">begin</a> + <a href="../D/13557.html" title="Multiple defined in 24 places.">count</a>; i++) <em class="brace">{</em>
<a id="L631" name="L631"></a> 631                 <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; e = <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>[i &amp; <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a>];
<a id="L632" name="L632"></a> 632                 <strong class="reserved">if</strong> (e == <strong class="reserved">null</strong> || e.<a href="../D/25816.html" title="Multiple defined in 6 places.">isLive</a>())
<a id="L633" name="L633"></a> 633                     <strong class="reserved">continue</strong>;  <em class="comment">// skip null and live entries</em>
<a id="L634" name="L634"></a> 634                 <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; <a href="../D/31077.html" title="Multiple defined in 2 places.">replacement</a> = <strong class="reserved">null</strong>;
<a id="L635" name="L635"></a> 635                 <strong class="reserved">if</strong> (PROBE_LIMIT &gt; 1) <em class="brace">{</em>
<a id="L636" name="L636"></a> 636                     <em class="comment">// avoid breaking up a non-null run</em>
<a id="L637" name="L637"></a> 637                     <a href="../D/31077.html" title="Multiple defined in 2 places.">replacement</a> = <a href="../S/1784.html#L650" title="Defined at 650 in src/java/lang/ClassValue.java.">findReplacement</a>(<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, i);
<a id="L638" name="L638"></a> 638                 <em class="brace">}</em>
<a id="L639" name="L639"></a> 639                 <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>[i &amp; <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a>] = <a href="../D/31077.html" title="Multiple defined in 2 places.">replacement</a>;
<a id="L640" name="L640"></a> 640                 <strong class="reserved">if</strong> (<a href="../D/31077.html" title="Multiple defined in 2 places.">replacement</a> == <strong class="reserved">null</strong>)  removed += 1;
<a id="L641" name="L641"></a> 641             <em class="brace">}</em>
<a id="L642" name="L642"></a> 642             cacheLoad = <a href="../S/1768.html#L105" title="Defined at 105 in src/java/lang/Math.java.">Math</a>.<a href="../D/27569.html" title="Multiple defined in 28 places.">max</a>(0, cacheLoad - removed);
<a id="L643" name="L643"></a> 643         <em class="brace">}</em>
<a id="L644" name="L644"></a> 644 
<div class="comment">
 Clearing a cache slot risks disconnecting following entries
           from the head of a non-null run, which would allow them
           to be found via reprobes.  Find an entry after cache[begin]
           to plug into the hole, or return null if none is needed.</div>
<a id="L650" name="L650"></a> 650         <strong class="reserved">private</strong> <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; <a href="../S/1784.html#L637" title="Referred from 637 in src/java/lang/ClassValue.java.">findReplacement</a>(<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, <strong class="reserved">int</strong> home1) <em class="brace">{</em>
<a id="L651" name="L651"></a> 651             <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; <a href="../D/31077.html" title="Multiple defined in 2 places.">replacement</a> = <strong class="reserved">null</strong>;
<a id="L652" name="L652"></a> 652             <strong class="reserved">int</strong> haveReplacement = -1, replacementPos = 0;
<a id="L653" name="L653"></a> 653             <strong class="reserved">int</strong> <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a> = (<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>-1);
<a id="L654" name="L654"></a> 654             <strong class="reserved">for</strong> (<strong class="reserved">int</strong> i2 = home1 + 1; i2 &lt; home1 + PROBE_LIMIT; i2++) <em class="brace">{</em>
<a id="L655" name="L655"></a> 655                 <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; e2 = <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>[i2 &amp; <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a>];
<a id="L656" name="L656"></a> 656                 <strong class="reserved">if</strong> (e2 == <strong class="reserved">null</strong>)  <strong class="reserved">break</strong>;  <em class="comment">// End of non-null run.</em>
<a id="L657" name="L657"></a> 657                 <strong class="reserved">if</strong> (!e2.<a href="../D/25816.html" title="Multiple defined in 6 places.">isLive</a>())  <strong class="reserved">continue</strong>;  <em class="comment">// Doomed anyway.</em>
<a id="L658" name="L658"></a> 658                 <strong class="reserved">int</strong> dis2 = <a href="../S/1784.html#L584" title="Defined at 584 in src/java/lang/ClassValue.java.">entryDislocation</a>(<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, i2, e2);
<a id="L659" name="L659"></a> 659                 <strong class="reserved">if</strong> (dis2 == 0)  <strong class="reserved">continue</strong>;  <em class="comment">// e2 already optimally placed</em>
<a id="L660" name="L660"></a> 660                 <strong class="reserved">int</strong> home2 = i2 - dis2;
<a id="L661" name="L661"></a> 661                 <strong class="reserved">if</strong> (home2 &lt;= home1) <em class="brace">{</em>
<a id="L662" name="L662"></a> 662                     <em class="comment">// e2 can replace entry at cache[home1]</em>
<a id="L663" name="L663"></a> 663                     <strong class="reserved">if</strong> (home2 == home1) <em class="brace">{</em>
<a id="L664" name="L664"></a> 664                         <em class="comment">// Put e2 exactly where he belongs.</em>
<a id="L665" name="L665"></a> 665                         haveReplacement = 1;
<a id="L666" name="L666"></a> 666                         replacementPos = i2;
<a id="L667" name="L667"></a> 667                         <a href="../D/31077.html" title="Multiple defined in 2 places.">replacement</a> = e2;
<a id="L668" name="L668"></a> 668                     <em class="brace">}</em> <strong class="reserved">else</strong> <strong class="reserved">if</strong> (haveReplacement &lt;= 0) <em class="brace">{</em>
<a id="L669" name="L669"></a> 669                         haveReplacement = 0;
<a id="L670" name="L670"></a> 670                         replacementPos = i2;
<a id="L671" name="L671"></a> 671                         <a href="../D/31077.html" title="Multiple defined in 2 places.">replacement</a> = e2;
<a id="L672" name="L672"></a> 672                     <em class="brace">}</em>
<a id="L673" name="L673"></a> 673                     <em class="comment">// And keep going, so we can favor larger dislocations.</em>
<a id="L674" name="L674"></a> 674                 <em class="brace">}</em>
<a id="L675" name="L675"></a> 675             <em class="brace">}</em>
<a id="L676" name="L676"></a> 676             <strong class="reserved">if</strong> (haveReplacement &gt;= 0) <em class="brace">{</em>
<a id="L677" name="L677"></a> 677                 <strong class="reserved">if</strong> (<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>[(replacementPos+1) &amp; <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a>] != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L678" name="L678"></a> 678                     <em class="comment">// Be conservative, to avoid breaking up a non-null run.</em>
<a id="L679" name="L679"></a> 679                     <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>[replacementPos &amp; <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a>] = (<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;) <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>.DEAD_ENTRY;
<a id="L680" name="L680"></a> 680                 <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L681" name="L681"></a> 681                     <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>[replacementPos &amp; <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a>] = <strong class="reserved">null</strong>;
<a id="L682" name="L682"></a> 682                     cacheLoad -= 1;
<a id="L683" name="L683"></a> 683                 <em class="brace">}</em>
<a id="L684" name="L684"></a> 684             <em class="brace">}</em>
<a id="L685" name="L685"></a> 685             <strong class="reserved">return</strong> <a href="../D/31077.html" title="Multiple defined in 2 places.">replacement</a>;
<a id="L686" name="L686"></a> 686         <em class="brace">}</em>
<a id="L687" name="L687"></a> 687 
<div class="comment">
         /** Remove stale entries in the range near classValue. */</div>
<a id="L689" name="L689"></a> 689         <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../R/26074.html" title="Multiple referred from 7 places.">removeStaleEntries</a>(<a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>&lt;?&gt; <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>) <em class="brace">{</em>
<a id="L690" name="L690"></a> 690             <a href="../D/30957.html" title="Multiple defined in 4 places.">removeStaleEntries</a>(<a href="../D/17438.html" title="Multiple defined in 2 places.">getCache</a>(), <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.hashCodeForCache, PROBE_LIMIT);
<a id="L691" name="L691"></a> 691         <em class="brace">}</em>
<a id="L692" name="L692"></a> 692 
<div class="comment">
         /** Remove all stale entries, everywhere. */</div>
<a id="L694" name="L694"></a> 694         <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../R/26074.html" title="Multiple referred from 7 places.">removeStaleEntries</a>() <em class="brace">{</em>
<a id="L695" name="L695"></a> 695             <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a> = <a href="../D/17438.html" title="Multiple defined in 2 places.">getCache</a>();
<a id="L696" name="L696"></a> 696             <a href="../D/30957.html" title="Multiple defined in 4 places.">removeStaleEntries</a>(<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, 0, <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a> + PROBE_LIMIT - 1);
<a id="L697" name="L697"></a> 697         <em class="brace">}</em>
<a id="L698" name="L698"></a> 698 
<div class="comment">
         /** Add the given entry to the cache, in its home location, unless it is out of date. */</div>
<a id="L700" name="L700"></a> 700         <strong class="reserved">private</strong> &lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <strong class="reserved">void</strong> <a href="../R/9995.html" title="Multiple referred from 5 places.">addToCache</a>(<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; e) <em class="brace">{</em>
<a id="L701" name="L701"></a> 701             <a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a> = e.<a href="../S/1784.html#L340" title="Defined at 340 in src/java/lang/ClassValue.java.">classValueOrNull</a>();
<a id="L702" name="L702"></a> 702             <strong class="reserved">if</strong> (<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a> != <strong class="reserved">null</strong>)
<a id="L703" name="L703"></a> 703                 <a href="../D/11118.html" title="Multiple defined in 2 places.">addToCache</a>(<a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>, e);
<a id="L704" name="L704"></a> 704         <em class="brace">}</em>
<a id="L705" name="L705"></a> 705 
<div class="comment">
         /** Add the given entry to the cache, in its home location. */</div>
<a id="L707" name="L707"></a> 707         <strong class="reserved">private</strong> &lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <strong class="reserved">void</strong> <a href="../R/9995.html" title="Multiple referred from 5 places.">addToCache</a>(<a href="../S/1784.html#L45" title="Defined at 45 in src/java/lang/ClassValue.java.">ClassValue</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>, <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; e) <em class="brace">{</em>
<a id="L708" name="L708"></a> 708             <strong class="reserved">if</strong> (PROBE_LIMIT &lt;= 0)  <strong class="reserved">return</strong>;  <em class="comment">// do not fill cache</em>
<a id="L709" name="L709"></a> 709             <em class="comment">// Add e to the cache.</em>
<a id="L710" name="L710"></a> 710             <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a> = <a href="../D/17438.html" title="Multiple defined in 2 places.">getCache</a>();
<a id="L711" name="L711"></a> 711             <strong class="reserved">int</strong> <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a> = (<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>-1);
<a id="L712" name="L712"></a> 712             <strong class="reserved">int</strong> <a href="../S/2912.html#L4518" title="Defined at 4518 in src/javax/swing/plaf/basic/BasicTreeUI.java.">home</a> = <a href="../S/1784.html#L307" title="Defined at 307 in src/java/lang/ClassValue.java.">classValue</a>.hashCodeForCache &amp; <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a>;
<a id="L713" name="L713"></a> 713             <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; e2 = <a href="../S/1784.html#L731" title="Defined at 731 in src/java/lang/ClassValue.java.">placeInCache</a>(<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, <a href="../S/2912.html#L4518" title="Defined at 4518 in src/javax/swing/plaf/basic/BasicTreeUI.java.">home</a>, e, <strong class="reserved">false</strong>);
<a id="L714" name="L714"></a> 714             <strong class="reserved">if</strong> (e2 == <strong class="reserved">null</strong>)  <strong class="reserved">return</strong>;  <em class="comment">// done</em>
<a id="L715" name="L715"></a> 715             <strong class="reserved">if</strong> (PROBE_LIMIT &gt; 1) <em class="brace">{</em>
<a id="L716" name="L716"></a> 716                 <em class="comment">// try to move e2 somewhere else in his probe range</em>
<a id="L717" name="L717"></a> 717                 <strong class="reserved">int</strong> dis2 = <a href="../S/1784.html#L584" title="Defined at 584 in src/java/lang/ClassValue.java.">entryDislocation</a>(<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, <a href="../S/2912.html#L4518" title="Defined at 4518 in src/javax/swing/plaf/basic/BasicTreeUI.java.">home</a>, e2);
<a id="L718" name="L718"></a> 718                 <strong class="reserved">int</strong> home2 = <a href="../S/2912.html#L4518" title="Defined at 4518 in src/javax/swing/plaf/basic/BasicTreeUI.java.">home</a> - dis2;
<a id="L719" name="L719"></a> 719                 <strong class="reserved">for</strong> (<strong class="reserved">int</strong> i2 = home2; i2 &lt; home2 + PROBE_LIMIT; i2++) <em class="brace">{</em>
<a id="L720" name="L720"></a> 720                     <strong class="reserved">if</strong> (<a href="../S/1784.html#L731" title="Defined at 731 in src/java/lang/ClassValue.java.">placeInCache</a>(<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, i2 &amp; <a href="../S/915.html#L394" title="Defined at 394 in src/java/util/stream/StreamOpFlag.java.">mask</a>, e2, <strong class="reserved">true</strong>) == <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L721" name="L721"></a> 721                         <strong class="reserved">return</strong>;
<a id="L722" name="L722"></a> 722                     <em class="brace">}</em>
<a id="L723" name="L723"></a> 723                 <em class="brace">}</em>
<a id="L724" name="L724"></a> 724             <em class="brace">}</em>
<a id="L725" name="L725"></a> 725             <em class="comment">// Note:  At this point, e2 is just dropped from the cache.</em>
<a id="L726" name="L726"></a> 726         <em class="brace">}</em>
<a id="L727" name="L727"></a> 727 
<div class="comment">
 Store the given entry.  Update cacheLoad, and return any live victim.
           'Gently' means return self rather than dislocating a live victim.</div>
<a id="L731" name="L731"></a> 731         <strong class="reserved">private</strong> <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; <a href="../R/24751.html" title="Multiple referred from 2 places.">placeInCache</a>(<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt;[] <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>, <strong class="reserved">int</strong> pos, <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; e, <strong class="reserved">boolean</strong> gently) <em class="brace">{</em>
<a id="L732" name="L732"></a> 732             <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;?&gt; e2 = <a href="../S/1784.html#L748" title="Defined at 748 in src/java/lang/ClassValue.java.">overwrittenEntry</a>(<a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>[pos]);
<a id="L733" name="L733"></a> 733             <strong class="reserved">if</strong> (gently &amp;&amp; e2 != <strong class="reserved">null</strong>) <em class="brace">{</em>
<a id="L734" name="L734"></a> 734                 <em class="comment">// do not overwrite a live entry</em>
<a id="L735" name="L735"></a> 735                 <strong class="reserved">return</strong> e;
<a id="L736" name="L736"></a> 736             <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L737" name="L737"></a> 737                 <a href="../S/2005.html#L328" title="Defined at 328 in src/java/nio/charset/Charset.java.">cache</a>[pos] = e;
<a id="L738" name="L738"></a> 738                 <strong class="reserved">return</strong> e2;
<a id="L739" name="L739"></a> 739             <em class="brace">}</em>
<a id="L740" name="L740"></a> 740         <em class="brace">}</em>
<a id="L741" name="L741"></a> 741 
<div class="comment">
 Note an entry that is about to be overwritten.
           If it is not live, quietly replace it by null.
           If it is an actual null, increment cacheLoad,
           because the caller is going to store something
           in its place.</div>
<a id="L748" name="L748"></a> 748         <strong class="reserved">private</strong> &lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; <a href="../S/1784.html#L732" title="Referred from 732 in src/java/lang/ClassValue.java.">overwrittenEntry</a>(<a href="../D/2925.html" title="Multiple defined in 20 places.">Entry</a>&lt;<a href="../D/8701.html" title="Multiple defined in 3 places.">T</a>&gt; e2) <em class="brace">{</em>
<a id="L749" name="L749"></a> 749             <strong class="reserved">if</strong> (e2 == <strong class="reserved">null</strong>)  cacheLoad += 1;
<a id="L750" name="L750"></a> 750             <strong class="reserved">else</strong> <strong class="reserved">if</strong> (e2.<a href="../D/25816.html" title="Multiple defined in 6 places.">isLive</a>())  <strong class="reserved">return</strong> e2;
<a id="L751" name="L751"></a> 751             <strong class="reserved">return</strong> <strong class="reserved">null</strong>;
<a id="L752" name="L752"></a> 752         <em class="brace">}</em>
<a id="L753" name="L753"></a> 753 
<div class="comment">
         /** Percent loading of cache before resize. */</div>
<a id="L755" name="L755"></a> 755         <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> CACHE_LOAD_LIMIT = 67;  <em class="comment">// 0..100</em>
<div class="comment">
         /** Maximum number of probes to attempt. */</div>
<a id="L757" name="L757"></a> 757         <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">final</strong> <strong class="reserved">int</strong> PROBE_LIMIT      =  6;       <em class="comment">// 1..</em>
<a id="L758" name="L758"></a> 758         <em class="comment">// N.B.  Set PROBE_LIMIT=0 to disable all fast paths.</em>
<a id="L759" name="L759"></a> 759     <em class="brace">}</em>
<a id="L760" name="L760"></a> 760 <em class="brace">}</em>
</pre>
<hr>
<div class="comment">
/* [&lt;][&gt;]<a href="#L71">[^]</a><a href="#L748">[v]</a><a href="#TOP">[top]</a>[bottom]<a href="../mains.html">[index]</a><a href="../help.html">[help]</a> */</div>
</body></html>