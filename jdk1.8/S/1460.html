<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
<title>src/java/math/BitSieve.java</title>
<meta name="robots" content="noindex,nofollow">
<meta name="generator" content="GLOBAL-6.6.3">
<meta http-equiv="Content-Style-Type" content="text/css">
<link rel="stylesheet" type="text/css" href="../style.css">
</head>
<body>
<a id="TOP" name="TOP"></a><div class="comment">
/* [&lt;][&gt;]<a href="#L134">[^]</a><a href="#L194">[v]</a>[top]<a href="#BOTTOM">[bottom]</a><a href="../mains.html">[index]</a><a href="../help.html">[help]</a> */</div>
<hr>
<h2 class="header">DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href="#L134" title="Defined at 134.">unitIndex</a></li>
<li><a href="#L141" title="Defined at 141.">bit</a></li>
<li><a href="#L148" title="Defined at 148.">get</a></li>
<li><a href="#L156" title="Defined at 156.">set</a></li>
<li><a href="#L166" title="Defined at 166.">sieveSearch</a></li>
<li><a href="#L184" title="Defined at 184.">sieveSingle</a></li>
<li><a href="#L194" title="Defined at 194.">retrieve</a></li>
</ol>
<hr>
<pre>
<div class="comment">
  Copyright (c) 1999, 2007, Oracle and/or its affiliates. All rights reserved.
  ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.</div>
<a id="L25" name="L25"></a>  25 
<a id="L26" name="L26"></a>  26 <strong class="reserved">package</strong> <a href="../S/3625.html#L43" title="Defined at 43 in src/javax/management/remote/rmi/RMIConnectionImpl_Stub.java.">java</a>.math;
<a id="L27" name="L27"></a>  27 
<div class="comment">
  A simple bit sieve used for finding prime number candidates. Allows setting
  and clearing of bits in a storage array. The size of the sieve is assumed to
  be constant to reduce overhead. All the bits of a new bitSieve are zero, and
  bits are removed from it by setting them.
  To reduce storage space and increase efficiency, no even numbers are
  represented in the sieve (each bit in the sieve represents an odd number).
  The relationship between the index of a bit and the number it represents is
  given by
  N = offset + (2*index + 1);
  Where N is the integer represented by a bit in the sieve, offset is some
  even integer offset indicating where the sieve begins, and index is the
  index of a bit in the sieve array.
  @see     BigInteger
  @author  Michael McCloskey
  @since   1.3</div>
<a id="L47" name="L47"></a>  47 <strong class="reserved">class</strong> <a href="../R/827.html" title="Multiple referred from 4 places.">BitSieve</a> <em class="brace">{</em>
<div class="comment">
      Stores the bits in this bitSieve.</div>
<a id="L51" name="L51"></a>  51     <strong class="reserved">private</strong> <strong class="reserved">long</strong> bits[];
<a id="L52" name="L52"></a>  52 
<div class="comment">
      Length is how many bits this sieve holds.</div>
<a id="L56" name="L56"></a>  56     <strong class="reserved">private</strong> <strong class="reserved">int</strong> <a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>;
<a id="L57" name="L57"></a>  57 
<div class="comment">
      A small sieve used to filter out multiples of small primes in a search
      sieve.</div>
<a id="L62" name="L62"></a>  62     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <a href="../S/1460.html#L47" title="Defined at 47 in src/java/math/BitSieve.java.">BitSieve</a> smallSieve = <strong class="reserved">new</strong> <a href="../S/1460.html#L47" title="Defined at 47 in src/java/math/BitSieve.java.">BitSieve</a>();
<a id="L63" name="L63"></a>  63 
<div class="comment">
      Construct a "small sieve" with a base of 0.  This constructor is
      used internally to generate the set of "small primes" whose multiples
      are excluded from sieves generated by the main (package private)
      constructor, BitSieve(BigInteger base, int searchLen).  The length
      of the sieve generated by this constructor was chosen for performance;
      it controls a tradeoff between how much time is spent constructing
      other sieves, and how much time is wasted testing composite candidates
      for primality.  The length was chosen experimentally to yield good
      performance.</div>
<a id="L75" name="L75"></a>  75     <strong class="reserved">private</strong> BitSieve() <em class="brace">{</em>
<a id="L76" name="L76"></a>  76         <a href="../D/26813.html" title="Multiple defined in 43 places.">length</a> = 150 * 64;
<a id="L77" name="L77"></a>  77         bits = <strong class="reserved">new</strong> <strong class="reserved">long</strong>[(<a href="../S/1460.html#L134" title="Defined at 134 in src/java/math/BitSieve.java.">unitIndex</a>(<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a> - 1) + 1)];
<a id="L78" name="L78"></a>  78 
<a id="L79" name="L79"></a>  79         <em class="comment">// Mark 1 as composite</em>
<a id="L80" name="L80"></a>  80         <a href="../D/31832.html" title="Multiple defined in 134 places.">set</a>(0);
<a id="L81" name="L81"></a>  81         <strong class="reserved">int</strong> <a href="../D/28157.html" title="Multiple defined in 12 places.">nextIndex</a> = 1;
<a id="L82" name="L82"></a>  82         <strong class="reserved">int</strong> nextPrime = 3;
<a id="L83" name="L83"></a>  83 
<a id="L84" name="L84"></a>  84         <em class="comment">// Find primes and remove their multiples from sieve</em>
<a id="L85" name="L85"></a>  85         <strong class="reserved">do</strong> <em class="brace">{</em>
<a id="L86" name="L86"></a>  86             <a href="../S/1460.html#L184" title="Defined at 184 in src/java/math/BitSieve.java.">sieveSingle</a>(<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>, <a href="../D/28157.html" title="Multiple defined in 12 places.">nextIndex</a> + nextPrime, nextPrime);
<a id="L87" name="L87"></a>  87             <a href="../D/28157.html" title="Multiple defined in 12 places.">nextIndex</a> = <a href="../S/1460.html#L166" title="Defined at 166 in src/java/math/BitSieve.java.">sieveSearch</a>(<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>, <a href="../D/28157.html" title="Multiple defined in 12 places.">nextIndex</a> + 1);
<a id="L88" name="L88"></a>  88             nextPrime = 2*<a href="../D/28157.html" title="Multiple defined in 12 places.">nextIndex</a> + 1;
<a id="L89" name="L89"></a>  89         <em class="brace">}</em> <strong class="reserved">while</strong>((<a href="../D/28157.html" title="Multiple defined in 12 places.">nextIndex</a> &gt; 0) &amp;&amp; (nextPrime &lt; <a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>));
<a id="L90" name="L90"></a>  90     <em class="brace">}</em>
<a id="L91" name="L91"></a>  91 
<div class="comment">
      Construct a bit sieve of searchLen bits used for finding prime number
      candidates. The new sieve begins at the specified base, which must
      be even.</div>
<a id="L97" name="L97"></a>  97     BitSieve(<a href="../S/1462.html#L123" title="Defined at 123 in src/java/math/BigInteger.java.">BigInteger</a> base, <strong class="reserved">int</strong> searchLen) <em class="brace">{</em>
<div class="comment">
          Candidates are indicated by clear bits in the sieve. As a candidates
          nonprimality is calculated, a bit is set in the sieve to eliminate
          it. To reduce storage space and increase efficiency, no even numbers
          are represented in the sieve (each bit in the sieve represents an
          odd number).</div>
<a id="L105" name="L105"></a> 105         bits = <strong class="reserved">new</strong> <strong class="reserved">long</strong>[(<a href="../S/1460.html#L134" title="Defined at 134 in src/java/math/BitSieve.java.">unitIndex</a>(searchLen-1) + 1)];
<a id="L106" name="L106"></a> 106         <a href="../D/26813.html" title="Multiple defined in 43 places.">length</a> = searchLen;
<a id="L107" name="L107"></a> 107         <strong class="reserved">int</strong> <a href="../D/34747.html" title="Multiple defined in 52 places.">start</a> = 0;
<a id="L108" name="L108"></a> 108 
<a id="L109" name="L109"></a> 109         <strong class="reserved">int</strong> <a href="../D/34874.html" title="Multiple defined in 3 places.">step</a> = smallSieve.<a href="../S/1460.html#L166" title="Defined at 166 in src/java/math/BitSieve.java.">sieveSearch</a>(smallSieve.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>, <a href="../D/34747.html" title="Multiple defined in 52 places.">start</a>);
<a id="L110" name="L110"></a> 110         <strong class="reserved">int</strong> convertedStep = (<a href="../D/34874.html" title="Multiple defined in 3 places.">step</a> *2) + 1;
<a id="L111" name="L111"></a> 111 
<a id="L112" name="L112"></a> 112         <em class="comment">// Construct the large sieve at an even offset specified by base</em>
<a id="L113" name="L113"></a> 113         <a href="../S/1466.html#L49" title="Defined at 49 in src/java/math/MutableBigInteger.java.">MutableBigInteger</a> b = <strong class="reserved">new</strong> <a href="../S/1466.html#L49" title="Defined at 49 in src/java/math/MutableBigInteger.java.">MutableBigInteger</a>(base);
<a id="L114" name="L114"></a> 114         <a href="../S/1466.html#L49" title="Defined at 49 in src/java/math/MutableBigInteger.java.">MutableBigInteger</a> q = <strong class="reserved">new</strong> <a href="../S/1466.html#L49" title="Defined at 49 in src/java/math/MutableBigInteger.java.">MutableBigInteger</a>();
<a id="L115" name="L115"></a> 115         <strong class="reserved">do</strong> <em class="brace">{</em>
<a id="L116" name="L116"></a> 116             <em class="comment">// Calculate base mod convertedStep</em>
<a id="L117" name="L117"></a> 117             <a href="../D/34747.html" title="Multiple defined in 52 places.">start</a> = b.<a href="../S/1466.html#L1085" title="Defined at 1085 in src/java/math/MutableBigInteger.java.">divideOneWord</a>(convertedStep, q);
<a id="L118" name="L118"></a> 118 
<a id="L119" name="L119"></a> 119             <em class="comment">// Take each multiple of step out of sieve</em>
<a id="L120" name="L120"></a> 120             <a href="../D/34747.html" title="Multiple defined in 52 places.">start</a> = convertedStep - <a href="../D/34747.html" title="Multiple defined in 52 places.">start</a>;
<a id="L121" name="L121"></a> 121             <strong class="reserved">if</strong> (<a href="../D/34747.html" title="Multiple defined in 52 places.">start</a>%2 == 0)
<a id="L122" name="L122"></a> 122                 <a href="../D/34747.html" title="Multiple defined in 52 places.">start</a> += convertedStep;
<a id="L123" name="L123"></a> 123             <a href="../S/1460.html#L184" title="Defined at 184 in src/java/math/BitSieve.java.">sieveSingle</a>(searchLen, (<a href="../D/34747.html" title="Multiple defined in 52 places.">start</a>-1)/2, convertedStep);
<a id="L124" name="L124"></a> 124 
<a id="L125" name="L125"></a> 125             <em class="comment">// Find next prime from small sieve</em>
<a id="L126" name="L126"></a> 126             <a href="../D/34874.html" title="Multiple defined in 3 places.">step</a> = smallSieve.<a href="../S/1460.html#L166" title="Defined at 166 in src/java/math/BitSieve.java.">sieveSearch</a>(smallSieve.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>, <a href="../D/34874.html" title="Multiple defined in 3 places.">step</a>+1);
<a id="L127" name="L127"></a> 127             convertedStep = (<a href="../D/34874.html" title="Multiple defined in 3 places.">step</a> *2) + 1;
<a id="L128" name="L128"></a> 128         <em class="brace">}</em> <strong class="reserved">while</strong> (<a href="../D/34874.html" title="Multiple defined in 3 places.">step</a> &gt; 0);
<a id="L129" name="L129"></a> 129     <em class="brace">}</em>
<a id="L130" name="L130"></a> 130 
<div class="comment">
      Given a bit index return unit index containing it.</div>
<a id="L134" name="L134"></a> 134     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">int</strong> <a href="../R/29688.html" title="Multiple referred from 6 places.">unitIndex</a>(<strong class="reserved">int</strong> bitIndex) <em class="brace">{</em>
<a id="L135" name="L135"></a> 135         <strong class="reserved">return</strong> bitIndex &gt;&gt;&gt; 6;
<a id="L136" name="L136"></a> 136     <em class="brace">}</em>
<a id="L137" name="L137"></a> 137 
<div class="comment">
      Return a unit that masks the specified bit in its unit.</div>
<a id="L141" name="L141"></a> 141     <strong class="reserved">private</strong> <strong class="reserved">static</strong> <strong class="reserved">long</strong> <a href="../R/10623.html" title="Multiple referred from 40 places.">bit</a>(<strong class="reserved">int</strong> bitIndex) <em class="brace">{</em>
<a id="L142" name="L142"></a> 142         <strong class="reserved">return</strong> 1L &lt;&lt; (bitIndex &amp; ((1&lt;&lt;6) - 1));
<a id="L143" name="L143"></a> 143     <em class="brace">}</em>
<a id="L144" name="L144"></a> 144 
<div class="comment">
      Get the value of the bit at the specified index.</div>
<a id="L148" name="L148"></a> 148     <strong class="reserved">private</strong> <strong class="reserved">boolean</strong> <a href="../R/14874.html" title="Multiple referred from 4230 places.">get</a>(<strong class="reserved">int</strong> bitIndex) <em class="brace">{</em>
<a id="L149" name="L149"></a> 149         <strong class="reserved">int</strong> <a href="../S/1460.html#L134" title="Defined at 134 in src/java/math/BitSieve.java.">unitIndex</a> = <a href="../S/1460.html#L134" title="Defined at 134 in src/java/math/BitSieve.java.">unitIndex</a>(bitIndex);
<a id="L150" name="L150"></a> 150         <strong class="reserved">return</strong> ((bits[<a href="../S/1460.html#L134" title="Defined at 134 in src/java/math/BitSieve.java.">unitIndex</a>] &amp; <a href="../D/11869.html" title="Multiple defined in 2 places.">bit</a>(bitIndex)) != 0);
<a id="L151" name="L151"></a> 151     <em class="brace">}</em>
<a id="L152" name="L152"></a> 152 
<div class="comment">
      Set the bit at the specified index.</div>
<a id="L156" name="L156"></a> 156     <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../R/26855.html" title="Multiple referred from 752 places.">set</a>(<strong class="reserved">int</strong> bitIndex) <em class="brace">{</em>
<a id="L157" name="L157"></a> 157         <strong class="reserved">int</strong> <a href="../S/1460.html#L134" title="Defined at 134 in src/java/math/BitSieve.java.">unitIndex</a> = <a href="../S/1460.html#L134" title="Defined at 134 in src/java/math/BitSieve.java.">unitIndex</a>(bitIndex);
<a id="L158" name="L158"></a> 158         bits[<a href="../S/1460.html#L134" title="Defined at 134 in src/java/math/BitSieve.java.">unitIndex</a>] |= <a href="../D/11869.html" title="Multiple defined in 2 places.">bit</a>(bitIndex);
<a id="L159" name="L159"></a> 159     <em class="brace">}</em>
<a id="L160" name="L160"></a> 160 
<div class="comment">
      This method returns the index of the first clear bit in the search
      array that occurs at or after start. It will not search past the
      specified limit. It returns -1 if there is no such clear bit.</div>
<a id="L166" name="L166"></a> 166     <strong class="reserved">private</strong> <strong class="reserved">int</strong> <a href="../R/28592.html" title="Multiple referred from 3 places.">sieveSearch</a>(<strong class="reserved">int</strong> <a href="../D/26840.html" title="Multiple defined in 12 places.">limit</a>, <strong class="reserved">int</strong> <a href="../D/34747.html" title="Multiple defined in 52 places.">start</a>) <em class="brace">{</em>
<a id="L167" name="L167"></a> 167         <strong class="reserved">if</strong> (<a href="../D/34747.html" title="Multiple defined in 52 places.">start</a> &gt;= <a href="../D/26840.html" title="Multiple defined in 12 places.">limit</a>)
<a id="L168" name="L168"></a> 168             <strong class="reserved">return</strong> -1;
<a id="L169" name="L169"></a> 169 
<a id="L170" name="L170"></a> 170         <strong class="reserved">int</strong> <a href="../D/24461.html" title="Multiple defined in 6 places.">index</a> = <a href="../D/34747.html" title="Multiple defined in 52 places.">start</a>;
<a id="L171" name="L171"></a> 171         <strong class="reserved">do</strong> <em class="brace">{</em>
<a id="L172" name="L172"></a> 172             <strong class="reserved">if</strong> (!<a href="../D/16676.html" title="Multiple defined in 434 places.">get</a>(<a href="../D/24461.html" title="Multiple defined in 6 places.">index</a>))
<a id="L173" name="L173"></a> 173                 <strong class="reserved">return</strong> <a href="../D/24461.html" title="Multiple defined in 6 places.">index</a>;
<a id="L174" name="L174"></a> 174             <a href="../D/24461.html" title="Multiple defined in 6 places.">index</a>++;
<a id="L175" name="L175"></a> 175         <em class="brace">}</em> <strong class="reserved">while</strong>(<a href="../D/24461.html" title="Multiple defined in 6 places.">index</a> &lt; <a href="../D/26840.html" title="Multiple defined in 12 places.">limit</a>-1);
<a id="L176" name="L176"></a> 176         <strong class="reserved">return</strong> -1;
<a id="L177" name="L177"></a> 177     <em class="brace">}</em>
<a id="L178" name="L178"></a> 178 
<div class="comment">
      Sieve a single set of multiples out of the sieve. Begin to remove
      multiples of the specified step starting at the specified start index,
      up to the specified limit.</div>
<a id="L184" name="L184"></a> 184     <strong class="reserved">private</strong> <strong class="reserved">void</strong> <a href="../R/28593.html" title="Multiple referred from 2 places.">sieveSingle</a>(<strong class="reserved">int</strong> <a href="../D/26840.html" title="Multiple defined in 12 places.">limit</a>, <strong class="reserved">int</strong> <a href="../D/34747.html" title="Multiple defined in 52 places.">start</a>, <strong class="reserved">int</strong> <a href="../D/34874.html" title="Multiple defined in 3 places.">step</a>) <em class="brace">{</em>
<a id="L185" name="L185"></a> 185         <strong class="reserved">while</strong>(<a href="../D/34747.html" title="Multiple defined in 52 places.">start</a> &lt; <a href="../D/26840.html" title="Multiple defined in 12 places.">limit</a>) <em class="brace">{</em>
<a id="L186" name="L186"></a> 186             <a href="../D/31832.html" title="Multiple defined in 134 places.">set</a>(<a href="../D/34747.html" title="Multiple defined in 52 places.">start</a>);
<a id="L187" name="L187"></a> 187             <a href="../D/34747.html" title="Multiple defined in 52 places.">start</a> += <a href="../D/34874.html" title="Multiple defined in 3 places.">step</a>;
<a id="L188" name="L188"></a> 188         <em class="brace">}</em>
<a id="L189" name="L189"></a> 189     <em class="brace">}</em>
<a id="L190" name="L190"></a> 190 
<div class="comment">
      Test probable primes in the sieve and return successful candidates.</div>
<a id="L194" name="L194"></a> 194     <a href="../S/1462.html#L123" title="Defined at 123 in src/java/math/BigInteger.java.">BigInteger</a> <a href="../R/26457.html" title="Multiple referred from 4 places.">retrieve</a>(<a href="../S/1462.html#L123" title="Defined at 123 in src/java/math/BigInteger.java.">BigInteger</a> initValue, <strong class="reserved">int</strong> certainty, <a href="../S/3625.html#L43" title="Defined at 43 in src/javax/management/remote/rmi/RMIConnectionImpl_Stub.java.">java</a>.util.<a href="../S/1000.html#L77" title="Defined at 77 in src/java/util/Random.java.">Random</a> <a href="../D/30092.html" title="Multiple defined in 3 places.">random</a>) <em class="brace">{</em>
<a id="L195" name="L195"></a> 195         <em class="comment">// Examine the sieve one long at a time to find possible primes</em>
<a id="L196" name="L196"></a> 196         <strong class="reserved">int</strong> <a href="../D/28472.html" title="Multiple defined in 2 places.">offset</a> = 1;
<a id="L197" name="L197"></a> 197         <strong class="reserved">for</strong> (<strong class="reserved">int</strong> i=0; i&lt;bits.<a href="../D/26813.html" title="Multiple defined in 43 places.">length</a>; i++) <em class="brace">{</em>
<a id="L198" name="L198"></a> 198             <strong class="reserved">long</strong> <a href="../D/28165.html" title="Multiple defined in 11 places.">nextLong</a> = ~bits[i];
<a id="L199" name="L199"></a> 199             <strong class="reserved">for</strong> (<strong class="reserved">int</strong> j=0; j&lt;64; j++) <em class="brace">{</em>
<a id="L200" name="L200"></a> 200                 <strong class="reserved">if</strong> ((<a href="../D/28165.html" title="Multiple defined in 11 places.">nextLong</a> &amp; 1) == 1) <em class="brace">{</em>
<a id="L201" name="L201"></a> 201                     <a href="../S/1462.html#L123" title="Defined at 123 in src/java/math/BigInteger.java.">BigInteger</a> candidate = initValue.<a href="../D/10632.html" title="Multiple defined in 301 places.">add</a>(
<a id="L202" name="L202"></a> 202                                            <a href="../S/1462.html#L123" title="Defined at 123 in src/java/math/BigInteger.java.">BigInteger</a>.<a href="../D/36373.html" title="Multiple defined in 48 places.">valueOf</a>(<a href="../D/28472.html" title="Multiple defined in 2 places.">offset</a>));
<a id="L203" name="L203"></a> 203                     <strong class="reserved">if</strong> (candidate.<a href="../S/1462.html#L856" title="Defined at 856 in src/java/math/BigInteger.java.">primeToCertainty</a>(certainty, <a href="../D/30092.html" title="Multiple defined in 3 places.">random</a>))
<a id="L204" name="L204"></a> 204                         <strong class="reserved">return</strong> candidate;
<a id="L205" name="L205"></a> 205                 <em class="brace">}</em>
<a id="L206" name="L206"></a> 206                 <a href="../D/28165.html" title="Multiple defined in 11 places.">nextLong</a> &gt;&gt;&gt;= 1;
<a id="L207" name="L207"></a> 207                 <a href="../D/28472.html" title="Multiple defined in 2 places.">offset</a>+=2;
<a id="L208" name="L208"></a> 208             <em class="brace">}</em>
<a id="L209" name="L209"></a> 209         <em class="brace">}</em>
<a id="L210" name="L210"></a> 210         <strong class="reserved">return</strong> <strong class="reserved">null</strong>;
<a id="L211" name="L211"></a> 211     <em class="brace">}</em>
<a id="L212" name="L212"></a> 212 <em class="brace">}</em>
</pre>
<hr>
<div class="comment">
/* [&lt;][&gt;]<a href="#L134">[^]</a><a href="#L194">[v]</a><a href="#TOP">[top]</a>[bottom]<a href="../mains.html">[index]</a><a href="../help.html">[help]</a> */</div>
</body></html>