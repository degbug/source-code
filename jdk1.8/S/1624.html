<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>
<title>src/java/lang/invoke/AbstractValidatingLambdaMetafactory.java</title>
<meta name="robots" content="noindex,nofollow">
<meta name="generator" content="GLOBAL-6.6.3">
<meta http-equiv="Content-Style-Type" content="text/css">
<link rel="stylesheet" type="text/css" href="../style.css">
</head>
<body>
<a id="TOP" name="TOP"></a><div class="comment">
/* [&lt;][&gt;]<a href="#L166">[^]</a><a href="#L347">[v]</a>[top]<a href="#BOTTOM">[bottom]</a><a href="../mains.html">[index]</a><a href="../help.html">[help]</a> */</div>
<hr>
<h2 class="header">DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href="#L166" title="Defined at 166.">buildCallSite</a></li>
<li><a href="#L173" title="Defined at 173.">validateMetafactoryArgs</a></li>
<li><a href="#L305" title="Defined at 305.">isAdaptableTo</a></li>
<li><a href="#L343" title="Defined at 343.">isAdaptableToAsReturn</a></li>
<li><a href="#L347" title="Defined at 347.">isAdaptableToAsReturnStrict</a></li>
</ol>
<hr>
<pre>
<div class="comment">
  Copyright (c) 2012, 2013, Oracle and/or its affiliates. All rights reserved.
  ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.</div>
<a id="L25" name="L25"></a>  25 <strong class="reserved">package</strong> <a href="../S/3625.html#L43" title="Defined at 43 in src/javax/management/remote/rmi/RMIConnectionImpl_Stub.java.">java</a>.lang.<a href="../D/25050.html" title="Multiple defined in 52 places.">invoke</a>;
<a id="L26" name="L26"></a>  26 
<a id="L27" name="L27"></a>  27 <strong class="reserved">import</strong> sun.invoke.util.Wrapper;
<a id="L28" name="L28"></a>  28 
<a id="L29" name="L29"></a>  29 <strong class="reserved">import</strong> static sun.invoke.util.Wrapper.forPrimitiveType;
<a id="L30" name="L30"></a>  30 <strong class="reserved">import</strong> static sun.invoke.util.Wrapper.forWrapperType;
<a id="L31" name="L31"></a>  31 <strong class="reserved">import</strong> static sun.invoke.util.Wrapper.isWrapperType;
<a id="L32" name="L32"></a>  32 
<div class="comment">
  Abstract implementation of a lambda metafactory which provides parameter
  unrolling and input validation.
  @see LambdaMetafactory</div>
<div class="comment">
 /* package */</div> <strong class="reserved">abstract</strong> <strong class="reserved">class</strong> <a href="../R/128.html" title="Multiple referred from 3 places.">AbstractValidatingLambdaMetafactory</a> <em class="brace">{</em>
<a id="L40" name="L40"></a>  40 
<div class="comment">
      For context, the comments for the following fields are marked in quotes
      with their values, given this program:
      interface II<t> {  Object foo(T x); }
      interface JJ<r extends number> extends II<r> { }
      class CC {  String impl(int i) { return "impl:"+i; }}
      class X {
          public static void main(String[] args) {
              JJ<integer> iii = (new CC())::impl;
              System.out.printf("&gt;&gt;&gt; %s\n", iii.foo(44));
      }}</integer></r></r></t></div>
<a id="L53" name="L53"></a>  53     <strong class="reserved">final</strong> <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; targetClass;               <em class="comment">// The class calling the meta-factory via invokedynamic "class X"</em>
<a id="L54" name="L54"></a>  54     <strong class="reserved">final</strong> <a href="../D/5628.html" title="Multiple defined in 4 places.">MethodType</a> invokedType;             <em class="comment">// The type of the invoked method "(CC)II"</em>
<a id="L55" name="L55"></a>  55     <strong class="reserved">final</strong> <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; samBase;                   <em class="comment">// The type of the returned instance "interface JJ"</em>
<a id="L56" name="L56"></a>  56     <strong class="reserved">final</strong> <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> samMethodName;               <em class="comment">// Name of the SAM method "foo"</em>
<a id="L57" name="L57"></a>  57     <strong class="reserved">final</strong> <a href="../D/5628.html" title="Multiple defined in 4 places.">MethodType</a> samMethodType;           <em class="comment">// Type of the SAM method "(Object)Object"</em>
<a id="L58" name="L58"></a>  58     <strong class="reserved">final</strong> <a href="../S/1623.html#L421" title="Defined at 421 in src/java/lang/invoke/MethodHandle.java.">MethodHandle</a> implMethod;            <em class="comment">// Raw method handle for the implementation method</em>
<a id="L59" name="L59"></a>  59     <strong class="reserved">final</strong> <a href="../S/1607.html#L126" title="Defined at 126 in src/java/lang/invoke/MethodHandleInfo.java.">MethodHandleInfo</a> implInfo;          <em class="comment">// Info about the implementation method handle "MethodHandleInfo[5 CC.impl(int)String]"</em>
<a id="L60" name="L60"></a>  60     <strong class="reserved">final</strong> <strong class="reserved">int</strong> implKind;                       <em class="comment">// Invocation kind for implementation "5"=invokevirtual</em>
<a id="L61" name="L61"></a>  61     <strong class="reserved">final</strong> <strong class="reserved">boolean</strong> implIsInstanceMethod;       <em class="comment">// Is the implementation an instance method "true"</em>
<a id="L62" name="L62"></a>  62     <strong class="reserved">final</strong> <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; implDefiningClass;         <em class="comment">// Type defining the implementation "class CC"</em>
<a id="L63" name="L63"></a>  63     <strong class="reserved">final</strong> <a href="../D/5628.html" title="Multiple defined in 4 places.">MethodType</a> implMethodType;          <em class="comment">// Type of the implementation method "(int)String"</em>
<a id="L64" name="L64"></a>  64     <strong class="reserved">final</strong> <a href="../D/5628.html" title="Multiple defined in 4 places.">MethodType</a> instantiatedMethodType;  <em class="comment">// Instantiated erased functional interface method type "(Integer)Object"</em>
<a id="L65" name="L65"></a>  65     <strong class="reserved">final</strong> <strong class="reserved">boolean</strong> <a href="../D/26224.html" title="Multiple defined in 4 places.">isSerializable</a>;             <em class="comment">// Should the returned instance be serializable</em>
<a id="L66" name="L66"></a>  66     <strong class="reserved">final</strong> <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt;[] markerInterfaces;        <em class="comment">// Additional marker interfaces to be implemented</em>
<a id="L67" name="L67"></a>  67     <strong class="reserved">final</strong> <a href="../D/5628.html" title="Multiple defined in 4 places.">MethodType</a>[] additionalBridges;     <em class="comment">// Signatures of additional methods to bridge</em>
<a id="L68" name="L68"></a>  68 
<a id="L69" name="L69"></a>  69 
<div class="comment">
      Meta-factory constructor.
      @param caller Stacked automatically by VM; represents a lookup context
                    with the accessibility privileges of the caller.
      @param invokedType Stacked automatically by VM; the signature of the
                         invoked method, which includes the expected static
                         type of the returned lambda object, and the static
                         types of the captured arguments for the lambda.  In
                         the event that the implementation method is an
                         instance method, the first argument in the invocation
                         signature will correspond to the receiver.
      @param samMethodName Name of the method in the functional interface to
                           which the lambda or method reference is being
                           converted, represented as a String.
      @param samMethodType Type of the method in the functional interface to
                           which the lambda or method reference is being
                           converted, represented as a MethodType.
      @param implMethod The implementation method which should be called
                        (with suitable adaptation of argument types, return
                        types, and adjustment for captured arguments) when
                        methods of the resulting functional interface instance
                        are invoked.
      @param instantiatedMethodType The signature of the primary functional
                                    interface method after type variables are
                                    substituted with their instantiation from
                                    the capture site
      @param isSerializable Should the lambda be made serializable?  If set,
                            either the target type or one of the additional SAM
                            types must extend <code>Serializable</code>.
      @param markerInterfaces Additional interfaces which the lambda object
                            should implement.
      @param additionalBridges Method types for additional signatures to be
                               bridged to the implementation method
      @throws LambdaConversionException If any of the meta-factory protocol
      invariants are violated</div>
<a id="L107" name="L107"></a> 107     AbstractValidatingLambdaMetafactory(<a href="../S/1619.html#L60" title="Defined at 60 in src/java/lang/invoke/MethodHandles.java.">MethodHandles</a>.<a href="../S/1619.html#L512" title="Defined at 512 in src/java/lang/invoke/MethodHandles.java.">Lookup</a> caller,
<a id="L108" name="L108"></a> 108                                        <a href="../D/5628.html" title="Multiple defined in 4 places.">MethodType</a> invokedType,
<a id="L109" name="L109"></a> 109                                        <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a> samMethodName,
<a id="L110" name="L110"></a> 110                                        <a href="../D/5628.html" title="Multiple defined in 4 places.">MethodType</a> samMethodType,
<a id="L111" name="L111"></a> 111                                        <a href="../S/1623.html#L421" title="Defined at 421 in src/java/lang/invoke/MethodHandle.java.">MethodHandle</a> implMethod,
<a id="L112" name="L112"></a> 112                                        <a href="../D/5628.html" title="Multiple defined in 4 places.">MethodType</a> instantiatedMethodType,
<a id="L113" name="L113"></a> 113                                        <strong class="reserved">boolean</strong> <a href="../D/26224.html" title="Multiple defined in 4 places.">isSerializable</a>,
<a id="L114" name="L114"></a> 114                                        <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt;[] markerInterfaces,
<a id="L115" name="L115"></a> 115                                        <a href="../D/5628.html" title="Multiple defined in 4 places.">MethodType</a>[] additionalBridges)
<a id="L116" name="L116"></a> 116             <strong class="reserved">throws</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a> <em class="brace">{</em>
<a id="L117" name="L117"></a> 117         <strong class="reserved">if</strong> ((caller.<a href="../S/1619.html#L591" title="Defined at 591 in src/java/lang/invoke/MethodHandles.java.">lookupModes</a>() &amp; <a href="../S/1619.html#L60" title="Defined at 60 in src/java/lang/invoke/MethodHandles.java.">MethodHandles</a>.<a href="../S/1619.html#L512" title="Defined at 512 in src/java/lang/invoke/MethodHandles.java.">Lookup</a>.PRIVATE) == 0) <em class="brace">{</em>
<a id="L118" name="L118"></a> 118             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>(<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>.<a href="../D/16531.html" title="Multiple defined in 87 places.">format</a>(
<a id="L119" name="L119"></a> 119                     "Invalid caller: %s",
<a id="L120" name="L120"></a> 120                     caller.<a href="../D/27102.html" title="Multiple defined in 4 places.">lookupClass</a>().<a href="../D/20784.html" title="Multiple defined in 355 places.">getName</a>()));
<a id="L121" name="L121"></a> 121         <em class="brace">}</em>
<a id="L122" name="L122"></a> 122         <strong class="reserved">this</strong>.targetClass = caller.<a href="../D/27102.html" title="Multiple defined in 4 places.">lookupClass</a>();
<a id="L123" name="L123"></a> 123         <strong class="reserved">this</strong>.invokedType = invokedType;
<a id="L124" name="L124"></a> 124 
<a id="L125" name="L125"></a> 125         <strong class="reserved">this</strong>.samBase = invokedType.<a href="../D/31403.html" title="Multiple defined in 4 places.">returnType</a>();
<a id="L126" name="L126"></a> 126 
<a id="L127" name="L127"></a> 127         <strong class="reserved">this</strong>.samMethodName = samMethodName;
<a id="L128" name="L128"></a> 128         <strong class="reserved">this</strong>.samMethodType  = samMethodType;
<a id="L129" name="L129"></a> 129 
<a id="L130" name="L130"></a> 130         <strong class="reserved">this</strong>.implMethod = implMethod;
<a id="L131" name="L131"></a> 131         <strong class="reserved">this</strong>.implInfo = caller.<a href="../S/1619.html#L1336" title="Defined at 1336 in src/java/lang/invoke/MethodHandles.java.">revealDirect</a>(implMethod);
<a id="L132" name="L132"></a> 132         <strong class="reserved">this</strong>.implKind = implInfo.<a href="../D/21916.html" title="Multiple defined in 3 places.">getReferenceKind</a>();
<a id="L133" name="L133"></a> 133         <strong class="reserved">this</strong>.implIsInstanceMethod =
<a id="L134" name="L134"></a> 134                 implKind == <a href="../S/1607.html#L126" title="Defined at 126 in src/java/lang/invoke/MethodHandleInfo.java.">MethodHandleInfo</a>.REF_invokeVirtual ||
<a id="L135" name="L135"></a> 135                 implKind == <a href="../S/1607.html#L126" title="Defined at 126 in src/java/lang/invoke/MethodHandleInfo.java.">MethodHandleInfo</a>.REF_invokeSpecial ||
<a id="L136" name="L136"></a> 136                 implKind == <a href="../S/1607.html#L126" title="Defined at 126 in src/java/lang/invoke/MethodHandleInfo.java.">MethodHandleInfo</a>.REF_invokeInterface;
<a id="L137" name="L137"></a> 137         <strong class="reserved">this</strong>.implDefiningClass = implInfo.<a href="../D/18264.html" title="Multiple defined in 10 places.">getDeclaringClass</a>();
<a id="L138" name="L138"></a> 138         <strong class="reserved">this</strong>.implMethodType = implInfo.<a href="../D/20598.html" title="Multiple defined in 3 places.">getMethodType</a>();
<a id="L139" name="L139"></a> 139         <strong class="reserved">this</strong>.instantiatedMethodType = instantiatedMethodType;
<a id="L140" name="L140"></a> 140         <strong class="reserved">this</strong>.<a href="../D/26224.html" title="Multiple defined in 4 places.">isSerializable</a> = <a href="../D/26224.html" title="Multiple defined in 4 places.">isSerializable</a>;
<a id="L141" name="L141"></a> 141         <strong class="reserved">this</strong>.markerInterfaces = markerInterfaces;
<a id="L142" name="L142"></a> 142         <strong class="reserved">this</strong>.additionalBridges = additionalBridges;
<a id="L143" name="L143"></a> 143 
<a id="L144" name="L144"></a> 144         <strong class="reserved">if</strong> (!samBase.<a href="../D/25735.html" title="Multiple defined in 6 places.">isInterface</a>()) <em class="brace">{</em>
<a id="L145" name="L145"></a> 145             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>(<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>.<a href="../D/16531.html" title="Multiple defined in 87 places.">format</a>(
<a id="L146" name="L146"></a> 146                     "Functional interface %s is not an interface",
<a id="L147" name="L147"></a> 147                     samBase.<a href="../D/20784.html" title="Multiple defined in 355 places.">getName</a>()));
<a id="L148" name="L148"></a> 148         <em class="brace">}</em>
<a id="L149" name="L149"></a> 149 
<a id="L150" name="L150"></a> 150         <strong class="reserved">for</strong> (<a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; <a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a> : markerInterfaces) <em class="brace">{</em>
<a id="L151" name="L151"></a> 151             <strong class="reserved">if</strong> (!<a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a>.<a href="../D/25735.html" title="Multiple defined in 6 places.">isInterface</a>()) <em class="brace">{</em>
<a id="L152" name="L152"></a> 152                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>(<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>.<a href="../D/16531.html" title="Multiple defined in 87 places.">format</a>(
<a id="L153" name="L153"></a> 153                         "Marker interface %s is not an interface",
<a id="L154" name="L154"></a> 154                         <a href="../S/986.html#L3167" title="Defined at 3167 in src/java/util/regex/Pattern.java.">c</a>.<a href="../D/20784.html" title="Multiple defined in 355 places.">getName</a>()));
<a id="L155" name="L155"></a> 155             <em class="brace">}</em>
<a id="L156" name="L156"></a> 156         <em class="brace">}</em>
<a id="L157" name="L157"></a> 157     <em class="brace">}</em>
<a id="L158" name="L158"></a> 158 
<div class="comment">
      Build the CallSite.
      @return a CallSite, which, when invoked, will return an instance of the
      functional interface
      @throws ReflectiveOperationException</div>
<a id="L166" name="L166"></a> 166     <strong class="reserved">abstract</strong> <a href="../S/1601.html#L86" title="Defined at 86 in src/java/lang/invoke/CallSite.java.">CallSite</a> <a href="../R/10692.html" title="Multiple referred from 2 places.">buildCallSite</a>()
<a id="L167" name="L167"></a> 167             <strong class="reserved">throws</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>;
<a id="L168" name="L168"></a> 168 
<div class="comment">
      Check the meta-factory arguments for errors
      @throws LambdaConversionException if there are improper conversions</div>
<a id="L173" name="L173"></a> 173     <strong class="reserved">void</strong> <a href="../R/30070.html" title="Multiple referred from 2 places.">validateMetafactoryArgs</a>() <strong class="reserved">throws</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a> <em class="brace">{</em>
<a id="L174" name="L174"></a> 174         <strong class="reserved">switch</strong> (implKind) <em class="brace">{</em>
<a id="L175" name="L175"></a> 175             <strong class="reserved">case</strong> <a href="../S/1607.html#L126" title="Defined at 126 in src/java/lang/invoke/MethodHandleInfo.java.">MethodHandleInfo</a>.REF_invokeInterface:
<a id="L176" name="L176"></a> 176             <strong class="reserved">case</strong> <a href="../S/1607.html#L126" title="Defined at 126 in src/java/lang/invoke/MethodHandleInfo.java.">MethodHandleInfo</a>.REF_invokeVirtual:
<a id="L177" name="L177"></a> 177             <strong class="reserved">case</strong> <a href="../S/1607.html#L126" title="Defined at 126 in src/java/lang/invoke/MethodHandleInfo.java.">MethodHandleInfo</a>.REF_invokeStatic:
<a id="L178" name="L178"></a> 178             <strong class="reserved">case</strong> <a href="../S/1607.html#L126" title="Defined at 126 in src/java/lang/invoke/MethodHandleInfo.java.">MethodHandleInfo</a>.REF_newInvokeSpecial:
<a id="L179" name="L179"></a> 179             <strong class="reserved">case</strong> <a href="../S/1607.html#L126" title="Defined at 126 in src/java/lang/invoke/MethodHandleInfo.java.">MethodHandleInfo</a>.REF_invokeSpecial:
<a id="L180" name="L180"></a> 180                 <strong class="reserved">break</strong>;
<a id="L181" name="L181"></a> 181             <strong class="reserved">default</strong>:
<a id="L182" name="L182"></a> 182                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>(<a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>.<a href="../D/16531.html" title="Multiple defined in 87 places.">format</a>("Unsupported MethodHandle kind: %s", implInfo));
<a id="L183" name="L183"></a> 183         <em class="brace">}</em>
<a id="L184" name="L184"></a> 184 
<a id="L185" name="L185"></a> 185         <em class="comment">// Check arity: optional-receiver + captured + SAM == impl</em>
<a id="L186" name="L186"></a> 186         <strong class="reserved">final</strong> <strong class="reserved">int</strong> implArity = implMethodType.<a href="../D/29054.html" title="Multiple defined in 2 places.">parameterCount</a>();
<a id="L187" name="L187"></a> 187         <strong class="reserved">final</strong> <strong class="reserved">int</strong> receiverArity = implIsInstanceMethod ? 1 : 0;
<a id="L188" name="L188"></a> 188         <strong class="reserved">final</strong> <strong class="reserved">int</strong> capturedArity = invokedType.<a href="../D/29054.html" title="Multiple defined in 2 places.">parameterCount</a>();
<a id="L189" name="L189"></a> 189         <strong class="reserved">final</strong> <strong class="reserved">int</strong> samArity = samMethodType.<a href="../D/29054.html" title="Multiple defined in 2 places.">parameterCount</a>();
<a id="L190" name="L190"></a> 190         <strong class="reserved">final</strong> <strong class="reserved">int</strong> instantiatedArity = instantiatedMethodType.<a href="../D/29054.html" title="Multiple defined in 2 places.">parameterCount</a>();
<a id="L191" name="L191"></a> 191         <strong class="reserved">if</strong> (implArity + receiverArity != capturedArity + samArity) <em class="brace">{</em>
<a id="L192" name="L192"></a> 192             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>(
<a id="L193" name="L193"></a> 193                     <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>.<a href="../D/16531.html" title="Multiple defined in 87 places.">format</a>("Incorrect number of parameters for %s method %s; %d captured parameters, %d functional interface method parameters, %d implementation parameters",
<a id="L194" name="L194"></a> 194                                   implIsInstanceMethod ? "instance" : "static", implInfo,
<a id="L195" name="L195"></a> 195                                   capturedArity, samArity, implArity));
<a id="L196" name="L196"></a> 196         <em class="brace">}</em>
<a id="L197" name="L197"></a> 197         <strong class="reserved">if</strong> (instantiatedArity != samArity) <em class="brace">{</em>
<a id="L198" name="L198"></a> 198             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>(
<a id="L199" name="L199"></a> 199                     <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>.<a href="../D/16531.html" title="Multiple defined in 87 places.">format</a>("Incorrect number of parameters for %s method %s; %d instantiated parameters, %d functional interface method parameters",
<a id="L200" name="L200"></a> 200                                   implIsInstanceMethod ? "instance" : "static", implInfo,
<a id="L201" name="L201"></a> 201                                   instantiatedArity, samArity));
<a id="L202" name="L202"></a> 202         <em class="brace">}</em>
<a id="L203" name="L203"></a> 203         <strong class="reserved">for</strong> (<a href="../D/5628.html" title="Multiple defined in 4 places.">MethodType</a> bridgeMT : additionalBridges) <em class="brace">{</em>
<a id="L204" name="L204"></a> 204             <strong class="reserved">if</strong> (bridgeMT.<a href="../D/29054.html" title="Multiple defined in 2 places.">parameterCount</a>() != samArity) <em class="brace">{</em>
<a id="L205" name="L205"></a> 205                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>(
<a id="L206" name="L206"></a> 206                         <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>.<a href="../D/16531.html" title="Multiple defined in 87 places.">format</a>("Incorrect number of parameters for bridge signature %s; incompatible with %s",
<a id="L207" name="L207"></a> 207                                       bridgeMT, samMethodType));
<a id="L208" name="L208"></a> 208             <em class="brace">}</em>
<a id="L209" name="L209"></a> 209         <em class="brace">}</em>
<a id="L210" name="L210"></a> 210 
<a id="L211" name="L211"></a> 211         <em class="comment">// If instance: first captured arg (receiver) must be subtype of class where impl method is defined</em>
<a id="L212" name="L212"></a> 212         <strong class="reserved">final</strong> <strong class="reserved">int</strong> capturedStart;
<a id="L213" name="L213"></a> 213         <strong class="reserved">final</strong> <strong class="reserved">int</strong> samStart;
<a id="L214" name="L214"></a> 214         <strong class="reserved">if</strong> (implIsInstanceMethod) <em class="brace">{</em>
<a id="L215" name="L215"></a> 215             <strong class="reserved">final</strong> <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; receiverClass;
<a id="L216" name="L216"></a> 216 
<a id="L217" name="L217"></a> 217             <em class="comment">// implementation is an instance method, adjust for receiver in captured variables / SAM arguments</em>
<a id="L218" name="L218"></a> 218             <strong class="reserved">if</strong> (capturedArity == 0) <em class="brace">{</em>
<a id="L219" name="L219"></a> 219                 <em class="comment">// receiver is function parameter</em>
<a id="L220" name="L220"></a> 220                 capturedStart = 0;
<a id="L221" name="L221"></a> 221                 samStart = 1;
<a id="L222" name="L222"></a> 222                 receiverClass = instantiatedMethodType.<a href="../D/29061.html" title="Multiple defined in 3 places.">parameterType</a>(0);
<a id="L223" name="L223"></a> 223             <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L224" name="L224"></a> 224                 <em class="comment">// receiver is a captured variable</em>
<a id="L225" name="L225"></a> 225                 capturedStart = 1;
<a id="L226" name="L226"></a> 226                 samStart = 0;
<a id="L227" name="L227"></a> 227                 receiverClass = invokedType.<a href="../D/29061.html" title="Multiple defined in 3 places.">parameterType</a>(0);
<a id="L228" name="L228"></a> 228             <em class="brace">}</em>
<a id="L229" name="L229"></a> 229 
<a id="L230" name="L230"></a> 230             <em class="comment">// check receiver type</em>
<a id="L231" name="L231"></a> 231             <strong class="reserved">if</strong> (!implDefiningClass.<a href="../D/25213.html" title="Multiple defined in 7 places.">isAssignableFrom</a>(receiverClass)) <em class="brace">{</em>
<a id="L232" name="L232"></a> 232                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>(
<a id="L233" name="L233"></a> 233                         <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>.<a href="../D/16531.html" title="Multiple defined in 87 places.">format</a>("Invalid receiver type %s; not a subtype of implementation type %s",
<a id="L234" name="L234"></a> 234                                       receiverClass, implDefiningClass));
<a id="L235" name="L235"></a> 235             <em class="brace">}</em>
<a id="L236" name="L236"></a> 236 
<a id="L237" name="L237"></a> 237            <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; implReceiverClass = implMethod.<a href="../D/35749.html" title="Multiple defined in 239 places.">type</a>().<a href="../D/29061.html" title="Multiple defined in 3 places.">parameterType</a>(0);
<a id="L238" name="L238"></a> 238            <strong class="reserved">if</strong> (implReceiverClass != implDefiningClass &amp;&amp; !implReceiverClass.<a href="../D/25213.html" title="Multiple defined in 7 places.">isAssignableFrom</a>(receiverClass)) <em class="brace">{</em>
<a id="L239" name="L239"></a> 239                <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>(
<a id="L240" name="L240"></a> 240                        <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>.<a href="../D/16531.html" title="Multiple defined in 87 places.">format</a>("Invalid receiver type %s; not a subtype of implementation receiver type %s",
<a id="L241" name="L241"></a> 241                                      receiverClass, implReceiverClass));
<a id="L242" name="L242"></a> 242             <em class="brace">}</em>
<a id="L243" name="L243"></a> 243         <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L244" name="L244"></a> 244             <em class="comment">// no receiver</em>
<a id="L245" name="L245"></a> 245             capturedStart = 0;
<a id="L246" name="L246"></a> 246             samStart = 0;
<a id="L247" name="L247"></a> 247         <em class="brace">}</em>
<a id="L248" name="L248"></a> 248 
<a id="L249" name="L249"></a> 249         <em class="comment">// Check for exact match on non-receiver captured arguments</em>
<a id="L250" name="L250"></a> 250         <strong class="reserved">final</strong> <strong class="reserved">int</strong> implFromCaptured = capturedArity - capturedStart;
<a id="L251" name="L251"></a> 251         <strong class="reserved">for</strong> (<strong class="reserved">int</strong> i=0; i&lt;implFromCaptured; i++) <em class="brace">{</em>
<a id="L252" name="L252"></a> 252             <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; implParamType = implMethodType.<a href="../D/29061.html" title="Multiple defined in 3 places.">parameterType</a>(i);
<a id="L253" name="L253"></a> 253             <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; capturedParamType = invokedType.<a href="../D/29061.html" title="Multiple defined in 3 places.">parameterType</a>(i + capturedStart);
<a id="L254" name="L254"></a> 254             <strong class="reserved">if</strong> (!capturedParamType.<a href="../D/15685.html" title="Multiple defined in 654 places.">equals</a>(implParamType)) <em class="brace">{</em>
<a id="L255" name="L255"></a> 255                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>(
<a id="L256" name="L256"></a> 256                         <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>.<a href="../D/16531.html" title="Multiple defined in 87 places.">format</a>("Type mismatch in captured lambda parameter %d: expecting %s, found %s",
<a id="L257" name="L257"></a> 257                                       i, capturedParamType, implParamType));
<a id="L258" name="L258"></a> 258             <em class="brace">}</em>
<a id="L259" name="L259"></a> 259         <em class="brace">}</em>
<a id="L260" name="L260"></a> 260         <em class="comment">// Check for adaptation match on SAM arguments</em>
<a id="L261" name="L261"></a> 261         <strong class="reserved">final</strong> <strong class="reserved">int</strong> samOffset = samStart - implFromCaptured;
<a id="L262" name="L262"></a> 262         <strong class="reserved">for</strong> (<strong class="reserved">int</strong> i=implFromCaptured; i&lt;implArity; i++) <em class="brace">{</em>
<a id="L263" name="L263"></a> 263             <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; implParamType = implMethodType.<a href="../D/29061.html" title="Multiple defined in 3 places.">parameterType</a>(i);
<a id="L264" name="L264"></a> 264             <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; instantiatedParamType = instantiatedMethodType.<a href="../D/29061.html" title="Multiple defined in 3 places.">parameterType</a>(i + samOffset);
<a id="L265" name="L265"></a> 265             <strong class="reserved">if</strong> (!<a href="../S/1624.html#L305" title="Defined at 305 in src/java/lang/invoke/AbstractValidatingLambdaMetafactory.java.">isAdaptableTo</a>(instantiatedParamType, implParamType, <strong class="reserved">true</strong>)) <em class="brace">{</em>
<a id="L266" name="L266"></a> 266                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>(
<a id="L267" name="L267"></a> 267                         <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>.<a href="../D/16531.html" title="Multiple defined in 87 places.">format</a>("Type mismatch for lambda argument %d: %s is not convertible to %s",
<a id="L268" name="L268"></a> 268                                       i, instantiatedParamType, implParamType));
<a id="L269" name="L269"></a> 269             <em class="brace">}</em>
<a id="L270" name="L270"></a> 270         <em class="brace">}</em>
<a id="L271" name="L271"></a> 271 
<a id="L272" name="L272"></a> 272         <em class="comment">// Adaptation match: return type</em>
<a id="L273" name="L273"></a> 273         <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; expectedType = instantiatedMethodType.<a href="../D/31403.html" title="Multiple defined in 4 places.">returnType</a>();
<a id="L274" name="L274"></a> 274         <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; actualReturnType =
<a id="L275" name="L275"></a> 275                 (implKind == <a href="../S/1607.html#L126" title="Defined at 126 in src/java/lang/invoke/MethodHandleInfo.java.">MethodHandleInfo</a>.REF_newInvokeSpecial)
<a id="L276" name="L276"></a> 276                   ? implDefiningClass
<a id="L277" name="L277"></a> 277                   : implMethodType.<a href="../D/31403.html" title="Multiple defined in 4 places.">returnType</a>();
<a id="L278" name="L278"></a> 278         <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; samReturnType = samMethodType.<a href="../D/31403.html" title="Multiple defined in 4 places.">returnType</a>();
<a id="L279" name="L279"></a> 279         <strong class="reserved">if</strong> (!<a href="../S/1624.html#L343" title="Defined at 343 in src/java/lang/invoke/AbstractValidatingLambdaMetafactory.java.">isAdaptableToAsReturn</a>(actualReturnType, expectedType)) <em class="brace">{</em>
<a id="L280" name="L280"></a> 280             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>(
<a id="L281" name="L281"></a> 281                     <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>.<a href="../D/16531.html" title="Multiple defined in 87 places.">format</a>("Type mismatch for lambda return: %s is not convertible to %s",
<a id="L282" name="L282"></a> 282                                   actualReturnType, expectedType));
<a id="L283" name="L283"></a> 283         <em class="brace">}</em>
<a id="L284" name="L284"></a> 284         <strong class="reserved">if</strong> (!<a href="../S/1624.html#L347" title="Defined at 347 in src/java/lang/invoke/AbstractValidatingLambdaMetafactory.java.">isAdaptableToAsReturnStrict</a>(expectedType, samReturnType)) <em class="brace">{</em>
<a id="L285" name="L285"></a> 285             <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>(
<a id="L286" name="L286"></a> 286                     <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>.<a href="../D/16531.html" title="Multiple defined in 87 places.">format</a>("Type mismatch for lambda expected return: %s is not convertible to %s",
<a id="L287" name="L287"></a> 287                                   expectedType, samReturnType));
<a id="L288" name="L288"></a> 288         <em class="brace">}</em>
<a id="L289" name="L289"></a> 289         <strong class="reserved">for</strong> (<a href="../D/5628.html" title="Multiple defined in 4 places.">MethodType</a> bridgeMT : additionalBridges) <em class="brace">{</em>
<a id="L290" name="L290"></a> 290             <strong class="reserved">if</strong> (!<a href="../S/1624.html#L347" title="Defined at 347 in src/java/lang/invoke/AbstractValidatingLambdaMetafactory.java.">isAdaptableToAsReturnStrict</a>(expectedType, bridgeMT.<a href="../D/31403.html" title="Multiple defined in 4 places.">returnType</a>())) <em class="brace">{</em>
<a id="L291" name="L291"></a> 291                 <strong class="reserved">throw</strong> <strong class="reserved">new</strong> <a href="../S/1632.html#L31" title="Defined at 31 in src/java/lang/invoke/LambdaConversionException.java.">LambdaConversionException</a>(
<a id="L292" name="L292"></a> 292                         <a href="../D/8419.html" title="Multiple defined in 2 places.">String</a>.<a href="../D/16531.html" title="Multiple defined in 87 places.">format</a>("Type mismatch for lambda expected return: %s is not convertible to %s",
<a id="L293" name="L293"></a> 293                                       expectedType, bridgeMT.<a href="../D/31403.html" title="Multiple defined in 4 places.">returnType</a>()));
<a id="L294" name="L294"></a> 294             <em class="brace">}</em>
<a id="L295" name="L295"></a> 295         <em class="brace">}</em>
<a id="L296" name="L296"></a> 296      <em class="brace">}</em>
<a id="L297" name="L297"></a> 297 
<div class="comment">
      Check type adaptability for parameter types.
      @param fromType Type to convert from
      @param toType Type to convert to
      @param strict If true, do strict checks, else allow that fromType may be parameterized
      @return True if 'fromType' can be passed to an argument of 'toType'</div>
<a id="L305" name="L305"></a> 305     <strong class="reserved">private</strong> <strong class="reserved">boolean</strong> <a href="../R/21140.html" title="Multiple referred from 3 places.">isAdaptableTo</a>(<a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; fromType, <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; toType, <strong class="reserved">boolean</strong> strict) <em class="brace">{</em>
<a id="L306" name="L306"></a> 306         <strong class="reserved">if</strong> (fromType.<a href="../D/15685.html" title="Multiple defined in 654 places.">equals</a>(toType)) <em class="brace">{</em>
<a id="L307" name="L307"></a> 307             <strong class="reserved">return</strong> <strong class="reserved">true</strong>;
<a id="L308" name="L308"></a> 308         <em class="brace">}</em>
<a id="L309" name="L309"></a> 309         <strong class="reserved">if</strong> (fromType.<a href="../D/26086.html" title="Multiple defined in 8 places.">isPrimitive</a>()) <em class="brace">{</em>
<a id="L310" name="L310"></a> 310             <a href="../S/2566.html#L42" title="Defined at 42 in src/java/sql/Wrapper.java.">Wrapper</a> wfrom = forPrimitiveType(fromType);
<a id="L311" name="L311"></a> 311             <strong class="reserved">if</strong> (toType.<a href="../D/26086.html" title="Multiple defined in 8 places.">isPrimitive</a>()) <em class="brace">{</em>
<a id="L312" name="L312"></a> 312                 <em class="comment">// both are primitive: widening</em>
<a id="L313" name="L313"></a> 313                 <a href="../S/2566.html#L42" title="Defined at 42 in src/java/sql/Wrapper.java.">Wrapper</a> wto = forPrimitiveType(toType);
<a id="L314" name="L314"></a> 314                 <strong class="reserved">return</strong> wto.isConvertibleFrom(wfrom);
<a id="L315" name="L315"></a> 315             <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L316" name="L316"></a> 316                 <em class="comment">// from primitive to reference: boxing</em>
<a id="L317" name="L317"></a> 317                 <strong class="reserved">return</strong> toType.<a href="../D/25213.html" title="Multiple defined in 7 places.">isAssignableFrom</a>(wfrom.wrapperType());
<a id="L318" name="L318"></a> 318             <em class="brace">}</em>
<a id="L319" name="L319"></a> 319         <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L320" name="L320"></a> 320             <strong class="reserved">if</strong> (toType.<a href="../D/26086.html" title="Multiple defined in 8 places.">isPrimitive</a>()) <em class="brace">{</em>
<a id="L321" name="L321"></a> 321                 <em class="comment">// from reference to primitive: unboxing</em>
<a id="L322" name="L322"></a> 322                 <a href="../S/2566.html#L42" title="Defined at 42 in src/java/sql/Wrapper.java.">Wrapper</a> wfrom;
<a id="L323" name="L323"></a> 323                 <strong class="reserved">if</strong> (isWrapperType(fromType) &amp;&amp; (wfrom = forWrapperType(fromType)).<a href="../S/3493.html#L58" title="Defined at 58 in src/javax/management/loading/MLetObjectInputStream.java.">primitiveType</a>().<a href="../D/26086.html" title="Multiple defined in 8 places.">isPrimitive</a>()) <em class="brace">{</em>
<a id="L324" name="L324"></a> 324                     <em class="comment">// fromType is a primitive wrapper; unbox+widen</em>
<a id="L325" name="L325"></a> 325                     <a href="../S/2566.html#L42" title="Defined at 42 in src/java/sql/Wrapper.java.">Wrapper</a> wto = forPrimitiveType(toType);
<a id="L326" name="L326"></a> 326                     <strong class="reserved">return</strong> wto.isConvertibleFrom(wfrom);
<a id="L327" name="L327"></a> 327                 <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L328" name="L328"></a> 328                     <em class="comment">// must be convertible to primitive</em>
<a id="L329" name="L329"></a> 329                     <strong class="reserved">return</strong> !strict;
<a id="L330" name="L330"></a> 330                 <em class="brace">}</em>
<a id="L331" name="L331"></a> 331             <em class="brace">}</em> <strong class="reserved">else</strong> <em class="brace">{</em>
<a id="L332" name="L332"></a> 332                 <em class="comment">// both are reference types: fromType should be a superclass of toType.</em>
<a id="L333" name="L333"></a> 333                 <strong class="reserved">return</strong> !strict || toType.<a href="../D/25213.html" title="Multiple defined in 7 places.">isAssignableFrom</a>(fromType);
<a id="L334" name="L334"></a> 334             <em class="brace">}</em>
<a id="L335" name="L335"></a> 335         <em class="brace">}</em>
<a id="L336" name="L336"></a> 336     <em class="brace">}</em>
<a id="L337" name="L337"></a> 337 
<div class="comment">
      Check type adaptability for return types --
      special handling of void type) and parameterized fromType
      @return True if 'fromType' can be converted to 'toType'</div>
<a id="L343" name="L343"></a> 343     <strong class="reserved">private</strong> <strong class="reserved">boolean</strong> <a href="../S/1624.html#L279" title="Referred from 279 in src/java/lang/invoke/AbstractValidatingLambdaMetafactory.java.">isAdaptableToAsReturn</a>(<a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; fromType, <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; toType) <em class="brace">{</em>
<a id="L344" name="L344"></a> 344         <strong class="reserved">return</strong> toType.<a href="../D/15685.html" title="Multiple defined in 654 places.">equals</a>(<strong class="reserved">void</strong>.<strong class="reserved">class</strong>)
<a id="L345" name="L345"></a> 345                || !fromType.<a href="../D/15685.html" title="Multiple defined in 654 places.">equals</a>(<strong class="reserved">void</strong>.<strong class="reserved">class</strong>) &amp;&amp; <a href="../S/1624.html#L305" title="Defined at 305 in src/java/lang/invoke/AbstractValidatingLambdaMetafactory.java.">isAdaptableTo</a>(fromType, toType, <strong class="reserved">false</strong>);
<a id="L346" name="L346"></a> 346     <em class="brace">}</em>
<a id="L347" name="L347"></a> 347     <strong class="reserved">private</strong> <strong class="reserved">boolean</strong> <a href="../R/21142.html" title="Multiple referred from 2 places.">isAdaptableToAsReturnStrict</a>(<a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; fromType, <a href="../S/1722.html#L119" title="Defined at 119 in src/java/lang/Class.java.">Class</a>&lt;?&gt; toType) <em class="brace">{</em>
<a id="L348" name="L348"></a> 348         <strong class="reserved">if</strong> (fromType.<a href="../D/15685.html" title="Multiple defined in 654 places.">equals</a>(<strong class="reserved">void</strong>.<strong class="reserved">class</strong>)) <strong class="reserved">return</strong> toType.<a href="../D/15685.html" title="Multiple defined in 654 places.">equals</a>(<strong class="reserved">void</strong>.<strong class="reserved">class</strong>);
<a id="L349" name="L349"></a> 349         <strong class="reserved">return</strong> <a href="../S/1624.html#L305" title="Defined at 305 in src/java/lang/invoke/AbstractValidatingLambdaMetafactory.java.">isAdaptableTo</a>(fromType, toType, <strong class="reserved">true</strong>);
<a id="L350" name="L350"></a> 350     <em class="brace">}</em>
<a id="L351" name="L351"></a> 351 
<a id="L352" name="L352"></a> 352 
<div class="comment">
********* Logging support -- for debugging only, uncomment as needed
    static final Executor logPool = Executors.newSingleThreadExecutor();
    protected static void log(final String s) {
        MethodHandleProxyLambdaMetafactory.logPool.execute(new Runnable() {
            @Override
            public void run() {
                System.out.println(s);
            }
        });
    }
    protected static void log(final String s, final Throwable e) {
        MethodHandleProxyLambdaMetafactory.logPool.execute(new Runnable() {
            @Override
            public void run() {
                System.out.println(s);
                e.printStackTrace(System.out);
            }
        });
    }
    **********************</div>
<a id="L374" name="L374"></a> 374 
<a id="L375" name="L375"></a> 375 <em class="brace">}</em>
</pre>
<hr>
<div class="comment">
/* [&lt;][&gt;]<a href="#L166">[^]</a><a href="#L347">[v]</a><a href="#TOP">[top]</a>[bottom]<a href="../mains.html">[index]</a><a href="../help.html">[help]</a> */</div>
</body></html>